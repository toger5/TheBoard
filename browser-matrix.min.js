!function e(t,r,n){function i(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(o)return o(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};t[s][0].call(l.exports,(function(e){return i(t[s][1][e]||e)}),l,l.exports,e,t,r,n)}return r[s].exports}for(var o="function"==typeof require&&require,s=0;s<n.length;s++)i(n[s]);return i}({1:[function(e,t,r){t.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}},{}],2:[function(e,t,r){t.exports=function(e){if(Array.isArray(e))return e}},{}],3:[function(e,t,r){var n=e("./arrayLikeToArray");t.exports=function(e){if(Array.isArray(e))return n(e)}},{"./arrayLikeToArray":1}],4:[function(e,t,r){t.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},{}],5:[function(e,t,r){function n(e,t,r,n,i,o,s){try{var a=e[o](s),u=a.value}catch(e){return void r(e)}a.done?t(u):Promise.resolve(u).then(n,i)}t.exports=function(e){return function(){var t=this,r=arguments;return new Promise((function(i,o){var s=e.apply(t,r);function a(e){n(s,i,o,a,u,"next",e)}function u(e){n(s,i,o,a,u,"throw",e)}a(void 0)}))}}},{}],6:[function(e,t,r){t.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],7:[function(e,t,r){var n=e("./setPrototypeOf"),i=e("./isNativeReflectConstruct");function o(e,r,s){return i()?t.exports=o=Reflect.construct:t.exports=o=function(e,t,r){var i=[null];i.push.apply(i,t);var o=new(Function.bind.apply(e,i));return r&&n(o,r.prototype),o},o.apply(null,arguments)}t.exports=o},{"./isNativeReflectConstruct":15,"./setPrototypeOf":21}],8:[function(e,t,r){function n(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}t.exports=function(e,t,r){return t&&n(e.prototype,t),r&&n(e,r),e}},{}],9:[function(e,t,r){t.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},{}],10:[function(e,t,r){function n(e){return t.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(e)}t.exports=n},{}],11:[function(e,t,r){var n=e("./setPrototypeOf");t.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}},{"./setPrototypeOf":21}],12:[function(e,t,r){t.exports=function(e){return e&&e.__esModule?e:{default:e}}},{}],13:[function(e,t,r){var n=e("@babel/runtime/helpers/typeof");function i(){if("function"!=typeof WeakMap)return null;var e=new WeakMap;return i=function(){return e},e}t.exports=function(e){if(e&&e.__esModule)return e;if(null===e||"object"!==n(e)&&"function"!=typeof e)return{default:e};var t=i();if(t&&t.has(e))return t.get(e);var r={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var s in e)if(Object.prototype.hasOwnProperty.call(e,s)){var a=o?Object.getOwnPropertyDescriptor(e,s):null;a&&(a.get||a.set)?Object.defineProperty(r,s,a):r[s]=e[s]}return r.default=e,t&&t.set(e,r),r}},{"@babel/runtime/helpers/typeof":24}],14:[function(e,t,r){t.exports=function(e){return-1!==Function.toString.call(e).indexOf("[native code]")}},{}],15:[function(e,t,r){t.exports=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}},{}],16:[function(e,t,r){t.exports=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},{}],17:[function(e,t,r){t.exports=function(e,t){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e)){var r=[],n=!0,i=!1,o=void 0;try{for(var s,a=e[Symbol.iterator]();!(n=(s=a.next()).done)&&(r.push(s.value),!t||r.length!==t);n=!0);}catch(e){i=!0,o=e}finally{try{n||null==a.return||a.return()}finally{if(i)throw o}}return r}}},{}],18:[function(e,t,r){t.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},{}],19:[function(e,t,r){t.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},{}],20:[function(e,t,r){var n=e("@babel/runtime/helpers/typeof"),i=e("./assertThisInitialized");t.exports=function(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?i(e):t}},{"./assertThisInitialized":4,"@babel/runtime/helpers/typeof":24}],21:[function(e,t,r){function n(e,r){return t.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(e,r)}t.exports=n},{}],22:[function(e,t,r){var n=e("./arrayWithHoles"),i=e("./iterableToArrayLimit"),o=e("./unsupportedIterableToArray"),s=e("./nonIterableRest");t.exports=function(e,t){return n(e)||i(e,t)||o(e,t)||s()}},{"./arrayWithHoles":2,"./iterableToArrayLimit":17,"./nonIterableRest":18,"./unsupportedIterableToArray":25}],23:[function(e,t,r){var n=e("./arrayWithoutHoles"),i=e("./iterableToArray"),o=e("./unsupportedIterableToArray"),s=e("./nonIterableSpread");t.exports=function(e){return n(e)||i(e)||o(e)||s()}},{"./arrayWithoutHoles":3,"./iterableToArray":16,"./nonIterableSpread":19,"./unsupportedIterableToArray":25}],24:[function(e,t,r){function n(e){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?t.exports=n=function(e){return typeof e}:t.exports=n=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},n(e)}t.exports=n},{}],25:[function(e,t,r){var n=e("./arrayLikeToArray");t.exports=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}},{"./arrayLikeToArray":1}],26:[function(e,t,r){var n=e("./getPrototypeOf"),i=e("./setPrototypeOf"),o=e("./isNativeFunction"),s=e("./construct");function a(e){var r="function"==typeof Map?new Map:void 0;return t.exports=a=function(e){if(null===e||!o(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==r){if(r.has(e))return r.get(e);r.set(e,t)}function t(){return s(e,arguments,n(this).constructor)}return t.prototype=Object.create(e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),i(t,e)},a(e)}t.exports=a},{"./construct":7,"./getPrototypeOf":10,"./isNativeFunction":14,"./setPrototypeOf":21}],27:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":48}],28:[function(e,t,r){"use strict";for(var n=/[\\\"\x00-\x1F]/g,i={},o=0;o<32;++o)i[String.fromCharCode(o)]="\\U"+("0000"+o.toString(16)).slice(-4).toUpperCase();function s(e){return n.lastIndex=0,e.replace(n,(function(e){return i[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=a(e[n]);return","!=t?"[]":r+"]"}(e):function(e){var t="{",r="",n=Object.keys(e);n.sort();for(var i=0;i<n.length;++i){var o=n[i];r+=t+'"'+s(o)+'":',t=",",r+=a(e[o])}return","!=t?"{}":r+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}i["\b"]="\\b",i["\t"]="\\t",i["\n"]="\\n",i["\f"]="\\f",i["\r"]="\\r",i['"']='\\"',i["\\"]="\\\\",t.exports={stringify:a}},{}],29:[function(e,t,r){"use strict";var n=e("safe-buffer").Buffer;t.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");for(var t=new Uint8Array(256),r=0;r<t.length;r++)t[r]=255;for(var i=0;i<e.length;i++){var o=e.charAt(i),s=o.charCodeAt(0);if(255!==t[s])throw new TypeError(o+" is ambiguous");t[s]=i}var a=e.length,u=e.charAt(0),c=Math.log(a)/Math.log(256),l=Math.log(256)/Math.log(a);function d(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return n.alloc(0);var r=0;if(" "!==e[r]){for(var i=0,o=0;e[r]===u;)i++,r++;for(var s=(e.length-r)*c+1>>>0,l=new Uint8Array(s);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var h=0,f=s-1;(0!==d||h<o)&&-1!==f;f--,h++)d+=a*l[f]>>>0,l[f]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");o=h,r++}if(" "!==e[r]){for(var p=s-o;p!==s&&0===l[p];)p++;var g=n.allocUnsafe(i+(s-p));g.fill(0,0,i);for(var v=i;p!==s;)g[v++]=l[p++];return g}}}return{encode:function(t){if((Array.isArray(t)||t instanceof Uint8Array)&&(t=n.from(t)),!n.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var r=0,i=0,o=0,s=t.length;o!==s&&0===t[o];)o++,r++;for(var c=(s-o)*l+1>>>0,d=new Uint8Array(c);o!==s;){for(var h=t[o],f=0,p=c-1;(0!==h||f<i)&&-1!==p;p--,f++)h+=256*d[p]>>>0,d[p]=h%a>>>0,h=h/a>>>0;if(0!==h)throw new Error("Non-zero carry");i=f,o++}for(var g=c-i;g!==c&&0===d[g];)g++;for(var v=u.repeat(r);g<c;++g)v+=e.charAt(d[g]);return v},decodeUnsafe:d,decode:function(e){var t=d(e);if(t)return t;throw new Error("Non-base"+a+" character")}}}},{"safe-buffer":49}],30:[function(e,t,r){"use strict";r.byteLength=function(e){var t=c(e),r=t[0],n=t[1];return 3*(r+n)/4-n},r.toByteArray=function(e){var t,r,n=c(e),s=n[0],a=n[1],u=new o(function(e,t,r){return 3*(t+r)/4-r}(0,s,a)),l=0,d=a>0?s-4:s;for(r=0;r<d;r+=4)t=i[e.charCodeAt(r)]<<18|i[e.charCodeAt(r+1)]<<12|i[e.charCodeAt(r+2)]<<6|i[e.charCodeAt(r+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;2===a&&(t=i[e.charCodeAt(r)]<<2|i[e.charCodeAt(r+1)]>>4,u[l++]=255&t);1===a&&(t=i[e.charCodeAt(r)]<<10|i[e.charCodeAt(r+1)]<<4|i[e.charCodeAt(r+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t);return u},r.fromByteArray=function(e){for(var t,r=e.length,i=r%3,o=[],s=16383,a=0,u=r-i;a<u;a+=s)o.push(l(e,a,a+s>u?u:a+s));1===i?(t=e[r-1],o.push(n[t>>2]+n[t<<4&63]+"==")):2===i&&(t=(e[r-2]<<8)+e[r-1],o.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return o.join("")};for(var n=[],i=[],o="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,u=s.length;a<u;++a)n[a]=s[a],i[s.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var i,o,s=[],a=t;a<r;a+=3)i=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(n[(o=i)>>18&63]+n[o>>12&63]+n[o>>6&63]+n[63&o]);return s.join("")}i["-".charCodeAt(0)]=62,i["_".charCodeAt(0)]=63},{}],31:[function(e,t,r){var n,i;n=this,i=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");function t(o,s){if("function"!=typeof s)throw new Error("Bad callback given: "+s);if(!o)throw new Error("No options given");var a=o.onResponse;if((o="string"==typeof o?{uri:o}:JSON.parse(JSON.stringify(o))).onResponse=a,o.verbose&&(t.log=function(){var e,t,r={},o=["trace","debug","info","warn","error"];for(t=0;t<o.length;t++)r[e=o[t]]=n,"undefined"!=typeof console&&console&&console[e]&&(r[e]=i(console,e));return r}()),o.url&&(o.uri=o.url,delete o.url),!o.uri&&""!==o.uri)throw new Error("options.uri is a required argument");if("string"!=typeof o.uri)throw new Error("options.uri must be a string");for(var u=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],c=0;c<u.length;c++)if(o[u[c]])throw new Error("options."+u[c]+" is not supported");if(o.callback=s,o.method=o.method||"GET",o.headers=o.headers||{},o.body=o.body||null,o.timeout=o.timeout||t.DEFAULT_TIMEOUT,o.headers.host)throw new Error("Options.headers.host is not supported");o.json&&(o.headers.accept=o.headers.accept||"application/json","GET"!==o.method&&(o.headers["content-type"]="application/json"),"boolean"!=typeof o.json?o.body=JSON.stringify(o.json):"string"!=typeof o.body&&(o.body=JSON.stringify(o.body)));var l=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")};if(o.qs){var d="string"==typeof o.qs?o.qs:l(o.qs);-1!==o.uri.indexOf("?")?o.uri=o.uri+"&"+d:o.uri=o.uri+"?"+d}if(o.form){if("string"==typeof o.form)throw"form name unsupported";if("POST"===o.method){var h=(o.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(o.headers["content-type"]=h,h){case"application/x-www-form-urlencoded":o.body=l(o.form).replace(/%20/g,"+");break;case"multipart/form-data":var f=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+n+'"\n\n'+e[n]+"\n");return r.push("--"+t.boundry+"--"),t.body=r.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(o.form);o.body=f.body,o.headers["content-type"]=f.type;break;default:throw new Error("unsupported encoding:"+h)}}}return o.onResponse=o.onResponse||n,!0===o.onResponse&&(o.onResponse=s,o.callback=n),!o.headers.authorization&&o.auth&&(o.headers.authorization="Basic "+function(e){var t,r,n,i,o,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",a=0,u=0,c="",l=[];if(!e)return e;do{t=(o=e.charCodeAt(a++)<<16|e.charCodeAt(a++)<<8|e.charCodeAt(a++))>>18&63,r=o>>12&63,n=o>>6&63,i=63&o,l[u++]=s.charAt(t)+s.charAt(r)+s.charAt(n)+s.charAt(i)}while(a<e.length);switch(c=l.join(""),e.length%3){case 1:c=c.slice(0,-2)+"==";break;case 2:c=c.slice(0,-1)+"="}return c}(o.auth.username+":"+o.auth.password)),function(n){var i=new e,o=!1,s=function(e){var t,r=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var n=r.exec(t.toLowerCase())||[],i=r.exec(e.toLowerCase());return!(!i||i[1]==n[1]&&i[2]==n[2]&&(i[3]||("http:"===i[1]?80:443))==(n[3]||("http:"===n[1]?80:443)))}(n.uri),a="withCredentials"in i;if(r+=1,i.seq_id=r,i.id=r+": "+n.method+" "+n.uri,i._id=i.id,s&&!a){var u=new Error("Browser does not support cross-origin request: "+n.uri);return u.cors="unsupported",n.callback(u,i)}function c(){o=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=n.timeout,t.log.error("Timeout",{id:i._id,milliseconds:n.timeout}),n.callback(e,i)}i.timeoutTimer=setTimeout(c,n.timeout);var l={response:!1,loading:!1,end:!1};return i.onreadystatechange=d,i.open(n.method,n.uri,!0),s&&(i.withCredentials=!!n.withCredentials),i.send(n.body),i;function d(r){if(o)return t.log.debug("Ignoring timed out state change",{state:i.readyState,id:i.id});if(t.log.debug("State change",{state:i.readyState,id:i.id,timed_out:o}),i.readyState===e.OPENED)for(var s in t.log.debug("Request started",{id:i.id}),n.headers)i.setRequestHeader(s,n.headers[s]);else i.readyState===e.HEADERS_RECEIVED?h():i.readyState===e.LOADING?(h(),f()):i.readyState===e.DONE&&(h(),f(),p())}function h(){if(!l.response){if(l.response=!0,t.log.debug("Got response",{id:i.id,status:i.status}),clearTimeout(i.timeoutTimer),i.statusCode=i.status,s&&0==i.statusCode){var e=new Error("CORS request rejected: "+n.uri);return e.cors="rejected",l.loading=!0,l.end=!0,n.callback(e,i)}n.onResponse(null,i)}}function f(){l.loading||(l.loading=!0,t.log.debug("Response body loading",{id:i.id}))}function p(){if(!l.end){if(l.end=!0,t.log.debug("Request done",{id:i.id}),i.body=i.responseText,n.json)try{i.body=JSON.parse(i.responseText)}catch(e){return n.callback(e,i)}n.callback(null,i,i.body)}}}(o)}t.log={trace:n,debug:n,info:n,warn:n,error:n};var r=0;function n(){}function i(e,t){return function(r,n){return"object"==typeof n&&(r+=" "+JSON.stringify(n)),e[t].call(e,r)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,r){var n=function(t){return function(r,n){for(var i in r="string"==typeof r?{uri:r}:JSON.parse(JSON.stringify(r)),e)void 0===r[i]&&(r[i]=e[i]);return t(r,n)}},i=n(t);return i.get=n(t.get),i.post=n(t.post),i.put=n(t.put),i.head=n(t.head),i},["get","put","post","head"].forEach((function(e){var r=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:r,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=r;var n=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,n)}})),t.couch=function(e,r){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,r=r||n,t(e,(function(e,t,n){if(e)return r(e,t,n);if((t.statusCode<200||t.statusCode>299)&&n.error){for(var i in e=new Error("CouchDB error: "+(n.error.reason||n.error.error)),n)e[i]=n[i];return r(e,t,n)}return r(e,t,n)}))},t},"function"==typeof define&&define.amd?define([],i):"object"==typeof r?t.exports=i():n.returnExports=i()},{}],32:[function(e,t,r){(function(e){(function(){!function(n){var i="object"==typeof r&&r&&!r.nodeType&&r,o="object"==typeof t&&t&&!t.nodeType&&t,s="object"==typeof e&&e;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var a,u,c=2147483647,l=36,d=/^xn--/,h=/[^\x20-\x7E]/,f=/[\x2E\u3002\uFF0E\uFF61]/g,p={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},g=Math.floor,v=String.fromCharCode;function y(e){throw new RangeError(p[e])}function m(e,t){for(var r=e.length,n=[];r--;)n[r]=t(e[r]);return n}function _(e,t){var r=e.split("@"),n="";return r.length>1&&(n=r[0]+"@",e=r[1]),n+m((e=e.replace(f,".")).split("."),t).join(".")}function b(e){for(var t,r,n=[],i=0,o=e.length;i<o;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<o?56320==(64512&(r=e.charCodeAt(i++)))?n.push(((1023&t)<<10)+(1023&r)+65536):(n.push(t),i--):n.push(t);return n}function S(e){return m(e,(function(e){var t="";return e>65535&&(t+=v((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=v(e)})).join("")}function k(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function E(e,t,r){var n=0;for(e=r?g(e/700):e>>1,e+=g(e/t);e>455;n+=l)e=g(e/35);return g(n+36*e/(e+38))}function w(e){var t,r,n,i,o,s,a,u,d,h,f,p=[],v=e.length,m=0,_=128,b=72;for((r=e.lastIndexOf("-"))<0&&(r=0),n=0;n<r;++n)e.charCodeAt(n)>=128&&y("not-basic"),p.push(e.charCodeAt(n));for(i=r>0?r+1:0;i<v;){for(o=m,s=1,a=l;i>=v&&y("invalid-input"),((u=(f=e.charCodeAt(i++))-48<10?f-22:f-65<26?f-65:f-97<26?f-97:l)>=l||u>g((c-m)/s))&&y("overflow"),m+=u*s,!(u<(d=a<=b?1:a>=b+26?26:a-b));a+=l)s>g(c/(h=l-d))&&y("overflow"),s*=h;b=E(m-o,t=p.length+1,0==o),g(m/t)>c-_&&y("overflow"),_+=g(m/t),m%=t,p.splice(m++,0,_)}return S(p)}function I(e){var t,r,n,i,o,s,a,u,d,h,f,p,m,_,S,w=[];for(p=(e=b(e)).length,t=128,r=0,o=72,s=0;s<p;++s)(f=e[s])<128&&w.push(v(f));for(n=i=w.length,i&&w.push("-");n<p;){for(a=c,s=0;s<p;++s)(f=e[s])>=t&&f<a&&(a=f);for(a-t>g((c-r)/(m=n+1))&&y("overflow"),r+=(a-t)*m,t=a,s=0;s<p;++s)if((f=e[s])<t&&++r>c&&y("overflow"),f==t){for(u=r,d=l;!(u<(h=d<=o?1:d>=o+26?26:d-o));d+=l)S=u-h,_=l-h,w.push(v(k(h+S%_,0))),u=g(S/_);w.push(v(k(u,0))),o=E(r,m,n==i),r=0,++n}++r,++t}return w.join("")}if(a={version:"1.4.1",ucs2:{decode:b,encode:S},decode:w,encode:I,toASCII:function(e){return _(e,(function(e){return h.test(e)?"xn--"+I(e):e}))},toUnicode:function(e){return _(e,(function(e){return d.test(e)?w(e.slice(4).toLowerCase()):e}))}},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",(function(){return a}));else if(i&&o)if(t.exports==i)o.exports=a;else for(u in a)a.hasOwnProperty(u)&&(i[u]=a[u]);else n.punycode=a}(this)}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],33:[function(e,t,r){var n=e("base-x");t.exports=n("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},{"base-x":29}],34:[function(e,t,r){(function(t){(function(){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
"use strict";var t=e("base64-js"),n=e("ieee754");r.Buffer=s,r.SlowBuffer=function(e){+e!=e&&(e=0);return s.alloc(+e)},r.INSPECT_MAX_BYTES=50;var i=2147483647;function o(e){if(e>i)throw new RangeError('The value "'+e+'" is invalid for option "size"');var t=new Uint8Array(e);return t.__proto__=s.prototype,t}function s(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return c(e)}return a(e,t,r)}function a(e,t,r){if("string"==typeof e)return function(e,t){"string"==typeof t&&""!==t||(t="utf8");if(!s.isEncoding(t))throw new TypeError("Unknown encoding: "+t);var r=0|h(e,t),n=o(r),i=n.write(e,t);i!==r&&(n=n.slice(0,i));return n}(e,t);if(ArrayBuffer.isView(e))return l(e);if(null==e)throw TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(q(e,ArrayBuffer)||e&&q(e.buffer,ArrayBuffer))return function(e,t,r){if(t<0||e.byteLength<t)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<t+(r||0))throw new RangeError('"length" is outside of buffer bounds');var n;n=void 0===t&&void 0===r?new Uint8Array(e):void 0===r?new Uint8Array(e,t):new Uint8Array(e,t,r);return n.__proto__=s.prototype,n}(e,t,r);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var n=e.valueOf&&e.valueOf();if(null!=n&&n!==e)return s.from(n,t,r);var i=function(e){if(s.isBuffer(e)){var t=0|d(e.length),r=o(t);return 0===r.length||e.copy(r,0,0,t),r}if(void 0!==e.length)return"number"!=typeof e.length||j(e.length)?o(0):l(e);if("Buffer"===e.type&&Array.isArray(e.data))return l(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return s.from(e[Symbol.toPrimitive]("string"),t,r);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function u(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function c(e){return u(e),o(e<0?0:0|d(e))}function l(e){for(var t=e.length<0?0:0|d(e.length),r=o(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function d(e){if(e>=i)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+i.toString(16)+" bytes");return 0|e}function h(e,t){if(s.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||q(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var r=e.length,n=arguments.length>2&&!0===arguments[2];if(!n&&0===r)return 0;for(var i=!1;;)switch(t){case"ascii":case"latin1":case"binary":return r;case"utf8":case"utf-8":return K(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*r;case"hex":return r>>>1;case"base64":return B(e).length;default:if(i)return n?-1:K(e).length;t=(""+t).toLowerCase(),i=!0}}function f(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return x(this,t,r);case"utf8":case"utf-8":return w(this,t,r);case"ascii":return T(this,t,r);case"latin1":case"binary":return R(this,t,r);case"base64":return E(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return C(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function p(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function g(e,t,r,n,i){if(0===e.length)return-1;if("string"==typeof r?(n=r,r=0):r>2147483647?r=2147483647:r<-2147483648&&(r=-2147483648),j(r=+r)&&(r=i?0:e.length-1),r<0&&(r=e.length+r),r>=e.length){if(i)return-1;r=e.length-1}else if(r<0){if(!i)return-1;r=0}if("string"==typeof t&&(t=s.from(t,n)),s.isBuffer(t))return 0===t.length?-1:v(e,t,r,n,i);if("number"==typeof t)return t&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,t,r):Uint8Array.prototype.lastIndexOf.call(e,t,r):v(e,[t],r,n,i);throw new TypeError("val must be string, number or Buffer")}function v(e,t,r,n,i){var o,s=1,a=e.length,u=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,u/=2,r/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(i){var l=-1;for(o=r;o<a;o++)if(c(e,o)===c(t,-1===l?0:o-l)){if(-1===l&&(l=o),o-l+1===u)return l*s}else-1!==l&&(o-=o-l),l=-1}else for(r+u>a&&(r=a-u),o=r;o>=0;o--){for(var d=!0,h=0;h<u;h++)if(c(e,o+h)!==c(t,h)){d=!1;break}if(d)return o}return-1}function y(e,t,r,n){r=Number(r)||0;var i=e.length-r;n?(n=Number(n))>i&&(n=i):n=i;var o=t.length;n>o/2&&(n=o/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(j(a))return s;e[r+s]=a}return s}function m(e,t,r,n){return L(K(t,e.length-r),e,r,n)}function _(e,t,r,n){return L(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function b(e,t,r,n){return _(e,t,r,n)}function S(e,t,r,n){return L(B(t),e,r,n)}function k(e,t,r,n){return L(function(e,t){for(var r,n,i,o=[],s=0;s<e.length&&!((t-=2)<0);++s)n=(r=e.charCodeAt(s))>>8,i=r%256,o.push(i),o.push(n);return o}(t,e.length-r),e,r,n)}function E(e,r,n){return 0===r&&n===e.length?t.fromByteArray(e):t.fromByteArray(e.slice(r,n))}function w(e,t,r){r=Math.min(e.length,r);for(var n=[],i=t;i<r;){var o,s,a,u,c=e[i],l=null,d=c>239?4:c>223?3:c>191?2:1;if(i+d<=r)switch(d){case 1:c<128&&(l=c);break;case 2:128==(192&(o=e[i+1]))&&(u=(31&c)<<6|63&o)>127&&(l=u);break;case 3:o=e[i+1],s=e[i+2],128==(192&o)&&128==(192&s)&&(u=(15&c)<<12|(63&o)<<6|63&s)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:o=e[i+1],s=e[i+2],a=e[i+3],128==(192&o)&&128==(192&s)&&128==(192&a)&&(u=(15&c)<<18|(63&o)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(l=u)}null===l?(l=65533,d=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),i+=d}return function(e){var t=e.length;if(t<=I)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=I));return r}(n)}r.kMaxLength=i,s.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1);return e.__proto__={__proto__:Uint8Array.prototype,foo:function(){return 42}},42===e.foo()}catch(e){return!1}}(),s.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(s.prototype,"parent",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.buffer}}),Object.defineProperty(s.prototype,"offset",{enumerable:!0,get:function(){if(s.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&s[Symbol.species]===s&&Object.defineProperty(s,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),s.poolSize=8192,s.from=function(e,t,r){return a(e,t,r)},s.prototype.__proto__=Uint8Array.prototype,s.__proto__=Uint8Array,s.alloc=function(e,t,r){return function(e,t,r){return u(e),e<=0?o(e):void 0!==t?"string"==typeof r?o(e).fill(t,r):o(e).fill(t):o(e)}(e,t,r)},s.allocUnsafe=function(e){return c(e)},s.allocUnsafeSlow=function(e){return c(e)},s.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==s.prototype},s.compare=function(e,t){if(q(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),q(t,Uint8Array)&&(t=s.from(t,t.offset,t.byteLength)),!s.isBuffer(e)||!s.isBuffer(t))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===t)return 0;for(var r=e.length,n=t.length,i=0,o=Math.min(r,n);i<o;++i)if(e[i]!==t[i]){r=e[i],n=t[i];break}return r<n?-1:n<r?1:0},s.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},s.concat=function(e,t){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return s.alloc(0);var r;if(void 0===t)for(t=0,r=0;r<e.length;++r)t+=e[r].length;var n=s.allocUnsafe(t),i=0;for(r=0;r<e.length;++r){var o=e[r];if(q(o,Uint8Array)&&(o=s.from(o)),!s.isBuffer(o))throw new TypeError('"list" argument must be an Array of Buffers');o.copy(n,i),i+=o.length}return n},s.byteLength=h,s.prototype._isBuffer=!0,s.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)p(this,t,t+1);return this},s.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)p(this,t,t+3),p(this,t+1,t+2);return this},s.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)p(this,t,t+7),p(this,t+1,t+6),p(this,t+2,t+5),p(this,t+3,t+4);return this},s.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?w(this,0,e):f.apply(this,arguments)},s.prototype.toLocaleString=s.prototype.toString,s.prototype.equals=function(e){if(!s.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===s.compare(this,e)},s.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},s.prototype.compare=function(e,t,r,n,i){if(q(e,Uint8Array)&&(e=s.from(e,e.offset,e.byteLength)),!s.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===t&&(t=0),void 0===r&&(r=e?e.length:0),void 0===n&&(n=0),void 0===i&&(i=this.length),t<0||r>e.length||n<0||i>this.length)throw new RangeError("out of range index");if(n>=i&&t>=r)return 0;if(n>=i)return-1;if(t>=r)return 1;if(this===e)return 0;for(var o=(i>>>=0)-(n>>>=0),a=(r>>>=0)-(t>>>=0),u=Math.min(o,a),c=this.slice(n,i),l=e.slice(t,r),d=0;d<u;++d)if(c[d]!==l[d]){o=c[d],a=l[d];break}return o<a?-1:a<o?1:0},s.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},s.prototype.indexOf=function(e,t,r){return g(this,e,t,r,!0)},s.prototype.lastIndexOf=function(e,t,r){return g(this,e,t,r,!1)},s.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var i=this.length-t;if((void 0===r||r>i)&&(r=i),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var o=!1;;)switch(n){case"hex":return y(this,e,t,r);case"utf8":case"utf-8":return m(this,e,t,r);case"ascii":return _(this,e,t,r);case"latin1":case"binary":return b(this,e,t,r);case"base64":return S(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return k(this,e,t,r);default:if(o)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),o=!0}},s.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var I=4096;function T(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(127&e[i]);return n}function R(e,t,r){var n="";r=Math.min(e.length,r);for(var i=t;i<r;++i)n+=String.fromCharCode(e[i]);return n}function x(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var i="",o=t;o<r;++o)i+=N(e[o]);return i}function C(e,t,r){for(var n=e.slice(t,r),i="",o=0;o<n.length;o+=2)i+=String.fromCharCode(n[o]+256*n[o+1]);return i}function O(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function A(e,t,r,n,i,o){if(!s.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>i||t<o)throw new RangeError('"value" argument is out of bounds');if(r+n>e.length)throw new RangeError("Index out of range")}function D(e,t,r,n,i,o){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function P(e,t,r,i,o){return t=+t,r>>>=0,o||D(e,0,r,4),n.write(e,t,r,i,23,4),r+4}function M(e,t,r,i,o){return t=+t,r>>>=0,o||D(e,0,r,8),n.write(e,t,r,i,52,8),r+8}s.prototype.slice=function(e,t){var r=this.length;(e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e);var n=this.subarray(e,t);return n.__proto__=s.prototype,n},s.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n},s.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);for(var n=this[e+--t],i=1;t>0&&(i*=256);)n+=this[e+--t]*i;return n},s.prototype.readUInt8=function(e,t){return e>>>=0,t||O(e,1,this.length),this[e]},s.prototype.readUInt16LE=function(e,t){return e>>>=0,t||O(e,2,this.length),this[e]|this[e+1]<<8},s.prototype.readUInt16BE=function(e,t){return e>>>=0,t||O(e,2,this.length),this[e]<<8|this[e+1]},s.prototype.readUInt32LE=function(e,t){return e>>>=0,t||O(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},s.prototype.readUInt32BE=function(e,t){return e>>>=0,t||O(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},s.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);for(var n=this[e],i=1,o=0;++o<t&&(i*=256);)n+=this[e+o]*i;return n>=(i*=128)&&(n-=Math.pow(2,8*t)),n},s.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||O(e,t,this.length);for(var n=t,i=1,o=this[e+--n];n>0&&(i*=256);)o+=this[e+--n]*i;return o>=(i*=128)&&(o-=Math.pow(2,8*t)),o},s.prototype.readInt8=function(e,t){return e>>>=0,t||O(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},s.prototype.readInt16LE=function(e,t){e>>>=0,t||O(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt16BE=function(e,t){e>>>=0,t||O(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},s.prototype.readInt32LE=function(e,t){return e>>>=0,t||O(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},s.prototype.readInt32BE=function(e,t){return e>>>=0,t||O(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},s.prototype.readFloatLE=function(e,t){return e>>>=0,t||O(e,4,this.length),n.read(this,e,!0,23,4)},s.prototype.readFloatBE=function(e,t){return e>>>=0,t||O(e,4,this.length),n.read(this,e,!1,23,4)},s.prototype.readDoubleLE=function(e,t){return e>>>=0,t||O(e,8,this.length),n.read(this,e,!0,52,8)},s.prototype.readDoubleBE=function(e,t){return e>>>=0,t||O(e,8,this.length),n.read(this,e,!1,52,8)},s.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var i=1,o=0;for(this[t]=255&e;++o<r&&(i*=256);)this[t+o]=e/i&255;return t+r},s.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var i=r-1,o=1;for(this[t+i]=255&e;--i>=0&&(o*=256);)this[t+i]=e/o&255;return t+r},s.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,255,0),this[t]=255&e,t+1},s.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},s.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);A(this,e,t,r,i-1,-i)}var o=0,s=1,a=0;for(this[t]=255&e;++o<r&&(s*=256);)e<0&&0===a&&0!==this[t+o-1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},s.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var i=Math.pow(2,8*r-1);A(this,e,t,r,i-1,-i)}var o=r-1,s=1,a=0;for(this[t+o]=255&e;--o>=0&&(s*=256);)e<0&&0===a&&0!==this[t+o+1]&&(a=1),this[t+o]=(e/s>>0)-a&255;return t+r},s.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},s.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},s.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},s.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},s.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},s.prototype.writeFloatLE=function(e,t,r){return P(this,e,t,!0,r)},s.prototype.writeFloatBE=function(e,t,r){return P(this,e,t,!1,r)},s.prototype.writeDoubleLE=function(e,t,r){return M(this,e,t,!0,r)},s.prototype.writeDoubleBE=function(e,t,r){return M(this,e,t,!1,r)},s.prototype.copy=function(e,t,r,n){if(!s.isBuffer(e))throw new TypeError("argument should be a Buffer");if(r||(r=0),n||0===n||(n=this.length),t>=e.length&&(t=e.length),t||(t=0),n>0&&n<r&&(n=r),n===r)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(r<0||r>=this.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("sourceEnd out of bounds");n>this.length&&(n=this.length),e.length-t<n-r&&(n=e.length-t+r);var i=n-r;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(t,r,n);else if(this===e&&r<t&&t<n)for(var o=i-1;o>=0;--o)e[o+t]=this[o+r];else Uint8Array.prototype.set.call(e,this.subarray(r,n),t);return i},s.prototype.fill=function(e,t,r,n){if("string"==typeof e){if("string"==typeof t?(n=t,t=0,r=this.length):"string"==typeof r&&(n=r,r=this.length),void 0!==n&&"string"!=typeof n)throw new TypeError("encoding must be a string");if("string"==typeof n&&!s.isEncoding(n))throw new TypeError("Unknown encoding: "+n);if(1===e.length){var i=e.charCodeAt(0);("utf8"===n&&i<128||"latin1"===n)&&(e=i)}}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<r)throw new RangeError("Out of range index");if(r<=t)return this;var o;if(t>>>=0,r=void 0===r?this.length:r>>>0,e||(e=0),"number"==typeof e)for(o=t;o<r;++o)this[o]=e;else{var a=s.isBuffer(e)?e:s.from(e,n),u=a.length;if(0===u)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(o=0;o<r-t;++o)this[o+t]=a[o%u]}return this};var U=/[^+/0-9A-Za-z-_]/g;function N(e){return e<16?"0"+e.toString(16):e.toString(16)}function K(e,t){var r;t=t||1/0;for(var n=e.length,i=null,o=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!i){if(r>56319){(t-=3)>-1&&o.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&o.push(239,191,189);continue}i=r;continue}if(r<56320){(t-=3)>-1&&o.push(239,191,189),i=r;continue}r=65536+(i-55296<<10|r-56320)}else i&&(t-=3)>-1&&o.push(239,191,189);if(i=null,r<128){if((t-=1)<0)break;o.push(r)}else if(r<2048){if((t-=2)<0)break;o.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;o.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;o.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return o}function B(e){return t.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(U,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function L(e,t,r,n){for(var i=0;i<n&&!(i+r>=t.length||i>=e.length);++i)t[i+r]=e[i];return i}function q(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function j(e){return e!=e}}).call(this)}).call(this,e("buffer").Buffer)},{"base64-js":30,buffer:34,ieee754:37}],35:[function(e,t,r){
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var n=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,i=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,o=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,u=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(o.test(t))return t;if(t.length>0&&!i.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}r.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!u.test(r))throw new TypeError("invalid type");var n=r;if(t&&"object"==typeof t)for(var i,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(i=s[a],!o.test(i))throw new TypeError("invalid parameter name");n+="; "+i+"="+c(t[i])}return n},r.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var r=t.indexOf(";"),i=-1!==r?t.substr(0,r).trim():t.trim();if(!u.test(i))throw new TypeError("invalid media type");var o=new l(i.toLowerCase());if(-1!==r){var a,c,d;for(n.lastIndex=r;c=n.exec(t);){if(c.index!==r)throw new TypeError("invalid parameter format");r+=c[0].length,a=c[1].toLowerCase(),'"'===(d=c[2])[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),o.parameters[a]=d}if(r!==t.length)throw new TypeError("invalid parameter format")}return o}},{}],36:[function(e,t,r){"use strict";var n,i="object"==typeof Reflect?Reflect:null,o=i&&"function"==typeof i.apply?i.apply:function(e,t,r){return Function.prototype.apply.call(e,t,r)};n=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var s=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}t.exports=a,t.exports.once=function(e,t){return new Promise((function(r,n){function i(){void 0!==o&&e.removeListener("error",o),r([].slice.call(arguments))}var o;"error"!==t&&(o=function(r){e.removeListener(t,i),n(r)},e.once("error",o)),e.once(t,i)}))},a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var u=10;function c(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function l(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,r,n){var i,o,s,a;if(c(r),void 0===(o=e._events)?(o=e._events=Object.create(null),e._eventsCount=0):(void 0!==o.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),o=e._events),s=o[t]),void 0===s)s=o[t]=r,++e._eventsCount;else if("function"==typeof s?s=o[t]=n?[r,s]:[s,r]:n?s.unshift(r):s.push(r),(i=l(e))>0&&s.length>i&&!s.warned){s.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+s.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=s.length,a=u,console&&console.warn&&console.warn(a)}return e}function h(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function f(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},i=h.bind(n);return i.listener=r,n.wrapFn=i,i}function p(e,t,r){var n=e._events;if(void 0===n)return[];var i=n[t];return void 0===i?[]:"function"==typeof i?r?[i.listener||i]:[i]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(i):v(i,i.length)}function g(e){var t=this._events;if(void 0!==t){var r=t[e];if("function"==typeof r)return 1;if(void 0!==r)return r.length}return 0}function v(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");u=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||s(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return l(this)},a.prototype.emit=function(e){for(var t=[],r=1;r<arguments.length;r++)t.push(arguments[r]);var n="error"===e,i=this._events;if(void 0!==i)n=n&&void 0===i.error;else if(!n)return!1;if(n){var s;if(t.length>0&&(s=t[0]),s instanceof Error)throw s;var a=new Error("Unhandled error."+(s?" ("+s.message+")":""));throw a.context=s,a}var u=i[e];if(void 0===u)return!1;if("function"==typeof u)o(u,this,t);else{var c=u.length,l=v(u,c);for(r=0;r<c;++r)o(l[r],this,t)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){return c(t),this.on(e,f(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return c(t),this.prependListener(e,f(this,e,t)),this},a.prototype.removeListener=function(e,t){var r,n,i,o,s;if(c(t),void 0===(n=this._events))return this;if(void 0===(r=n[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete n[e],n.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,o=r.length-1;o>=0;o--)if(r[o]===t||r[o].listener===t){s=r[o].listener,i=o;break}if(i<0)return this;0===i?r.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(r,i),1===r.length&&(n[e]=r[0]),void 0!==n.removeListener&&this.emit("removeListener",e,s||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,r,n;if(void 0===(r=this._events))return this;if(void 0===r.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==r[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete r[e]),this;if(0===arguments.length){var i,o=Object.keys(r);for(n=0;n<o.length;++n)"removeListener"!==(i=o[n])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(void 0!==t)for(n=t.length-1;n>=0;n--)this.removeListener(e,t[n]);return this},a.prototype.listeners=function(e){return p(this,e,!0)},a.prototype.rawListeners=function(e){return p(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):g.call(e,t)},a.prototype.listenerCount=g,a.prototype.eventNames=function(){return this._eventsCount>0?n(this._events):[]}},{}],37:[function(e,t,r){
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
r.read=function(e,t,r,n,i){var o,s,a=8*i-n-1,u=(1<<a)-1,c=u>>1,l=-7,d=r?i-1:0,h=r?-1:1,f=e[t+d];for(d+=h,o=f&(1<<-l)-1,f>>=-l,l+=a;l>0;o=256*o+e[t+d],d+=h,l-=8);for(s=o&(1<<-l)-1,o>>=-l,l+=n;l>0;s=256*s+e[t+d],d+=h,l-=8);if(0===o)o=1-c;else{if(o===u)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,n),o-=c}return(f?-1:1)*s*Math.pow(2,o-n)},r.write=function(e,t,r,n,i,o){var s,a,u,c=8*o-i-1,l=(1<<c)-1,d=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,f=n?0:o-1,p=n?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+d>=1?h/u:h*Math.pow(2,1-d))*u>=2&&(s++,u/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*u-1)*Math.pow(2,i),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,i),s=0));i>=8;e[r+f]=255&a,f+=p,a/=256,i-=8);for(s=s<<i|a,c+=i;c>0;e[r+f]=255&s,f+=p,s/=256,c-=8);e[r+f-p]|=128*g}},{}],38:[function(e,t,r){!function(e,r){"use strict";"function"==typeof define&&define.amd?define(r):"object"==typeof t&&t.exports?t.exports=r():e.log=r()}(this,(function(){"use strict";var e=function(){},t="undefined",r=typeof window!==t&&typeof window.navigator!==t&&/Trident\/|MSIE /.test(window.navigator.userAgent),n=["trace","debug","info","warn","error"];function i(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function o(){console.log&&(console.log.apply?console.log.apply(console,arguments):Function.prototype.apply.apply(console.log,[console,arguments])),console.trace&&console.trace()}function s(n){return"debug"===n&&(n="log"),typeof console!==t&&("trace"===n&&r?o:void 0!==console[n]?i(console,n):void 0!==console.log?i(console,"log"):e)}function a(t,r){for(var i=0;i<n.length;i++){var o=n[i];this[o]=i<t?e:this.methodFactory(o,t,r)}this.log=this.debug}function u(e,r,n){return function(){typeof console!==t&&(a.call(this,r,n),this[e].apply(this,arguments))}}function c(e,t,r){return s(e)||u.apply(this,arguments)}function l(e,r,i){var o,s=this,u="loglevel";function l(){var e;if(typeof window!==t&&u){try{e=window.localStorage[u]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(u)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===s.levels[e]&&(e=void 0),e}}"string"==typeof e?u+=":"+e:"symbol"==typeof e&&(u=void 0),s.name=e,s.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},s.methodFactory=i||c,s.getLevel=function(){return o},s.setLevel=function(r,i){if("string"==typeof r&&void 0!==s.levels[r.toUpperCase()]&&(r=s.levels[r.toUpperCase()]),!("number"==typeof r&&r>=0&&r<=s.levels.SILENT))throw"log.setLevel() called with invalid level: "+r;if(o=r,!1!==i&&function(e){var r=(n[e]||"silent").toUpperCase();if(typeof window!==t&&u){try{return void(window.localStorage[u]=r)}catch(e){}try{window.document.cookie=encodeURIComponent(u)+"="+r+";"}catch(e){}}}(r),a.call(s,r,e),typeof console===t&&r<s.levels.SILENT)return"No console available for logging"},s.setDefaultLevel=function(e){l()||s.setLevel(e,!1)},s.enableAll=function(e){s.setLevel(s.levels.TRACE,e)},s.disableAll=function(e){s.setLevel(s.levels.SILENT,e)};var d=l();null==d&&(d=null==r?"WARN":r),s.setLevel(d,!1)}var d=new l,h={};d.getLogger=function(e){if("symbol"!=typeof e&&"string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=h[e];return t||(t=h[e]=new l(e,d.getLevel(),d.methodFactory)),t};var f=typeof window!==t?window.log:void 0;return d.noConflict=function(){return typeof window!==t&&window.log===d&&(window.log=f),d},d.getLoggers=function(){return h},d.default=d,d}))},{}],39:[function(e,t,r){var n,i,o=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(e){n=s}try{i="function"==typeof clearTimeout?clearTimeout:a}catch(e){i=a}}();var c,l=[],d=!1,h=-1;function f(){d&&c&&(d=!1,c.length?l=c.concat(l):h=-1,l.length&&p())}function p(){if(!d){var e=u(f);d=!0;for(var t=l.length;t;){for(c=l,l=[];++h<t;)c&&c[h].run();h=-1,t=l.length}c=null,d=!1,function(e){if(i===clearTimeout)return clearTimeout(e);if((i===a||!i)&&clearTimeout)return i=clearTimeout,clearTimeout(e);try{i(e)}catch(t){try{return i.call(null,e)}catch(t){return i.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function v(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];l.push(new g(e,t)),1!==l.length||d||u(p)},g.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=v,o.addListener=v,o.once=v,o.off=v,o.removeListener=v,o.removeAllListeners=v,o.emit=v,o.prependListener=v,o.prependOnceListener=v,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},{}],40:[function(e,t,r){"use strict";var n=String.prototype.replace,i=/%20/g,o="RFC1738",s="RFC3986";t.exports={default:s,formatters:{RFC1738:function(e){return n.call(e,i,"+")},RFC3986:function(e){return String(e)}},RFC1738:o,RFC3986:s}},{}],41:[function(e,t,r){"use strict";var n=e("./stringify"),i=e("./parse"),o=e("./formats");t.exports={formats:o,parse:i,stringify:n}},{"./formats":40,"./parse":42,"./stringify":43}],42:[function(e,t,r){"use strict";var n=e("./utils"),i=Object.prototype.hasOwnProperty,o=Array.isArray,s={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:n.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},a=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},u=function(e,t){return e&&"string"==typeof e&&t.comma&&e.indexOf(",")>-1?e.split(","):e},c=function(e,t,r,n){if(e){var o=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,s=/(\[[^[\]]*])/g,a=r.depth>0&&/(\[[^[\]]*])/.exec(o),c=a?o.slice(0,a.index):o,l=[];if(c){if(!r.plainObjects&&i.call(Object.prototype,c)&&!r.allowPrototypes)return;l.push(c)}for(var d=0;r.depth>0&&null!==(a=s.exec(o))&&d<r.depth;){if(d+=1,!r.plainObjects&&i.call(Object.prototype,a[1].slice(1,-1))&&!r.allowPrototypes)return;l.push(a[1])}return a&&l.push("["+o.slice(a.index)+"]"),function(e,t,r,n){for(var i=n?t:u(t,r),o=e.length-1;o>=0;--o){var s,a=e[o];if("[]"===a&&r.parseArrays)s=[].concat(i);else{s=r.plainObjects?Object.create(null):{};var c="["===a.charAt(0)&&"]"===a.charAt(a.length-1)?a.slice(1,-1):a,l=parseInt(c,10);r.parseArrays||""!==c?!isNaN(l)&&a!==c&&String(l)===c&&l>=0&&r.parseArrays&&l<=r.arrayLimit?(s=[])[l]=i:s[c]=i:s={0:i}}i=s}return i}(l,t,r,n)}};t.exports=function(e,t){var r=function(e){if(!e)return s;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?s.charset:e.charset;return{allowDots:void 0===e.allowDots?s.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:s.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:s.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:s.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:s.comma,decoder:"function"==typeof e.decoder?e.decoder:s.decoder,delimiter:"string"==typeof e.delimiter||n.isRegExp(e.delimiter)?e.delimiter:s.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:s.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:s.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:s.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:s.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:s.strictNullHandling}}(t);if(""===e||null==e)return r.plainObjects?Object.create(null):{};for(var l="string"==typeof e?function(e,t){var r,c={},l=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,d=t.parameterLimit===1/0?void 0:t.parameterLimit,h=l.split(t.delimiter,d),f=-1,p=t.charset;if(t.charsetSentinel)for(r=0;r<h.length;++r)0===h[r].indexOf("utf8=")&&("utf8=%E2%9C%93"===h[r]?p="utf-8":"utf8=%26%2310003%3B"===h[r]&&(p="iso-8859-1"),f=r,r=h.length);for(r=0;r<h.length;++r)if(r!==f){var g,v,y=h[r],m=y.indexOf("]="),_=-1===m?y.indexOf("="):m+1;-1===_?(g=t.decoder(y,s.decoder,p,"key"),v=t.strictNullHandling?null:""):(g=t.decoder(y.slice(0,_),s.decoder,p,"key"),v=n.maybeMap(u(y.slice(_+1),t),(function(e){return t.decoder(e,s.decoder,p,"value")}))),v&&t.interpretNumericEntities&&"iso-8859-1"===p&&(v=a(v)),y.indexOf("[]=")>-1&&(v=o(v)?[v]:v),i.call(c,g)?c[g]=n.combine(c[g],v):c[g]=v}return c}(e,r):e,d=r.plainObjects?Object.create(null):{},h=Object.keys(l),f=0;f<h.length;++f){var p=h[f],g=c(p,l[p],r,"string"==typeof e);d=n.merge(d,g,r)}return n.compact(d)}},{"./utils":44}],43:[function(e,t,r){"use strict";var n=e("./utils"),i=e("./formats"),o=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,u=Array.prototype.push,c=function(e,t){u.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,d=i.default,h={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:n.encode,encodeValuesOnly:!1,format:d,formatter:i.formatters[d],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},f=function e(t,r,i,o,s,u,l,d,f,p,g,v,y,m){var _,b=t;if("function"==typeof l?b=l(r,b):b instanceof Date?b=p(b):"comma"===i&&a(b)&&(b=n.maybeMap(b,(function(e){return e instanceof Date?p(e):e}))),null===b){if(o)return u&&!y?u(r,h.encoder,m,"key",g):r;b=""}if("string"==typeof(_=b)||"number"==typeof _||"boolean"==typeof _||"symbol"==typeof _||"bigint"==typeof _||n.isBuffer(b))return u?[v(y?r:u(r,h.encoder,m,"key",g))+"="+v(u(b,h.encoder,m,"value",g))]:[v(r)+"="+v(String(b))];var S,k=[];if(void 0===b)return k;if("comma"===i&&a(b))S=[{value:b.length>0?b.join(",")||null:void 0}];else if(a(l))S=l;else{var E=Object.keys(b);S=d?E.sort(d):E}for(var w=0;w<S.length;++w){var I=S[w],T="object"==typeof I&&void 0!==I.value?I.value:b[I];if(!s||null!==T){var R=a(b)?"function"==typeof i?i(r,I):r:r+(f?"."+I:"["+I+"]");c(k,e(T,R,i,o,s,u,l,d,f,p,g,v,y,m))}}return k};t.exports=function(e,t){var r,n=e,u=function(e){if(!e)return h;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||h.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=i.default;if(void 0!==e.format){if(!o.call(i.formatters,e.format))throw new TypeError("Unknown format option provided.");r=e.format}var n=i.formatters[r],s=h.filter;return("function"==typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:h.addQueryPrefix,allowDots:void 0===e.allowDots?h.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:h.charsetSentinel,delimiter:void 0===e.delimiter?h.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:h.encode,encoder:"function"==typeof e.encoder?e.encoder:h.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:h.encodeValuesOnly,filter:s,format:r,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:h.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:h.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:h.strictNullHandling}}(t);"function"==typeof u.filter?n=(0,u.filter)("",n):a(u.filter)&&(r=u.filter);var l,d=[];if("object"!=typeof n||null===n)return"";l=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var p=s[l];r||(r=Object.keys(n)),u.sort&&r.sort(u.sort);for(var g=0;g<r.length;++g){var v=r[g];u.skipNulls&&null===n[v]||c(d,f(n[v],v,p,u.strictNullHandling,u.skipNulls,u.encode?u.encoder:null,u.filter,u.sort,u.allowDots,u.serializeDate,u.format,u.formatter,u.encodeValuesOnly,u.charset))}var y=d.join(u.delimiter),m=!0===u.addQueryPrefix?"?":"";return u.charsetSentinel&&("iso-8859-1"===u.charset?m+="utf8=%26%2310003%3B&":m+="utf8=%E2%9C%93&"),y.length>0?m+y:""}},{"./formats":40,"./utils":44}],44:[function(e,t,r){"use strict";var n=e("./formats"),i=Object.prototype.hasOwnProperty,o=Array.isArray,s=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),a=function(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},n=0;n<e.length;++n)void 0!==e[n]&&(r[n]=e[n]);return r};t.exports={arrayToObject:a,assign:function(e,t){return Object.keys(t).reduce((function(e,r){return e[r]=t[r],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],n=0;n<t.length;++n)for(var i=t[n],s=i.obj[i.prop],a=Object.keys(s),u=0;u<a.length;++u){var c=a[u],l=s[c];"object"==typeof l&&null!==l&&-1===r.indexOf(l)&&(t.push({obj:s,prop:c}),r.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),r=t.obj[t.prop];if(o(r)){for(var n=[],i=0;i<r.length;++i)void 0!==r[i]&&n.push(r[i]);t.obj[t.prop]=n}}}(t),e},decode:function(e,t,r){var n=e.replace(/\+/g," ");if("iso-8859-1"===r)return n.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(n)}catch(e){return n}},encode:function(e,t,r,i,o){if(0===e.length)return e;var a=e;if("symbol"==typeof e?a=Symbol.prototype.toString.call(e):"string"!=typeof e&&(a=String(e)),"iso-8859-1"===r)return escape(a).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var u="",c=0;c<a.length;++c){var l=a.charCodeAt(c);45===l||46===l||95===l||126===l||l>=48&&l<=57||l>=65&&l<=90||l>=97&&l<=122||o===n.RFC1738&&(40===l||41===l)?u+=a.charAt(c):l<128?u+=s[l]:l<2048?u+=s[192|l>>6]+s[128|63&l]:l<55296||l>=57344?u+=s[224|l>>12]+s[128|l>>6&63]+s[128|63&l]:(c+=1,l=65536+((1023&l)<<10|1023&a.charCodeAt(c)),u+=s[240|l>>18]+s[128|l>>12&63]+s[128|l>>6&63]+s[128|63&l])}return u},isBuffer:function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},maybeMap:function(e,t){if(o(e)){for(var r=[],n=0;n<e.length;n+=1)r.push(t(e[n]));return r}return t(e)},merge:function e(t,r,n){if(!r)return t;if("object"!=typeof r){if(o(t))t.push(r);else{if(!t||"object"!=typeof t)return[t,r];(n&&(n.plainObjects||n.allowPrototypes)||!i.call(Object.prototype,r))&&(t[r]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(r);var s=t;return o(t)&&!o(r)&&(s=a(t,n)),o(t)&&o(r)?(r.forEach((function(r,o){if(i.call(t,o)){var s=t[o];s&&"object"==typeof s&&r&&"object"==typeof r?t[o]=e(s,r,n):t.push(r)}else t[o]=r})),t):Object.keys(r).reduce((function(t,o){var s=r[o];return i.call(t,o)?t[o]=e(t[o],s,n):t[o]=s,t}),s)}}},{"./formats":40}],45:[function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,r,o){t=t||"&",r=r||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var u=1e3;o&&"number"==typeof o.maxKeys&&(u=o.maxKeys);var c=e.length;u>0&&c>u&&(c=u);for(var l=0;l<c;++l){var d,h,f,p,g=e[l].replace(a,"%20"),v=g.indexOf(r);v>=0?(d=g.substr(0,v),h=g.substr(v+1)):(d=g,h=""),f=decodeURIComponent(d),p=decodeURIComponent(h),n(s,f)?i(s[f])?s[f].push(p):s[f]=[s[f],p]:s[f]=p}return s};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],46:[function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?o(s(e),(function(s){var a=encodeURIComponent(n(s))+r;return i(e[s])?o(e[s],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[s]))})).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function o(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var s=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},{}],47:[function(e,t,r){"use strict";r.decode=r.parse=e("./decode"),r.encode=r.stringify=e("./encode")},{"./decode":45,"./encode":46}],48:[function(e,t,r){var n=function(e){"use strict";var t,r=Object.prototype,n=r.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},o=i.iterator||"@@iterator",s=i.asyncIterator||"@@asyncIterator",a=i.toStringTag||"@@toStringTag";function u(e,t,r){return Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{u({},"")}catch(e){u=function(e,t,r){return e[t]=r}}function c(e,t,r,n){var i=t&&t.prototype instanceof v?t:v,o=Object.create(i.prototype),s=new x(n||[]);return o._invoke=function(e,t,r){var n=d;return function(i,o){if(n===f)throw new Error("Generator is already running");if(n===p){if("throw"===i)throw o;return O()}for(r.method=i,r.arg=o;;){var s=r.delegate;if(s){var a=I(s,r);if(a){if(a===g)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=p,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=f;var u=l(e,t,r);if("normal"===u.type){if(n=r.done?p:h,u.arg===g)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=p,r.method="throw",r.arg=u.arg)}}}(e,r,s),o}function l(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}e.wrap=c;var d="suspendedStart",h="suspendedYield",f="executing",p="completed",g={};function v(){}function y(){}function m(){}var _={};_[o]=function(){return this};var b=Object.getPrototypeOf,S=b&&b(b(C([])));S&&S!==r&&n.call(S,o)&&(_=S);var k=m.prototype=v.prototype=Object.create(_);function E(e){["next","throw","return"].forEach((function(t){u(e,t,(function(e){return this._invoke(t,e)}))}))}function w(e,t){function r(i,o,s,a){var u=l(e[i],e,o);if("throw"!==u.type){var c=u.arg,d=c.value;return d&&"object"==typeof d&&n.call(d,"__await")?t.resolve(d.__await).then((function(e){r("next",e,s,a)}),(function(e){r("throw",e,s,a)})):t.resolve(d).then((function(e){c.value=e,s(c)}),(function(e){return r("throw",e,s,a)}))}a(u.arg)}var i;this._invoke=function(e,n){function o(){return new t((function(t,i){r(e,n,t,i)}))}return i=i?i.then(o,o):o()}}function I(e,r){var n=e.iterator[r.method];if(n===t){if(r.delegate=null,"throw"===r.method){if(e.iterator.return&&(r.method="return",r.arg=t,I(e,r),"throw"===r.method))return g;r.method="throw",r.arg=new TypeError("The iterator does not provide a 'throw' method")}return g}var i=l(n,e.iterator,r.arg);if("throw"===i.type)return r.method="throw",r.arg=i.arg,r.delegate=null,g;var o=i.arg;return o?o.done?(r[e.resultName]=o.value,r.next=e.nextLoc,"return"!==r.method&&(r.method="next",r.arg=t),r.delegate=null,g):o:(r.method="throw",r.arg=new TypeError("iterator result is not an object"),r.delegate=null,g)}function T(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function R(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function x(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(T,this),this.reset(!0)}function C(e){if(e){var r=e[o];if(r)return r.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,s=function r(){for(;++i<e.length;)if(n.call(e,i))return r.value=e[i],r.done=!1,r;return r.value=t,r.done=!0,r};return s.next=s}}return{next:O}}function O(){return{value:t,done:!0}}return y.prototype=k.constructor=m,m.constructor=y,y.displayName=u(m,a,"GeneratorFunction"),e.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===y||"GeneratorFunction"===(t.displayName||t.name))},e.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,m):(e.__proto__=m,u(e,a,"GeneratorFunction")),e.prototype=Object.create(k),e},e.awrap=function(e){return{__await:e}},E(w.prototype),w.prototype[s]=function(){return this},e.AsyncIterator=w,e.async=function(t,r,n,i,o){void 0===o&&(o=Promise);var s=new w(c(t,r,n,i),o);return e.isGeneratorFunction(r)?s:s.next().then((function(e){return e.done?e.value:s.next()}))},E(k),u(k,a,"Generator"),k[o]=function(){return this},k.toString=function(){return"[object Generator]"},e.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},e.values=C,x.prototype={constructor:x,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(R),!e)for(var r in this)"t"===r.charAt(0)&&n.call(this,r)&&!isNaN(+r.slice(1))&&(this[r]=t)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var r=this;function i(n,i){return a.type="throw",a.arg=e,r.next=n,i&&(r.method="next",r.arg=t),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var s=this.tryEntries[o],a=s.completion;if("root"===s.tryLoc)return i("end");if(s.tryLoc<=this.prev){var u=n.call(s,"catchLoc"),c=n.call(s,"finallyLoc");if(u&&c){if(this.prev<s.catchLoc)return i(s.catchLoc,!0);if(this.prev<s.finallyLoc)return i(s.finallyLoc)}else if(u){if(this.prev<s.catchLoc)return i(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return i(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var i=this.tryEntries[r];if(i.tryLoc<=this.prev&&n.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var s=o?o.completion:{};return s.type=e,s.arg=t,o?(this.method="next",this.next=o.finallyLoc,g):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),g},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),R(r),g}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var i=n.arg;R(r)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,r,n){return this.delegate={iterator:C(e),resultName:r,nextLoc:n},"next"===this.method&&(this.arg=t),g}},e}("object"==typeof t?t.exports:{});try{regeneratorRuntime=n}catch(e){Function("r","regeneratorRuntime = r")(n)}},{}],49:[function(e,t,r){
/*! safe-buffer. MIT License. Feross Aboukhadijeh <https://feross.org/opensource> */
var n=e("buffer"),i=n.Buffer;function o(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return i(e,t,r)}i.from&&i.alloc&&i.allocUnsafe&&i.allocUnsafeSlow?t.exports=n:(o(n,r),r.Buffer=s),s.prototype=Object.create(i.prototype),o(i,s),s.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return i(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=i(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return i(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:34}],50:[function(e,t,r){t.exports={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"b","":"b","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"'''","":"'''","":"''''","":"'B","":"'D","":"'n","":"'P","":"'T","":"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(w)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"$","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b'","":"bl","":"","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"C","":"c","":"c","":"C","":"C","":"C'","":"c/o","":"c/u","":"\t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G'","":"","":"","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"K","":"K","":"K","":"K","":"K","":"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"llS","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"o","":"O,","":"O.","":"o'","":"O'","":"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r'","":"rn",m:"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"u","":"U","":"U","":"U","":"U'","":"ue","":"uo","":"","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"w","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"w","":"w","":"W","":"w","":"","":"","":"","":"","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"/","":"","":"","":"","":"","":"","":"'","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"b","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"b","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}},{}],51:[function(e,t,r){"use strict";var n=e("./data.json");var i=RegExp(Object.keys(n).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function o(e){return n[e]}t.exports=function(e){return e.replace(i,o)}},{"./data.json":50}],52:[function(e,t,r){"use strict";var n=e("punycode"),i=e("./util");function o(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}r.parse=_,r.resolve=function(e,t){return _(e,!1,!0).resolve(t)},r.resolveObject=function(e,t){return e?_(e,!1,!0).resolveObject(t):t},r.format=function(e){i.isString(e)&&(e=_(e));return e instanceof o?e.format():o.prototype.format.call(e)},r.Url=o;var s=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,u=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(c),d=["%","/","?",";","#"].concat(l),h=["/","?","#"],f=/^[+a-z0-9A-Z_-]{0,63}$/,p=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,g={javascript:!0,"javascript:":!0},v={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},m=e("querystring");function _(e,t,r){if(e&&i.isObject(e)&&e instanceof o)return e;var n=new o;return n.parse(e,t,r),n}o.prototype.parse=function(e,t,r){if(!i.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var o=e.indexOf("?"),a=-1!==o&&o<e.indexOf("#")?"?":"#",c=e.split(a);c[0]=c[0].replace(/\\/g,"/");var _=e=c.join(a);if(_=_.trim(),!r&&1===e.split("#").length){var b=u.exec(_);if(b)return this.path=_,this.href=_,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?m.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var S=s.exec(_);if(S){var k=(S=S[0]).toLowerCase();this.protocol=k,_=_.substr(S.length)}if(r||S||_.match(/^\/\/[^@\/]+@[^@\/]+/)){var E="//"===_.substr(0,2);!E||S&&v[S]||(_=_.substr(2),this.slashes=!0)}if(!v[S]&&(E||S&&!y[S])){for(var w,I,T=-1,R=0;R<h.length;R++){-1!==(x=_.indexOf(h[R]))&&(-1===T||x<T)&&(T=x)}-1!==(I=-1===T?_.lastIndexOf("@"):_.lastIndexOf("@",T))&&(w=_.slice(0,I),_=_.slice(I+1),this.auth=decodeURIComponent(w)),T=-1;for(R=0;R<d.length;R++){var x;-1!==(x=_.indexOf(d[R]))&&(-1===T||x<T)&&(T=x)}-1===T&&(T=_.length),this.host=_.slice(0,T),_=_.slice(T),this.parseHost(),this.hostname=this.hostname||"";var C="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!C)for(var O=this.hostname.split(/\./),A=(R=0,O.length);R<A;R++){var D=O[R];if(D&&!D.match(f)){for(var P="",M=0,U=D.length;M<U;M++)D.charCodeAt(M)>127?P+="x":P+=D[M];if(!P.match(f)){var N=O.slice(0,R),K=O.slice(R+1),B=D.match(p);B&&(N.push(B[1]),K.unshift(B[2])),K.length&&(_="/"+K.join(".")+_),this.hostname=N.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),C||(this.hostname=n.toASCII(this.hostname));var L=this.port?":"+this.port:"",q=this.hostname||"";this.host=q+L,this.href+=this.host,C&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==_[0]&&(_="/"+_))}if(!g[k])for(R=0,A=l.length;R<A;R++){var j=l[R];if(-1!==_.indexOf(j)){var F=encodeURIComponent(j);F===j&&(F=escape(j)),_=_.split(j).join(F)}}var G=_.indexOf("#");-1!==G&&(this.hash=_.substr(G),_=_.slice(0,G));var V=_.indexOf("?");if(-1!==V?(this.search=_.substr(V),this.query=_.substr(V+1),t&&(this.query=m.parse(this.query)),_=_.slice(0,V)):t&&(this.search="",this.query={}),_&&(this.pathname=_),y[k]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){L=this.pathname||"";var $=this.search||"";this.path=L+$}return this.href=this.format(),this},o.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",o=!1,s="";this.host?o=e+this.host:this.hostname&&(o=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(o+=":"+this.port)),this.query&&i.isObject(this.query)&&Object.keys(this.query).length&&(s=m.stringify(this.query));var a=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||y[t])&&!1!==o?(o="//"+(o||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):o||(o=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+o+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},o.prototype.resolve=function(e){return this.resolveObject(_(e,!1,!0)).format()},o.prototype.resolveObject=function(e){if(i.isString(e)){var t=new o;t.parse(e,!1,!0),e=t}for(var r=new o,n=Object.keys(this),s=0;s<n.length;s++){var a=n[s];r[a]=this[a]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var u=Object.keys(e),c=0;c<u.length;c++){var l=u[c];"protocol"!==l&&(r[l]=e[l])}return y[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!y[e.protocol]){for(var d=Object.keys(e),h=0;h<d.length;h++){var f=d[h];r[f]=e[f]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||v[e.protocol])r.pathname=e.pathname;else{for(var p=(e.pathname||"").split("/");p.length&&!(e.host=p.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==p[0]&&p.unshift(""),p.length<2&&p.unshift(""),r.pathname=p.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var g=r.pathname||"",m=r.search||"";r.path=g+m}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var _=r.pathname&&"/"===r.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),S=b||_||r.host&&e.pathname,k=S,E=r.pathname&&r.pathname.split("/")||[],w=(p=e.pathname&&e.pathname.split("/")||[],r.protocol&&!y[r.protocol]);if(w&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===p[0]?p[0]=e.host:p.unshift(e.host)),e.host=null),S=S&&(""===p[0]||""===E[0])),b)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,E=p;else if(p.length)E||(E=[]),E.pop(),E=E.concat(p),r.search=e.search,r.query=e.query;else if(!i.isNullOrUndefined(e.search)){if(w)r.hostname=r.host=E.shift(),(C=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=C.shift(),r.host=r.hostname=C.shift());return r.search=e.search,r.query=e.query,i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var I=E.slice(-1)[0],T=(r.host||e.host||E.length>1)&&("."===I||".."===I)||""===I,R=0,x=E.length;x>=0;x--)"."===(I=E[x])?E.splice(x,1):".."===I?(E.splice(x,1),R++):R&&(E.splice(x,1),R--);if(!S&&!k)for(;R--;R)E.unshift("..");!S||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),T&&"/"!==E.join("/").substr(-1)&&E.push("");var C,O=""===E[0]||E[0]&&"/"===E[0].charAt(0);w&&(r.hostname=r.host=O?"":E.length?E.shift():"",(C=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=C.shift(),r.host=r.hostname=C.shift()));return(S=S||r.host&&E.length)&&!O&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),i.isNull(r.pathname)&&i.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},o.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":53,punycode:32,querystring:47}],53:[function(e,t,r){"use strict";t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}],54:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.UNSTABLE_MSC3089_BRANCH=r.UNSTABLE_MSC3089_LEAF=r.UNSTABLE_MSC3089_TREE_SUBTYPE=r.UNSTABLE_MSC3088_ENABLED=r.UNSTABLE_MSC3088_PURPOSE=r.RoomType=r.RoomCreateTypeField=r.MsgType=r.EventType=void 0;const n=e("../NamespacedValue");!function(e){e.RoomCanonicalAlias="m.room.canonical_alias",e.RoomCreate="m.room.create",e.RoomJoinRules="m.room.join_rules",e.RoomMember="m.room.member",e.RoomThirdPartyInvite="m.room.third_party_invite",e.RoomPowerLevels="m.room.power_levels",e.RoomName="m.room.name",e.RoomTopic="m.room.topic",e.RoomAvatar="m.room.avatar",e.RoomPinnedEvents="m.room.pinned_events",e.RoomEncryption="m.room.encryption",e.RoomHistoryVisibility="m.room.history_visibility",e.RoomGuestAccess="m.room.guest_access",e.RoomServerAcl="m.room.server_acl",e.RoomTombstone="m.room.tombstone",e.RoomAliases="m.room.aliases",e.SpaceChild="m.space.child",e.SpaceParent="m.space.parent",e.RoomRedaction="m.room.redaction",e.RoomMessage="m.room.message",e.RoomMessageEncrypted="m.room.encrypted",e.Sticker="m.sticker",e.CallInvite="m.call.invite",e.CallCandidates="m.call.candidates",e.CallAnswer="m.call.answer",e.CallHangup="m.call.hangup",e.CallReject="m.call.reject",e.CallSelectAnswer="m.call.select_answer",e.CallNegotiate="m.call.negotiate",e.CallReplaces="m.call.replaces",e.CallAssertedIdentity="m.call.asserted_identity",e.CallAssertedIdentityPrefix="org.matrix.call.asserted_identity",e.KeyVerificationRequest="m.key.verification.request",e.KeyVerificationStart="m.key.verification.start",e.KeyVerificationCancel="m.key.verification.cancel",e.KeyVerificationMac="m.key.verification.mac",e.KeyVerificationDone="m.key.verification.done",e.RoomMessageFeedback="m.room.message.feedback",e.Reaction="m.reaction",e.Typing="m.typing",e.Receipt="m.receipt",e.Presence="m.presence",e.FullyRead="m.fully_read",e.Tag="m.tag",e.SpaceOrder="org.matrix.msc3230.space_order",e.PushRules="m.push_rules",e.Direct="m.direct",e.IgnoredUserList="m.ignored_user_list",e.RoomKey="m.room_key",e.RoomKeyRequest="m.room_key_request",e.ForwardedRoomKey="m.forwarded_room_key",e.Dummy="m.dummy"}(r.EventType||(r.EventType={})),function(e){e.Text="m.text",e.Emote="m.emote",e.Notice="m.notice",e.Image="m.image",e.File="m.file",e.Audio="m.audio",e.Location="m.location",e.Video="m.video"}(r.MsgType||(r.MsgType={})),r.RoomCreateTypeField="type",function(e){e.Space="m.space"}(r.RoomType||(r.RoomType={})),r.UNSTABLE_MSC3088_PURPOSE=new n.UnstableValue("m.room.purpose","org.matrix.msc3088.purpose"),r.UNSTABLE_MSC3088_ENABLED=new n.UnstableValue("m.enabled","org.matrix.msc3088.enabled"),r.UNSTABLE_MSC3089_TREE_SUBTYPE=new n.UnstableValue("m.data_tree","org.matrix.msc3089.data_tree"),r.UNSTABLE_MSC3089_LEAF=new n.UnstableValue("m.leaf","org.matrix.msc3089.leaf"),r.UNSTABLE_MSC3089_BRANCH=new n.UnstableValue("m.branch","org.matrix.msc3089.branch")},{"../NamespacedValue":56}],55:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Preset=r.Visibility=void 0,function(e){e.Public="public",e.Private="private"}(r.Visibility||(r.Visibility={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(r.Preset||(r.Preset={}))},{}],56:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.UnstableValue=r.NamespacedValue=void 0;class n{constructor(e,t){if(this.stable=e,this.unstable=t,!this.unstable&&!this.stable)throw new Error("One of stable or unstable values must be supplied")}get name(){return this.stable?this.stable:this.unstable}get altName(){return this.stable?this.unstable:null}matches(e){return this.name===e||this.altName===e}findIn(e){let t;return this.name&&(t=null==e?void 0:e[this.name]),!t&&this.altName&&(t=null==e?void 0:e[this.altName]),t}includedIn(e){let t=!1;return this.name&&(t=e.includes(this.name)),!t&&this.altName&&(t=e.includes(this.altName)),t}}r.NamespacedValue=n;r.UnstableValue=class extends n{constructor(e,t){if(super(e,t),!this.unstable)throw new Error("Unstable value must be supplied")}get name(){return this.unstable}get altName(){return this.stable}}},{}],57:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ReEmitter=void 0;r.ReEmitter=class{constructor(e){this.target=e}reEmit(e,t){for(const r of t){const t=(...t)=>{"error"===r&&0===this.target.listenerCount("error")||this.target.emit(r,...t,e)};e.on(r,t)}}}},{}],58:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.AutoDiscovery=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/asyncToGenerator")),s=n(e("@babel/runtime/helpers/createClass")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=e("./logger"),c=e("url"),l=function(){function t(){(0,a.default)(this,t)}var r,n,l,d;return(0,s.default)(t,null,[{key:"fromDiscoveryConfig",value:(d=(0,o.default)(i.default.mark((function e(r){var n,o,s,a,c,l;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},r&&r["m.homeserver"]){e.next=6;break}return u.logger.error("No m.homeserver key in config"),n["m.homeserver"].state=t.FAIL_PROMPT,n["m.homeserver"].error=t.ERROR_INVALID,e.abrupt("return",Promise.resolve(n));case 6:if(r["m.homeserver"].base_url){e.next=11;break}return u.logger.error("No m.homeserver base_url in config"),n["m.homeserver"].state=t.FAIL_PROMPT,n["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,e.abrupt("return",Promise.resolve(n));case 11:if(o=this._sanitizeWellKnownUrl(r["m.homeserver"].base_url)){e.next=16;break}return u.logger.error("Invalid base_url for m.homeserver"),n["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,e.abrupt("return",Promise.resolve(n));case 16:return e.next=18,this._fetchWellKnownObject("".concat(o,"/_matrix/client/versions"));case 18:if((s=e.sent)&&s.raw.versions){e.next=24;break}return u.logger.error("Invalid /versions response"),n["m.homeserver"].error=t.ERROR_INVALID_HOMESERVER,n["m.homeserver"].base_url=o,e.abrupt("return",Promise.resolve(n));case 24:if(n["m.homeserver"]={state:t.SUCCESS,error:null,base_url:o},a="",!r["m.identity_server"]){e.next=41;break}if(c={"m.homeserver":n["m.homeserver"],"m.identity_server":{state:t.FAIL_PROMPT,error:t.ERROR_INVALID_IS,base_url:null}},a=this._sanitizeWellKnownUrl(r["m.identity_server"].base_url)){e.next=33;break}return u.logger.error("Invalid base_url for m.identity_server"),c["m.identity_server"].error=t.ERROR_INVALID_IS_BASE_URL,e.abrupt("return",Promise.resolve(c));case 33:return e.next=35,this._fetchWellKnownObject("".concat(a,"/_matrix/identity/api/v1"));case 35:if((l=e.sent)&&l.raw&&"SUCCESS"===l.action){e.next=41;break}return u.logger.error("Invalid /api/v1 response"),c["m.identity_server"].error=t.ERROR_INVALID_IDENTITY_SERVER,c["m.identity_server"].base_url=a,e.abrupt("return",Promise.resolve(c));case 41:return a&&a.length>0&&(n["m.identity_server"]={state:t.SUCCESS,error:null,base_url:a}),Object.keys(r).map((function(e){if("m.homeserver"===e||"m.identity_server"===e)for(var t=["error","state","base_url"],i=0,o=Object.keys(r[e]);i<o.length;i++){var s=o[i];t.includes(s)||(n[e][s]=r[e][s])}else n[e]=r[e]})),e.abrupt("return",Promise.resolve(n));case 44:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"findClientConfig",value:(l=(0,o.default)(i.default.mark((function e(r){var n,o;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&"string"==typeof r&&0!==r.length){e.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return n={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},e.next=5,this._fetchWellKnownObject("https://".concat(r,"/.well-known/matrix/client"));case 5:if((o=e.sent)&&"SUCCESS"===o.action){e.next=11;break}return u.logger.error("No response or error when parsing .well-known"),o.reason&&u.logger.error(o.reason),"IGNORE"===o.action?n["m.homeserver"]={state:t.PROMPT,error:null,base_url:null}:(n["m.homeserver"].state=t.FAIL_PROMPT,n["m.homeserver"].error=t.ERROR_INVALID),e.abrupt("return",Promise.resolve(n));case 11:return e.abrupt("return",t.fromDiscoveryConfig(o.raw));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return l.apply(this,arguments)})},{key:"getRawClientConfig",value:(n=(0,o.default)(i.default.mark((function e(t){var r;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&"string"==typeof t&&0!==t.length){e.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return e.next=4,this._fetchWellKnownObject("https://".concat(t,"/.well-known/matrix/client"));case 4:if(r=e.sent){e.next=7;break}return e.abrupt("return",{});case 7:return e.abrupt("return",r.raw||{});case 8:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"_sanitizeWellKnownUrl",value:function(e){if(!e)return!1;try{var t=null;try{t=c.URL?new c.URL(e):new URL(e)}catch(r){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;var r=t.port?":".concat(t.port):"",n=t.pathname?t.pathname:"",i="".concat(t.protocol,"//").concat(t.hostname).concat(r).concat(n);return i.endsWith("/")&&(i=i.substring(0,i.length-1)),i}catch(e){return u.logger.error(e),!1}}},{key:"_fetchWellKnownObject",value:(r=(0,o.default)(i.default.mark((function r(n){return i.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.abrupt("return",new Promise((function(r,i){var o=e("./matrix").getRequest();if(!o)throw new Error("No request library available");o({method:"GET",uri:n,timeout:5e3},(function(e,n,i){if(e||n&&(n.statusCode<200||n.statusCode>=300)){var o="FAIL_PROMPT",s=(e?e.message:null)||"General failure";return n&&404===n.statusCode&&(o="IGNORE",s=t.ERROR_MISSING_WELLKNOWN),void r({raw:{},action:o,reason:s,error:e})}try{r({raw:JSON.parse(i),action:"SUCCESS"})}catch(e){var a=t.ERROR_INVALID;"SyntaxError"===e.name&&(a=t.ERROR_INVALID_JSON),r({raw:{},action:"FAIL_PROMPT",reason:a,error:e})}}))})));case 1:case"end":return r.stop()}}),r)}))),function(e){return r.apply(this,arguments)})},{key:"ERROR_INVALID",get:function(){return"Invalid homeserver discovery response"}},{key:"ERROR_GENERIC_FAILURE",get:function(){return"Failed to get autodiscovery configuration from server"}},{key:"ERROR_INVALID_HS_BASE_URL",get:function(){return"Invalid base_url for m.homeserver"}},{key:"ERROR_INVALID_HOMESERVER",get:function(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}},{key:"ERROR_INVALID_IS_BASE_URL",get:function(){return"Invalid base_url for m.identity_server"}},{key:"ERROR_INVALID_IDENTITY_SERVER",get:function(){return"Identity server URL does not appear to be a valid identity server"}},{key:"ERROR_INVALID_IS",get:function(){return"Invalid identity server discovery response"}},{key:"ERROR_MISSING_WELLKNOWN",get:function(){return"No .well-known JSON file found"}},{key:"ERROR_INVALID_JSON",get:function(){return"Invalid JSON"}},{key:"ALL_ERRORS",get:function(){return[t.ERROR_INVALID,t.ERROR_GENERIC_FAILURE,t.ERROR_INVALID_HS_BASE_URL,t.ERROR_INVALID_HOMESERVER,t.ERROR_INVALID_IS_BASE_URL,t.ERROR_INVALID_IDENTITY_SERVER,t.ERROR_INVALID_IS,t.ERROR_MISSING_WELLKNOWN,t.ERROR_INVALID_JSON]}},{key:"FAIL_ERROR",get:function(){return"FAIL_ERROR"}},{key:"FAIL_PROMPT",get:function(){return"FAIL_PROMPT"}},{key:"PROMPT",get:function(){return"PROMPT"}},{key:"SUCCESS",get:function(){return"SUCCESS"}}]),t}();r.AutoDiscovery=l},{"./logger":102,"./matrix":103,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/regenerator":27,url:52}],59:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault"),i=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0});var o={};r.default=void 0;var s=i(e("./matrix"));Object.keys(s).forEach((function(e){"default"!==e&&"__esModule"!==e&&(Object.prototype.hasOwnProperty.call(o,e)||e in r&&r[e]===s[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return s[e]}}))}));var a,u=n(e("browser-request")),c=n(e("qs"));s.request((function(e,t){return e.qs=c.default.stringify(e.qs||{},e.qsStringifyOptions),(0,u.default)(e,t)}));try{a=t.indexedDB}catch(e){}a&&s.setCryptoStoreFactory((function(){return new s.IndexedDBCryptoStore(a,"matrix-js-sdk:crypto")}));var l=s;r.default=l,t.matrixcs=s}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./matrix":103,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"browser-request":31,qs:41}],60:[function(e,t,r){(function(t){(function(){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))},a=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixClient=r.CRYPTO_ENABLED=void 0;const u=e("events"),c=e("./sync"),l=e("./models/event"),d=e("./store/stub"),h=e("./webrtc/call"),f=e("./filter"),p=e("./webrtc/callEventHandler"),g=o(e("./utils")),v=e("./utils"),y=e("./models/event-timeline"),m=e("./pushprocessor"),_=e("./autodiscovery"),b=e("./http-api"),S=o(e("./crypto/olmlib")),k=e("./crypto/olmlib"),E=e("./ReEmitter"),w=e("./crypto/RoomList"),I=e("./logger"),T=e("./service-types"),R=e("./http-api"),x=e("./crypto"),C=e("./crypto/recoverykey"),O=e("./crypto/key_passphrase"),A=e("./models/user"),D=e("./content-repo"),P=e("./models/search-result"),M=e("./crypto/dehydration"),U=e("./sync.api"),N=o(e("./content-helpers")),K=e("./crypto/api"),B=e("./@types/event"),L=e("./@types/partials"),q=e("./event-mapper"),j=a(e("url")),F=e("./randomstring"),G=e("./crypto/backup"),V=e("./models/MSC3089TreeSpace");r.CRYPTO_ENABLED=x.isCryptoAvailable();const $=6e5;class H extends u.EventEmitter{constructor(e){super(),this.reEmitter=new E.ReEmitter(this),this.olmVersion=null,this.usingExternalCrypto=!1,this.clientRunning=!1,this.timelineSupport=!1,this.urlPreviewCache={},this.unstableClientRelationAggregation=!1,this.supportsCallTransfer=!1,this.forceTURN=!1,this.iceCandidatePoolSize=0,this.canSupportVoip=!1,this.peekSync=null,this.isGuestAccount=!1,this.ongoingScrollbacks={},this.notifTimelineSet=null,this.fallbackICEServerAllowed=!1,this.syncedLeftRooms=!1,this.pushProcessor=new m.PushProcessor(this),this.turnServers=[],this.turnServersExpiry=0,this.txnCtr=0,this.startCallEventHandler=()=>{this.isInitialSyncComplete()&&(this.callEventHandler.start(),this.off("sync",this.startCallEventHandler))},e.baseUrl=g.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=g.ensureNoTrailingSlash(e.idBaseUrl),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.usingExternalCrypto=e.usingExternalCrypto,this.store=e.store||new d.StubStore,this.deviceId=e.deviceId||null;const t=e.userId||null;this.credentials={userId:t},this.http=new R.MatrixHttpApi(this,{baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:R.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader}),e.deviceToImport?this.deviceId?I.logger.warn("not importing device because device ID is provided to constructor independently of exported data"):this.credentials.userId?I.logger.warn("not importing device because user ID is provided to constructor independently of exported data"):e.deviceToImport.deviceId?(this.deviceId=e.deviceToImport.deviceId,this.credentials.userId=e.deviceToImport.userId,this.exportedOlmDeviceToImport=e.deviceToImport.olmDevice):I.logger.warn("not importing device because no device ID in exported data"):e.pickleKey&&(this.pickleKey=e.pickleKey),this.scheduler=e.scheduler,this.scheduler&&this.scheduler.setProcessFunction((e=>s(this,void 0,void 0,(function*(){const t=this.getRoom(e.getRoomId());e.status!==l.EventStatus.SENDING&&this.updatePendingEventStatus(t,e,l.EventStatus.SENDING);const r=yield this.sendEventHttpRequest(e);return t&&t.updatePendingEvent(e,l.EventStatus.SENT,r.event_id),r}))));h.createNewMatrixCall(this,void 0,void 0)&&(this.callEventHandler=new p.CallEventHandler(this),this.canSupportVoip=!0,this.on("sync",this.startCallEventHandler)),this.timelineSupport=Boolean(e.timelineSupport),this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this.cryptoStore=e.cryptoStore,this.sessionStore=e.sessionStore,this.verificationMethods=e.verificationMethods,this.cryptoCallbacks=e.cryptoCallbacks||{},this.forceTURN=e.forceTURN||!1,this.iceCandidatePoolSize=void 0===e.iceCandidatePoolSize?0:e.iceCandidatePoolSize,this.supportsCallTransfer=e.supportsCallTransfer||!1,this.fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this.roomList=new w.RoomList(this.cryptoStore),this.on("Event.decrypted",(e=>{const t=e.getPushActions(),r=this.pushProcessor.actionsForEvent(e);e.setPushActions(r);const n=this.getRoom(e.getRoomId());if(!n)return;const i=n.getUnreadNotificationCount("highlight"),o=!(!t||!t.tweaks)&&!!t.tweaks.highlight,s=!(!r||!r.tweaks)&&!!r.tweaks.highlight;if((o!==s||i>0)&&!n.hasUserReadEvent(this.getUserId(),e.getId())){let e=i;s&&!o&&e++,!s&&o&&e--,n.setUnreadNotificationCount("highlight",e);n.getUnreadNotificationCount("total")<e&&n.setUnreadNotificationCount("total",e)}})),this.on("Room.receipt",((e,t)=>{if(t&&this.isRoomEncrypted(t.roomId)){const r=e.getContent();if(!(Object.keys(r).filter((e=>Object.keys(r[e]["m.read"]).includes(this.getUserId()))).length>0))return;const n=20,i=t.getLiveTimeline().getEvents();let o=0;for(let e=i.length-1;e>=0;e--){if(e===i.length-n)return;const r=i[e];if(t.hasUserReadEvent(this.getUserId(),r.getId()))break;const s=this.getPushActionsForEvent(r);o+=s.tweaks&&s.tweaks.highlight?1:0}t.setUnreadNotificationCount("highlight",o)}}))}startClient(e){return s(this,void 0,void 0,(function*(){if(this.clientRunning)return;this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e});const t=this.getUserId();t&&this.store.storeUser(new A.User(t)),this.crypto&&(this.crypto.uploadDeviceKeys(),this.crypto.start()),this.canSupportVoip&&(this.checkTurnServersIntervalID=setInterval((()=>{this.checkTurnServers()}),$),this.checkTurnServers()),this.syncApi&&(I.logger.error("Still have sync object whilst not running: stopping old one"),this.syncApi.stop()),this.clientOpts=Object.assign({},e),this.clientOpts.crypto=this.crypto,this.clientOpts.canResetEntireTimeline=e=>!!this.canResetTimelineCallback&&this.canResetTimelineCallback(e),this.syncApi=new c.SyncApi(this,this.clientOpts),this.syncApi.sync(),void 0!==this.clientOpts.clientWellKnownPollPeriod&&(this.clientWellKnownIntervalID=setInterval((()=>{this.fetchClientWellKnown()}),1e3*this.clientOpts.clientWellKnownPollPeriod),this.fetchClientWellKnown())}))}stopClient(){var e,r,n,i;I.logger.log("stopping MatrixClient"),this.clientRunning=!1,null===(e=this.syncApi)||void 0===e||e.stop(),this.syncApi=null,null===(r=this.crypto)||void 0===r||r.stop(),null===(n=this.peekSync)||void 0===n||n.stopPeeking(),null===(i=this.callEventHandler)||void 0===i||i.stop(),this.callEventHandler=null,t.clearInterval(this.checkTurnServersIntervalID),void 0!==this.clientWellKnownIntervalID&&t.clearInterval(this.clientWellKnownIntervalID)}rehydrateDevice(){return s(this,void 0,void 0,(function*(){if(this.crypto)throw new Error("Cannot rehydrate device after crypto is initialized");if(!this.cryptoCallbacks.getDehydrationKey)return;const e=yield this.getDehydratedDevice();if(!e)return;if(!e.device_data||!e.device_id)return void I.logger.info("no dehydrated device found");const r=new t.Olm.Account;try{const t=e.device_data;if(t.algorithm!==M.DEHYDRATION_ALGORITHM)return void I.logger.warn("Wrong algorithm for dehydrated device");I.logger.log("unpickling dehydrated device");const n=yield this.cryptoCallbacks.getDehydrationKey(t,(e=>{r.unpickle(new Uint8Array(e),t.account)}));r.unpickle(n,t.account),I.logger.log("unpickled device");if(!0===(yield this.http.authedRequest(void 0,"POST","/dehydrated_device/claim",void 0,{device_id:e.device_id},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).success){this.deviceId=e.device_id,I.logger.info("using dehydrated device");const t=this.pickleKey||"DEFAULT_KEY";return this.exportedOlmDeviceToImport={pickledAccount:r.pickle(t),sessions:[],pickleKey:t},r.free(),this.deviceId}return r.free(),void I.logger.info("not using dehydrated device")}catch(e){r.free(),I.logger.warn("could not unpickle",e)}}))}getDehydratedDevice(){return s(this,void 0,void 0,(function*(){try{return yield this.http.authedRequest(void 0,"GET","/dehydrated_device",void 0,void 0,{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})}catch(e){return void I.logger.info("could not get dehydrated device",e.toString())}}))}setDehydrationKey(e,t,r){return s(this,void 0,void 0,(function*(){if(this.crypto)return yield this.crypto._dehydrationManager.setKeyAndQueueDehydration(e,t,r);I.logger.warn("not dehydrating device if crypto is not enabled")}))}createDehydratedDevice(e,t,r){return s(this,void 0,void 0,(function*(){if(this.crypto)return yield this.crypto._dehydrationManager.setKey(e,t,r),yield this.crypto._dehydrationManager.dehydrateDevice();I.logger.warn("not dehydrating device if crypto is not enabled")}))}exportDevice(){return s(this,void 0,void 0,(function*(){if(this.crypto)return{userId:this.credentials.userId,deviceId:this.deviceId,olmDevice:yield this.crypto._olmDevice.export()};I.logger.warn("not exporting device if crypto is not enabled")}))}clearStores(){if(this.clientRunning)throw new Error("Cannot clear stores while client is running");const e=[];return e.push(this.store.deleteAllData()),this.cryptoStore&&e.push(this.cryptoStore.deleteAllData()),Promise.all(e).then()}getUserId(){return this.credentials&&this.credentials.userId?this.credentials.userId:null}getDomain(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null}getUserIdLocalpart(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null}getDeviceId(){return this.deviceId}supportsVoip(){return this.canSupportVoip}setForceTURN(e){this.forceTURN=e}setSupportsCallTransfer(e){this.supportsCallTransfer=e}createCall(e){return h.createNewMatrixCall(this,e)}getSyncState(){return this.syncApi?this.syncApi.getSyncState():null}getSyncStateData(){return this.syncApi?this.syncApi.getSyncStateData():null}isInitialSyncComplete(){const e=this.getSyncState();return!!e&&(e===U.SyncState.Prepared||e===U.SyncState.Syncing)}isGuest(){return this.isGuestAccount}setGuest(e){this.isGuestAccount=e}getScheduler(){return this.scheduler}retryImmediately(){return this.syncApi.retryImmediately()}getNotifTimelineSet(){return this.notifTimelineSet}setNotifTimelineSet(e){this.notifTimelineSet=e}getCapabilities(e=!1){const t=(new Date).getTime();return this.cachedCapabilities&&!e&&t<this.cachedCapabilities.expiration?(I.logger.log("Returning cached capabilities"),Promise.resolve(this.cachedCapabilities.capabilities)):this.http.authedRequest(void 0,"GET","/capabilities").catch((e=>(I.logger.error(e),null))).then((e=>{e||(e={});const r=e.capabilities||{},n=Object.keys(r).length?216e5:6e4+5e3*Math.random();return this.cachedCapabilities={capabilities:r,expiration:t+n},I.logger.log("Caching capabilities: ",r),r}))}initCrypto(){return s(this,void 0,void 0,(function*(){if(!x.isCryptoAvailable())throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");if(this.crypto)return void I.logger.warn("Attempt to re-initialise e2e encryption on MatrixClient");if(!this.sessionStore)throw new Error("Cannot enable encryption: no sessionStore provided");if(!this.cryptoStore)throw new Error("Cannot enable encryption: no cryptoStore provided");I.logger.log("Crypto: Starting up crypto store..."),yield this.cryptoStore.startup(),I.logger.log("Crypto: initialising roomlist..."),yield this.roomList.init();const e=this.getUserId();if(null===e)throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");if(null===this.deviceId)throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");const t=new x.Crypto(this,this.sessionStore,e,this.deviceId,this.store,this.cryptoStore,this.roomList,this.verificationMethods);this.reEmitter.reEmit(t,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","crypto.willUpdateDevices","deviceVerificationChanged","userTrustStatusChanged","crossSigning.keysChanged"]),I.logger.log("Crypto: initialising crypto object..."),yield t.init({exportedOlmDevice:this.exportedOlmDeviceToImport,pickleKey:this.pickleKey}),delete this.exportedOlmDeviceToImport,this.olmVersion=x.Crypto.getOlmVersion(),t.registerEventHandlers(this),this.crypto=t}))}isCryptoEnabled(){return!!this.crypto}getDeviceEd25519Key(){return this.crypto?this.crypto.getDeviceEd25519Key():null}getDeviceCurve25519Key(){return this.crypto?this.crypto.getDeviceCurve25519Key():null}uploadKeys(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.uploadDeviceKeys()}downloadKeys(e,t){return this.crypto?this.crypto.downloadKeys(e,t):Promise.reject(new Error("End-to-end encryption disabled"))}getStoredDevicesForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevicesForUser(e)||[]}getStoredDevice(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredDevice(e,t)||null}setDeviceVerified(e,t,r=!0){const n=this.setDeviceVerification(e,t,r,null,null);return e==this.credentials.userId&&this.checkKeyBackup(),n}setDeviceBlocked(e,t,r=!0){return this.setDeviceVerification(e,t,null,r,null)}setDeviceKnown(e,t,r=!0){return this.setDeviceVerification(e,t,null,null,r)}setDeviceVerification(e,t,r,n,i){return s(this,void 0,void 0,(function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto.setDeviceVerification(e,t,r,n,i)}))}requestVerificationDM(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerificationDM(e,t)}findVerificationRequestDMInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.findVerificationRequestDMInProgress(e)}getVerificationRequestsToDeviceInProgress(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getVerificationRequestsToDeviceInProgress(e)}requestVerification(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestVerification(e,t)}beginKeyVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.beginKeyVerification(e,t,r)}checkSecretStorageKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStorageKey(e,t)}setGlobalBlacklistUnverifiedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalBlacklistUnverifiedDevices(e)}getGlobalBlacklistUnverifiedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalBlacklistUnverifiedDevices()}setGlobalErrorOnUnknownDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setGlobalErrorOnUnknownDevices(e)}getGlobalErrorOnUnknownDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getGlobalErrorOnUnknownDevices()}getCrossSigningId(e=K.CrossSigningKey.Master){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCrossSigningId(e)}getStoredCrossSigningForUser(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getStoredCrossSigningForUser(e)}checkUserTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkUserTrust(e)}checkDeviceTrust(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkDeviceTrust(e,t)}checkOwnCrossSigningTrust(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkOwnCrossSigningTrust(e)}checkCrossSigningPrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkCrossSigningPrivateKey(e,t)}legacyDeviceVerification(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.legacyDeviceVerification(e,t,r)}prepareToEncrypt(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.prepareToEncrypt(e)}isCrossSigningReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isCrossSigningReady()}bootstrapCrossSigning(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapCrossSigning(e)}getCryptoTrustCrossSignedDevices(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getCryptoTrustCrossSignedDevices()}setCryptoTrustCrossSignedDevices(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setCryptoTrustCrossSignedDevices(e)}countSessionsNeedingBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.countSessionsNeedingBackup()}getEventEncryptionInfo(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getEventEncryptionInfo(e)}createRecoveryKeyFromPassphrase(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.createRecoveryKeyFromPassphrase(e)}isSecretStorageReady(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStorageReady()}bootstrapSecretStorage(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.bootstrapSecretStorage(e)}addSecretStorageKey(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.addSecretStorageKey(e,t,r)}hasSecretStorageKey(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.hasSecretStorageKey(e)}storeSecret(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.storeSecret(e,t,r)}getSecret(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getSecret(e)}isSecretStored(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.isSecretStored(e,t)}requestSecret(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.requestSecret(e,t)}getDefaultSecretStorageKeyId(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.getDefaultSecretStorageKeyId()}setDefaultSecretStorageKeyId(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.setDefaultSecretStorageKeyId(e)}checkSecretStoragePrivateKey(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.checkSecretStoragePrivateKey(e,t)}getEventSenderDeviceInfo(e){return this.crypto?this.crypto.getEventSenderDeviceInfo(e):null}isEventSenderVerified(e){return s(this,void 0,void 0,(function*(){const t=yield this.getEventSenderDeviceInfo(e);return!!t&&t.isVerified()}))}cancelAndResendEventRoomKeyRequest(e){return e.cancelAndResendKeyRequest(this.crypto,this.getUserId())}setRoomEncryption(e,t){if(!this.crypto)throw new Error("End-to-End encryption disabled");return this.crypto.setRoomEncryption(e,t)}isRoomEncrypted(e){const t=this.getRoom(e);if(!t)return!1;return!!t.currentState.getStateEvents("m.room.encryption","")||this.roomList.isRoomEncrypted(e)}forceDiscardSession(e){if(!this.crypto)throw new Error("End-to-End encryption disabled");this.crypto.forceDiscardSession(e)}exportRoomKeys(){return this.crypto?this.crypto.exportRoomKeys():Promise.reject(new Error("End-to-end encryption disabled"))}importRoomKeys(e,t){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto.importRoomKeys(e,t)}checkKeyBackup(){return this.crypto._backupManager.checkKeyBackup()}getKeyBackupVersion(){return this.http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:R.PREFIX_UNSTABLE}).then((e=>{if(e.algorithm!==S.MEGOLM_BACKUP_ALGORITHM){const t="Unknown backup algorithm: "+e.algorithm;return Promise.reject(t)}if("object"==typeof e.auth_data&&e.auth_data.public_key)return e;{const e="Invalid backup data returned";return Promise.reject(e)}})).catch((e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e}))}isKeyBackupTrusted(e){return this.crypto._backupManager.isKeyBackupTrusted(e)}getKeyBackupEnabled(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto._backupManager.getKeyBackupEnabled()}enableKeyBackup(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto._backupManager.enableKeyBackup(e)}disableKeyBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto._backupManager.disableKeyBackup()}prepareKeyBackupVersion(e,t={secureSecretStorage:!1}){return s(this,void 0,void 0,(function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const{algorithm:r,auth_data:n,recovery_key:i,privateKey:o}=yield this.crypto._backupManager.prepareKeyBackupVersion(e);return t.secureSecretStorage&&(yield this.storeSecret("m.megolm_backup.v1",k.encodeBase64(o)),I.logger.info("Key backup private key stored in secret storage")),{algorithm:r,auth_data:n,recovery_key:i}}))}isKeyBackupKeyStored(){return Promise.resolve(this.isSecretStored("m.megolm_backup.v1",!1))}createKeyBackupVersion(e){return s(this,void 0,void 0,(function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto._backupManager.createKeyBackupVersion(e);const t={algorithm:e.algorithm,auth_data:e.auth_data};yield this.crypto._signObject(t.auth_data),this.cryptoCallbacks.getCrossSigningKey&&this.crypto._crossSigningInfo.getId()&&(yield this.crypto._crossSigningInfo.signObject(t.auth_data,"master"));const r=yield this.http.authedRequest(void 0,"POST","/room_keys/version",void 0,t,{prefix:R.PREFIX_UNSTABLE});return yield this.checkKeyBackup(),this.getKeyBackupEnabled()||I.logger.error("Key backup not usable even though we just created it"),r}))}deleteKeyBackupVersion(e){if(!this.crypto)throw new Error("End-to-end encryption disabled");this.crypto._backupManager.version&&this.crypto._backupManager.disableKeyBackup();const t=g.encodeUri("/room_keys/version/$version",{$version:e});return this.http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:R.PREFIX_UNSTABLE})}makeKeyBackupPath(e,t,r){let n;n=void 0!==t?g.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?g.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys";return{path:n,queryData:void 0===r?void 0:{version:r}}}sendKeyBackup(e,t,r,n){if(!this.crypto)throw new Error("End-to-end encryption disabled");const i=this.makeKeyBackupPath(e,t,r);return this.http.authedRequest(void 0,"PUT",i.path,i.queryData,n,{prefix:R.PREFIX_UNSTABLE})}scheduleAllGroupSessionsForBackup(){return s(this,void 0,void 0,(function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");yield this.crypto._backupManager.scheduleAllGroupSessionsForBackup()}))}flagAllGroupSessionsForBackup(){if(!this.crypto)throw new Error("End-to-end encryption disabled");return this.crypto._backupManager.flagAllGroupSessionsForBackup()}isValidRecoveryKey(e){try{return C.decodeRecoveryKey(e),!0}catch(e){return!1}}keyBackupKeyFromPassword(e,t){return O.keyFromAuthData(t.auth_data,e)}keyBackupKeyFromRecoveryKey(e){return C.decodeRecoveryKey(e)}restoreKeyBackupWithPassword(e,t,r,n,i){return s(this,void 0,void 0,(function*(){const o=yield O.keyFromAuthData(n.auth_data,e);return this.restoreKeyBackup(o,t,r,n,i)}))}restoreKeyBackupWithSecretStorage(e,t,r,n){return s(this,void 0,void 0,(function*(){const i=yield this.getSecret("m.megolm_backup.v1"),o=x.fixBackupKey(i);if(o){const[e]=yield this.crypto.getSecretStorageKey();yield this.storeSecret("m.megolm_backup.v1",o,[e])}const s=k.decodeBase64(o||i);return this.restoreKeyBackup(s,t,r,e,n)}))}restoreKeyBackupWithRecoveryKey(e,t,r,n,i){const o=C.decodeRecoveryKey(e);return this.restoreKeyBackup(o,t,r,n,i)}restoreKeyBackupWithCache(e,t,r,n){return s(this,void 0,void 0,(function*(){const i=yield this.crypto.getSessionBackupPrivateKey();if(!i)throw new Error("Couldn't get key");return this.restoreKeyBackup(i,e,t,r,n)}))}restoreKeyBackup(e,t,r,n,i){return s(this,void 0,void 0,(function*(){const o=null==i?void 0:i.cacheCompleteCallback,a=null==i?void 0:i.progressCallback;if(!this.crypto)throw new Error("End-to-end encryption disabled");let u=0,c=[];const l=this.makeKeyBackupPath(t,r,n.version),d=yield G.BackupManager.makeAlgorithm(n,(()=>s(this,void 0,void 0,(function*(){return e}))));try{if(!(yield d.keyMatches(e)))return Promise.reject(new b.MatrixError({errcode:H.RESTORE_BACKUP_ERROR_BAD_KEY}));this.crypto.storeSessionBackupPrivateKey(e).catch((e=>{I.logger.warn("Error caching session backup key:",e)})).then(o),a&&a({stage:"fetch"});const n=yield this.http.authedRequest(void 0,"GET",l.path,l.queryData,void 0,{prefix:R.PREFIX_UNSTABLE});if(n.rooms)for(const[e,t]of Object.entries(n.rooms)){if(!t.sessions)continue;u+=Object.keys(t.sessions).length;const r=yield d.decryptSessions(t.sessions);for(const t of r)t.room_id=e,c.push(t)}else if(n.sessions){u=Object.keys(n.sessions).length,c=yield d.decryptSessions(n.sessions);for(const e of c)e.room_id=t}else{u=1;try{const[e]=yield d.decryptSessions({[r]:n});e.room_id=t,e.session_id=r,c.push(e)}catch(e){I.logger.log("Failed to decrypt megolm session from backup",e)}}}finally{d.free()}return yield this.importRoomKeys(c,{progressCallback:a,untrusted:!0,source:"backup"}),yield this.checkKeyBackup(),{total:u,imported:c.length}}))}deleteKeysFromBackup(e,t,r){if(!this.crypto)throw new Error("End-to-end encryption disabled");const n=this.makeKeyBackupPath(e,t,r);return this.http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:R.PREFIX_UNSTABLE})}sendSharedHistoryKeys(e,t){return s(this,void 0,void 0,(function*(){if(!this.crypto)throw new Error("End-to-end encryption disabled");const r=this.roomList.getRoomEncryption(e);if(!r)return void I.logger.error("Unknown room.  Not sharing decryption keys");const n=yield this.crypto.downloadKeys(t),i={};for(const[e,t]of Object.entries(n))i[e]=Object.values(t);const o=this.crypto._getRoomDecryptor(e,r.algorithm);o.sendSharedHistoryInboundSessions?yield o.sendSharedHistoryInboundSessions(i):I.logger.warn("Algorithm does not support sharing previous keys",r.algorithm)}))}getGroup(e){return this.store.getGroup(e)}getGroups(){return this.store.getGroups()}getMediaConfig(e){return this.http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:R.PREFIX_MEDIA_R0})}getRoom(e){return this.store.getRoom(e)}getRooms(){return this.store.getRooms()}getVisibleRooms(){const e=this.store.getRooms(),t=new Set;for(const r of e){const e=r.currentState.getStateEvents("m.room.create","");if(e){const r=e.getContent().predecessor;r&&r.room_id&&t.add(r.room_id)}}return e.filter((e=>!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId)))}getUser(e){return this.store.getUser(e)}getUsers(){return this.store.getUsers()}setAccountData(e,t,r){const n=g.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e}),i=R.retryNetworkOperation(5,(()=>this.http.authedRequest(void 0,"PUT",n,void 0,t)));return r&&i.then((e=>r(null,e)),r),i}getAccountData(e){return this.store.getAccountData(e)}getAccountDataFromServer(e){return s(this,void 0,void 0,(function*(){if(this.isInitialSyncComplete()){const t=this.store.getAccountData(e);return t?t.getContent():null}const t=g.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});try{return yield this.http.authedRequest(void 0,"GET",t,void 0)}catch(e){if(e.data&&"M_NOT_FOUND"===e.data.errcode)return null;throw e}}))}getIgnoredUsers(){const e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?Object.keys(e.getContent().ignored_users):[]}setIgnoredUsers(e,t){const r={ignored_users:{}};return e.map((e=>r.ignored_users[e]={})),this.setAccountData("m.ignored_user_list",r,t)}isUserIgnored(e){return this.getIgnoredUsers().includes(e)}joinRoom(e,t,r){return s(this,void 0,void 0,(function*(){if(g.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);const n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return Promise.resolve(n);let i=Promise.resolve();t.inviteSignUrl&&(i=this.http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));const o={};t.viaServers&&(o.server_name=t.viaServers);const s={qsStringifyOptions:{arrayFormat:"repeat"}};try{const n={},a=yield i;a&&(n.third_party_signed=a);const u=g.encodeUri("/join/$roomid",{$roomid:e}),l=(yield this.http.authedRequest(void 0,"POST",u,o,n,s)).room_id,d=new c.SyncApi(this,this.clientOpts).createRoom(l);return t.syncRoom,null==r||r(null,d),d}catch(e){throw null==r||r(e),e}}))}resendEvent(e,t){return this.updatePendingEventStatus(t,e,l.EventStatus.SENDING),this.encryptAndSendEvent(t,e)}cancelPendingEvent(e){if([l.EventStatus.QUEUED,l.EventStatus.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e);const t=this.getRoom(e.getRoomId());this.updatePendingEventStatus(t,e,l.EventStatus.CANCELLED)}setRoomName(e,t,r){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,r)}setRoomTopic(e,t,r){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,r)}getRoomTags(e,t){const r=g.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this.http.authedRequest(t,"GET",r,void 0)}setRoomTag(e,t,r,n){const i=g.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(n,"PUT",i,void 0,r)}deleteRoomTag(e,t,r){const n=g.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this.http.authedRequest(r,"DELETE",n,void 0,void 0)}setRoomAccountData(e,t,r,n){const i=g.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this.http.authedRequest(n,"PUT",i,void 0,r)}setPowerLevel(e,t,r,n,i){let o={users:{}};n&&"m.room.power_levels"===n.getType()&&(o=g.deepCopy(n.getContent())),o.users[t]=r;const s=g.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this.http.authedRequest(i,"PUT",s,void 0,o)}sendEvent(e,t,r,n,i){return this.sendCompleteEvent(e,{type:t,content:r},n,i)}sendCompleteEvent(e,t,r,n){g.isFunction(r)&&(n=r,r=void 0),r||(r=this.makeTxnId());const i=new l.MatrixEvent(Object.assign(t,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,sender:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),o=this.getRoom(e),s=i.getAssociatedId();if(s&&s.startsWith("~")){const e=o.getPendingEvents().find((e=>e.getId()===s));e.once("Event.localEventIdReplaced",(()=>{i.updateAssociatedId(e.getId())}))}const a=i.getType();return I.logger.log(`sendEvent of type ${a} in ${e} with txnId ${r}`),i.setTxnId(r),i.setStatus(l.EventStatus.SENDING),o&&o.addPendingEvent(i,r),i.status===l.EventStatus.NOT_SENT?Promise.reject(new Error("Event blocked by other events not yet sent")):this.encryptAndSendEvent(o,i,n)}encryptAndSendEvent(e,t,r){return Promise.resolve().then((()=>{const r=this.encryptEventIfNeeded(t,e);return r?(this.updatePendingEventStatus(e,t,l.EventStatus.ENCRYPTING),r.then((()=>this.updatePendingEventStatus(e,t,l.EventStatus.SENDING)))):null})).then((()=>{let r;return this.scheduler&&(r=this.scheduler.queueEvent(t),r&&this.scheduler.getQueueForEvent(t).length>1&&this.updatePendingEventStatus(e,t,l.EventStatus.QUEUED)),r||(r=this.sendEventHttpRequest(t),e&&(r=r.then((r=>(e.updatePendingEvent(t,l.EventStatus.SENT,r.event_id),r))))),r})).then((e=>(null==r||r(null,e),e))).catch((n=>{I.logger.error("Error sending event",n.stack||n);try{t.error=n,this.updatePendingEventStatus(e,t,l.EventStatus.NOT_SENT),n.event=t,null==r||r(n)}catch(e){I.logger.error("Exception in error handler!",e.stack||n)}throw n}))}encryptEventIfNeeded(e,t){if(e.isEncrypted())return null;if(!this.isRoomEncrypted(e.getRoomId()))return null;if(!this.crypto&&this.usingExternalCrypto)return null;if(e.getType()===B.EventType.Reaction)return null;if(!this.crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return this.crypto.encryptEvent(e,t)}getEncryptedIfNeededEventType(e,t){return t===B.EventType.Reaction?t:this.isRoomEncrypted(e)?B.EventType.RoomMessageEncrypted:t}updatePendingEventStatus(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}sendEventHttpRequest(e){let t=e.getTxnId();t||(t=this.makeTxnId(),e.setTxnId(t));const r={$roomId:e.getRoomId(),$eventType:e.getWireType(),$stateKey:e.getStateKey(),$txnId:t};let n;if(e.isState()){let t="/rooms/$roomId/state/$eventType";e.getStateKey()&&e.getStateKey().length>0&&(t="/rooms/$roomId/state/$eventType/$stateKey"),n=g.encodeUri(t,r)}else if(e.isRedaction()){const t="/rooms/$roomId/redact/$redactsEventId/$txnId";n=g.encodeUri(t,Object.assign({$redactsEventId:e.event.redacts},r))}else n=g.encodeUri("/rooms/$roomId/send/$eventType/$txnId",r);return this.http.authedRequest(void 0,"PUT",n,void 0,e.getWireContent()).then((t=>(I.logger.log(`Event sent to ${e.getRoomId()} with event id ${t.event_id}`),t)))}redactEvent(e,t,r,n){const i=("object"==typeof n?n:{}).reason,o="function"==typeof n?n:void 0;return this.sendCompleteEvent(e,{type:B.EventType.RoomRedaction,content:{reason:i},redacts:t},r,o)}sendMessage(e,t,r,n){return g.isFunction(r)&&(n=r,r=void 0),this.sendEvent(e,"m.room.message",t,r,n)}sendTextMessage(e,t,r,n){const i=N.makeTextMessage(t);return this.sendMessage(e,i,r,n)}sendNotice(e,t,r,n){const i=N.makeNotice(t);return this.sendMessage(e,i,r,n)}sendEmoteMessage(e,t,r,n){const i=N.makeEmoteMessage(t);return this.sendMessage(e,i,r,n)}sendImageMessage(e,t,r,n="Image",i){g.isFunction(n)&&(i=n,n=void 0);const o={msgtype:"m.image",url:t,info:r,body:n};return this.sendMessage(e,o,void 0,i)}sendStickerMessage(e,t,r,n="Sticker",i){g.isFunction(n)&&(i=n,n=void 0);const o={url:t,info:r,body:n};return this.sendEvent(e,B.EventType.Sticker,o,void 0,i)}sendHtmlMessage(e,t,r,n){const i=N.makeHtmlMessage(t,r);return this.sendMessage(e,i,void 0,n)}sendHtmlNotice(e,t,r,n){const i=N.makeHtmlNotice(t,r);return this.sendMessage(e,i,void 0,n)}sendHtmlEmote(e,t,r,n){const i=N.makeHtmlEmote(t,r);return this.sendMessage(e,i,void 0,n)}sendReceipt(e,t,r,n){if("function"==typeof r&&(n=r,r={}),this.isGuest())return Promise.resolve({});const i=g.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),o=this.http.authedRequest(n,"POST",i,void 0,r||{}),s=this.getRoom(e.getRoomId());return s&&s._addLocalEchoReceipt(this.credentials.userId,e,t),o}sendReadReceipt(e,t,r){return s(this,void 0,void 0,(function*(){"function"==typeof t&&(r=t,t={}),t||(t={});const n=e.getId(),i=this.getRoom(e.getRoomId());if(i&&i.hasPendingEvent(n))throw new Error(`Cannot set read receipt to a pending event (${n})`);const o={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",o,r)}))}setRoomReadMarkers(e,t,r,n){return s(this,void 0,void 0,(function*(){const i=this.getRoom(e);if(i&&i.hasPendingEvent(t))throw new Error(`Cannot set read marker to a pending event (${t})`);let o;if(r){if(o=r.getId(),i&&i.hasPendingEvent(o))throw new Error(`Cannot set read receipt to a pending event (${o})`);i&&i._addLocalEchoReceipt(this.credentials.userId,r,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,o,n)}))}getUrlPreview(e,t,r){const n=(t=6e4*Math.floor(t/6e4))+"_"+e,i=this.urlPreviewCache[n];if(i)return r&&i.then(r).catch(r),i;const o=this.http.authedRequest(r,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:R.PREFIX_MEDIA_R0});return this.urlPreviewCache[n]=o,o}sendTyping(e,t,r,n){if(this.isGuest())return Promise.resolve({});const i=g.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),o={typing:t};return t&&(o.timeout=r||2e4),this.http.authedRequest(n,"PUT",i,void 0,o)}getRoomUpgradeHistory(e,t=!1){let r=this.getRoom(e);if(!r)return[];const n=[r];let i=r.currentState.getStateEvents("m.room.create","");for(;i;){I.logger.log(`Looking at ${i.getId()}`);const e=i.getContent().predecessor;if(!e||!e.room_id)break;{I.logger.log(`Looking at predecessor ${e.room_id}`);const r=this.getRoom(e.room_id);if(!r)break;if(t){const e=r.currentState.getStateEvents("m.room.tombstone","");if(!e||e.getContent().replacement_room!==r.roomId)break}n.splice(0,0,r),i=r.currentState.getStateEvents("m.room.create","")}}let o=r.currentState.getStateEvents("m.room.tombstone","");for(;o;){const e=this.getRoom(o.getContent().replacement_room);if(!e)break;if(e.roomId===r.roomId)break;if(t){if(i=e.currentState.getStateEvents("m.room.create",""),!i||!i.getContent().predecessor)break;if(i.getContent().predecessor.room_id!==r.roomId)break}n.push(e);if(new Set(n.map((e=>e.roomId))).size<n.length)return n.slice(0,n.length-1);r=e,o=r.currentState.getStateEvents("m.room.tombstone","")}return n}invite(e,t,r,n){return this.membershipChange(e,t,"invite",n,r)}inviteByEmail(e,t,r){return this.inviteByThreePid(e,"email",t,r)}inviteByThreePid(e,t,r,n){return s(this,void 0,void 0,(function*(){const i=g.encodeUri("/rooms/$roomId/invite",{$roomId:e}),o=this.getIdentityServerUrl(!0);if(!o)return Promise.reject(new b.MatrixError({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"}));const s={id_server:o,medium:t,address:r};if(this.identityServer&&this.identityServer.getAccessToken&&(yield this.doesServerAcceptIdentityAccessToken())){const e=yield this.identityServer.getAccessToken();e&&(s.id_access_token=e)}return this.http.authedRequest(n,"POST",i,void 0,s)}))}leave(e,t){return this.membershipChange(e,void 0,"leave",void 0,t)}leaveRoomChain(e,t=!0){const r=this.getRoomUpgradeHistory(e);let n=r;if(!t){n=[];for(const t of r)if(n.push(t),t.roomId===e)break}const i={},o=[],s=e=>this.leave(e).then((()=>{i[e]=null})).catch((t=>(i[e]=t,null)));for(const e of n)o.push(s(e.roomId));return Promise.all(o).then((()=>i))}ban(e,t,r,n){return this.membershipChange(e,t,"ban",r,n)}forget(e,t,r){void 0===t&&(t=!0);const n=this.membershipChange(e,void 0,"forget",void 0,r);return t?n.then((t=>(this.store.removeRoom(e),this.emit("deleteRoom",e),t))):n}unban(e,t,r){const n=g.encodeUri("/rooms/$roomId/unban",{$roomId:e}),i={user_id:t};return this.http.authedRequest(r,"POST",n,void 0,i)}kick(e,t,r,n){return this.setMembershipState(e,t,"leave",r,n)}setMembershipState(e,t,r,n,i){g.isFunction(n)&&(i=n,n=void 0);const o=g.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:e,$userId:t});return this.http.authedRequest(i,"PUT",o,void 0,{membership:r,reason:n})}membershipChange(e,t,r,n,i){g.isFunction(n)&&(i=n,n=void 0);const o=g.encodeUri("/rooms/$room_id/$membership",{$room_id:e,$membership:r});return this.http.authedRequest(i,"POST",o,void 0,{user_id:t,reason:n})}getPushActionsForEvent(e){return e.getPushActions()||e.setPushActions(this.pushProcessor.actionsForEvent(e)),e.getPushActions()}setProfileInfo(e,t,r){const n=g.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this.http.authedRequest(r,"PUT",n,void 0,t)}setDisplayName(e,t){return s(this,void 0,void 0,(function*(){const r=yield this.setProfileInfo("displayname",{displayname:e},t),n=this.getUser(this.getUserId());return n&&(n.displayName=e,n.emit("User.displayName",n.events.presence,n)),r}))}setAvatarUrl(e,t){return s(this,void 0,void 0,(function*(){const r=yield this.setProfileInfo("avatar_url",{avatar_url:e},t),n=this.getUser(this.getUserId());return n&&(n.avatarUrl=e,n.emit("User.avatarUrl",n.events.presence,n)),r}))}mxcUrlToHttp(e,t,r,n,i){return D.getHttpUriForMxc(this.baseUrl,e,t,r,n,i)}_unstable_setStatusMessage(e){const t="im.vector.user_status";return Promise.all(this.getRooms().map((r=>{const n="join"===r.getMyMembership(),i=2===r.getInvitedAndJoinedMemberCount();if(!n||!i)return Promise.resolve();return r.currentState.mayClientSendStateEvent(t,this)?this.sendStateEvent(r.roomId,t,{status:e},this.getUserId()):Promise.resolve()}))).then()}setPresence(e,t){const r=g.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1===["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this.http.authedRequest(t,"PUT",r,void 0,e)}getPresence(e,t){const r=g.encodeUri("/presence/$userId/status",{$userId:e});return this.http.authedRequest(t,"GET",r,void 0,void 0)}scrollback(e,t,r){g.isFunction(t)&&(r=t,t=void 0),t=t||30;let n=0,i=this.ongoingScrollbacks[e.roomId]||{};if(i.promise)return i.promise;if(i.errorTs){const e=Date.now()-i.errorTs;n=Math.max(3e3-e,0)}if(null===e.oldState.paginationToken)return Promise.resolve(e);const o=this.store.scrollback(e,t).length;if(o===t)return Promise.resolve(e);t-=o;const s=new Promise(((i,o)=>{v.sleep(n).then((()=>this.createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b"))).then((t=>{const n=t.chunk.map(this.getEventMapper());if(t.state){const r=t.state.map(this.getEventMapper());e.currentState.setUnknownStateEvents(r)}e.addEventsToTimeline(n,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),this.store.storeEvents(e,n,t.end,!0),this.ongoingScrollbacks[e.roomId]=null,null==r||r(null,e),i(e)})).catch((t=>{this.ongoingScrollbacks[e.roomId]={errorTs:Date.now()},null==r||r(t),o(t)}))}));return i={promise:s,errorTs:null},this.ongoingScrollbacks[e.roomId]=i,s}getEventMapper(e){return q.eventMapperFor(this,e||{})}getEventTimeline(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return Promise.resolve(e.getTimelineForEvent(t));const r=g.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t});let n;this.clientOpts.lazyLoadMembers&&(n={filter:JSON.stringify(f.Filter.LAZY_LOADING_MESSAGES_FILTER)});return this.http.authedRequest(void 0,"GET",r,n).then((r=>{if(!r.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);r.events_after.reverse();const n=r.events_after.concat([r.event]).concat(r.events_before).map(this.getEventMapper());let i=e.getTimelineForEvent(n[0].getId());if(i){const e=r.state.map(this.getEventMapper());i.getState(y.EventTimeline.BACKWARDS).setUnknownStateEvents(e)}else i=e.addTimeline(),i.initialiseState(r.state.map(this.getEventMapper())),i.getState(y.EventTimeline.FORWARDS).paginationToken=r.end;return e.addEventsToTimeline(n,!0,i,r.start),e.getTimelineForEvent(t)||i}))}createMessagesRequest(e,t,r,n,i){const o=g.encodeUri("/rooms/$roomId/messages",{$roomId:e});void 0===r&&(r=30);const s={from:t,limit:r,dir:n};let a=null;return this.clientOpts.lazyLoadMembers&&(a=Object.assign({},f.Filter.LAZY_LOADING_MESSAGES_FILTER)),i&&(a=a||{},Object.assign(a,i.getRoomTimelineFilterComponent())),a&&(s.filter=JSON.stringify(a)),this.http.authedRequest(void 0,"GET",o,s)}paginateEventTimeline(e,t){const r=e.getTimelineSet()===this.notifTimelineSet,n=(t=t||{}).backwards||!1;if(r&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");const i=n?y.EventTimeline.BACKWARDS:y.EventTimeline.FORWARDS,o=e.getPaginationToken(i);if(!o)return Promise.resolve(!1);const s=e._paginationRequests[i];if(s)return s;let a,u,c;if(r)a="/notifications",u={limit:"limit"in t?t.limit:30,only:"highlight"},o&&"end"!==o&&(u.from=o),c=this.http.authedRequest(void 0,"GET","/notifications",u,void 0).then((t=>{const r=t.next_token,o=[];for(let e=0;e<t.notifications.length;e++){const r=t.notifications[e],n=this.getEventMapper()(r.event);n.setPushActions(m.PushProcessor.actionListToActionsObject(r.actions)),n.event.room_id=r.room_id,o[e]=n}return e.getTimelineSet().addEventsToTimeline(o,n,e,r),n&&!t.next_token&&e.setPaginationToken(null,i),!!t.next_token})).finally((()=>{e._paginationRequests[i]=null})),e._paginationRequests[i]=c;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());c=this.createMessagesRequest(e.getRoomId(),o,t.limit,i,e.getFilter()),c.then((t=>{if(t.state){const r=e.getState(i),n=t.state.map(this.getEventMapper());r.setUnknownStateEvents(n)}const r=t.end,o=t.chunk.map(this.getEventMapper());return e.getTimelineSet().addEventsToTimeline(o,n,e,r),n&&t.end==t.start&&e.setPaginationToken(null,i),t.end!=t.start})).finally((()=>{e._paginationRequests[i]=null})),e._paginationRequests[i]=c}return c}resetNotifTimelineSet(){this.notifTimelineSet&&this.notifTimelineSet.resetLiveTimeline("end",null)}peekInRoom(e){return this.peekSync&&this.peekSync.stopPeeking(),this.peekSync=new c.SyncApi(this,this.clientOpts),this.peekSync.peek(e)}stopPeeking(){this.peekSync&&(this.peekSync.stopPeeking(),this.peekSync=null)}setGuestAccess(e,t){const r=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"},"");let n=Promise.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"},"")),Promise.all([n,r]).then()}requestRegisterEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestRegisterMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestAdd3pidEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestAdd3pidMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestPasswordEmailToken(e,t,r,n){return this.requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})}requestPasswordMsisdnToken(e,t,r,n,i){return this.requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:i})}requestTokenFromEndpoint(e,t){return s(this,void 0,void 0,(function*(){const r=Object.assign({},t);if(!(yield this.doesServerSupportSeparateAddAndBind())&&this.idBaseUrl){const e=j.default.parse(this.idBaseUrl);if(!e.host)throw new Error("Invalid ID server URL: "+this.idBaseUrl);if(r.id_server=e.host,this.identityServer&&this.identityServer.getAccessToken&&(yield this.doesServerAcceptIdentityAccessToken())){const e=yield this.identityServer.getAccessToken();e&&(r.id_access_token=e)}}return this.http.request(void 0,"POST",e,void 0,r)}))}getRoomPushRule(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(let r=0;r<this.pushRules[e].room.length;r++){const n=this.pushRules[e].room[r];if(n.rule_id===t)return n}}setRoomMutePushRule(e,t,r){let n,i;const o=this.getRoomPushRule(e,t);if(o&&0<=o.actions.indexOf("dont_notify")&&(i=!0),r?o?i||(n=g.defer(),this.deletePushRule(e,"room",o.rule_id).then((()=>{this.addPushRule(e,"room",t,{actions:["dont_notify"]}).then((()=>{n.resolve()})).catch((e=>{n.reject(e)}))})).catch((e=>{n.reject(e)})),n=n.promise):n=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(n=this.deletePushRule(e,"room",o.rule_id)),n)return new Promise(((e,t)=>{n.then((()=>{this.getPushRules().then((t=>{this.pushRules=t,e()})).catch((e=>{t(e)}))})).catch((e=>{this.getPushRules().then((r=>{this.pushRules=r,t(e)})).catch((r=>{t(e)}))}))}))}searchMessageText(e,t){const r={search_term:e.query};return"keys"in e&&(r.keys=e.keys),this.search({body:{search_categories:{room_events:r}}},t)}searchRoomEvents(e){const t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then((e=>this.processRoomEventsSearch(r,e)))}backPaginateRoomEventsSearch(e){if(!e.next_batch)return Promise.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;const t={body:e._query,next_batch:e.next_batch},r=this.search(t).then((t=>this.processRoomEventsSearch(e,t))).finally((()=>{e.pendingRequest=null}));return e.pendingRequest=r,r}processRoomEventsSearch(e,t){const r=t.search_categories.room_events;e.count=r.count,e.next_batch=r.next_batch;const n={};r.highlights.forEach((e=>{n[e]=1})),e.highlights.forEach((e=>{n[e]=1})),e.highlights=Object.keys(n);const i=r.results?r.results.length:0;for(let t=0;t<i;t++){const n=P.SearchResult.fromJson(r.results[t],this.getEventMapper());e.results.push(n)}return e}syncLeftRooms(){if(this.syncedLeftRooms)return Promise.resolve([]);if(this.syncLeftRoomsPromise)return this.syncLeftRoomsPromise;const e=new c.SyncApi(this,this.clientOpts);return this.syncLeftRoomsPromise=e.syncLeftRooms(),this.syncLeftRoomsPromise.then((e=>{I.logger.log("Marking success of sync left room request"),this.syncedLeftRooms=!0})).finally((()=>{this.syncLeftRoomsPromise=null})),this.syncLeftRoomsPromise}createFilter(e){const t=g.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",t,void 0,e).then((t=>{const r=f.Filter.fromJson(this.credentials.userId,t.filter_id,e);return this.store.storeFilter(r),r}))}getFilter(e,t,r){if(r){const r=this.store.getFilter(e,t);if(r)return Promise.resolve(r)}const n=g.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this.http.authedRequest(void 0,"GET",n,void 0,void 0).then((r=>{const n=f.Filter.fromJson(e,t,r);return this.store.storeFilter(n),n}))}getOrCreateFilter(e,t){return s(this,void 0,void 0,(function*(){const r=this.store.getFilterIdByName(e);let n;if(r){try{const e=yield this.getFilter(this.credentials.userId,r,!0);if(e){const i=e.getDefinition(),o=t.getDefinition();g.deepCompare(i,o)&&(n=r)}}catch(e){if("M_UNKNOWN"!==e.errcode&&"M_NOT_FOUND"!==e.errcode)throw e}n||this.store.setFilterIdByName(e,void 0)}if(n)return n;const i=yield this.createFilter(t.getDefinition());return this.store.setFilterIdByName(e,i.filterId),i.filterId}))}getOpenIdToken(){const e=g.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this.http.authedRequest(void 0,"POST",e,void 0,{})}turnServer(e){return this.http.authedRequest(e,"GET","/voip/turnServer")}getTurnServers(){return this.turnServers||[]}getTurnServersExpiry(){return this.turnServersExpiry}checkTurnServers(){return s(this,void 0,void 0,(function*(){if(!this.canSupportVoip)return;let e=!1;const r=this.turnServersExpiry-Date.now();if(r>$)I.logger.debug("TURN creds are valid for another "+r+" ms: not fetching new ones."),e=!0;else{I.logger.debug("Fetching new TURN credentials");try{const t=yield this.turnServer();if(t.uris){I.logger.log("Got TURN URIs: "+t.uris+" refresh in "+t.ttl+" secs");const r={urls:t.uris,username:t.username,credential:t.password};this.turnServers=[r],this.turnServersExpiry=Date.now()+1e3*t.ttl,e=!0}}catch(e){I.logger.error("Failed to get TURN URIs",e),403===e.httpStatus&&(I.logger.info("TURN access unavailable for this account: stopping credentials checks"),null!==this.checkTurnServersIntervalID&&t.clearInterval(this.checkTurnServersIntervalID),this.checkTurnServersIntervalID=null)}}return e}))}setFallbackICEServerAllowed(e){this.fallbackICEServerAllowed=e}isFallbackICEServerAllowed(){return this.fallbackICEServerAllowed}isSynapseAdministrator(){const e=g.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this.http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then((e=>e.admin))}whoisSynapseUser(e){const t=g.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})}deactivateSynapseUser(e){const t=g.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this.http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})}fetchClientWellKnown(){return s(this,void 0,void 0,(function*(){this.clientWellKnownPromise=_.AutoDiscovery.getRawClientConfig(this.getDomain()),this.clientWellKnown=yield this.clientWellKnownPromise,this.emit("WellKnown.client",this.clientWellKnown)}))}getClientWellKnown(){return this.clientWellKnown}waitForClientWellKnown(){return this.clientWellKnownPromise}storeClientOptions(){const e=["boolean","string","number"],t=Object.entries(this.clientOpts).filter((([t,r])=>e.includes(typeof r))).reduce(((e,[t,r])=>(e[t]=r,e)),{});return this.store.storeClientOptions(t)}_unstable_getSharedRooms(e){return s(this,void 0,void 0,(function*(){if(!(yield this.doesServerSupportUnstableFeature("uk.half-shot.msc2666")))throw Error("Server does not support shared_rooms API");const t=g.encodeUri("/uk.half-shot.msc2666/user/shared_rooms/$userId",{$userId:e});return(yield this.http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:R.PREFIX_UNSTABLE})).joined}))}getVersions(){return this.serverVersionsPromise||(this.serverVersionsPromise=this.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""}).catch((e=>{throw this.serverVersionsPromise=null,e}))),this.serverVersionsPromise}isVersionSupported(e){return s(this,void 0,void 0,(function*(){const{versions:t}=yield this.getVersions();return t&&t.includes(e)}))}doesServerSupportLazyLoading(){return s(this,void 0,void 0,(function*(){const e=yield this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.5.0")||r&&r["m.lazy_load_members"]}))}doesServerRequireIdServerParam(){return s(this,void 0,void 0,(function*(){const e=yield this.getVersions();if(!e)return!0;const t=e.versions;if(t&&t.includes("r0.6.0"))return!1;const r=e.unstable_features;return!r||(void 0===r["m.require_identity_server"]||r["m.require_identity_server"])}))}doesServerAcceptIdentityAccessToken(){return s(this,void 0,void 0,(function*(){const e=yield this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.6.0")||r&&r["m.id_access_token"]}))}doesServerSupportSeparateAddAndBind(){return s(this,void 0,void 0,(function*(){const e=yield this.getVersions();if(!e)return!1;const t=e.versions,r=e.unstable_features;return t&&t.includes("r0.6.0")||r&&r["m.separate_add_and_bind"]}))}doesServerSupportUnstableFeature(e){return s(this,void 0,void 0,(function*(){const t=yield this.getVersions();if(!t)return!1;const r=t.unstable_features;return r&&!!r[e]}))}doesServerForceEncryptionForPreset(e){return s(this,void 0,void 0,(function*(){const t=yield this.getVersions();if(!t)return!1;const r=t.unstable_features,n=e.includes("_chat")?e.substring(0,e.indexOf("_chat")):e;return r&&!!r[`io.element.e2ee_forced.${n}`]}))}hasLazyLoadMembersEnabled(){return!!this.clientOpts.lazyLoadMembers}setCanResetTimelineCallback(e){this.canResetTimelineCallback=e}getCanResetTimelineCallback(){return this.canResetTimelineCallback}relations(e,t,r,n,i){return s(this,void 0,void 0,(function*(){const o=this.getEncryptedIfNeededEventType(e,n),s=yield this.fetchRelations(e,t,r,o,i),a=this.getEventMapper();let u;s.original_event&&(u=a(s.original_event));let c=s.chunk.map(a);if("m.room.encrypted"===o){const e=u?c.concat(u):c;yield Promise.all(e.map((e=>new Promise((t=>e.once("Event.decrypted",t)))))),c=c.filter((e=>e.getType()===n))}return u&&"m.replace"===r&&(c=c.filter((e=>e.getSender()===u.getSender()))),{originalEvent:u,events:c,nextBatch:s.next_batch}}))}getCrossSigningCacheCallbacks(){var e;return null===(e=this.crypto)||void 0===e?void 0:e._crossSigningInfo.getCacheCallbacks()}generateClientSecret(){return F.randomString(32)}decryptEventIfNeeded(e,t){return e.shouldAttemptDecryption()&&e.attemptDecryption(this.crypto,t),e.isBeingDecrypted()?e._decryptionPromise:Promise.resolve()}termsUrlForService(e,t){switch(e){case T.SERVICE_TYPES.IS:return t+R.PREFIX_IDENTITY_V2+"/terms";case T.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}getHomeserverUrl(){return this.baseUrl}getIdentityServerUrl(e=!1){return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl}setIdentityServerUrl(e){this.idBaseUrl=g.ensureNoTrailingSlash(e),this.http.setIdBaseUrl(this.idBaseUrl)}getAccessToken(){return this.http.opts.accessToken||null}isLoggedIn(){return void 0!==this.http.opts.accessToken}makeTxnId(){return"m"+(new Date).getTime()+"."+this.txnCtr++}isUsernameAvailable(e){return this.http.authedRequest(void 0,"GET","/register/available",{username:e}).then((e=>e.available))}register(e,t,r,n,i,o,s,a){!0===i?i={email:!0}:null==i&&(i={}),"function"==typeof s&&(a=s,s=void 0),r&&(n.session=r);const u={auth:n};return null!=e&&(u.username=e),null!=t&&(u.password=t),i.email&&(u.bind_email=!0),i.msisdn&&(u.bind_msisdn=!0),null!=o&&(u.guest_access_token=o),null!=s&&(u.inhibit_login=s),null!=t&&(u.x_show_msisdn=!0),this.registerRequest(u,void 0,a)}registerGuest(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)}registerRequest(e,t,r){const n={};return t&&(n.kind=t),this.http.request(r,"POST","/register",n,e)}loginFlows(e){return this.http.request(e,"GET","/login")}login(e,t,r){const n={type:e};return g.extend(n,t),this.http.authedRequest(((e,t)=>{t&&t.access_token&&t.user_id&&(this.http.opts.accessToken=t.access_token,this.credentials={userId:t.user_id}),r&&r(e,t)}),"POST","/login",void 0,n)}loginWithPassword(e,t,r){return this.login("m.login.password",{user:e,password:t},r)}loginWithSAML2(e,t){return this.login("m.login.saml2",{relay_state:e},t)}getCasLoginUrl(e){return this.getSsoLoginUrl(e,"cas")}getSsoLoginUrl(e,t="sso",r){let n="/login/"+t+"/redirect";return r&&(n+="/"+r),this.http.getUrl(n,{redirectUrl:e},R.PREFIX_R0)}loginWithToken(e,t){return this.login("m.login.token",{token:e},t)}logout(e){return this.http.authedRequest(e,"POST","/logout")}deactivateAccount(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");const r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this.http.authedRequest(void 0,"POST","/account/deactivate",void 0,r)}getFallbackAuthUrl(e,t){const r=g.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this.http.getUrl(r,{session:t},R.PREFIX_R0)}createRoom(e,t){return s(this,void 0,void 0,(function*(){const r=(e.invite_3pid||[]).filter((e=>!e.id_access_token));if(r.length>0&&this.identityServer&&this.identityServer.getAccessToken&&(yield this.doesServerAcceptIdentityAccessToken())){const e=yield this.identityServer.getAccessToken();if(e)for(const t of r)t.id_access_token=e}return this.http.authedRequest(t,"POST","/createRoom",void 0,e)}))}fetchRelations(e,t,r,n,i){return s(this,void 0,void 0,(function*(){const o={};i.from&&(o.from=i.from);const s=g.encodeParams(o),a=g.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+s,{$roomId:e,$eventId:t,$relationType:r,$eventType:n});return yield this.http.authedRequest(void 0,"GET",a,null,null,{prefix:R.PREFIX_UNSTABLE})}))}roomState(e,t){const r=g.encodeUri("/rooms/$roomId/state",{$roomId:e});return this.http.authedRequest(t,"GET",r)}fetchRoomEvent(e,t,r){const n=g.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(r,"GET",n)}members(e,t,r,n,i){const o={};t&&(o.membership=t),r&&(o.not_membership=r),n&&(o.at=n);const s=g.encodeParams(o),a=g.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this.http.authedRequest(i,"GET",a)}upgradeRoom(e,t){const r=g.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this.http.authedRequest(void 0,"POST",r,void 0,{new_version:t})}getStateEvent(e,t,r,n){const i={$roomId:e,$eventType:t,$stateKey:r};let o=g.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==r&&(o=g.encodeUri(o+"/$stateKey",i)),this.http.authedRequest(n,"GET",o)}sendStateEvent(e,t,r,n="",i){const o={$roomId:e,$eventType:t,$stateKey:n};let s=g.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==n&&(s=g.encodeUri(s+"/$stateKey",o)),this.http.authedRequest(i,"PUT",s,void 0,r)}roomInitialSync(e,t,r){g.isFunction(t)&&(r=t,t=void 0);const n=g.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this.http.authedRequest(r,"GET",n,{limit:t})}setRoomReadMarkersHttpRequest(e,t,r,n){const i=g.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),o={"m.fully_read":t,"m.read":r,"m.hidden":Boolean(!!n&&n.hidden)};return this.http.authedRequest(void 0,"POST",i,void 0,o)}getJoinedRooms(){const e=g.encodeUri("/joined_rooms",{});return this.http.authedRequest(void 0,"GET",e)}getJoinedRoomMembers(e){const t=g.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this.http.authedRequest(void 0,"GET",t)}publicRooms(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});const r={};return e.server&&(r.server=e.server,delete e.server),0===Object.keys(e).length&&0===Object.keys(r).length?this.http.authedRequest(t,"GET","/publicRooms"):this.http.authedRequest(t,"POST","/publicRooms",r,e)}createAlias(e,t,r){const n=g.encodeUri("/directory/room/$alias",{$alias:e}),i={room_id:t};return this.http.authedRequest(r,"PUT",n,void 0,i)}deleteAlias(e,t){const r=g.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"DELETE",r,void 0,void 0)}unstableGetLocalAliases(e,t){const r=g.encodeUri("/rooms/$roomId/aliases",{$roomId:e}),n=R.PREFIX_UNSTABLE+"/org.matrix.msc2432";return this.http.authedRequest(t,"GET",r,null,null,{prefix:n})}getRoomIdForAlias(e,t){const r=g.encodeUri("/directory/room/$alias",{$alias:e});return this.http.authedRequest(t,"GET",r)}resolveRoomAlias(e,t){const r=g.encodeUri("/directory/room/$alias",{$alias:e});return this.http.request(t,"GET",r)}getRoomDirectoryVisibility(e,t){const r=g.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(t,"GET",r)}setRoomDirectoryVisibility(e,t,r){const n=g.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this.http.authedRequest(r,"PUT",n,void 0,{visibility:t})}setRoomDirectoryVisibilityAppService(e,t,r,n){const i=g.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this.http.authedRequest(n,"PUT",i,void 0,{visibility:r})}searchUserDirectory(e){const t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this.http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)}uploadContent(e,t){return this.http.uploadContent(e,t)}cancelUpload(e){return this.http.cancelUpload(e)}getCurrentUploads(){return this.http.getCurrentUploads()}getProfileInfo(e,t,r){g.isFunction(t)&&(r=t,t=void 0);const n=t?g.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):g.encodeUri("/profile/$userId",{$userId:e});return this.http.authedRequest(r,"GET",n)}getThreePids(e){return this.http.authedRequest(e,"GET","/account/3pid",void 0,void 0)}addThreePid(e,t,r){const n={threePidCreds:e,bind:t};return this.http.authedRequest(r,"POST","/account/3pid",null,n)}addThreePidOnly(e){return s(this,void 0,void 0,(function*(){const t=(yield this.isVersionSupported("r0.6.0"))?R.PREFIX_R0:R.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,"POST","/account/3pid/add",null,e,{prefix:t})}))}bindThreePid(e){return s(this,void 0,void 0,(function*(){const t=(yield this.isVersionSupported("r0.6.0"))?R.PREFIX_R0:R.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,"POST","/account/3pid/bind",null,e,{prefix:t})}))}unbindThreePid(e,t){return s(this,void 0,void 0,(function*(){const r={medium:e,address:t,id_server:this.getIdentityServerUrl(!0)},n=(yield this.isVersionSupported("r0.6.0"))?R.PREFIX_R0:R.PREFIX_UNSTABLE;return this.http.authedRequest(void 0,"POST","/account/3pid/unbind",null,r,{prefix:n})}))}deleteThreePid(e,t){const r={medium:e,address:t};return this.http.authedRequest(void 0,"POST","/account/3pid/delete",null,r)}setPassword(e,t,r){const n={auth:e,new_password:t};return this.http.authedRequest(r,"POST","/account/password",null,n)}getDevices(){return this.http.authedRequest(void 0,"GET","/devices",void 0,void 0)}getDevice(e){const t=g.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"GET",t,void 0,void 0)}setDeviceDetails(e,t){const r=g.encodeUri("/devices/$device_id",{$device_id:e});return this.http.authedRequest(void 0,"PUT",r,void 0,t)}deleteDevice(e,t){const r=g.encodeUri("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this.http.authedRequest(void 0,"DELETE",r,void 0,n)}deleteMultipleDevices(e,t){const r={devices:e};t&&(r.auth=t);return this.http.authedRequest(void 0,"POST","/delete_devices",void 0,r)}getPushers(e){return this.http.authedRequest(e,"GET","/pushers",void 0,void 0)}setPusher(e,t){return this.http.authedRequest(t,"POST","/pushers/set",null,e)}getPushRules(e){return this.http.authedRequest(e,"GET","/pushrules/").then((e=>m.PushProcessor.rewriteDefaultRules(e)))}addPushRule(e,t,r,n,i){const o=g.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(i,"PUT",o,void 0,n)}deletePushRule(e,t,r,n){const i=g.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this.http.authedRequest(n,"DELETE",i)}setPushRuleEnabled(e,t,r,n,i){const o=g.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this.http.authedRequest(i,"PUT",o,void 0,{enabled:n})}setPushRuleActions(e,t,r,n,i){const o=g.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this.http.authedRequest(i,"PUT",o,void 0,{actions:n})}search(e,t){const r={};return e.next_batch&&(r.next_batch=e.next_batch),this.http.authedRequest(t,"POST","/search",r,e.body)}uploadKeysRequest(e,t,r){return this.http.authedRequest(r,"POST","/keys/upload",void 0,e)}uploadKeySignatures(e){return this.http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:R.PREFIX_UNSTABLE})}downloadKeysForUsers(e,t){if(g.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");const r={device_keys:{}};return"token"in(t=t||{})&&(r.token=t.token),e.forEach((e=>{r.device_keys[e]=[]})),this.http.authedRequest(void 0,"POST","/keys/query",void 0,r)}claimOneTimeKeys(e,t="signed_curve25519",r){const n={};void 0===t&&(t="signed_curve25519");for(let r=0;r<e.length;++r){const i=e[r][0],o=e[r][1],s=n[i]||{};n[i]=s,s[o]=t}const i={one_time_keys:n};r&&(i.timeout=r);return this.http.authedRequest(void 0,"POST","/keys/claim",void 0,i)}getKeyChanges(e,t){const r={from:e,to:t};return this.http.authedRequest(void 0,"GET","/keys/changes",r,void 0)}uploadDeviceSigningKeys(e,t){const r=Object.assign({},t);return e&&Object.assign(r,{auth:e}),this.http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,r,{prefix:R.PREFIX_UNSTABLE})}registerWithIdentityServer(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");const t=this.idBaseUrl+R.PREFIX_IDENTITY_V2+"/account/register";return this.http.requestOtherUrl(void 0,"POST",t,null,e)}requestEmailToken(e,t,r,n,i,o){return s(this,void 0,void 0,(function*(){const s={client_secret:t,email:e,send_attempt:r,next_link:n};return yield this.http.idServerRequest(i,"POST","/validate/email/requestToken",s,R.PREFIX_IDENTITY_V2,o)}))}requestMsisdnToken(e,t,r,n,i,o,a){return s(this,void 0,void 0,(function*(){const s={client_secret:r,country:e,phone_number:t,send_attempt:n,next_link:i};return yield this.http.idServerRequest(o,"POST","/validate/msisdn/requestToken",s,R.PREFIX_IDENTITY_V2,a)}))}submitMsisdnToken(e,t,r,n){return s(this,void 0,void 0,(function*(){const i={sid:e,client_secret:t,token:r};return yield this.http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,R.PREFIX_IDENTITY_V2,n)}))}submitMsisdnTokenOtherUrl(e,t,r,n){const i={sid:t,client_secret:r,token:n};return this.http.requestOtherUrl(void 0,"POST",e,void 0,i)}getIdentityHashDetails(e){return this.http.idServerRequest(void 0,"GET","/hash_details",null,R.PREFIX_IDENTITY_V2,e)}identityHashedLookup(e,r){return s(this,void 0,void 0,(function*(){const n={},i=yield this.getIdentityHashDetails(r);if(!i||!i.lookup_pepper||!i.algorithms)throw new Error("Unsupported identity server: bad response");n.pepper=i.lookup_pepper;const o={};if(i.algorithms.includes("sha256")){const r=new t.Olm.Utility;n.addresses=e.map((e=>{const t=e[0].toLowerCase(),i=e[1].toLowerCase(),s=r.sha256(`${t} ${i} ${n.pepper}`).replace(/\+/g,"-").replace(/\//g,"_");return o[s]=e[0],s})),n.algorithm="sha256"}else{if(!i.algorithms.includes("none"))throw new Error("Unsupported identity server: unknown hash algorithm");n.addresses=e.map((e=>{const t=`${e[0].toLowerCase()} ${e[1].toLowerCase()}`;return o[t]=e[0],t})),n.algorithm="none"}const s=yield this.http.idServerRequest(void 0,"POST","/lookup",n,R.PREFIX_IDENTITY_V2,r);if(!s||!s.mappings)return[];const a=[];for(const e of Object.keys(s.mappings)){const t=s.mappings[e],r=o[e];if(!r)throw new Error("Identity server returned more results than expected");a.push({address:r,mxid:t})}return a}))}lookupThreePid(e,t,r,n){return s(this,void 0,void 0,(function*(){const i=(yield this.identityHashedLookup([[t,e]],n)).find((e=>e.address===t));if(!i)return r&&r(null,{}),{};const o={address:t,medium:e,mxid:i.mxid};return r&&r(null,o),o}))}bulkLookupThreePids(e,t){return s(this,void 0,void 0,(function*(){const r=yield this.identityHashedLookup(e.map((e=>[e[1],e[0]])),t),n=[];for(const t of r){const r=e.find((e=>e[1]===t.address));if(!r)throw new Error("Identity sever returned unexpected results");n.push([r[0],t.address,t.mxid])}return{threepids:n}}))}getIdentityAccount(e){return this.http.idServerRequest(void 0,"GET","/account",void 0,R.PREFIX_IDENTITY_V2,e)}sendToDevice(e,t,r){const n=g.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),i={messages:t},o=Object.keys(t).reduce(((e,r)=>(e[r]=Object.keys(t[r]),e)),{});return I.logger.log(`PUT ${n}`,o),this.http.authedRequest(void 0,"PUT",n,void 0,i)}getThirdpartyProtocols(){return this.http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then((e=>{if(!e||"object"!=typeof e)throw new Error(`/thirdparty/protocols did not return an object: ${e}`);return e}))}getThirdpartyLocation(e,t){const r=g.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",r,t,void 0)}getThirdpartyUser(e,t){const r=g.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this.http.authedRequest(void 0,"GET",r,t,void 0)}getTerms(e,t){const r=this.termsUrlForService(e,t);return this.http.requestOtherUrl(void 0,"GET",r)}agreeToTerms(e,t,r,n){const i=this.termsUrlForService(e,t),o={Authorization:"Bearer "+r};return this.http.requestOtherUrl(void 0,"POST",i,null,{user_accepts:n},{headers:o})}reportEvent(e,t,r,n){const i=g.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this.http.authedRequest(void 0,"POST",i,null,{score:r,reason:n})}getSpaceSummary(e,t,r,n,i,o){const s=g.encodeUri("/rooms/$roomId/spaces",{$roomId:e});return this.http.authedRequest(void 0,"POST",s,null,{max_rooms_per_space:t,suggested_only:r,auto_join_only:n,limit:i,batch:o},{prefix:"/_matrix/client/unstable/org.matrix.msc2946"})}unstableCreateFileTree(e){return s(this,void 0,void 0,(function*(){const{room_id:t}=yield this.createRoom({name:e,preset:L.Preset.PrivateChat,power_level_content_override:Object.assign(Object.assign({},V.DEFAULT_TREE_POWER_LEVELS_TEMPLATE),{users:{[this.getUserId()]:100}}),creation_content:{[B.RoomCreateTypeField]:B.RoomType.Space},initial_state:[{type:B.UNSTABLE_MSC3088_PURPOSE.name,state_key:B.UNSTABLE_MSC3089_TREE_SUBTYPE.name,content:{[B.UNSTABLE_MSC3088_ENABLED.name]:!0}},{type:B.EventType.RoomEncryption,state_key:"",content:{algorithm:S.MEGOLM_ALGORITHM}}]});return new V.MSC3089TreeSpace(this,t)}))}unstableGetFileTreeSpace(e){var t,r;const n=this.getRoom(e);if(!n)return null;const i=n.currentState.getStateEvents(B.EventType.RoomCreate,""),o=n.currentState.getStateEvents(B.UNSTABLE_MSC3088_PURPOSE.name,B.UNSTABLE_MSC3089_TREE_SUBTYPE.name);if(!i)throw new Error("Expected single room create event");return(null===(t=null==o?void 0:o.getContent())||void 0===t?void 0:t[B.UNSTABLE_MSC3088_ENABLED.name])?(null===(r=i.getContent())||void 0===r?void 0:r[B.RoomCreateTypeField])!==B.RoomType.Space?null:new V.MSC3089TreeSpace(this,e):null}getGroupSummary(e){const t=g.encodeUri("/groups/$groupId/summary",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupProfile(e){const t=g.encodeUri("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}setGroupProfile(e,t){const r=g.encodeUri("/groups/$groupId/profile",{$groupId:e});return this.http.authedRequest(void 0,"POST",r,void 0,t)}setGroupJoinPolicy(e,t){const r=g.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this.http.authedRequest(void 0,"PUT",r,void 0,{"m.join_policy":t})}getGroupUsers(e){const t=g.encodeUri("/groups/$groupId/users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupInvitedUsers(e){const t=g.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}getGroupRooms(e){const t=g.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this.http.authedRequest(void 0,"GET",t)}inviteUserToGroup(e,t){const r=g.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",r,void 0,{})}removeUserFromGroup(e,t){const r=g.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"PUT",r,void 0,{})}addUserToGroupSummary(e,t,r){const n=g.encodeUri(r?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:r,$userId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeUserFromGroupSummary(e,t){const r=g.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this.http.authedRequest(void 0,"DELETE",r,void 0,{})}addRoomToGroupSummary(e,t,r){const n=g.encodeUri(r?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:r,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{})}removeRoomFromGroupSummary(e,t){const r=g.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",r,void 0,{})}addRoomToGroup(e,t,r){void 0===r&&(r=!0);const n=g.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:r?"public":"private"}})}updateGroupRoomVisibility(e,t,r){const n=g.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"PUT",n,void 0,{type:r?"public":"private"})}removeRoomFromGroup(e,t){const r=g.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this.http.authedRequest(void 0,"DELETE",r,void 0,{})}acceptGroupInvite(e,t=null){const r=g.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this.http.authedRequest(void 0,"PUT",r,void 0,t||{})}joinGroup(e){const t=g.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}leaveGroup(e){const t=g.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this.http.authedRequest(void 0,"PUT",t,void 0,{})}getJoinedGroups(){const e=g.encodeUri("/joined_groups",{});return this.http.authedRequest(void 0,"GET",e)}createGroup(e){const t=g.encodeUri("/create_group",{});return this.http.authedRequest(void 0,"POST",t,void 0,e)}getPublicisedGroups(e){const t=g.encodeUri("/publicised_groups",{});return this.http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})}setGroupPublicity(e,t){const r=g.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this.http.authedRequest(void 0,"PUT",r,void 0,{publicise:t})}}r.MatrixClient=H,H.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY"}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./@types/event":54,"./@types/partials":55,"./ReEmitter":57,"./autodiscovery":58,"./content-helpers":61,"./content-repo":62,"./crypto":79,"./crypto/RoomList":68,"./crypto/api":75,"./crypto/backup":76,"./crypto/dehydration":77,"./crypto/key_passphrase":80,"./crypto/olmlib":81,"./crypto/recoverykey":82,"./event-mapper":96,"./filter":98,"./http-api":99,"./logger":102,"./models/MSC3089TreeSpace":105,"./models/event":109,"./models/event-timeline":108,"./models/search-result":116,"./models/user":117,"./pushprocessor":118,"./randomstring":119,"./service-types":122,"./store/stub":128,"./sync":131,"./sync.api":130,"./utils":133,"./webrtc/call":134,"./webrtc/callEventHandler":135,events:36,url:52}],61:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.makeHtmlMessage=function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeHtmlNotice=function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeHtmlEmote=function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},r.makeTextMessage=function(e){return{msgtype:"m.text",body:e}},r.makeNotice=function(e){return{msgtype:"m.notice",body:e}},r.makeEmoteMessage=function(e){return{msgtype:"m.emote",body:e}}},{}],62:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.getHttpUriForMxc=function(e,t,r,n,o,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";var a=t.slice(6),u="/_matrix/media/r0/download/",c={};r&&(c.width=Math.round(r));n&&(c.height=Math.round(n));o&&(c.method=o);Object.keys(c).length>0&&(u="/_matrix/media/r0/thumbnail/");var l=a.indexOf("#"),d="";l>=0&&(d=a.substr(l),a=a.substr(0,l));return e+u+a+(0===Object.keys(c).length?"":"?"+i.encodeParams(c))+d};var i=n(e("./utils"))},{"./utils":133,"@babel/runtime/helpers/interopRequireWildcard":13}],63:[function(e,t,r){(function(t,n){(function(){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.createCryptoStoreCacheCallbacks=function(e,t){return{getCrossSigningKeyCache:(i=(0,u.default)(a.default.mark((function r(i,o){var s,u,c;return a.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,new Promise((function(t){return e.doTxn("readonly",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(function(r){e.getSecretStorePrivateKey(r,t,i)}))}));case 2:if(!(s=r.sent)||!s.ciphertext){r.next=11;break}return u=n.from(t._pickleKey),r.next=7,(0,_.decryptAES)(s,u,i);case 7:return c=r.sent,r.abrupt("return",(0,g.decodeBase64)(c));case 11:return r.abrupt("return",s);case 12:case"end":return r.stop()}}),r)}))),function(e,t){return i.apply(this,arguments)}),storeCrossSigningKeyCache:(r=(0,u.default)(a.default.mark((function r(i,o){var s;return a.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o instanceof Uint8Array){r.next=2;break}throw new Error("storeCrossSigningKeyCache expects Uint8Array, got ".concat(o));case 2:return s=n.from(t._pickleKey),r.next=5,(0,_.encryptAES)((0,g.encodeBase64)(o),s,i);case 5:return o=r.sent,r.abrupt("return",e.doTxn("readwrite",[m.IndexedDBCryptoStore.STORE_ACCOUNT],(function(t){e.storeSecretStorePrivateKey(t,i,o)})));case 7:case"end":return r.stop()}}),r)}))),function(e,t){return r.apply(this,arguments)})};var r;var i},r.requestKeysDuringVerification=function(e,t,r){return x.apply(this,arguments)},r.DeviceTrustLevel=r.UserTrustLevel=r.CrossSigningLevel=r.CrossSigningInfo=void 0;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/asyncToGenerator")),c=i(e("@babel/runtime/helpers/classCallCheck")),l=i(e("@babel/runtime/helpers/createClass")),d=i(e("@babel/runtime/helpers/assertThisInitialized")),h=i(e("@babel/runtime/helpers/inherits")),f=i(e("@babel/runtime/helpers/possibleConstructorReturn")),p=i(e("@babel/runtime/helpers/getPrototypeOf")),g=e("./olmlib"),v=e("events"),y=e("../logger"),m=e("../crypto/store/indexeddb-crypto-store"),_=e("./aes");function b(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return S(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return S(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function S(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function k(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,p.default)(e);if(t){var i=(0,p.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,f.default)(this,r)}}function E(e){return Object.values(e.keys)[0]}var w=function(e){(0,h.default)(C,e);var r,n,i,f,p,v,m,_,S,w,x=k(C);function C(e,t,r){var n;return(0,c.default)(this,C),n=x.call(this),Object.defineProperty((0,d.default)(n),"userId",{enumerable:!0,value:e}),n._callbacks=t||{},n._cacheCallbacks=r||{},n.keys={},n.firstUse=!0,n.crossSigningVerifiedBefore=!1,n}return(0,l.default)(C,[{key:"toStorage",value:function(){return{keys:this.keys,firstUse:this.firstUse,crossSigningVerifiedBefore:this.crossSigningVerifiedBefore}}},{key:"getCrossSigningKey",value:(w=(0,u.default)(a.default.mark((function e(r,n){var i,o,s,u,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=function(e){if(e){var r=new t.Olm.PkSigning,i=r.init_with_seed(e);if(i===n)return[i,r];r.free()}},i=["master","self_signing","user_signing"].indexOf(r)>=0,this._callbacks.getCrossSigningKey){e.next=4;break}throw new Error("No getCrossSigningKey callback supplied");case 4:if(void 0===n&&(n=this.getId(r)),!this._cacheCallbacks.getCrossSigningKeyCache||!i){e.next=9;break}return e.next=8,this._cacheCallbacks.getCrossSigningKeyCache(r,n);case 8:s=e.sent;case 9:if(!(u=o(s))){e.next=12;break}return e.abrupt("return",u);case 12:return e.next=14,this._callbacks.getCrossSigningKey(r,n);case 14:if(s=e.sent,!(c=o(s))){e.next=21;break}if(!this._cacheCallbacks.storeCrossSigningKeyCache||!i){e.next=20;break}return e.next=20,this._cacheCallbacks.storeCrossSigningKeyCache(r,s);case 20:return e.abrupt("return",c);case 21:if(s){e.next=23;break}throw new Error("getCrossSigningKey callback for "+r+" returned falsey");case 23:throw new Error("Key type "+r+" from getCrossSigningKey callback did not match");case 24:case"end":return e.stop()}}),e,this)}))),function(e,t){return w.apply(this,arguments)})},{key:"isStoredInSecretStorage",value:(S=(0,u.default)(a.default.mark((function e(t){var r,n,i,o,s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=function(e){for(var t=0,n=Object.keys(r);t<n.length;t++){var i=n[t];e[i]||delete r[i]}},e.next=3,t.isStored("m.cross_signing.master",!1);case 3:if(e.t0=e.sent,e.t0){e.next=6;break}e.t0={};case 6:r=e.t0,i=0,o=["self_signing","user_signing"];case 8:if(!(i<o.length)){e.next=21;break}return s=o[i],e.t1=n,e.next=13,t.isStored("m.cross_signing.".concat(s),!1);case 13:if(e.t2=e.sent,e.t2){e.next=16;break}e.t2={};case 16:e.t3=e.t2,(0,e.t1)(e.t3);case 18:i++,e.next=8;break;case 21:return e.abrupt("return",Object.keys(r).length?r:null);case 22:case"end":return e.stop()}}),e)}))),function(e){return S.apply(this,arguments)})},{key:"isStoredInKeyCache",value:(_=(0,u.default)(a.default.mark((function e(t){var r,n,i,o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._cacheCallbacks){e.next=3;break}return e.abrupt("return",!1);case 3:n=0,i=t?[t]:["master","self_signing","user_signing"];case 5:if(!(n<i.length)){e.next=14;break}return o=i[n],e.next=9,r.getCrossSigningKeyCache(o);case 9:if(e.sent){e.next=11;break}return e.abrupt("return",!1);case 11:n++,e.next=5;break;case 14:return e.abrupt("return",!0);case 15:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"getCrossSigningKeysFromCache",value:(m=(0,u.default)(a.default.mark((function e(){var t,r,n,i,o,s;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=new Map,r=this._cacheCallbacks){e.next=4;break}return e.abrupt("return",t);case 4:n=0,i=["master","self_signing","user_signing"];case 5:if(!(n<i.length)){e.next=16;break}return o=i[n],e.next=9,r.getCrossSigningKeyCache(o);case 9:if(s=e.sent){e.next=12;break}return e.abrupt("continue",13);case 12:t.set(o,s);case 13:n++,e.next=5;break;case 16:return e.abrupt("return",t);case 17:case"end":return e.stop()}}),e,this)}))),function(){return m.apply(this,arguments)})},{key:"getId",value:function(e){return e=e||"master",this.keys[e]?E(this.keys[e]):null}},{key:"resetKeys",value:(v=(0,u.default)(a.default.mark((function e(r){var n,i,u,c,l,d,h,f,p,v;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._callbacks.saveCrossSigningKeys){e.next=2;break}throw new Error("No saveCrossSigningKeys callback supplied");case 2:if(!(void 0===r||r&I.MASTER)&&this.keys.master){e.next=6;break}r=I.MASTER|I.USER_SIGNING|I.SELF_SIGNING,e.next=8;break;case 6:if(0!==r){e.next=8;break}return e.abrupt("return");case 8:if(n={},i={},e.prev=10,!(r&I.MASTER)){e.next=18;break}u=new t.Olm.PkSigning,n.master=u.generate_seed(),c=u.init_with_seed(n.master),i.master={user_id:this.userId,usage:["master"],keys:(0,s.default)({},"ed25519:"+c,c)},e.next=24;break;case 18:return e.next=20,this.getCrossSigningKey("master");case 20:l=e.sent,d=(0,o.default)(l,2),c=d[0],u=d[1];case 24:if(r&I.SELF_SIGNING){h=new t.Olm.PkSigning;try{n.self_signing=h.generate_seed(),f=h.init_with_seed(n.self_signing),i.self_signing={user_id:this.userId,usage:["self_signing"],keys:(0,s.default)({},"ed25519:"+f,f)},(0,g.pkSign)(i.self_signing,u,this.userId,c)}finally{h.free()}}if(r&I.USER_SIGNING){p=new t.Olm.PkSigning;try{n.user_signing=p.generate_seed(),v=p.init_with_seed(n.user_signing),i.user_signing={user_id:this.userId,usage:["user_signing"],keys:(0,s.default)({},"ed25519:"+v,v)},(0,g.pkSign)(i.user_signing,u,this.userId,c)}finally{p.free()}}Object.assign(this.keys,i),this._callbacks.saveCrossSigningKeys(n);case 28:return e.prev=28,u&&u.free(),e.finish(28);case 31:case"end":return e.stop()}}),e,this,[[10,,28,31]])}))),function(e){return v.apply(this,arguments)})},{key:"clearKeys",value:function(){this.keys={}}},{key:"setKeys",value:function(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw y.logger.error(r),new Error(r)}this.keys.master?E(e.master)!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}var n=E(t.master);if(e.user_signing){if(e.user_signing.user_id!==this.userId){var i="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw y.logger.error(i),new Error(i)}try{(0,g.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw y.logger.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var o="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw y.logger.error(o),new Error(o)}try{(0,g.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw y.logger.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,this.keys.self_signing=null,this.keys.user_signing=null),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}},{key:"updateCrossSigningVerifiedBefore",value:function(e){!this.crossSigningVerifiedBefore&&e&&(this.crossSigningVerifiedBefore=!0)}},{key:"signObject",value:(p=(0,u.default)(a.default.mark((function e(t,r){var n,i,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keys[r]){e.next=2;break}throw new Error("Attempted to sign with "+r+" key but no such key present");case 2:return e.next=4,this.getCrossSigningKey(r);case 4:return n=e.sent,i=(0,o.default)(n,2),s=i[0],u=i[1],e.prev=8,(0,g.pkSign)(t,u,this.userId,s),e.abrupt("return",t);case 11:return e.prev=11,u.free(),e.finish(11);case 14:case"end":return e.stop()}}),e,this,[[8,,11,14]])}))),function(e,t){return p.apply(this,arguments)})},{key:"signUser",value:(f=(0,u.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keys.user_signing){e.next=3;break}return y.logger.info("No user signing key: not signing user"),e.abrupt("return");case 3:return e.abrupt("return",this.signObject(t.keys.master,"user_signing"));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"signDevice",value:(i=(0,u.default)(a.default.mark((function e(t,r){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t===this.userId){e.next=2;break}throw new Error("Trying to sign ".concat(t,"'s device; can only sign our own device"));case 2:if(this.keys.self_signing){e.next=5;break}return y.logger.info("No self signing key: not signing device"),e.abrupt("return");case 5:return e.abrupt("return",this.signObject({algorithms:r.algorithms,keys:r.keys,device_id:r.deviceId,user_id:t},"self_signing"));case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"checkUserTrust",value:function(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new T(!0,!0,this.firstUse);if(!this.keys.user_signing)return new T(!1,!1,e.firstUse);var t,r=e.keys.master,n=this.getId("user_signing");try{(0,g.pkVerify)(r,n,this.userId),t=!0}catch(e){t=!1}return new T(t,e.crossSigningVerifiedBefore,e.firstUse)}},{key:"checkDeviceTrust",value:function(e,t,r,n){var i=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new R(!1,!1,r,n);var s=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,g.pkVerify)(o,e.getId(),e.userId),(0,g.pkVerify)(s,E(o),e.userId),R.fromUserTrustLevel(i,r,n)}catch(e){return new R(!1,!1,r,n)}}},{key:"getCacheCallbacks",value:function(){return this._cacheCallbacks}}],[{key:"fromStorage",value:function(e,t){var r=new C(t);for(var n in e)e.hasOwnProperty(n)&&(r[n]=e[n]);return r}},{key:"storeInSecretStorage",value:(n=(0,u.default)(a.default.mark((function e(t,r){var n,i,s,u,c,l;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=b(t),e.prev=1,n.s();case 3:if((i=n.n()).done){e.next=10;break}return s=(0,o.default)(i.value,2),u=s[0],c=s[1],l=(0,g.encodeBase64)(c),e.next=8,r.store("m.cross_signing.".concat(u),l);case 8:e.next=3;break;case 10:e.next=15;break;case 12:e.prev=12,e.t0=e.catch(1),n.e(e.t0);case 15:return e.prev=15,n.f(),e.finish(15);case 18:case"end":return e.stop()}}),e,null,[[1,12,15,18]])}))),function(e,t){return n.apply(this,arguments)})},{key:"getFromSecretStorage",value:(r=(0,u.default)(a.default.mark((function e(t,r){var n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.get("m.cross_signing.".concat(t));case 2:if(n=e.sent){e.next=5;break}return e.abrupt("return",null);case 5:return e.abrupt("return",(0,g.decodeBase64)(n));case 6:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})}]),C}(v.EventEmitter);r.CrossSigningInfo=w;var I={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1};r.CrossSigningLevel=I;var T=function(){function e(t,r,n){(0,c.default)(this,e),this._crossSigningVerified=t,this._crossSigningVerifiedBefore=r,this._tofu=n}return(0,l.default)(e,[{key:"isVerified",value:function(){return this.isCrossSigningVerified()}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"wasCrossSigningVerified",value:function(){return this._crossSigningVerifiedBefore}},{key:"isTofu",value:function(){return this._tofu}}]),e}();r.UserTrustLevel=T;var R=function(){function e(t,r,n,i){(0,c.default)(this,e),this._crossSigningVerified=t,this._tofu=r,this._localVerified=n,this._trustCrossSignedDevices=i}return(0,l.default)(e,[{key:"isVerified",value:function(){return Boolean(this.isLocallyVerified()||this._trustCrossSignedDevices&&this.isCrossSigningVerified())}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"isLocallyVerified",value:function(){return this._localVerified}},{key:"isTofu",value:function(){return this._tofu}}],[{key:"fromUserTrustLevel",value:function(t,r,n){return new e(t._crossSigningVerified,t._tofu,r,n)}}]),e}();function x(){return(x=(0,u.default)(a.default.mark((function e(t,r,n){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.getUserId()===r){e.next=2;break}return e.abrupt("return");case 2:return y.logger.log("Cross-signing: Self-verification done; requesting keys"),e.abrupt("return",new Promise((function(e,r){var i,o=t,s=o.crypto._crossSigningInfo,c=new w(s.userId,{getCrossSigningKey:(i=(0,u.default)(a.default.mark((function e(t){var r,i,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return y.logger.debug("Cross-signing: requesting secret",t,n),r=o.requestSecret("m.cross_signing.".concat(t),[n]),i=r.promise,e.next=4,i;case 4:return s=e.sent,u=(0,g.decodeBase64)(s),e.abrupt("return",Uint8Array.from(u));case 7:case"end":return e.stop()}}),e)}))),function(e){return i.apply(this,arguments)})},s._cacheCallbacks);c.keys=s.keys;var l=new Promise((function(e,t){setTimeout(e,6e4,new Error("Timeout"))})),d=new Promise(function(){var e=(0,u.default)(a.default.mark((function e(t){var r,i,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,o.crypto.getSessionBackupPrivateKey();case 2:if(e.sent){e.next=18;break}return y.logger.info("No cached backup key found. Requesting..."),r=o.requestSecret("m.megolm_backup.v1",[n]),e.next=8,r.promise;case 8:return i=e.sent,y.logger.info("Got key backup key, decoding..."),s=(0,g.decodeBase64)(i),y.logger.info("Decoded backup key, storing..."),o.crypto.storeSessionBackupPrivateKey(Uint8Array.from(s)),y.logger.info("Backup key stored. Starting backup restore..."),e.next=16,o.getKeyBackupVersion();case 16:u=e.sent,o.restoreKeyBackupWithCache(void 0,void 0,u).then((function(){y.logger.info("Backup restored.")}));case 18:t();case 19:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());return Promise.race([Promise.all([c.getCrossSigningKey("master"),c.getCrossSigningKey("self_signing"),c.getCrossSigningKey("user_signing"),d]),l]).then(e,r)})).catch((function(e){y.logger.warn("Cross-signing: failure while requesting keys:",e)})));case 4:case"end":return e.stop()}}),e)})))).apply(this,arguments)}r.DeviceTrustLevel=R}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../crypto/store/indexeddb-crypto-store":84,"../logger":102,"./aes":70,"./olmlib":81,"@babel/runtime/helpers/assertThisInitialized":4,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,buffer:34,events:36}],64:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceList=void 0;var o=i(e("@babel/runtime/helpers/toConsumableArray")),s=i(e("@babel/runtime/helpers/slicedToArray")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/asyncToGenerator")),c=i(e("@babel/runtime/helpers/classCallCheck")),l=i(e("@babel/runtime/helpers/createClass")),d=i(e("@babel/runtime/helpers/assertThisInitialized")),h=i(e("@babel/runtime/helpers/inherits")),f=i(e("@babel/runtime/helpers/possibleConstructorReturn")),p=i(e("@babel/runtime/helpers/getPrototypeOf")),g=e("events"),v=e("../logger"),y=e("./deviceinfo"),m=e("./CrossSigning"),_=n(e("./olmlib")),b=e("./store/indexeddb-crypto-store"),S=e("../utils");function k(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return E(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return E(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function w(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,p.default)(e);if(t){var i=(0,p.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,f.default)(this,r)}}var I=function(e){(0,h.default)(i,e);var t,r,n=w(i);function i(e,t,r){var o,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:250;return(0,c.default)(this,i),(o=n.call(this))._cryptoStore=t,o._devices={},o._crossSigningInfo={},o._userByIdentityKey={},o._deviceTrackingStatus={},o._syncToken=null,o._serialiser=new T(e,r,(0,d.default)(o)),o._keyDownloadsInProgressByUser={},o._keyDownloadChunkSize=s,o._dirty=!1,o._savePromise=null,o._resolveSavePromise=null,o._savePromiseTime=null,o._saveTimer=null,o._hasFetched=null,o}return(0,l.default)(i,[{key:"load",value:(r=(0,u.default)(a.default.mark((function e(){var t,r,n,i=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[b.IndexedDBCryptoStore.STORE_DEVICE_DATA],(function(e){i._cryptoStore.getEndToEndDeviceData(e,(function(e){i._hasFetched=Boolean(e&&e.devices),i._devices=e?e.devices:{},i._crossSigningInfo=e&&e.crossSigningInfo||{},i._deviceTrackingStatus=e?e.trackingStatus:{},i._syncToken=e?e.syncToken:null,i._userByIdentityKey={};for(var t=0,r=Object.keys(i._devices);t<r.length;t++)for(var n=r[t],o=i._devices[n],s=0,a=Object.keys(o);s<a.length;s++){var u=a[s],c=o[u].keys["curve25519:"+u];void 0!==c&&(i._userByIdentityKey[c]=n)}}))}));case 2:for(t=0,r=Object.keys(this._deviceTrackingStatus);t<r.length;t++)n=r[t],2==this._deviceTrackingStatus[n]&&(this._deviceTrackingStatus[n]=1);case 3:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"stop",value:function(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}},{key:"saveIfDirty",value:(t=(0,u.default)(a.default.mark((function e(t){var r,n,i,o=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._dirty){e.next=2;break}return e.abrupt("return",Promise.resolve(!1));case 2:return void 0===t&&(t=500),r=Date.now+t,this._savePromiseTime&&r<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null),null===(n=this._savePromise)&&(n=new Promise((function(e,t){o._resolveSavePromise=e})),this._savePromise=n),null===this._saveTimer&&(i=this._resolveSavePromise,this._savePromiseTime=r,this._saveTimer=setTimeout((function(){v.logger.log("Saving device tracking data",o._syncToken),o._savePromiseTime=null,o._saveTimer=null,o._savePromise=null,o._resolveSavePromise=null,o._cryptoStore.doTxn("readwrite",[b.IndexedDBCryptoStore.STORE_DEVICE_DATA],(function(e){o._cryptoStore.storeEndToEndDeviceData({devices:o._devices,crossSigningInfo:o._crossSigningInfo,trackingStatus:o._deviceTrackingStatus,syncToken:o._syncToken},e)})).then((function(){o._dirty=!1,i()}),(function(e){v.logger.error("Failed to save device tracking data",o._syncToken),v.logger.error(e)}))}),t)),e.abrupt("return",n);case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getSyncToken",value:function(){return this._syncToken}},{key:"setSyncToken",value:function(e){this._syncToken=e}},{key:"downloadKeys",value:function(e,t){var r=this,n=[],i=[];if(e.forEach((function(e){var o=r._deviceTrackingStatus[e];r._keyDownloadsInProgressByUser[e]?(v.logger.log("downloadKeys: already have a download in progress for "+"".concat(e,": awaiting its result")),i.push(r._keyDownloadsInProgressByUser[e])):(t||3!=o)&&n.push(e)})),0!=n.length){v.logger.log("downloadKeys: downloading for",n);var o=this._doKeyDownload(n);i.push(o)}return 0===i.length&&v.logger.log("downloadKeys: already have all necessary keys"),Promise.all(i).then((function(){return r._getDevicesFromStore(e)}))}},{key:"_getDevicesFromStore",value:function(e){var t={},r=this;return e.map((function(e){t[e]={},(r.getStoredDevicesForUser(e)||[]).map((function(r){t[e][r.deviceId]=r}))})),t}},{key:"getKnownUserIds",value:function(){return Object.keys(this._devices)}},{key:"getStoredDevicesForUser",value:function(e){var t=this._devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(y.DeviceInfo.fromStorage(t[n],n));return r}},{key:"getRawStoredDevicesForUser",value:function(e){return this._devices[e]}},{key:"getStoredCrossSigningForUser",value:function(e){return this._crossSigningInfo[e]?m.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}},{key:"storeCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}},{key:"getStoredDevice",value:function(e,t){var r=this._devices[e];if(r&&r[t])return y.DeviceInfo.fromStorage(r[t],t)}},{key:"getUserByIdentityKey",value:function(e,t){return e!==_.OLM_ALGORITHM&&e!==_.MEGOLM_ALGORITHM?null:this._userByIdentityKey[t]}},{key:"getDeviceByIdentityKey",value:function(e,t){var r=this.getUserByIdentityKey(e,t);if(!r)return null;var n=this._devices[r];if(!n)return null;for(var i in n)if(n.hasOwnProperty(i)){var o=n[i];for(var s in o.keys){if(o.keys.hasOwnProperty(s))if(0===s.indexOf("curve25519:"))if(o.keys[s]==t)return y.DeviceInfo.fromStorage(o,i)}}return null}},{key:"storeDevicesForUser",value:function(e,t){if(void 0!==this._devices[e])for(var r=0,n=Object.entries(this._devices[e]);r<n.length;r++){var i=(0,s.default)(n[r],2),o=i[0],a=i[1].keys["curve25519:"+o];delete this._userByIdentityKey[a]}this._devices[e]=t;for(var u=0,c=Object.entries(t);u<c.length;u++){var l=(0,s.default)(c[u],2),d=l[0],h=l[1].keys["curve25519:"+d];this._userByIdentityKey[h]=e}this._dirty=!0}},{key:"startTrackingDeviceList",value:function(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(v.logger.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"stopTrackingDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(v.logger.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}},{key:"stopTrackingAllDeviceLists",value:function(){for(var e=0,t=Object.keys(this._deviceTrackingStatus);e<t.length;e++){var r=t[e];this._deviceTrackingStatus[r]=0}this._dirty=!0}},{key:"invalidateUserDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(v.logger.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"refreshOutdatedDeviceLists",value:function(){this.saveIfDirty();for(var e=[],t=0,r=Object.keys(this._deviceTrackingStatus);t<r.length;t++){var n=r[t];1==this._deviceTrackingStatus[n]&&e.push(n)}return this._doKeyDownload(e)}},{key:"_setRawStoredDevicesForUser",value:function(e,t){if(void 0!==this._devices[e])for(var r=0,n=Object.entries(this._devices[e]);r<n.length;r++){var i=(0,s.default)(n[r],2),o=i[0],a=i[1].keys["curve25519:"+o];delete this._userByIdentityKey[a]}this._devices[e]=t;for(var u=0,c=Object.entries(t);u<c.length;u++){var l=(0,s.default)(c[u],2),d=l[0],h=l[1].keys["curve25519:"+d];this._userByIdentityKey[h]=e}}},{key:"setRawStoredCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t}},{key:"_doKeyDownload",value:function(e){var t=this;if(0===e.length)return Promise.resolve();var r=this._serialiser.updateDevicesForUsers(e,this._syncToken).then((function(){n(!0)}),(function(t){throw v.logger.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((function(e){t._keyDownloadsInProgressByUser[e]=r,1==t._deviceTrackingStatus[e]&&(t._deviceTrackingStatus[e]=2)}));var n=function(n){t.emit("crypto.willUpdateDevices",e,!t._hasFetched),e.forEach((function(e){(t._dirty=!0,t._keyDownloadsInProgressByUser[e]===r)?(delete t._keyDownloadsInProgressByUser[e],2==t._deviceTrackingStatus[e]&&(n?(t._deviceTrackingStatus[e]=3,v.logger.log("Device list for",e,"now up to date")):t._deviceTrackingStatus[e]=1)):v.logger.log("Another update in the queue for",e,"- not marking up-to-date")})),t.saveIfDirty(),t.emit("crypto.devicesUpdated",e,!t._hasFetched),t._hasFetched=!0};return r}}]),i}(g.EventEmitter);r.DeviceList=I;var T=function(){function e(t,r,n){(0,c.default)(this,e),this._baseApis=t,this._olmDevice=r,this._deviceList=n,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}var t;return(0,l.default)(e,[{key:"updateDevicesForUsers",value:function(e,t){var r=this;return e.forEach((function(e){r._keyDownloadsQueuedByUser[e]=!0})),this._queuedQueryDeferred||(this._queuedQueryDeferred=(0,S.defer)()),this._syncToken=t,this._downloadInProgress?(v.logger.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}},{key:"_doQueuedQueries",value:function(){var e=this;if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");var t=Object.keys(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};var r=this._queuedQueryDeferred;this._queuedQueryDeferred=null,v.logger.log("Starting key download for",t),this._downloadInProgress=!0;var n={};this._syncToken&&(n.token=this._syncToken);for(var i=[],s=function(r){var o=t.slice(r,r+e._deviceList._keyDownloadChunkSize);i.push((function(){return e._baseApis.downloadKeysForUsers(o,n)}))},c=0;c<t.length;c+=this._deviceList._keyDownloadChunkSize)s(c);return(0,S.chunkPromises)(i,3).then(function(){var r=(0,u.default)(a.default.mark((function r(n){var i,s,u,c,l,d,h;return a.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:i=Object.assign.apply(Object,[{}].concat((0,o.default)(n.map((function(e){return e.device_keys||{}}))))),s=Object.assign.apply(Object,[{}].concat((0,o.default)(n.map((function(e){return e.master_keys||{}}))))),u=Object.assign.apply(Object,[{}].concat((0,o.default)(n.map((function(e){return e.self_signing_keys||{}}))))),c=Object.assign.apply(Object,[{}].concat((0,o.default)(n.map((function(e){return e.user_signing_keys||{}}))))),l=k(t),r.prev=5,l.s();case 7:if((d=l.n()).done){r.next=21;break}return h=d.value,r.next=11,(0,S.sleep)(5);case 11:return r.prev=11,r.next=14,e._processQueryResponseForUser(h,i[h],{master:s[h],self_signing:u[h],user_signing:c[h]});case 14:r.next=19;break;case 16:r.prev=16,r.t0=r.catch(11),v.logger.error("Error processing keys for ".concat(h,":"),r.t0);case 19:r.next=7;break;case 21:r.next=26;break;case 23:r.prev=23,r.t1=r.catch(5),l.e(r.t1);case 26:return r.prev=26,l.f(),r.finish(26);case 29:case"end":return r.stop()}}),r,null,[[5,23,26,29],[11,16]])})));return function(e){return r.apply(this,arguments)}}()).then((function(){v.logger.log("Completed key download for "+t),e._downloadInProgress=!1,r.resolve(),e._queuedQueryDeferred&&e._doQueuedQueries()}),(function(n){v.logger.warn("Error downloading keys for "+t+":",n),e._downloadInProgress=!1,r.reject(n)})),r.promise}},{key:"_processQueryResponseForUser",value:(t=(0,u.default)(a.default.mark((function e(t,r,n){var i,o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return v.logger.log("got device keys for "+t+":",r),v.logger.log("got cross-signing keys for "+t+":",n),i={},(o=this._deviceList.getRawStoredDevicesForUser(t))&&Object.keys(o).forEach((function(e){var t=y.DeviceInfo.fromStorage(o[e],e);i[e]=t})),e.next=7,R(this._olmDevice,t,i,r||{},this._baseApis.getUserId(),this._baseApis.deviceId);case 7:s={},Object.keys(i).forEach((function(e){s[e]=i[e].toStorage()})),this._deviceList._setRawStoredDevicesForUser(t,s),n&&(n.master||n.self_signing||n.user_signing)&&((u=this._deviceList.getStoredCrossSigningForUser(t)||new m.CrossSigningInfo(t)).setKeys(n),this._deviceList.setRawStoredCrossSigningForUser(t,u.toStorage()),this._deviceList.emit("userCrossSigningUpdated",t));case 11:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})}]),e}();function R(e,t,r,n,i,o){return x.apply(this,arguments)}function x(){return(x=(0,u.default)(a.default.mark((function e(t,r,n,i,o,s){var u,c,l,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:u=!1,e.t0=a.default.keys(n);case 2:if((e.t1=e.t0()).done){e.next=15;break}if(c=e.t1.value,n.hasOwnProperty(c)){e.next=6;break}return e.abrupt("continue",2);case 6:if(c in i){e.next=13;break}if(r!==o||c!==s){e.next=10;break}return v.logger.warn("Local device ".concat(c," missing from sync, skipping removal")),e.abrupt("continue",2);case 10:v.logger.log("Device "+r+":"+c+" has been removed"),delete n[c],u=!0;case 13:e.next=2;break;case 15:e.t2=a.default.keys(i);case 16:if((e.t3=e.t2()).done){e.next=33;break}if(l=e.t3.value,i.hasOwnProperty(l)){e.next=20;break}return e.abrupt("continue",16);case 20:if((d=i[l]).user_id===r){e.next=24;break}return v.logger.warn("Mismatched user_id "+d.user_id+" in keys from "+r+":"+l),e.abrupt("continue",16);case 24:if(d.device_id===l){e.next=27;break}return v.logger.warn("Mismatched device_id "+d.device_id+" in keys from "+r+":"+l),e.abrupt("continue",16);case 27:return e.next=29,C(t,n,d);case 29:if(!e.sent){e.next=31;break}u=!0;case 31:e.next=16;break;case 33:return e.abrupt("return",u);case 34:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function C(e,t,r){return O.apply(this,arguments)}function O(){return(O=(0,u.default)(a.default.mark((function e(t,r,n){var i,o,s,u,c,l,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.keys){e.next=2;break}return e.abrupt("return",!1);case 2:if(i=n.device_id,o=n.user_id,s="ed25519:"+i,u=n.keys[s]){e.next=9;break}return v.logger.warn("Device "+o+":"+i+" has no ed25519 key"),e.abrupt("return",!1);case 9:return c=n.unsigned||{},l=n.signatures||{},e.prev=11,e.next=14,_.verifySignature(t,n,o,i,u);case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(11),v.logger.warn("Unable to verify signature on device "+o+":"+i+":"+e.t0),e.abrupt("return",!1);case 20:if(!(i in r)){e.next=27;break}if((d=r[i]).getFingerprint()==u){e.next=25;break}return v.logger.warn("Ed25519 key for device "+o+":"+i+" has changed"),e.abrupt("return",!1);case 25:e.next=28;break;case 27:r[i]=d=new y.DeviceInfo(i);case 28:return d.keys=n.keys||{},d.algorithms=n.algorithms||[],d.unsigned=c,d.signatures=l,e.abrupt("return",!0);case 33:case"end":return e.stop()}}),e,null,[[11,16]])})))).apply(this,arguments)}},{"../logger":102,"../utils":133,"./CrossSigning":63,"./deviceinfo":78,"./olmlib":81,"./store/indexeddb-crypto-store":84,"@babel/runtime/helpers/assertThisInitialized":4,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/helpers/toConsumableArray":23,"@babel/runtime/regenerator":27,events:36}],65:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.EncryptionSetupOperation=r.EncryptionSetupBuilder=void 0;var i=n(e("@babel/runtime/helpers/inherits")),o=n(e("@babel/runtime/helpers/possibleConstructorReturn")),s=n(e("@babel/runtime/helpers/getPrototypeOf")),a=n(e("@babel/runtime/helpers/slicedToArray")),u=n(e("@babel/runtime/regenerator")),c=n(e("@babel/runtime/helpers/asyncToGenerator")),l=n(e("@babel/runtime/helpers/classCallCheck")),d=n(e("@babel/runtime/helpers/createClass")),h=e("../logger"),f=e("../models/event"),p=e("events"),g=e("./CrossSigning"),v=e("./store/indexeddb-crypto-store"),y=e("../http-api");function m(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,s.default)(e);if(t){var i=(0,s.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,o.default)(this,r)}}function _(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return b(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var S=function(){function e(t,r){(0,l.default)(this,e),this.accountDataClientAdapter=new E(t),this.crossSigningCallbacks=new w,this.ssssCryptoCallbacks=new I(r),this._crossSigningKeys=null,this._keySignatures=null,this._keyBackupInfo=null}var t;return(0,d.default)(e,[{key:"addCrossSigningKeys",value:function(e,t){this._crossSigningKeys={authUpload:e,keys:t}}},{key:"addSessionBackup",value:function(e){this._keyBackupInfo=e}},{key:"addSessionBackupPrivateKeyToCache",value:function(e){this._sessionBackupPrivateKey=e}},{key:"addKeySignature",value:function(e,t,r){this._keySignatures||(this._keySignatures={});var n=this._keySignatures[e]||{};this._keySignatures[e]=n,n[t]=r}},{key:"setAccountData",value:function(e,t){return this.accountDataClientAdapter.setAccountData(e,t)}},{key:"buildOperation",value:function(){var e=this.accountDataClientAdapter._values;return new k(e,this._crossSigningKeys,this._keyBackupInfo,this._keySignatures)}},{key:"persist",value:(t=(0,c.default)(u.default.mark((function e(t){var r,n,i,o,s,a=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._crossSigningKeys){e.next=14;break}r=(0,g.createCryptoStoreCacheCallbacks)(t._cryptoStore,t._olmDevice),n=0,i=["master","self_signing","user_signing"];case 3:if(!(n<i.length)){e.next=12;break}return o=i[n],h.logger.log("Cache ".concat(o," cross-signing private key locally")),s=this.crossSigningCallbacks.privateKeys.get(o),e.next=9,r.storeCrossSigningKeyCache(o,s);case 9:n++,e.next=3;break;case 12:return e.next=14,t._cryptoStore.doTxn("readwrite",[v.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){t._cryptoStore.storeCrossSigningKeys(e,a._crossSigningKeys.keys)}));case 14:if(!this._sessionBackupPrivateKey){e.next=17;break}return e.next=17,t.storeSessionBackupPrivateKey(this._sessionBackupPrivateKey);case 17:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})}]),e}();r.EncryptionSetupBuilder=S;var k=function(){function e(t,r,n,i){(0,l.default)(this,e),this._accountData=t,this._crossSigningKeys=r,this._keyBackupInfo=n,this._keySignatures=i}var t;return(0,d.default)(e,[{key:"apply",value:(t=(0,c.default)(u.default.mark((function e(t){var r,n,i,o,s,c,l,d,h,f,p,g;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t._baseApis,!this._crossSigningKeys){e.next=7;break}for(n={},i=0,o=Object.entries(this._crossSigningKeys.keys);i<o.length;i++)s=(0,a.default)(o[i],2),c=s[0],l=s[1],n[c+"_key"]=l;return e.next=6,this._crossSigningKeys.authUpload((function(e){return r.uploadDeviceSigningKeys(e,n)}));case 6:t._crossSigningInfo.setKeys(this._crossSigningKeys.keys);case 7:if(!this._accountData){e.next=25;break}d=_(this._accountData),e.prev=9,d.s();case 11:if((h=d.n()).done){e.next=17;break}return f=(0,a.default)(h.value,2),p=f[0],g=f[1],e.next=15,r.setAccountData(p,g);case 15:e.next=11;break;case 17:e.next=22;break;case 19:e.prev=19,e.t0=e.catch(9),d.e(e.t0);case 22:return e.prev=22,d.f(),e.finish(22);case 25:if(!this._keySignatures){e.next=28;break}return e.next=28,r.uploadKeySignatures(this._keySignatures);case 28:if(!this._keyBackupInfo){e.next=36;break}if(!this._keyBackupInfo.version){e.next=34;break}return e.next=32,r.http.authedRequest(void 0,"PUT","/room_keys/version/"+this._keyBackupInfo.version,void 0,{algorithm:this._keyBackupInfo.algorithm,auth_data:this._keyBackupInfo.auth_data},{prefix:y.PREFIX_UNSTABLE});case 32:e.next=36;break;case 34:return e.next=36,r.http.authedRequest(void 0,"POST","/room_keys/version",void 0,this._keyBackupInfo,{prefix:y.PREFIX_UNSTABLE});case 36:case"end":return e.stop()}}),e,this,[[9,19,22,25]])}))),function(e){return t.apply(this,arguments)})}]),e}();r.EncryptionSetupOperation=k;var E=function(e){(0,i.default)(r,e);var t=m(r);function r(e){var n;return(0,l.default)(this,r),(n=t.call(this))._existingValues=e,n._values=new Map,n}return(0,d.default)(r,[{key:"getAccountDataFromServer",value:function(e){return Promise.resolve(this.getAccountData(e))}},{key:"getAccountData",value:function(e){var t=this._values.get(e);if(t)return t;var r=this._existingValues[e];return r?r.getContent():null}},{key:"setAccountData",value:function(e,t){var r=this,n=this._values.get(e);return this._values.set(e,t),Promise.resolve().then((function(){var i=new f.MatrixEvent({type:e,content:t});r.emit("accountData",i,n)}))}}]),r}(p.EventEmitter),w=function(){function e(){(0,l.default)(this,e),this.privateKeys=new Map}return(0,d.default)(e,[{key:"getCrossSigningKeyCache",value:function(e,t){return this.getCrossSigningKey(e,t)}},{key:"storeCrossSigningKeyCache",value:function(e,t){return this.privateKeys.set(e,t),Promise.resolve()}},{key:"getCrossSigningKey",value:function(e,t){return Promise.resolve(this.privateKeys.get(e))}},{key:"saveCrossSigningKeys",value:function(e){for(var t=0,r=Object.entries(e);t<r.length;t++){var n=(0,a.default)(r[t],2),i=n[0],o=n[1];this.privateKeys.set(i,o)}}}]),e}(),I=function(){function e(t){(0,l.default)(this,e),this._privateKeys=new Map,this._delegateCryptoCallbacks=t}var t;return(0,d.default)(e,[{key:"getSecretStorageKey",value:(t=(0,c.default)(u.default.mark((function e(t,r){var n,i,o,s,c,l,d,h,f;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=t.keys,i=0,o=Object.keys(n);case 2:if(!(i<o.length)){e.next=10;break}if(s=o[i],!(c=this._privateKeys.get(s))){e.next=7;break}return e.abrupt("return",[s,c]);case 7:i++,e.next=2;break;case 10:if(!this._delegateCryptoCallbacks){e.next=16;break}return e.next=13,this._delegateCryptoCallbacks.getSecretStorageKey({keys:n},r);case 13:return(l=e.sent)&&(d=(0,a.default)(l,2),h=d[0],f=d[1],this._privateKeys.set(h,f)),e.abrupt("return",l);case 16:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"addPrivateKey",value:function(e,t,r){this._privateKeys.set(e,r),this._delegateCryptoCallbacks&&this._delegateCryptoCallbacks.cacheSecretStorageKey&&this._delegateCryptoCallbacks.cacheSecretStorageKey(e,t,r)}}]),e}()},{"../http-api":99,"../logger":102,"../models/event":109,"./CrossSigning":63,"./store/indexeddb-crypto-store":84,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,events:36}],66:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.OlmDevice=f,r.WITHHELD_MESSAGES=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=e("../logger"),u=e("./store/indexeddb-crypto-store"),c=n(e("./algorithms"));function l(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){throw e})),f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}((function(e){a=!0,o=e})),f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function h(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>49152){var t=new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is 49152 bytes.");throw t.data={errcode:"M_TOO_LARGE",error:"Payload too large for encrypted message"},t}}function f(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={},this._olmPrekeyPromise=Promise.resolve()}function p(e,t,r,n){return g.apply(this,arguments)}function g(){return(g=(0,s.default)(o.default.mark((function e(t,r,n,i){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT,u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){r.storeAccount(e,t.pickledAccount),t.sessions.forEach((function(t){var n=t.deviceKey,i=t.sessionId,o={session:t.session,lastReceivedMessageTs:t.lastReceivedMessageTs};r.storeEndToEndSession(n,i,o,e)}))}));case 2:i.unpickle(n,t.pickledAccount);case 3:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(e,t,r){return y.apply(this,arguments)}function y(){return(y=(0,s.default)(o.default.mark((function e(t,r,n){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){t.getAccount(e,(function(i){null!==i?n.unpickle(r,i):(n.create(),i=n.pickle(r),t.storeAccount(e,i))}))}));case 2:case"end":return e.stop()}}),e)})))).apply(this,arguments)}f.prototype.init=(0,s.default)(o.default.mark((function e(){var r,n,i,s,u,c=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=c.length>0&&void 0!==c[0]?c[0]:{},i=new t.Olm.Account,s=r.pickleKey,u=r.fromExportedDevice,e.prev=3,!u){e.next=11;break}return s&&a.logger.warn("ignoring opts.pickleKey because opts.fromExportedDevice is present."),this._pickleKey=u.pickleKey,e.next=9,p(u,this._cryptoStore,this._pickleKey,i);case 9:e.next=14;break;case 11:return s&&(this._pickleKey=s),e.next=14,v(this._cryptoStore,this._pickleKey,i);case 14:n=JSON.parse(i.identity_keys()),this._maxOneTimeKeys=i.max_number_of_one_time_keys();case 16:return e.prev=16,i.free(),e.finish(16);case 19:this.deviceCurve25519Key=n.curve25519,this.deviceEd25519Key=n.ed25519;case 21:case"end":return e.stop()}}),e,this,[[3,,16,19]])}))),f.getOlmVersion=function(){return t.Olm.get_library_version()},f.prototype._getAccount=function(e,r){var n=this;this._cryptoStore.getAccount(e,(function(e){var i=new t.Olm.Account;try{i.unpickle(n._pickleKey,e),r(i)}finally{i.free()}}))},f.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},f.prototype.export=(0,s.default)(o.default.mark((function e(){var t,r=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t={pickleKey:this._pickleKey},e.next=3,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_ACCOUNT,u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){r._cryptoStore.getAccount(e,(function(e){t.pickledAccount=e})),t.sessions=[],r._cryptoStore.getAllEndToEndSessions(e,(function(e){t.sessions.push(e)}))}));case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)}))),f.prototype._getSession=function(e,t,r,n){var i=this;this._cryptoStore.getEndToEndSession(e,t,r,(function(e){i._unpickleSession(e,n)}))},f.prototype._unpickleSession=function(e,r){var n=new t.Olm.Session;try{n.unpickle(this._pickleKey,e.session),r(Object.assign({},e,{session:n}))}finally{n.free()}},f.prototype._saveSession=function(e,t,r){var n=t.session.session_id(),i=Object.assign(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,i,r)},f.prototype._getUtility=function(e){var r=new t.Olm.Utility;try{return e(r)}finally{r.free()}},f.prototype.sign=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){n._getAccount(e,(function(e){r=e.sign(t)}))}));case 2:return e.abrupt("return",r);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),f.prototype.getOneTimeKeys=(0,s.default)(o.default.mark((function e(){var t,r=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){r._getAccount(e,(function(e){t=JSON.parse(e.one_time_keys())}))}));case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e,this)}))),f.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},f.prototype.markKeysAsPublished=(0,s.default)(o.default.mark((function e(){var t=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){t._getAccount(e,(function(r){r.mark_keys_as_published(),t._storeAccount(e,r)}))}));case 2:case"end":return e.stop()}}),e,this)}))),f.prototype.generateOneTimeKeys=function(e){var t=this;return this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(r){t._getAccount(r,(function(n){n.generate_one_time_keys(e),t._storeAccount(r,n)}))}))},f.prototype.generateFallbackKey=(0,s.default)(o.default.mark((function e(){var t=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){t._getAccount(e,(function(r){r.generate_fallback_key(),t._storeAccount(e,r)}))}));case 2:case"end":return e.stop()}}),e,this)}))),f.prototype.getFallbackKey=(0,s.default)(o.default.mark((function e(){var t,r=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){r._getAccount(e,(function(e){t=JSON.parse(e.fallback_key())}))}));case 2:return e.abrupt("return",t);case 3:case"end":return e.stop()}}),e,this)}))),f.prototype.createOutboundSession=function(){var e=(0,s.default)(o.default.mark((function e(r,n){var i,s=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT,u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){s._getAccount(e,(function(o){var a=new t.Olm.Session;try{a.create_outbound(o,r,n),i=a.session_id(),s._storeAccount(e,o);var u={session:a,lastReceivedMessageTs:Date.now()};s._saveSession(r,u,e)}finally{a.free()}}))}),a.logger.withPrefix("[createOutboundSession]"));case 2:return e.abrupt("return",i);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),f.prototype.createInboundSession=function(){var e=(0,s.default)(o.default.mark((function e(r,n,i){var s,c=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===n){e.next=2;break}throw new Error("Need messageType == 0 to create inbound session");case 2:return e.next=4,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ACCOUNT,u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){c._getAccount(e,(function(o){var a=new t.Olm.Session;try{a.create_inbound_from(o,r,i),o.remove_one_time_keys(a),c._storeAccount(e,o);var u=a.decrypt(n,i),l={session:a,lastReceivedMessageTs:Date.now()};c._saveSession(r,l,e),s={payload:u,session_id:a.session_id()}}finally{a.free()}}))}),a.logger.withPrefix("[createInboundSession]"));case 4:return e.abrupt("return",s);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),f.prototype.getSessionIdsForDevice=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n,i=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=a.logger.withPrefix("[getSessionIdsForDevice]"),!this._sessionsInProgress[t]){e.next=10;break}return r.debug("Waiting for Olm session for ".concat(t," to be created")),e.prev=3,e.next=6,this._sessionsInProgress[t];case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(3);case 10:return e.next=12,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){i._cryptoStore.getEndToEndSessions(t,e,(function(e){n=Object.keys(e)}))}),r);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this,[[3,8]])})));return function(t){return e.apply(this,arguments)}}(),f.prototype.getSessionIdForDevice=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n){var i,s,a,u,c,l,d;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getSessionInfoForDevice(t,r,n);case 2:if(0!==(i=e.sent).length){e.next=5;break}return e.abrupt("return",null);case 5:for(s=0,a=1;a<i.length;a++)u=i[a],c=void 0===u.lastReceivedMessageTs?0:u.lastReceivedMessageTs,l=i[s],d=void 0===l.lastReceivedMessageTs?0:l.lastReceivedMessageTs,(c>d||c===d&&u.sessionId<l.sessionId)&&(s=a);return e.abrupt("return",i[s].sessionId);case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),f.prototype.getSessionInfoForDevice=function(){var e=(0,s.default)(o.default.mark((function e(t,r){var n,i,s=this,c=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(n=c.length>2&&void 0!==c[2]?c[2]:a.logger).withPrefix("[getSessionInfoForDevice]"),!this._sessionsInProgress[t]||r){e.next=11;break}return n.debug("Waiting for Olm session for ".concat(t," to be created")),e.prev=4,e.next=7,this._sessionsInProgress[t];case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(4);case 11:return i=[],e.next=14,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){s._cryptoStore.getEndToEndSessions(t,e,(function(e){var t,r=l(Object.keys(e).sort());try{var n=function(){var r=t.value;s._unpickleSession(e[r],(function(e){i.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:r})}))};for(r.s();!(t=r.n()).done;)n()}catch(e){r.e(e)}finally{r.f()}}))}),n);case 14:return e.abrupt("return",i);case 15:case"end":return e.stop()}}),e,this,[[4,9]])})));return function(t,r){return e.apply(this,arguments)}}(),f.prototype.encryptMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n){var i,s=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h(n),e.next=3,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){s._getSession(t,r,e,(function(o){var u=o.session.describe();a.logger.log("encryptMessage: Olm Session ID "+r+" to "+t+": "+u),i=o.session.encrypt(n),s._saveSession(t,o,e)}))}),a.logger.withPrefix("[encryptMessage]"));case 3:return e.abrupt("return",i);case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),f.prototype.decryptMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n,i){var s,c=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){c._getSession(t,r,e,(function(o){var u=o.session.describe();a.logger.log("decryptMessage: Olm Session ID "+r+" from "+t+": "+u),s=o.session.decrypt(n,i),o.lastReceivedMessageTs=Date.now(),c._saveSession(t,o,e)}))}),a.logger.withPrefix("[decryptMessage]"));case 2:return e.abrupt("return",s);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),f.prototype.matchesSession=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n,i){var s,c=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===n){e.next=2;break}return e.abrupt("return",!1);case 2:return e.next=4,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_SESSIONS],(function(e){c._getSession(t,r,e,(function(e){s=e.session.matches_inbound(i)}))}),a.logger.withPrefix("[matchesSession]"));case 4:return e.abrupt("return",s);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),f.prototype.recordSessionProblem=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.storeEndToEndSessionProblem(t,r,n);case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),f.prototype.sessionMayHaveProblems=function(){var e=(0,s.default)(o.default.mark((function e(t,r){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.getEndToEndSessionProblem(t,r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),f.prototype.filterOutNotifiedErrorDevices=function(){var e=(0,s.default)(o.default.mark((function e(t){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.filterOutNotifiedErrorDevices(t);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),f.prototype._saveOutboundGroupSession=function(e){var t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},f.prototype._getOutboundGroupSession=function(e,r){var n=this._outboundGroupSessionStore[e];if(void 0===n)throw new Error("Unknown outbound group session "+e);var i=new t.Olm.OutboundGroupSession;try{return i.unpickle(this._pickleKey,n),r(i)}finally{i.free()}},f.prototype.createOutboundGroupSession=function(){var e=new t.Olm.OutboundGroupSession;try{return e.create(),this._saveOutboundGroupSession(e),e.session_id()}finally{e.free()}},f.prototype.encryptGroupMessage=function(e,t){var r=this;return a.logger.log("encrypting msg with megolm session ".concat(e)),h(t),this._getOutboundGroupSession(e,(function(e){var n=e.encrypt(t);return r._saveOutboundGroupSession(e),n}))},f.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},f.prototype._unpickleInboundGroupSession=function(e,r){var n=new t.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,e.session),r(n)}finally{n.free()}},f.prototype._getInboundGroupSession=function(e,t,r,n,i){var o=this;this._cryptoStore.getEndToEndInboundGroupSession(t,r,n,(function(t,r){if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");o._unpickleInboundGroupSession(t,(function(e){i(e,t,r)}))}else i(null,null,r)}))},f.prototype.addInboundGroupSession=function(){var e=(0,s.default)(o.default.mark((function e(r,n,i,s,c,l,d){var h,f=this,p=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=p.length>7&&void 0!==p[7]?p[7]:{},e.next=3,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD,u.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(function(e){f._getInboundGroupSession(r,n,s,e,(function(o,u){var p=new t.Olm.InboundGroupSession;try{if(d?p.import_session(c):p.create(c),s!=p.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(o&&(a.logger.log("Update for megolm session "+n+"/"+s),o.first_known_index()<=p.first_known_index()&&(o.first_known_index()!=p.first_known_index()||h.untrusted||!u.untrusted)))return void a.logger.log("Keeping existing megolm session ".concat(s));a.logger.info("Storing megolm session "+n+"/"+s+" with first index "+p.first_known_index());var g=Object.assign({},h,{room_id:r,session:p.pickle(f._pickleKey),keysClaimed:l,forwardingCurve25519KeyChain:i});f._cryptoStore.storeEndToEndInboundGroupSession(n,s,g,e),!o&&h.sharedHistory&&f._cryptoStore.addSharedHistoryInboundGroupSession(r,n,s,e)}finally{p.free()}}))}),a.logger.withPrefix("[addInboundGroupSession]"));case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o,s,a){return e.apply(this,arguments)}}(),f.prototype.addInboundGroupSessionWithheld=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n,i,s){var a=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){a._cryptoStore.storeEndToEndInboundGroupSessionWithheld(r,n,{room_id:t,code:i,reason:s},e)}));case 2:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o){return e.apply(this,arguments)}}();var m={"m.unverified":"The sender has disabled encrypting to unverified devices.","m.blacklisted":"The sender has blocked you.","m.unauthorised":"You are not authorised to read the message.","m.no_olm":"Unable to establish a secure channel."};function _(e){return e.code&&e.code in m?m[e.code]:e.reason?e.reason:"decryption key withheld"}r.WITHHELD_MESSAGES=m,f.prototype.decryptGroupMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n,i,s,l){var d,h,f=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){f._getInboundGroupSession(t,r,n,e,(function(t,o,a){if(null===t)return a&&(h=new c.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",_(a),{session:r+"|"+n})),void(d=null);var u;try{u=t.decrypt(i)}catch(e){return void(h=e&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.message&&a?new c.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",_(a),{session:r+"|"+n}):e)}var p=u.plaintext;if(void 0===p)p=u;else{var g=r+"|"+n+"|"+u.message_index;if(g in f._inboundGroupSessionMessageIndexes){var v=f._inboundGroupSessionMessageIndexes[g];if(v.id!==s||v.timestamp!==l)return void(h=new Error("Duplicate message index, possible replay attack: "+g))}f._inboundGroupSessionMessageIndexes[g]={id:s,timestamp:l}}o.session=t.pickle(f._pickleKey),f._cryptoStore.storeEndToEndInboundGroupSession(r,n,o,e),d={result:p,keysClaimed:o.keysClaimed||{},senderKey:r,forwardingCurve25519KeyChain:o.forwardingCurve25519KeyChain||[],untrusted:o.untrusted}}))}),a.logger.withPrefix("[decryptGroupMessage]"));case 2:if(!h){e.next=4;break}throw h;case 4:return e.abrupt("return",d);case 5:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o,s){return e.apply(this,arguments)}}(),f.prototype.hasInboundSessionKeys=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n){var i,s=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){s._cryptoStore.getEndToEndInboundGroupSession(r,n,e,(function(e){null!==e?t!==e.room_id?(a.logger.warn("requested keys for inbound group session ".concat(r,"|")+"".concat(n,", with incorrect room_id ")+"(expected ".concat(e.room_id,", ")+"was ".concat(t,")")),i=!1):i=!0:i=!1}))}),a.logger.withPrefix("[hasInboundSessionKeys]"));case 2:return e.abrupt("return",i);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),f.prototype.getInboundGroupSessionKey=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n,i){var s,c=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,u.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){c._getInboundGroupSession(t,r,n,e,(function(e,t){if(null!==e){void 0===i&&(i=e.first_known_index());var r=e.export_session(i),n=(t.keysClaimed||{}).ed25519||null;s={chain_index:i,key:r,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:n,shared_history:t.sharedHistory||!1}}else s=null}))}),a.logger.withPrefix("[getInboundGroupSessionKey]"));case 2:return e.abrupt("return",s);case 3:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),f.prototype.exportInboundGroupSession=function(e,t,r){return this._unpickleInboundGroupSession(r,(function(n){var i=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(i),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index(),"org.matrix.msc3061.shared_history":r.sharedHistory||!1}}))},f.prototype.getSharedHistoryInboundGroupSessions=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readonly",[u.IndexedDBCryptoStore.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS],(function(e){r=n._cryptoStore.getSharedHistoryInboundGroupSessions(t,e)}),a.logger.withPrefix("[getSharedHistoryInboundGroupSessionsForRoom]"));case 2:return e.abrupt("return",r);case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),f.prototype.verifySignature=function(e,t,r){this._getUtility((function(n){n.ed25519_verify(e,t,r)}))}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":102,"./algorithms":72,"./store/indexeddb-crypto-store":84,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27}],67:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.OutgoingRoomKeyRequestManager=r.ROOM_KEY_REQUEST_STATES=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/asyncToGenerator")),s=n(e("@babel/runtime/helpers/classCallCheck")),a=n(e("@babel/runtime/helpers/createClass")),u=e("../logger");function c(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return l(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return l(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var d={UNSENT:0,SENT:1,CANCELLATION_PENDING:2,CANCELLATION_PENDING_AND_WILL_RESEND:3};r.ROOM_KEY_REQUEST_STATES=d;var h=function(){function e(t,r,n){(0,s.default)(this,e),this._baseApis=t,this._deviceId=r,this._cryptoStore=n,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}var r,n;return(0,a.default)(e,[{key:"start",value:function(){this._clientRunning=!0}},{key:"stop",value:function(){u.logger.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}},{key:"sendQueuedRequests",value:function(){this._startTimer()}},{key:"queueRoomKeyRequest",value:(n=(0,o.default)(i.default.mark((function e(t,r){var n,o,s,a,c,l=arguments;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=l.length>2&&void 0!==l[2]&&l[2],e.next=3,this._cryptoStore.getOutgoingRoomKeyRequest(t);case 3:if(o=e.sent){e.next=9;break}return e.next=7,this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:t,recipients:r,requestId:this._baseApis.makeTxnId(),state:d.UNSENT});case 7:e.next=36;break;case 9:e.t0=o.state,e.next=e.t0===d.CANCELLATION_PENDING_AND_WILL_RESEND||e.t0===d.UNSENT?12:e.t0===d.CANCELLATION_PENDING?13:e.t0===d.SENT?17:35;break;case 12:return e.abrupt("return");case 13:return s=n?d.CANCELLATION_PENDING_AND_WILL_RESEND:d.SENT,e.next=16,this._cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,d.CANCELLATION_PENDING,{state:s,cancellationTxnId:this._baseApis.makeTxnId()});case 16:return e.abrupt("break",36);case 17:if(!n){e.next=34;break}return a=d.CANCELLATION_PENDING_AND_WILL_RESEND,e.next=21,this._cryptoStore.updateOutgoingRoomKeyRequest(o.requestId,d.SENT,{state:a,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()});case 21:if(c=e.sent){e.next=26;break}return e.next=25,this.queueRoomKeyRequest(t,r,n);case 25:return e.abrupt("return",e.sent);case 26:return e.prev=26,e.next=29,this._sendOutgoingRoomKeyRequestCancellation(c,!0);case 29:e.next=34;break;case 31:e.prev=31,e.t1=e.catch(26),u.logger.error("Error sending room key request cancellation; will retry later.",e.t1);case 34:return e.abrupt("break",36);case 35:throw new Error("unhandled state: "+o.state);case 36:case"end":return e.stop()}}),e,this,[[26,31]])}))),function(e,t){return n.apply(this,arguments)})},{key:"cancelRoomKeyRequest",value:function(e){var t=this;return this._cryptoStore.getOutgoingRoomKeyRequest(e).then((function(r){if(r)switch(r.state){case d.CANCELLATION_PENDING:case d.CANCELLATION_PENDING_AND_WILL_RESEND:return;case d.UNSENT:return u.logger.log("deleting unnecessary room key request for "+f(e)),t._cryptoStore.deleteOutgoingRoomKeyRequest(r.requestId,d.UNSENT);case d.SENT:return t._cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,d.SENT,{state:d.CANCELLATION_PENDING,cancellationTxnId:t._baseApis.makeTxnId()}).then((function(r){r?t._sendOutgoingRoomKeyRequestCancellation(r).catch((function(e){u.logger.error("Error sending room key request cancellation; will retry later.",e),t._startTimer()})):u.logger.log("Tried to cancel room key request for "+f(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+r.state)}}))}},{key:"getOutgoingSentRoomKeyRequest",value:function(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[d.SENT])}},{key:"cancelAndResendAllOutgoingRequests",value:(r=(0,o.default)(i.default.mark((function e(){var t,r=this;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.getAllOutgoingRoomKeyRequestsByState(d.SENT);case 2:return t=e.sent,e.abrupt("return",Promise.all(t.map((function(e){var t=e.requestBody,n=e.recipients;return r.queueRoomKeyRequest(t,n,!0)}))));case 4:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"_startTimer",value:function(){var e=this;if(!this._sendOutgoingRoomKeyRequestsTimer){this._sendOutgoingRoomKeyRequestsTimer=t.setTimeout((function(){if(e._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");e._sendOutgoingRoomKeyRequestsRunning=!0,e._sendOutgoingRoomKeyRequests().finally((function(){e._sendOutgoingRoomKeyRequestsRunning=!1})).catch((function(e){u.logger.warn("error in OutgoingRoomKeyRequestManager: ".concat(e))}))}),500)}}},{key:"_sendOutgoingRoomKeyRequests",value:function(){var e=this;return this._clientRunning?this._cryptoStore.getOutgoingRoomKeyRequestByState([d.CANCELLATION_PENDING,d.CANCELLATION_PENDING_AND_WILL_RESEND,d.UNSENT]).then((function(t){if(t){var r;switch(t.state){case d.UNSENT:r=e._sendOutgoingRoomKeyRequest(t);break;case d.CANCELLATION_PENDING:r=e._sendOutgoingRoomKeyRequestCancellation(t);break;case d.CANCELLATION_PENDING_AND_WILL_RESEND:r=e._sendOutgoingRoomKeyRequestCancellation(t,!0)}return r.then((function(){return e._sendOutgoingRoomKeyRequests()})).catch((function(t){u.logger.error("Error sending room key request; will retry later.",t),e._sendOutgoingRoomKeyRequestsTimer=null}))}e._sendOutgoingRoomKeyRequestsTimer=null})):(this._sendOutgoingRoomKeyRequestsTimer=null,Promise.resolve())}},{key:"_sendOutgoingRoomKeyRequest",value:function(e){var t=this;u.logger.log("Requesting keys for ".concat(f(e.requestBody))+" from ".concat(p(e.recipients))+"(id ".concat(e.requestId,")"));var r={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(r,e.recipients,e.requestTxnId||e.requestId).then((function(){return t._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,d.UNSENT,{state:d.SENT})}))}},{key:"_sendOutgoingRoomKeyRequestCancellation",value:function(e,t){var r=this;u.logger.log("Sending cancellation for key request for "+"".concat(f(e.requestBody)," to ")+"".concat(p(e.recipients)," ")+"(cancellation id ".concat(e.cancellationTxnId,")"));var n={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((function(){return t?r._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,d.CANCELLATION_PENDING_AND_WILL_RESEND,{state:d.UNSENT}):r._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,d.CANCELLATION_PENDING)}))}},{key:"_sendMessageToDevices",value:function(e,t,r){var n,i={},o=c(t);try{for(o.s();!(n=o.n()).done;){var s=n.value;i[s.userId]||(i[s.userId]={}),i[s.userId][s.deviceId]=e}}catch(e){o.e(e)}finally{o.f()}return this._baseApis.sendToDevice("m.room_key_request",i,r)}}]),e}();function f(e){return e.room_id+" / "+e.session_id}function p(e){return"["+e.map((function(e){return"".concat(e.userId,":").concat(e.deviceId)})).join(",")+"]"}r.OutgoingRoomKeyRequestManager=h}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":102,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/regenerator":27}],68:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomList=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/asyncToGenerator")),s=n(e("@babel/runtime/helpers/classCallCheck")),a=n(e("@babel/runtime/helpers/createClass")),u=e("./store/indexeddb-crypto-store"),c=function(){function e(t){(0,s.default)(this,e),this._cryptoStore=t,this._roomEncryption={}}var t,r;return(0,a.default)(e,[{key:"init",value:(r=(0,o.default)(i.default.mark((function e(){var t=this;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ROOMS],(function(e){t._cryptoStore.getEndToEndRooms(e,(function(e){t._roomEncryption=e}))}));case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getRoomEncryption",value:function(e){return this._roomEncryption[e]||null}},{key:"isRoomEncrypted",value:function(e){return Boolean(this.getRoomEncryption(e))}},{key:"setRoomEncryption",value:(t=(0,o.default)(i.default.mark((function e(t,r){var n=this;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._roomEncryption[t]=r,e.next=3,this._cryptoStore.doTxn("readwrite",[u.IndexedDBCryptoStore.STORE_ROOMS],(function(e){n._cryptoStore.storeEndToEndRoom(t,r,e)}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),e}();r.RoomList=c},{"./store/indexeddb-crypto-store":84,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/regenerator":27}],69:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SecretStorage=r.SECRET_STORAGE_ALGORITHM_V1_AES=void 0;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/asyncToGenerator")),c=i(e("@babel/runtime/helpers/classCallCheck")),l=i(e("@babel/runtime/helpers/createClass")),d=i(e("@babel/runtime/helpers/inherits")),h=i(e("@babel/runtime/helpers/possibleConstructorReturn")),f=i(e("@babel/runtime/helpers/getPrototypeOf")),p=e("events"),g=e("../logger"),v=n(e("./olmlib")),y=e("../randomstring"),m=e("./aes");function _(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return b(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,f.default)(e);if(t){var i=(0,f.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,h.default)(this,r)}}var k="m.secret_storage.v1.aes-hmac-sha2";r.SECRET_STORAGE_ALGORITHM_V1_AES=k;var E=function(e){(0,d.default)(x,e);var t,r,n,i,h,f,p,b,E,w,I,T,R=S(x);function x(e,t){var r;return(0,c.default)(this,x),(r=R.call(this))._baseApis=e,r._cryptoCallbacks=t,r._requests={},r._incomingRequests={},r}return(0,l.default)(x,[{key:"getDefaultKeyId",value:(T=(0,u.default)(a.default.mark((function e(){var t;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._baseApis.getAccountDataFromServer("m.secret_storage.default_key");case 2:if(t=e.sent){e.next=5;break}return e.abrupt("return",null);case 5:return e.abrupt("return",t.key);case 6:case"end":return e.stop()}}),e,this)}))),function(){return T.apply(this,arguments)})},{key:"setDefaultKeyId",value:function(e){var t=this;return new Promise(function(){var r=(0,u.default)(a.default.mark((function r(n,i){var o;return a.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=function r(i){"m.secret_storage.default_key"===i.getType()&&i.getContent().key===e&&(t._baseApis.removeListener("accountData",r),n())},t._baseApis.on("accountData",o),r.prev=2,r.next=5,t._baseApis.setAccountData("m.secret_storage.default_key",{key:e});case 5:r.next=11;break;case 7:r.prev=7,r.t0=r.catch(2),t._baseApis.removeListener("accountData",o),i(r.t0);case 11:case"end":return r.stop()}}),r,null,[[2,7]])})));return function(e,t){return r.apply(this,arguments)}}())}},{key:"addKey",value:(I=(0,u.default)(a.default.mark((function e(t,r,n){var i,o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={algorithm:t},r||(r={}),r.name&&(i.name=r.name),t!==k){e.next=15;break}if(r.passphrase&&(i.passphrase=r.passphrase),!r.key){e.next=13;break}return e.next=8,x._calculateKeyCheck(r.key);case 8:o=e.sent,s=o.iv,u=o.mac,i.iv=s,i.mac=u;case 13:e.next=16;break;case 15:throw new Error("Unknown key algorithm ".concat(r.algorithm));case 16:if(n){e.next=21;break}case 17:n=(0,y.randomString)(32);case 18:return e.next=20,this._baseApis.getAccountDataFromServer("m.secret_storage.key.".concat(n));case 20:if(e.sent){e.next=17;break}case 21:return e.next=23,this._baseApis.setAccountData("m.secret_storage.key.".concat(n),i);case 23:return e.abrupt("return",{keyId:n,keyInfo:i});case 24:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return I.apply(this,arguments)})},{key:"getKey",value:(w=(0,u.default)(a.default.mark((function e(t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=4;break}return e.next=3,this.getDefaultKeyId();case 3:t=e.sent;case 4:if(t){e.next=6;break}return e.abrupt("return",null);case 6:return e.next=8,this._baseApis.getAccountDataFromServer("m.secret_storage.key."+t);case 8:return r=e.sent,e.abrupt("return",r?[t,r]:null);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"hasKey",value:(E=(0,u.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.getKey(t);case 2:return e.abrupt("return",!!e.sent);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return E.apply(this,arguments)})},{key:"checkKey",value:(b=(0,u.default)(a.default.mark((function e(t,r){var n,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.algorithm!==k){e.next=12;break}if(!r.mac){e.next=9;break}return e.next=4,x._calculateKeyCheck(t,r.iv);case 4:return n=e.sent,i=n.mac,e.abrupt("return",r.mac.replace(/=+$/g,"")===i.replace(/=+$/g,""));case 9:return e.abrupt("return",!0);case 10:e.next=13;break;case 12:throw new Error("Unknown algorithm");case 13:case"end":return e.stop()}}),e)}))),function(e,t){return b.apply(this,arguments)})},{key:"store",value:(p=(0,u.default)(a.default.mark((function e(t,r,n){var i,u,c,l,d,h,f,p,v,y;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={},n){e.next=8;break}return e.next=4,this.getDefaultKeyId();case 4:if(u=e.sent){e.next=7;break}throw new Error("No keys specified and no default key present");case 7:n=[u];case 8:if(0!==n.length){e.next=10;break}throw new Error("Zero keys given to encrypt with!");case 10:c=_(n),e.prev=11,c.s();case 13:if((l=c.n()).done){e.next=35;break}return d=l.value,e.next=17,this._baseApis.getAccountDataFromServer("m.secret_storage.key."+d);case 17:if(h=e.sent){e.next=20;break}throw new Error("Unknown key: "+d);case 20:if(h.algorithm!==k){e.next=32;break}return f=(0,s.default)({},d,h),e.next=24,this._getSecretStorageKey(f,t);case 24:return p=e.sent,v=(0,o.default)(p,2),y=v[1],e.next=29,y.encrypt(r);case 29:i[d]=e.sent,e.next=33;break;case 32:g.logger.warn("unknown algorithm for secret storage key "+d+": "+h.algorithm);case 33:e.next=13;break;case 35:e.next=40;break;case 37:e.prev=37,e.t0=e.catch(11),c.e(e.t0);case 40:return e.prev=40,c.f(),e.finish(40);case 43:return e.next=45,this._baseApis.setAccountData(t,{encrypted:i});case 45:case"end":return e.stop()}}),e,this,[[11,37,40,43]])}))),function(e,t,r){return p.apply(this,arguments)})},{key:"_fixupStoredSecret",value:(f=(0,u.default)(a.default.mark((function e(t,r){var n,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(1!==(n=Object.keys(r)).length||"encrypted"===n[0]||!r[n[0]].passthrough){e.next=13;break}return e.next=4,this.hasKey(n[0]);case 4:if(!e.sent){e.next=13;break}return g.logger.log("Fixing up passthrough secret: "+t),e.next=9,this.storePassthrough(t,n[0]);case 9:return e.next=11,this._baseApis.getAccountDataFromServer(t);case 11:return i=e.sent,e.abrupt("return",i);case 13:return e.abrupt("return",null);case 14:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)})},{key:"get",value:(h=(0,u.default)(a.default.mark((function e(t){var r,n,i,s,u,c,l,d,h,f,p,g;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._baseApis.getAccountDataFromServer(t);case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return");case 5:if(r.encrypted){e.next=11;break}return e.next=8,this._fixupStoredSecret(t,r);case 8:if((r=e.sent)&&r.encrypted){e.next=11;break}throw new Error("Content is not encrypted!");case 11:n={},i=0,s=Object.keys(r.encrypted);case 13:if(!(i<s.length)){e.next=23;break}return u=s[i],e.next=17,this._baseApis.getAccountDataFromServer("m.secret_storage.key."+u);case 17:c=e.sent,l=r.encrypted[u],c.algorithm===k&&l.iv&&l.ciphertext&&l.mac&&(n[u]=c);case 20:i++,e.next=13;break;case 23:if(0!==Object.keys(n).length){e.next=25;break}throw new Error("Could not decrypt ".concat(t," because none of ")+"the keys it is encrypted with are for a supported algorithm");case 25:return e.prev=25,e.next=28,this._getSecretStorageKey(n,t);case 28:if(f=e.sent,p=(0,o.default)(f,2),d=p[0],h=p[1],!(g=r.encrypted[d]).passthrough){e.next=35;break}return e.abrupt("return",(0,v.encodeBase64)(h.get_private_key()));case 35:return e.next=37,h.decrypt(g);case 37:return e.abrupt("return",e.sent);case 38:return e.prev=38,h&&h.free&&h.free(),e.finish(38);case 41:case"end":return e.stop()}}),e,this,[[25,,38,41]])}))),function(e){return h.apply(this,arguments)})},{key:"isStored",value:(i=(0,u.default)(a.default.mark((function e(t,r){var n,i,o,s,u,c,l;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._baseApis.getAccountDataFromServer(t);case 2:if(n=e.sent){e.next=5;break}return e.abrupt("return",null);case 5:if(n.encrypted){e.next=11;break}return e.next=8,this._fixupStoredSecret(t,n);case 8:if((n=e.sent)&&n.encrypted){e.next=11;break}return e.abrupt("return",null);case 11:void 0===r&&(r=!0),i={},o=0,s=Object.keys(n.encrypted);case 14:if(!(o<s.length)){e.next=26;break}return u=s[o],e.next=18,this._baseApis.getAccountDataFromServer("m.secret_storage.key."+u);case 18:if(c=e.sent){e.next=21;break}return e.abrupt("continue",23);case 21:l=n.encrypted[u],c.algorithm===k&&l.iv&&l.ciphertext&&l.mac&&(i[u]=c);case 23:o++,e.next=14;break;case 26:return e.abrupt("return",Object.keys(i).length?i:null);case 27:case"end":return e.stop()}}),e,this)}))),function(e,t){return i.apply(this,arguments)})},{key:"request",value:function(e,t){var r,n=this,i=this._baseApis.makeTxnId(),o=this._requests[i]={name:e,devices:t},a=new Promise((function(e,t){o.resolve=e,o.reject=t})),u={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:i},c={},l=_(t);try{for(l.s();!(r=l.n()).done;){c[r.value]=u}}catch(e){l.e(e)}finally{l.f()}return g.logger.info("Request secret ".concat(e," from ").concat(t,", id ").concat(i)),this._baseApis.sendToDevice("m.secret.request",(0,s.default)({},this._baseApis.getUserId(),c)),{request_id:i,promise:a,cancel:function(e){var r,a={action:"request_cancellation",requesting_device_id:n._baseApis.deviceId,request_id:i},u={},c=_(t);try{for(c.s();!(r=c.n()).done;){u[r.value]=a}}catch(e){c.e(e)}finally{c.f()}n._baseApis.sendToDevice("m.secret.request",(0,s.default)({},n._baseApis.getUserId(),u)),o.reject(new Error(e||"Cancelled"))}}}},{key:"_onRequestReceived",value:(n=(0,u.default)(a.default.mark((function e(t){var r,n,i,o,u,c,l;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getSender(),n=t.getContent(),r===this._baseApis.getUserId()&&n.name&&n.action&&n.requesting_device_id&&n.request_id){e.next=4;break}return e.abrupt("return");case 4:if(i=n.requesting_device_id,"request_cancellation"!==n.action){e.next=9;break}this._incomingRequests[i]&&this._incomingRequests[i][n.request_id]&&(g.logger.info("received request cancellation for secret ("+r+", "+i+", "+n.request_id+")"),this._baseApis.emit("crypto.secrets.requestCancelled",{user_id:r,device_id:i,request_id:n.request_id})),e.next=32;break;case 9:if("request"!==n.action){e.next=32;break}if(i!==this._baseApis.deviceId){e.next=12;break}return e.abrupt("return");case 12:if(g.logger.info("received request for secret ("+r+", "+i+", "+n.request_id+")"),this._cryptoCallbacks.onSecretRequested){e.next=15;break}return e.abrupt("return");case 15:return e.next=17,this._cryptoCallbacks.onSecretRequested(r,i,n.request_id,n.name,this._baseApis.checkDeviceTrust(r,i));case 17:if(!(o=e.sent)){e.next=31;break}return g.logger.info("Preparing ".concat(n.name," secret for ").concat(i)),u={type:"m.secret.send",content:{request_id:n.request_id,secret:o}},c={algorithm:v.OLM_ALGORITHM,sender_key:this._baseApis.crypto._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=24,v.ensureOlmSessionsForDevices(this._baseApis.crypto._olmDevice,this._baseApis,(0,s.default)({},r,[this._baseApis.getStoredDevice(r,i)]));case 24:return e.next=26,v.encryptMessageForDevice(c.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis.crypto._olmDevice,r,this._baseApis.getStoredDevice(r,i),u);case 26:l=(0,s.default)({},r,(0,s.default)({},i,c)),g.logger.info("Sending ".concat(n.name," secret for ").concat(i)),this._baseApis.sendToDevice("m.room.encrypted",l),e.next=32;break;case 31:g.logger.info("Request denied for ".concat(n.name," secret for ").concat(i));case 32:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"_onSecretReceived",value:function(e){if(e.getSender()===this._baseApis.getUserId()){var t=e.getContent();g.logger.log("got secret share for request",t.request_id);var r=this._requests[t.request_id];if(r){var n=this._baseApis.crypto._deviceList.getDeviceByIdentityKey(v.OLM_ALGORITHM,e.getSenderKey());if(!n)return void g.logger.log("secret share from unknown device with key",e.getSenderKey());if(!r.devices.includes(n.deviceId))return void g.logger.log("unsolicited secret share from device",n.deviceId);g.logger.log("Successfully received secret ".concat(r.name," ")+"from ".concat(n.deviceId)),r.resolve(t.secret)}}}},{key:"_getSecretStorageKey",value:(r=(0,u.default)(a.default.mark((function e(t,r){var n,i,s,c,l;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._cryptoCallbacks.getSecretStorageKey){e.next=2;break}throw new Error("No getSecretStorageKey callback supplied");case 2:return e.next=4,this._cryptoCallbacks.getSecretStorageKey({keys:t},r);case 4:if(n=e.sent){e.next=7;break}throw new Error("getSecretStorageKey callback returned falsey");case 7:if(!(n.length<2)){e.next=9;break}throw new Error("getSecretStorageKey callback returned invalid data");case 9:if(i=(0,o.default)(n,2),s=i[0],c=i[1],t[s]){e.next=12;break}throw new Error("App returned unknown key from getSecretStorageKey!");case 12:if(t[s].algorithm!==k){e.next=17;break}return l={encrypt:function(){var e=(0,u.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.encryptAES)(t,c,r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),decrypt:function(){var e=(0,u.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.decryptAES)(t,c,r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()},e.abrupt("return",[s,l]);case 17:throw new Error("Unknown key type: "+t[s].algorithm);case 18:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})}],[{key:"_calculateKeyCheck",value:(t=(0,u.default)(a.default.mark((function e(t,r){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,m.encryptAES)("\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0",t,"",r);case 2:return e.abrupt("return",e.sent);case 3:case"end":return e.stop()}}),e)}))),function(e,r){return t.apply(this,arguments)})}]),x}(p.EventEmitter);r.SecretStorage=E},{"../logger":102,"../randomstring":119,"./aes":70,"./olmlib":81,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,events:36}],70:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.encryptAES=function(){return c?v.apply(void 0,arguments):d.apply(void 0,arguments)},r.decryptAES=function(){return c?m.apply(void 0,arguments):f.apply(void 0,arguments)};var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/slicedToArray")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=e("../utils"),u=e("./olmlib"),c="undefined"!=typeof window&&window.crypto?window.crypto.subtle||window.crypto.webkitSubtle:null,l=new Uint8Array(8);function d(e,t,r,n){return h.apply(this,arguments)}function h(){return(h=(0,s.default)(i.default.mark((function e(t,r,n,s){var c,l,d,h,f,p,v,y,m;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=(0,a.getCrypto)()){e.next=3;break}throw new Error("No usable crypto implementation");case 3:return(l=s?(0,u.decodeBase64)(s):c.randomBytes(16))[8]&=127,d=g(r,n),h=(0,o.default)(d,2),f=h[0],p=h[1],v=c.createCipheriv("aes-256-ctr",f,l),y=v.update(t,"utf-8","base64")+v.final("base64"),m=c.createHmac("sha256",p).update(y,"base64").digest("base64"),e.abrupt("return",{iv:(0,u.encodeBase64)(l),ciphertext:y,mac:m});case 10:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function f(e,t,r){return p.apply(this,arguments)}function p(){return(p=(0,s.default)(i.default.mark((function e(t,r,n){var s,c,l,d,h,f;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=(0,a.getCrypto)()){e.next=3;break}throw new Error("No usable crypto implementation");case 3:if(c=g(r,n),l=(0,o.default)(c,2),d=l[0],h=l[1],s.createHmac("sha256",h).update(t.ciphertext,"base64").digest("base64").replace(/=+$/g,"")===t.mac.replace(/=+$/g,"")){e.next=7;break}throw new Error("Error decrypting secret ".concat(n,": bad MAC"));case 7:return f=s.createDecipheriv("aes-256-ctr",d,(0,u.decodeBase64)(t.iv)),e.abrupt("return",f.update(t.ciphertext,"base64","utf-8")+f.final("utf-8"));case 9:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function g(e,r){var n=(0,a.getCrypto)(),i=n.createHmac("sha256",l).update(e).digest(),o=t.alloc(1,1),s=n.createHmac("sha256",i).update(r,"utf-8").update(o).digest();return o[0]=2,[s,n.createHmac("sha256",i).update(s).update(r,"utf-8").update(o).digest()]}function v(e,t,r,n){return y.apply(this,arguments)}function y(){return(y=(0,s.default)(i.default.mark((function e(t,r,n,s){var a,l,d,h,f,p,g,v;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s?a=(0,u.decodeBase64)(s):(a=new Uint8Array(16),window.crypto.getRandomValues(a)),a[8]&=127,e.next=4,b(r,n);case 4:return l=e.sent,d=(0,o.default)(l,2),h=d[0],f=d[1],p=(new TextEncoder).encode(t),e.next=11,c.encrypt({name:"AES-CTR",counter:a,length:64},h,p);case 11:return g=e.sent,e.next=14,c.sign({name:"HMAC"},f,g);case 14:return v=e.sent,e.abrupt("return",{iv:(0,u.encodeBase64)(a),ciphertext:(0,u.encodeBase64)(g),mac:(0,u.encodeBase64)(v)});case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function m(e,t,r){return _.apply(this,arguments)}function _(){return(_=(0,s.default)(i.default.mark((function e(t,r,n){var s,a,l,d,h,f;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,b(r,n);case 2:return s=e.sent,a=(0,o.default)(s,2),l=a[0],d=a[1],h=(0,u.decodeBase64)(t.ciphertext),e.next=9,c.verify({name:"HMAC"},d,(0,u.decodeBase64)(t.mac),h);case 9:if(e.sent){e.next=11;break}throw new Error("Error decrypting secret ".concat(n,": bad MAC"));case 11:return e.next=13,c.decrypt({name:"AES-CTR",counter:(0,u.decodeBase64)(t.iv),length:64},l,h);case 13:return f=e.sent,e.abrupt("return",(new TextDecoder).decode(new Uint8Array(f)));case 15:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function b(e,t){return S.apply(this,arguments)}function S(){return(S=(0,s.default)(i.default.mark((function e(t,r){var n,o,s,a,u,d;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,c.importKey("raw",t,{name:"HKDF"},!1,["deriveBits"]);case 2:return n=e.sent,e.next=5,c.deriveBits({name:"HKDF",salt:l,info:(new TextEncoder).encode(r),hash:"SHA-256"},n,512);case 5:return o=e.sent,s=o.slice(0,32),a=o.slice(32),u=c.importKey("raw",s,{name:"AES-CTR"},!1,["encrypt","decrypt"]),d=c.importKey("raw",a,{name:"HMAC",hash:{name:"SHA-256"}},!1,["sign","verify"]),e.next=12,Promise.all([u,d]);case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this)}).call(this,e("buffer").Buffer)},{"../utils":133,"./olmlib":81,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,buffer:34}],71:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.registerAlgorithm=function(e,t,r){p[e]=t,g[e]=r},r.UnknownDeviceError=r.DecryptionError=r.DecryptionAlgorithm=r.EncryptionAlgorithm=r.DECRYPTION_CLASSES=r.ENCRYPTION_CLASSES=void 0;var i=n(e("@babel/runtime/helpers/assertThisInitialized")),o=n(e("@babel/runtime/helpers/inherits")),s=n(e("@babel/runtime/helpers/possibleConstructorReturn")),a=n(e("@babel/runtime/helpers/getPrototypeOf")),u=n(e("@babel/runtime/helpers/wrapNativeSuper")),c=n(e("@babel/runtime/regenerator")),l=n(e("@babel/runtime/helpers/asyncToGenerator")),d=n(e("@babel/runtime/helpers/classCallCheck")),h=n(e("@babel/runtime/helpers/createClass"));function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,a.default)(e);if(t){var i=(0,a.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,s.default)(this,r)}}var p={};r.ENCRYPTION_CLASSES=p;var g={};r.DECRYPTION_CLASSES=g;var v=function(){function e(t){(0,d.default)(this,e),this._userId=t.userId,this._deviceId=t.deviceId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return(0,h.default)(e,[{key:"prepareToEncrypt",value:function(e){}},{key:"onRoomMembership",value:function(e,t,r){}}]),e}();r.EncryptionAlgorithm=v;var y=function(){function e(t){(0,d.default)(this,e),this._userId=t.userId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}var t;return(0,h.default)(e,[{key:"onRoomKeyEvent",value:function(e){}},{key:"importRoomKey",value:function(e){}},{key:"hasKeysForKeyRequest",value:function(e){return Promise.resolve(!1)}},{key:"shareKeysWithDevice",value:function(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}},{key:"retryDecryptionFromSender",value:(t=(0,l.default)(c.default.mark((function e(t){return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:case"end":return e.stop()}}),e)}))),function(e){return t.apply(this,arguments)})}]),e}();r.DecryptionAlgorithm=y;var m=function(e){(0,o.default)(r,e);var t=f(r);function r(e,n,o){var s;return(0,d.default)(this,r),(s=t.call(this,n)).code=e,s.name="DecryptionError",s.detailedString=function(e,t){var r=e.name+"[msg: "+e.message;t&&(r+=", "+Object.keys(t).map((function(e){return e+": "+t[e]})).join(", "));return r+="]"}((0,i.default)(s),o),s}return r}((0,u.default)(Error));r.DecryptionError=m;var _=function(e){(0,o.default)(r,e);var t=f(r);function r(e,n){var i;return(0,d.default)(this,r),(i=t.call(this,e)).name="UnknownDeviceError",i.devices=n,i}return r}((0,u.default)(Error));r.UnknownDeviceError=_},{"@babel/runtime/helpers/assertThisInitialized":4,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/wrapNativeSuper":26,"@babel/runtime/regenerator":27}],72:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),e("./olm"),e("./megolm");var n=e("./base");Object.keys(n).forEach((function(e){"default"!==e&&"__esModule"!==e&&(e in r&&r[e]===n[e]||Object.defineProperty(r,e,{enumerable:!0,get:function(){return n[e]}}))}))},{"./base":71,"./megolm":73,"./olm":74}],73:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault"),o=i(e("@babel/runtime/helpers/toConsumableArray")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/slicedToArray")),c=i(e("@babel/runtime/helpers/asyncToGenerator")),l=e("../../logger"),d=n(e("../../utils")),h=n(e("../olmlib")),f=e("./base"),p=e("../OlmDevice");function g(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function y(e){var t=e.currentState&&e.currentState.getStateEvents("m.room.history_visibility",""),r=t&&t.getContent()&&t.getContent().history_visibility;return["world_readable","shared"].includes(r)}function m(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={},this.blockedDevicesNotified={},this.sharedHistory=t}function _(e){(0,d.polyfillSuper)(this,f.EncryptionAlgorithm,e),this._setupPromise=Promise.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function b(e){(0,d.polyfillSuper)(this,f.DecryptionAlgorithm,e),this._pendingEvents={},this.olmlib=h}m.prototype.needsRotation=function(e,t){var r=(new Date).getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(l.logger.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)},m.prototype.markSharedWithDevice=function(e,t,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=r},m.prototype.markNotifiedBlockedDevice=function(e,t){this.blockedDevicesNotified[e]||(this.blockedDevicesNotified[e]={}),this.blockedDevicesNotified[e][t]=!0},m.prototype.sharedWithTooManyDevices=function(e){for(var t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return l.logger.log("Starting new megolm session because we shared with "+t),!0;for(var r in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(r)&&!e[t].hasOwnProperty(r))return l.logger.log("Starting new megolm session because we shared with "+t+":"+r),!0}},d.inherits(_,f.EncryptionAlgorithm),_.prototype._ensureOutboundSession=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n,i){var o,s,d,f,p=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=function(){return o},s=function(){var e=(0,c.default)(a.default.mark((function e(s){var d,f,v,m,_,b,S,k,E,w,I,T,R,x,C,O,A,D;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=s,d=y(t),o&&d!==o.sharedHistory&&(o=null),o&&o.needsRotation(p._sessionRotationPeriodMsgs,p._sessionRotationPeriodMs)&&(l.logger.log("Starting new megolm session because we need to rotate."),o=null),o&&o.sharedWithTooManyDevices(r)&&(o=null),o){e.next=12;break}return l.logger.log("Starting new megolm session for room ".concat(p._roomId)),e.next=9,p._prepareNewSession(d);case 9:o=e.sent,l.logger.log("Started new megolm session ".concat(o.sessionId," ")+"for room ".concat(p._roomId)),p._outboundSessions[o.sessionId]=o;case 12:f={},v=0,m=Object.entries(r);case 14:if(!(v<m.length)){e.next=29;break}_=(0,u.default)(m[v],2),b=_[0],S=_[1],k=0,E=Object.entries(S);case 17:if(!(k<E.length)){e.next=26;break}if(w=(0,u.default)(E[k],2),I=w[0],T=w[1],T.getIdentityKey()!=p._olmDevice.deviceCurve25519Key){e.next=22;break}return e.abrupt("continue",23);case 22:o.sharedWithDevices[b]&&void 0!==o.sharedWithDevices[b][I]||(f[b]=f[b]||[],f[b].push(T));case 23:k++,e.next=17;break;case 26:v++,e.next=14;break;case 29:return R=p._olmDevice.getOutboundGroupSessionKey(o.sessionId),x={type:"m.room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:p._roomId,session_id:o.sessionId,session_key:R.key,chain_index:R.chain_index,"org.matrix.msc3061.shared_history":d}},e.next=33,h.getExistingOlmSessions(p._olmDevice,p._baseApis,f);case 33:return C=e.sent,O=(0,u.default)(C,2),A=O[0],D=O[1],e.next=39,Promise.all([(0,c.default)(a.default.mark((function e(){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.logger.debug("Sharing keys with existing Olm sessions in ".concat(p._roomId)),e.next=3,p._shareKeyWithOlmSessions(o,R,x,D);case 3:l.logger.debug("Shared keys with existing Olm sessions in ".concat(p._roomId));case 4:case"end":return e.stop()}}),e)})))(),(0,c.default)(a.default.mark((function e(){var t,r,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.logger.debug("Sharing keys (start phase 1) with new Olm sessions in ".concat(p._roomId)),t=[],r=Date.now(),n=[],e.next=6,p._shareKeyWithDevices(o,R,x,A,t,i?1e4:2e3,n);case 6:if(l.logger.debug("Shared keys (end phase 1) with new Olm sessions in ".concat(p._roomId)),i||!(Date.now()-r<1e4)){e.next=11;break}(0,c.default)(a.default.mark((function e(){var r,i,s,u,c,d,h,f,v,y,m,_;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r={},i=new Set,s=g(n);try{for(s.s();!(u=s.n()).done;)c=u.value,i.add(c)}catch(e){s.e(e)}finally{s.f()}d=[],h=g(t);try{for(h.s();!(f=h.n()).done;)v=f.value,y=v.userId,m=v.deviceInfo,_=y.slice(y.indexOf(":")+1),i.has(_)?(r[y]=r[y]||[],r[y].push(m)):d.push({userId:y,deviceInfo:m})}catch(e){h.e(e)}finally{h.f()}return l.logger.debug("Sharing keys (start phase 2) with new Olm sessions in ".concat(p._roomId)),e.next=10,p._shareKeyWithDevices(o,R,x,r,d,3e4);case 10:return l.logger.debug("Shared keys (end phase 2) with new Olm sessions in ".concat(p._roomId)),e.next=13,p._notifyFailedOlmDevices(o,R,d);case 13:case"end":return e.stop()}}),e)})))(),e.next=13;break;case 11:return e.next=13,p._notifyFailedOlmDevices(o,R,t);case 13:l.logger.debug("Shared keys (all phases done) with new Olm sessions in ".concat(p._roomId));case 14:case"end":return e.stop()}}),e)})))(),(0,c.default)(a.default.mark((function e(){var t,r,i,s,c,d,h,f,g,v,y,m;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(l.logger.debug("Notifying blocked devices in ".concat(p._roomId)),t={},r=0,i=0,s=Object.entries(n);i<s.length;i++)for(c=(0,u.default)(s[i],2),d=c[0],h=c[1],f=0,g=Object.entries(h);f<g.length;f++)v=(0,u.default)(g[f],2),y=v[0],m=v[1],o.blockedDevicesNotified[d]&&void 0!==o.blockedDevicesNotified[d][y]||(t[d]=t[d]||{},t[d][y]={device:m},r++);return e.next=6,p._notifyBlockedDevices(o,t);case 6:l.logger.debug("Notified ".concat(r," blocked devices in ").concat(p._roomId));case 7:case"end":return e.stop()}}),e)})))()]);case 39:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),(f=this._setupPromise.then(s)).catch((function(e){l.logger.error("Failed to ensure outbound session in ".concat(p._roomId),e)})),this._setupPromise=f.then(d,d),e.abrupt("return",f.then(d));case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),_.prototype._prepareNewSession=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._olmDevice.createOutboundGroupSession(),n=this._olmDevice.getOutboundGroupSessionKey(r),e.next=4,this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],r,n.key,{ed25519:this._olmDevice.deviceEd25519Key},!1,{sharedHistory:t});case 4:return this._crypto._backupManager.backupGroupSession(this._olmDevice.deviceCurve25519Key,r),e.abrupt("return",new m(r,t));case 6:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),_.prototype._getDevicesWithoutSessions=function(e,t,r){r=r||[];for(var n=0,i=Object.entries(t);n<i.length;n++){var o,s=(0,u.default)(i[n],2),a=s[0],c=s[1],l=e[a],d=g(c);try{for(d.s();!(o=d.n()).done;){var h=o.value,f=h.deviceId;l[f].sessionId||(r.push({userId:a,deviceInfo:h}),delete l[f])}}catch(e){d.e(e)}finally{d.f()}}return r},_.prototype._splitDevices=function(e){for(var t=[],r=[t],n=0,i=Object.entries(e);n<i.length;n++){for(var o=(0,u.default)(i[n],2),s=o[0],a=o[1],c=0,l=Object.values(a);c<l.length;c++){var d=l[c];t.push({userId:s,deviceInfo:d.device})}t.length>20&&(t=[],r.push(t))}return 0===t.length&&r.pop(),r},_.prototype._encryptAndSendKeysToDevices=function(e,t,r,n){for(var i=this,o={},s=[],a=0;a<r.length;a++){var u={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},c=r[a],d=c.userId,f=c.deviceInfo,p=f.deviceId;o[d]||(o[d]={}),o[d][p]=u,s.push(h.encryptMessageForDevice(u.ciphertext,this._userId,this._deviceId,this._olmDevice,d,f,n))}return Promise.all(s).then((function(){for(var r=0,n=Object.keys(o);r<n.length;r++){for(var s=n[r],a=0,u=Object.keys(o[s]);a<u.length;a++){var c=u[a];0===Object.keys(o[s][c].ciphertext).length&&(l.logger.log("No ciphertext for device "+s+":"+c+": pruning"),delete o[s][c])}0===Object.keys(o[s]).length&&(l.logger.log("Pruned all devices for user "+s),delete o[s])}if(0!==Object.keys(o).length)return i._baseApis.sendToDevice("m.room.encrypted",o).then((function(){for(var r=0,n=Object.keys(o);r<n.length;r++)for(var i=n[r],s=0,a=Object.keys(o[i]);s<a.length;s++){var u=a[s];e.markSharedWithDevice(i,u,t)}}));l.logger.log("No users left to send to: aborting")}))},_.prototype._sendBlockedNotificationsToDevices=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n){var i,o,s,u,c,l,d,h,f,p,v,y,m,_,b;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i={},o=g(r);try{for(o.s();!(s=o.n()).done;)u=s.value,c=u.userId,l=u.deviceInfo,d=l.deviceInfo,h=d.deviceId,(f=Object.assign({},n)).code=l.code,f.reason=l.reason,"m.no_olm"===f.code&&(delete f.room_id,delete f.session_id),i[c]||(i[c]={}),i[c][h]=f}catch(e){o.e(e)}finally{o.f()}return e.next=5,this._baseApis.sendToDevice("org.matrix.room_key.withheld",i);case 5:for(p=0,v=Object.keys(i);p<v.length;p++)for(y=v[p],m=0,_=Object.keys(i[y]);m<_.length;m++)b=_[m],t.markNotifiedBlockedDevice(y,b);case 6:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),_.prototype.reshareKeyWithDevice=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n,i){var o,u,c,d,f;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=this._outboundSessions[r]){e.next=4;break}return l.logger.debug("megolm session ".concat(r," not found: not re-sharing keys")),e.abrupt("return");case 4:if(void 0!==o.sharedWithDevices[n]){e.next=7;break}return l.logger.debug("megolm session ".concat(r," never shared with user ").concat(n)),e.abrupt("return");case 7:if(void 0!==(u=o.sharedWithDevices[n][i.deviceId])){e.next=11;break}return l.logger.debug("megolm session ID "+r+" never shared with device "+n+":"+i.deviceId),e.abrupt("return");case 11:return e.next=13,this._olmDevice.getInboundGroupSessionKey(this._roomId,t,r,u);case 13:if(c=e.sent){e.next=17;break}return l.logger.warn("No inbound session key found for megolm ".concat(r,": not re-sharing keys")),e.abrupt("return");case 17:return e.next=19,h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,s.default)({},n,[i]));case 19:return d={type:"m.forwarded_room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:r,session_key:c.key,chain_index:c.chain_index,sender_key:t,sender_claimed_ed25519_key:c.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:c.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":c.shared_history||!1}},f={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=23,h.encryptMessageForDevice(f.ciphertext,this._userId,this._deviceId,this._olmDevice,n,i,d);case 23:return e.next=25,this._baseApis.sendToDevice("m.room.encrypted",(0,s.default)({},n,(0,s.default)({},i.deviceId,f)));case 25:l.logger.debug("Re-shared key for megolm session ".concat(r," ")+"with ".concat(n,":").concat(i.deviceId));case 26:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i){return e.apply(this,arguments)}}(),_.prototype._shareKeyWithDevices=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n,i,o,s,u){var c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return l.logger.debug("Ensuring Olm sessions for devices in ".concat(this._roomId)),e.next=3,h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,i,s,u,l.logger.withPrefix("[".concat(this._roomId,"]")));case 3:return c=e.sent,l.logger.debug("Ensured Olm sessions for devices in ".concat(this._roomId)),this._getDevicesWithoutSessions(c,i,o),l.logger.debug("Sharing keys with Olm sessions in ".concat(this._roomId)),e.next=9,this._shareKeyWithOlmSessions(t,r,n,c);case 9:l.logger.debug("Shared keys with Olm sessions in ".concat(this._roomId));case 10:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o,s,a){return e.apply(this,arguments)}}(),_.prototype._shareKeyWithOlmSessions=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n,i){var o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=this._splitDevices(i),s=0;case 2:if(!(s<o.length)){e.next=18;break}return u="megolm keys for ".concat(t.sessionId," ")+"in ".concat(this._roomId," (slice ").concat(s+1,"/").concat(o.length,")"),e.prev=4,l.logger.debug("Sharing ".concat(u)),e.next=8,this._encryptAndSendKeysToDevices(t,r.chain_index,o[s],n);case 8:l.logger.debug("Shared ".concat(u)),e.next=15;break;case 11:throw e.prev=11,e.t0=e.catch(4),l.logger.error("Failed to share ".concat(u)),e.t0;case 15:s++,e.next=2;break;case 18:case"end":return e.stop()}}),e,this,[[4,11]])})));return function(t,r,n,i){return e.apply(this,arguments)}}(),_.prototype._notifyFailedOlmDevices=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n){var i,o,s,u,c,d,h,f,v,y,m,_,b;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l.logger.debug("Notifying ".concat(n.length," devices we failed to ")+"create Olm sessions in ".concat(this._roomId)),i=g(n);try{for(i.s();!(o=i.n()).done;)s=o.value,u=s.userId,c=s.deviceInfo,d=c.deviceId,t.markSharedWithDevice(u,d,r.chain_index)}catch(e){i.e(e)}finally{i.f()}return e.next=5,this._olmDevice.filterOutNotifiedErrorDevices(n);case 5:h=e.sent,l.logger.debug("Filtered down to ".concat(h.length," error devices ")+"in ".concat(this._roomId)),f={},v=g(h);try{for(v.s();!(y=v.n()).done;)m=y.value,_=m.userId,b=m.deviceInfo,f[_]=f[_]||{},f[_][b.deviceId]={device:{code:"m.no_olm",reason:p.WITHHELD_MESSAGES["m.no_olm"],deviceInfo:b}}}catch(e){v.e(e)}finally{v.f()}return e.next=12,this._notifyBlockedDevices(t,f);case 12:l.logger.debug("Notified ".concat(h.length," devices we failed to ")+"create Olm sessions in ".concat(this._roomId));case 13:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),_.prototype._notifyBlockedDevices=function(){var e=(0,c.default)(a.default.mark((function e(t,r){var n,i,o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n={room_id:this._roomId,session_id:t.sessionId,algorithm:h.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key},i=this._splitDevices(r),o=0;case 3:if(!(o<i.length)){e.next=17;break}return e.prev=4,e.next=7,this._sendBlockedNotificationsToDevices(t,i[o],n);case 7:l.logger.log("Completed blacklist notification for ".concat(t.sessionId," ")+"in ".concat(this._roomId," (slice ").concat(o+1,"/").concat(i.length,")")),e.next=14;break;case 10:throw e.prev=10,e.t0=e.catch(4),l.logger.log("blacklist notification for ".concat(t.sessionId," in ")+"".concat(this._roomId," (slice ").concat(o+1,"/").concat(i.length,") failed")),e.t0;case 14:o++,e.next=3;break;case 17:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t,r){return e.apply(this,arguments)}}(),_.prototype.prepareToEncrypt=function(e){var t=this;if(this.encryptionPreparation){var r=Date.now()-this.encryptionPreparationMetadata.startTime;l.logger.debug("Already started preparing to encrypt for ".concat(this._roomId," ")+"".concat(r," ms ago, skipping"))}else l.logger.debug("Preparing to encrypt events for ".concat(this._roomId)),this.encryptionPreparationMetadata={startTime:Date.now()},this.encryptionPreparation=(0,c.default)(a.default.mark((function r(){var n,i,o,s;return a.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,l.logger.debug("Getting devices in ".concat(t._roomId)),r.next=4,t._getDevicesInRoom(e);case 4:return n=r.sent,i=(0,u.default)(n,2),o=i[0],s=i[1],t._crypto.getGlobalErrorOnUnknownDevices()&&t._removeUnknownDevices(o),l.logger.debug("Ensuring outbound session in ".concat(t._roomId)),r.next=12,t._ensureOutboundSession(e,o,s,!0);case 12:l.logger.debug("Ready to encrypt events for ".concat(t._roomId)),r.next=18;break;case 15:r.prev=15,r.t0=r.catch(0),l.logger.error("Failed to prepare to encrypt events for ".concat(t._roomId),r.t0);case 18:return r.prev=18,delete t.encryptionPreparationMetadata,delete t.encryptionPreparation,r.finish(18);case 22:case"end":return r.stop()}}),r,null,[[0,15,18,22]])})))()},_.prototype.encryptMessage=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n){var i,o,s,c,d,f,p,g;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(l.logger.log("Starting to encrypt event for ".concat(this._roomId)),!this.encryptionPreparation){e.next=9;break}return e.prev=2,e.next=5,this.encryptionPreparation;case 5:e.next=9;break;case 7:e.prev=7,e.t0=e.catch(2);case 9:return e.next=11,this._getDevicesInRoom(t);case 11:return i=e.sent,o=(0,u.default)(i,2),s=o[0],c=o[1],this._crypto.getGlobalErrorOnUnknownDevices()&&this._checkForUnknownDevices(s),e.next=18,this._ensureOutboundSession(t,s,c);case 18:return d=e.sent,f={room_id:this._roomId,type:r,content:n},p=this._olmDevice.encryptGroupMessage(d.sessionId,JSON.stringify(f)),g={algorithm:h.MEGOLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:p,session_id:d.sessionId,device_id:this._deviceId},d.useCount++,e.abrupt("return",g);case 24:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t,r,n){return e.apply(this,arguments)}}(),_.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then((function(){return null}))},_.prototype._checkForUnknownDevices=function(e){var t={};if(Object.keys(e).forEach((function(r){Object.keys(e[r]).forEach((function(n){var i=e[r][n];i.isUnverified()&&!i.isKnown()&&(t[r]||(t[r]={}),t[r][n]=i)}))})),Object.keys(t).length)throw new f.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},_.prototype._removeUnknownDevices=function(e){for(var t=0,r=Object.entries(e);t<r.length;t++){for(var n=(0,u.default)(r[t],2),i=n[0],o=n[1],s=0,a=Object.entries(o);s<a.length;s++){var c=(0,u.default)(a[s],2),l=c[0],d=c[1];d.isUnverified()&&!d.isKnown()&&delete o[l]}0===Object.keys(o).length&&delete e[i]}},_.prototype._getDevicesInRoom=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n,i,o,s,u,c,l,d,h;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getEncryptionTargetMembers();case 2:return r=e.sent,n=r.map((function(e){return e.userId})),i=this._crypto.getGlobalBlacklistUnverifiedDevices(),"boolean"==typeof t.getBlacklistUnverifiedDevices()&&(i=t.getBlacklistUnverifiedDevices()),e.next=8,this._crypto.downloadKeys(n,!1);case 8:o=e.sent,s={},e.t0=a.default.keys(o);case 11:if((e.t1=e.t0()).done){e.next=27;break}if(u=e.t1.value,o.hasOwnProperty(u)){e.next=15;break}return e.abrupt("continue",11);case 15:c=o[u],e.t2=a.default.keys(c);case 17:if((e.t3=e.t2()).done){e.next=25;break}if(l=e.t3.value,c.hasOwnProperty(l)){e.next=21;break}return e.abrupt("continue",17);case 21:d=this._crypto.checkDeviceTrust(u,l),(c[l].isBlocked()||!d.isVerified()&&i)&&(s[u]||(s[u]={}),(h=c[l].isBlocked()?{code:"m.blacklisted",reason:p.WITHHELD_MESSAGES["m.blacklisted"]}:{code:"m.unverified",reason:p.WITHHELD_MESSAGES["m.unverified"]}).deviceInfo=c[l],s[u][l]=h,delete c[l]),e.next=17;break;case 25:e.next=11;break;case 27:return e.abrupt("return",[o,s]);case 28:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),d.inherits(b,f.DecryptionAlgorithm);var S={no_olm:"The sender was unable to establish a secure channel.",unknown:"The secure channel with the sender was corrupted."};b.prototype.decryptEvent=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n,i,o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.getWireContent()).sender_key&&r.session_id&&r.ciphertext){e.next=3;break}throw new f.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");case 3:return this._addEventToPendingList(t),e.prev=4,e.next=7,this._olmDevice.decryptGroupMessage(t.getRoomId(),r.sender_key,r.session_id,r.ciphertext,t.getId(),t.getTs());case 7:n=e.sent,e.next=17;break;case 10:if(e.prev=10,e.t0=e.catch(4),"DecryptionError"!==e.t0.name){e.next=14;break}throw e.t0;case 14:throw i="OLM_DECRYPT_GROUP_MESSAGE_ERROR",e.t0&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.t0.message&&(this._requestKeysForEvent(t),i="OLM_UNKNOWN_MESSAGE_INDEX"),new f.DecryptionError(i,e.t0?e.t0.toString():"Unknown Error: Error is undefined",{session:r.sender_key+"|"+r.session_id});case 17:if(null!==n){e.next=27;break}return this._requestKeysForEvent(t),e.next=21,this._olmDevice.sessionMayHaveProblems(r.sender_key,t.getTs()-12e4);case 21:if(!(o=e.sent)){e.next=26;break}throw s=S[o.type]||S.unknown,o.fixed&&(s+=" Trying to create a new secure channel and re-requesting the keys."),new f.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID",s,{session:r.sender_key+"|"+r.session_id});case 26:throw new f.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:r.sender_key+"|"+r.session_id});case 27:if(this._removeEventFromPendingList(t),(u=JSON.parse(n.result)).room_id===t.getRoomId()){e.next=31;break}throw new f.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+u.room_id);case 31:return e.abrupt("return",{clearEvent:u,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain,untrusted:n.untrusted});case 32:case"end":return e.stop()}}),e,this,[[4,10]])})));return function(t){return e.apply(this,arguments)}}(),b.prototype._requestKeysForEvent=function(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)},b.prototype._addEventToPendingList=function(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id;this._pendingEvents[r]||(this._pendingEvents[r]=new Map);var i=this._pendingEvents[r];i.has(n)||i.set(n,new Set),i.get(n).add(e)},b.prototype._removeEventFromPendingList=function(e){var t=e.getWireContent(),r=t.sender_key,n=t.session_id,i=this._pendingEvents[r],o=i&&i.get(n);o&&(o.delete(e),0===o.size&&i.delete(r),0===i.size&&delete this._pendingEvents[r])},b.prototype.onRoomKeyEvent=function(e){var t,r=this,n=e.getContent(),i=n.session_id,o=e.getSenderKey(),s=[],a=!1;if(n.room_id&&i&&n.session_key){if(o){if("m.forwarded_room_key"==e.getType()){if(a=!0,s=n.forwarding_curve25519_key_chain,Array.isArray(s)||(s=[]),(s=s.slice()).push(o),!(o=n.sender_key))return void l.logger.error("forwarded_room_key event is missing sender_key field");var u=n.sender_claimed_ed25519_key;if(!u)return void l.logger.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");t={ed25519:u}}else t=e.getKeysClaimed();var c={};return n["org.matrix.msc3061.shared_history"]&&(c.sharedHistory=!0),this._olmDevice.addInboundGroupSession(n.room_id,o,s,i,n.session_key,t,a,c).then((function(){r._retryDecryption(o,i).then((function(e){e&&r._crypto.cancelRoomKeyRequest({algorithm:n.algorithm,room_id:n.room_id,session_id:n.session_id,sender_key:o})}))})).then((function(){r._crypto._backupManager.backupGroupSession(o,n.session_id)})).catch((function(e){l.logger.error("Error handling m.room_key_event: ".concat(e))}))}l.logger.error("key event has no sender key (not encrypted?)")}else l.logger.error("key event is missing fields")},b.prototype.onRoomKeyWithheldEvent=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n,i,o,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getContent(),n=r.sender_key,"m.no_olm"!==r.code){e.next=36;break}return i=t.getSender(),l.logger.warn("".concat(i,":").concat(n," was unable to establish an olm session with us")),e.next=7,this._olmDevice.getSessionIdForDevice(n);case 7:if(!e.sent){e.next=13;break}return l.logger.debug("New session already created.  Not creating a new one."),e.next=11,this._olmDevice.recordSessionProblem(n,"no_olm",!0);case 11:return this.retryDecryptionFromSender(n),e.abrupt("return");case 13:if(o=this._crypto._deviceList.getDeviceByIdentityKey(r.algorithm,n)){e.next=24;break}return e.next=17,this._crypto.downloadKeys([i],!1);case 17:if(o=this._crypto._deviceList.getDeviceByIdentityKey(r.algorithm,n)){e.next=24;break}return l.logger.info("Couldn't find device for identity key "+n+": not establishing session"),e.next=22,this._olmDevice.recordSessionProblem(n,"no_olm",!1);case 22:return this.retryDecryptionFromSender(n),e.abrupt("return");case 24:return e.next=26,h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,s.default)({},i,[o]),!1);case 26:return u={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=29,h.encryptMessageForDevice(u.ciphertext,this._userId,this._deviceId,this._olmDevice,i,o,{type:"m.dummy"});case 29:return e.next=31,this._olmDevice.recordSessionProblem(n,"no_olm",!0);case 31:return this.retryDecryptionFromSender(n),e.next=34,this._baseApis.sendToDevice("m.room.encrypted",(0,s.default)({},i,(0,s.default)({},o.deviceId,u)));case 34:e.next=38;break;case 36:return e.next=38,this._olmDevice.addInboundGroupSessionWithheld(r.room_id,n,r.session_id,r.code,r.reason);case 38:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),b.prototype.hasKeysForKeyRequest=function(e){var t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},b.prototype.shareKeysWithDevice=function(e){var t=this,r=e.userId,n=e.deviceId,i=this._crypto.getStoredDevice(r,n),o=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,s.default)({},r,[i])).then((function(e){return e[r][n].sessionId?(l.logger.log("sharing keys for session "+o.sender_key+"|"+o.session_id+" with device "+r+":"+n),t._buildKeyForwardingMessage(o.room_id,o.sender_key,o.session_id)):null})).then((function(e){var o={algorithm:h.OLM_ALGORITHM,sender_key:t._olmDevice.deviceCurve25519Key,ciphertext:{}};return t.olmlib.encryptMessageForDevice(o.ciphertext,t._userId,t._deviceId,t._olmDevice,r,i,e).then((function(){var e=(0,s.default)({},r,(0,s.default)({},n,o));return t._baseApis.sendToDevice("m.room.encrypted",e)}))}))},b.prototype._buildKeyForwardingMessage=function(){var e=(0,c.default)(a.default.mark((function e(t,r,n){var i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._olmDevice.getInboundGroupSessionKey(t,r,n);case 2:return i=e.sent,e.abrupt("return",{type:"m.forwarded_room_key",content:{algorithm:h.MEGOLM_ALGORITHM,room_id:t,sender_key:r,sender_claimed_ed25519_key:i.sender_claimed_ed25519_key,session_id:n,session_key:i.key,chain_index:i.chain_index,forwarding_curve25519_key_chain:i.forwarding_curve25519_key_chain,"org.matrix.msc3061.shared_history":i.shared_history||!1}});case 4:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),b.prototype.importRoomKey=function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n={};return r.untrusted&&(n.untrusted=!0),e["org.matrix.msc3061.shared_history"]&&(n.sharedHistory=!0),this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0,n).then((function(){"backup"!==r.source&&t._crypto._backupManager.backupGroupSession(e.sender_key,e.session_id).catch((function(e){l.logger.log("Failed to back up megolm session",e)})),t._retryDecryption(e.sender_key,e.session_id)}))},b.prototype._retryDecryption=function(){var e=(0,c.default)(a.default.mark((function e(t,r){var n,i,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._pendingEvents[t]){e.next=3;break}return e.abrupt("return",!0);case 3:if(i=n.get(r)){e.next=6;break}return e.abrupt("return",!0);case 6:return l.logger.debug("Retrying decryption on events",(0,o.default)(i)),e.next=9,Promise.all((0,o.default)(i).map(function(){var e=(0,c.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.attemptDecryption(s._crypto,{isRetry:!0});case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()));case 9:return e.abrupt("return",!(this._pendingEvents[t]||{})[r]);case 10:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),b.prototype.retryDecryptionFromSender=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._pendingEvents[t]){e.next=3;break}return e.abrupt("return",!0);case 3:return delete this._pendingEvents[t],e.next=6,Promise.all((0,o.default)(r).map(function(){var e=(0,c.default)(a.default.mark((function e(t){var r,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=(0,u.default)(t,2),r[0],i=r[1],e.next=3,Promise.all((0,o.default)(i).map(function(){var e=(0,c.default)(a.default.mark((function e(t){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,t.attemptDecryption(n._crypto);case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,null,[[0,5]])})));return function(t){return e.apply(this,arguments)}}()));case 3:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()));case 6:return e.abrupt("return",!this._pendingEvents[t]);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),b.prototype.sendSharedHistoryInboundSessions=function(){var e=(0,c.default)(a.default.mark((function e(t){var r,n,i,o,s,c,d,f,p,v,y,m,_,b,S,k,E,w,I,T,R,x,C,O;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,h.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t);case 2:return l.logger.log("sendSharedHistoryInboundSessions to users",Object.keys(t)),e.next=5,this._olmDevice.getSharedHistoryInboundGroupSessions(this._roomId);case 5:r=e.sent,l.logger.log("shared-history sessions",r),n=g(r),e.prev=8,n.s();case 10:if((i=n.n()).done){e.next=28;break}return o=(0,u.default)(i.value,2),s=o[0],c=o[1],e.next=14,this._buildKeyForwardingMessage(this._roomId,s,c);case 14:for(d=e.sent,f=[],p={},v=0,y=Object.entries(t);v<y.length;v++){m=(0,u.default)(y[v],2),_=m[0],b=m[1],p[_]={},S=g(b);try{for(S.s();!(k=S.n()).done;)E=k.value,w={algorithm:h.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},p[_][E.deviceId]=w,f.push(h.encryptMessageForDevice(w.ciphertext,this._userId,this._deviceId,this._olmDevice,_,E,d))}catch(e){S.e(e)}finally{S.f()}}return e.next=20,Promise.all(f);case 20:for(I=0,T=Object.keys(p);I<T.length;I++){for(R=T[I],x=0,C=Object.keys(p[R]);x<C.length;x++)O=C[x],0===Object.keys(p[R][O].ciphertext).length&&(l.logger.log("No ciphertext for device "+R+":"+O+": pruning"),delete p[R][O]);0===Object.keys(p[R]).length&&(l.logger.log("Pruned all devices for user "+R),delete p[R])}if(0!==Object.keys(p).length){e.next=24;break}return l.logger.log("No users left to send to: aborting"),e.abrupt("return");case 24:return e.next=26,this._baseApis.sendToDevice("m.room.encrypted",p);case 26:e.next=10;break;case 28:e.next=33;break;case 30:e.prev=30,e.t0=e.catch(8),n.e(e.t0);case 33:return e.prev=33,n.f(),e.finish(33);case 36:case"end":return e.stop()}}),e,this,[[8,30,33,36]])})));return function(t){return e.apply(this,arguments)}}(),(0,f.registerAlgorithm)(h.MEGOLM_ALGORITHM,_,b)},{"../../logger":102,"../../utils":133,"../OlmDevice":66,"../olmlib":81,"./base":71,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/helpers/toConsumableArray":23,"@babel/runtime/regenerator":27}],74:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault"),o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=e("../../logger"),u=n(e("../../utils")),c=n(e("../olmlib")),l=e("../deviceinfo"),d=e("./base"),h=l.DeviceInfo.DeviceVerification;function f(e){(0,u.polyfillSuper)(this,d.EncryptionAlgorithm,e),this._sessionPrepared=!1,this._prepPromise=null}function p(e){(0,u.polyfillSuper)(this,d.DecryptionAlgorithm,e)}u.inherits(f,d.EncryptionAlgorithm),f.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return Promise.resolve();var t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(r){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},f.prototype.encryptMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r,n){var i,s,a,u,l,d,f,p,g,v,y;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getEncryptionTargetMembers();case 2:return i=e.sent,s=i.map((function(e){return e.userId})),a=this,e.next=7,this._ensureSession(s);case 7:u={room_id:t.roomId,type:r,content:n},l={algorithm:c.OLM_ALGORITHM,sender_key:a._olmDevice.deviceCurve25519Key,ciphertext:{}},d=[],f=0;case 11:if(!(f<s.length)){e.next=29;break}p=s[f],g=a._crypto.getStoredDevicesForUser(p),v=0;case 15:if(!(v<g.length)){e.next=26;break}if(y=g[v],y.getIdentityKey()!=a._olmDevice.deviceCurve25519Key){e.next=20;break}return e.abrupt("continue",23);case 20:if(y.verified!=h.BLOCKED){e.next=22;break}return e.abrupt("continue",23);case 22:d.push(c.encryptMessageForDevice(l.ciphertext,a._userId,a._deviceId,a._olmDevice,p,y,u));case 23:++v,e.next=15;break;case 26:++f,e.next=11;break;case 29:return e.next=31,Promise.all(d).then((function(){return l}));case 31:return e.abrupt("return",e.sent);case 32:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),u.inherits(p,d.DecryptionAlgorithm),p.prototype.decryptEvent=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n,i,s,a,u,c;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getWireContent(),n=r.sender_key,i=r.ciphertext){e.next=5;break}throw new d.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");case 5:if(this._olmDevice.deviceCurve25519Key in i){e.next=7;break}throw new d.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");case 7:return s=i[this._olmDevice.deviceCurve25519Key],e.prev=8,e.next=11,this._decryptMessage(n,s);case 11:a=e.sent,e.next=17;break;case 14:throw e.prev=14,e.t0=e.catch(8),new d.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e.t0});case 17:if((u=JSON.parse(a)).recipient==this._userId){e.next=20;break}throw new d.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+u.recipient);case 20:if(u.recipient_keys.ed25519==this._olmDevice.deviceEd25519Key){e.next=22;break}throw new d.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:u.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});case 22:if(u.sender==t.getSender()){e.next=24;break}throw new d.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+u.sender,{reported_sender:t.getSender()});case 24:if(u.room_id===t.getRoomId()){e.next=26;break}throw new d.DecryptionError("OLM_BAD_ROOM","Message intended for room "+u.room_id,{reported_room:t.room_id});case 26:return c=u.keys||{},e.abrupt("return",{clearEvent:u,senderCurve25519Key:n,claimedEd25519Key:c.ed25519||null});case 28:case"end":return e.stop()}}),e,this,[[8,14]])})));return function(t){return e.apply(this,arguments)}}(),p.prototype._decryptMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r){var n,i=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===r.type){e.next=4;break}return e.abrupt("return",this._reallyDecryptMessage(t,r));case 4:return n=this._olmDevice._olmPrekeyPromise.then((function(){return i._reallyDecryptMessage(t,r)})),this._olmDevice._olmPrekeyPromise=n.catch((function(){})),e.next=8,n;case 8:return e.abrupt("return",e.sent);case 9:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),p.prototype._reallyDecryptMessage=function(){var e=(0,s.default)(o.default.mark((function e(t,r){var n,i,s,u,c,l;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._olmDevice.getSessionIdsForDevice(t);case 2:n=e.sent,i={},s=0;case 5:if(!(s<n.length)){e.next=26;break}return u=n[s],e.prev=7,e.next=10,this._olmDevice.decryptMessage(t,u,r.type,r.body);case 10:return c=e.sent,a.logger.log("Decrypted Olm message from "+t+" with session "+u),e.abrupt("return",c);case 15:return e.prev=15,e.t0=e.catch(7),e.next=19,this._olmDevice.matchesSession(t,u,r.type,r.body);case 19:if(!e.sent){e.next=22;break}throw new Error("Error decrypting prekey message with existing session id "+u+": "+e.t0.message);case 22:i[u]=e.t0.message;case 23:s++,e.next=5;break;case 26:if(0===r.type){e.next=30;break}if(0!==n.length){e.next=29;break}throw new Error("No existing sessions");case 29:throw new Error("Error decrypting non-prekey message with existing sessions: "+JSON.stringify(i));case 30:return e.prev=30,e.next=33,this._olmDevice.createInboundSession(t,r.type,r.body);case 33:l=e.sent,e.next=40;break;case 36:throw e.prev=36,e.t1=e.catch(30),i["(new)"]=e.t1.message,new Error("Error decrypting prekey message: "+JSON.stringify(i));case 40:return a.logger.log("created new inbound Olm session ID "+l.session_id+" with "+t),e.abrupt("return",l.payload);case 42:case"end":return e.stop()}}),e,this,[[7,15],[30,36]])})));return function(t,r){return e.apply(this,arguments)}}(),(0,d.registerAlgorithm)(c.OLM_ALGORITHM,f,p)},{"../../logger":102,"../../utils":133,"../deviceinfo":78,"../olmlib":81,"./base":71,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27}],75:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.CrossSigningKey=void 0,function(e){e.Master="master",e.SelfSigning="self_signing",e.UserSigning="user_signing"}(r.CrossSigningKey||(r.CrossSigningKey={}))},{}],76:[function(e,t,r){(function(t){(function(){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.DefaultAlgorithm=r.algorithmsByName=r.Curve25519=r.BackupManager=void 0;const i=e("../client"),o=e("../logger"),s=e("./olmlib"),a=e("./key_passphrase"),u=e("../utils"),c=e("./store/indexeddb-crypto-store"),l=e("./recoverykey");class d{constructor(e,t){this.baseApis=e,this.getKey=t,this.checkedForBackup=!1,this.sendingBackups=!1}get version(){return this.backupInfo&&this.backupInfo.version}static makeAlgorithm(e,t){return n(this,void 0,void 0,(function*(){const n=r.algorithmsByName[e.algorithm];if(!n)throw new Error("Unknown backup algorithm");return yield n.init(e.auth_data,t)}))}enableKeyBackup(e){return n(this,void 0,void 0,(function*(){this.backupInfo=e,this.algorithm&&this.algorithm.free(),this.algorithm=yield d.makeAlgorithm(e,this.getKey),this.baseApis.emit("crypto.keyBackupStatus",!0),this.scheduleKeyBackupSend()}))}disableKeyBackup(){this.algorithm&&this.algorithm.free(),this.algorithm=void 0,this.backupInfo=void 0,this.baseApis.emit("crypto.keyBackupStatus",!1)}getKeyBackupEnabled(){return this.checkedForBackup?Boolean(this.algorithm):null}prepareKeyBackupVersion(e,t){return n(this,void 0,void 0,(function*(){const n=t?r.algorithmsByName[t]:r.DefaultAlgorithm;if(!n)throw new Error("Unknown backup algorithm");const[i,o]=yield n.prepare(e),s=l.encodeRecoveryKey(i);return{algorithm:n.algorithmName,auth_data:o,recovery_key:s,privateKey:i}}))}createKeyBackupVersion(e){return n(this,void 0,void 0,(function*(){this.algorithm=yield d.makeAlgorithm(e,this.getKey)}))}checkAndStart(){return n(this,void 0,void 0,(function*(){if(o.logger.log("Checking key backup status..."),this.baseApis.isGuest())return o.logger.log("Skipping key backup check since user is guest"),this.checkedForBackup=!0,null;let e;try{e=yield this.baseApis.getKeyBackupVersion()}catch(e){return o.logger.log("Error checking for active key backup",e),404===e.httpStatus&&(this.checkedForBackup=!0),null}this.checkedForBackup=!0;const t=yield this.isKeyBackupTrusted(e);return t.usable&&!this.backupInfo?(o.logger.log("Found usable key backup v"+e.version+": enabling key backups"),yield this.enableKeyBackup(e)):!t.usable&&this.backupInfo?(o.logger.log("No usable key backup: disabling key backup"),this.disableKeyBackup()):t.usable||this.backupInfo?t.usable&&this.backupInfo&&(e.version!==this.backupInfo.version?(o.logger.log("On backup version "+this.backupInfo.version+" but found version "+e.version+": switching."),this.disableKeyBackup(),yield this.enableKeyBackup(e),yield this.scheduleAllGroupSessionsForBackup()):o.logger.log("Backup version "+e.version+" still current")):o.logger.log("No usable key backup: not enabling key backup"),{backupInfo:e,trustInfo:t}}))}checkKeyBackup(){return n(this,void 0,void 0,(function*(){return this.checkedForBackup=!1,this.checkAndStart()}))}isKeyBackupTrusted(e){return n(this,void 0,void 0,(function*(){const t={usable:!1,trusted_locally:!1,sigs:[]};if(!(e&&e.algorithm&&e.auth_data&&e.auth_data.public_key&&e.auth_data.signatures))return o.logger.info("Key backup is absent or missing required data"),t;const r=this.baseApis.crypto._sessionStore.getLocalTrustedBackupPubKey();e.auth_data.public_key===r&&(o.logger.info("Backup public key "+r+" is trusted locally"),t.trusted_locally=!0);const n=e.auth_data.signatures[this.baseApis.getUserId()]||[];for(const r of Object.keys(n)){const n=r.split(":");if("ed25519"!==n[0]){o.logger.log("Ignoring unknown signature type: "+n[0]);continue}const i={deviceId:n[1]},a=this.baseApis.crypto._crossSigningInfo.getId();if(a===i.deviceId){i.crossSigningId=!0;try{yield s.verifySignature(this.baseApis.crypto._olmDevice,e.auth_data,this.baseApis.getUserId(),i.deviceId,a),i.valid=!0}catch(e){o.logger.warn("Bad signature from cross signing key "+a,e),i.valid=!1}t.sigs.push(i);continue}const u=this.baseApis.crypto._deviceList.getStoredDevice(this.baseApis.getUserId(),i.deviceId);if(u){i.device=u,i.deviceTrust=yield this.baseApis.checkDeviceTrust(this.baseApis.getUserId(),i.deviceId);try{yield s.verifySignature(this.baseApis.crypto._olmDevice,e.auth_data,this.baseApis.getUserId(),u.deviceId,u.getFingerprint()),i.valid=!0}catch(t){o.logger.info("Bad signature from key ID "+r+" userID "+this.baseApis.getUserId()+" device ID "+u.deviceId+" fingerprint: "+u.getFingerprint(),e.auth_data,t),i.valid=!1}}else i.valid=null,o.logger.info("Ignoring signature from unknown key "+r);t.sigs.push(i)}return t.usable=t.sigs.some((e=>e.valid&&(e.device&&e.deviceTrust.isVerified()||e.crossSigningId))),t.usable=t.usable||t.trusted_locally,t}))}scheduleKeyBackupSend(e=1e4){return n(this,void 0,void 0,(function*(){if(!this.sendingBackups){this.sendingBackups=!0;try{const t=Math.random()*e;yield u.sleep(t,void 0);let r=0;for(;;){if(!this.algorithm)return;try{if(0===(yield this.backupPendingKeys(200)))return;r=0}catch(e){if(r++,o.logger.log("Key backup request failed",e),e.data&&("M_NOT_FOUND"==e.data.errcode||"M_WRONG_ROOM_KEYS_VERSION"==e.data.errcode))throw yield this.checkKeyBackup(),this.baseApis.crypto.emit("crypto.keyBackupFailed",e.data.errcode),e}r&&(yield u.sleep(1e3*Math.pow(2,Math.min(r-1,4)),void 0))}}finally{this.sendingBackups=!1}}}))}backupPendingKeys(e){return n(this,void 0,void 0,(function*(){const t=yield this.baseApis.crypto._cryptoStore.getSessionsNeedingBackup(e);if(!t.length)return 0;let r=yield this.baseApis.crypto._cryptoStore.countSessionsNeedingBackup();this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",r);const n={};for(const e of t){const t=e.sessionData.room_id;void 0===n[t]&&(n[t]={sessions:{}});const r=yield this.baseApis.crypto._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);r.algorithm=s.MEGOLM_ALGORITHM;const i=(r.forwarding_curve25519_key_chain||[]).length,o=this.baseApis.crypto._deviceList.getUserByIdentityKey(s.MEGOLM_ALGORITHM,e.senderKey),a=this.baseApis.crypto._deviceList.getDeviceByIdentityKey(s.MEGOLM_ALGORITHM,e.senderKey),u=this.baseApis.crypto._checkDeviceInfoTrust(o,a).isVerified();n[t].sessions[e.sessionId]={first_message_index:r.first_known_index,forwarded_count:i,is_verified:u,session_data:yield this.algorithm.encryptSession(r)}}return yield this.baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:n}),yield this.baseApis.crypto._cryptoStore.unmarkSessionsNeedingBackup(t),r=yield this.baseApis.crypto._cryptoStore.countSessionsNeedingBackup(),this.baseApis.crypto.emit("crypto.keyBackupSessionsRemaining",r),t.length}))}backupGroupSession(e,t){return n(this,void 0,void 0,(function*(){yield this.baseApis.crypto._cryptoStore.markSessionsNeedingBackup([{senderKey:e,sessionId:t}]),this.backupInfo&&this.scheduleKeyBackupSend()}))}scheduleAllGroupSessionsForBackup(){return n(this,void 0,void 0,(function*(){yield this.flagAllGroupSessionsForBackup(),this.scheduleKeyBackupSend(0)}))}flagAllGroupSessionsForBackup(){return n(this,void 0,void 0,(function*(){yield this.baseApis.crypto._cryptoStore.doTxn("readwrite",[c.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS,c.IndexedDBCryptoStore.STORE_BACKUP],(e=>{this.baseApis.crypto._cryptoStore.getAllEndToEndInboundGroupSessions(e,(t=>{null!==t&&this.baseApis.crypto._cryptoStore.markSessionsNeedingBackup([t],e)}))}));const e=yield this.baseApis.crypto._cryptoStore.countSessionsNeedingBackup();return this.baseApis.emit("crypto.keyBackupSessionsRemaining",e),e}))}countSessionsNeedingBackup(){return this.baseApis.crypto._cryptoStore.countSessionsNeedingBackup()}}r.BackupManager=d;class h{constructor(e,t,r){this.authData=e,this.publicKey=t,this.getKey=r}static init(e,r){return n(this,void 0,void 0,(function*(){if(!e||!e.public_key)throw new Error("auth_data missing required information");const n=new t.Olm.PkEncryption;return n.set_recipient_key(e.public_key),new h(e,n,r)}))}static prepare(e){return n(this,void 0,void 0,(function*(){const r=new t.Olm.PkDecryption;try{const n={};if(e)if(e instanceof Uint8Array)n.public_key=r.init_with_private_key(e);else{const t=yield a.keyFromPassphrase(e);n.private_key_salt=t.salt,n.private_key_iterations=t.iterations,n.public_key=r.init_with_private_key(t.key)}else n.public_key=r.generate_key();return(new t.Olm.PkEncryption).set_recipient_key(n.public_key),[r.get_private_key(),n]}finally{r.free()}}))}encryptSession(e){return n(this,void 0,void 0,(function*(){const t=Object.assign({},e);return delete t.session_id,delete t.room_id,delete t.first_known_index,this.publicKey.encrypt(JSON.stringify(t))}))}decryptSessions(e){return n(this,void 0,void 0,(function*(){const r=yield this.getKey(),n=new t.Olm.PkDecryption;try{if(n.init_with_private_key(r)!==this.authData.public_key)throw{errcode:i.MatrixClient.RESTORE_BACKUP_ERROR_BAD_KEY};const t=[];for(const[r,i]of Object.entries(e))try{const e=JSON.parse(n.decrypt(i.session_data.ephemeral,i.session_data.mac,i.session_data.ciphertext));e.session_id=r,t.push(e)}catch(e){o.logger.log("Failed to decrypt megolm session from backup",e,i)}return t}finally{n.free()}}))}keyMatches(e){return n(this,void 0,void 0,(function*(){const r=new t.Olm.PkDecryption;let n;try{n=r.init_with_private_key(e)}finally{r.free()}return n===this.authData.public_key}))}free(){this.publicKey.free()}}r.Curve25519=h,h.algorithmName="m.megolm_backup.v1.curve25519-aes-sha2",r.algorithmsByName={[h.algorithmName]:h},r.DefaultAlgorithm=h}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../client":60,"../logger":102,"../utils":133,"./key_passphrase":80,"./olmlib":81,"./recoverykey":82,"./store/indexeddb-crypto-store":84}],77:[function(e,t,r){(function(t,n){(function(){"use strict";var i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))},o=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.DehydrationManager=r.DEHYDRATION_ALGORITHM=void 0;const s=e("./olmlib"),a=e("../crypto/store/indexeddb-crypto-store"),u=e("./aes"),c=o(e("another-json")),l=e("../logger");r.DEHYDRATION_ALGORITHM="org.matrix.msc2697.v1.olm.libolm_pickle";const d=6048e5;r.DehydrationManager=class{constructor(e){this.crypto=e,this.inProgress=!1,this.getDehydrationKeyFromCache()}getDehydrationKeyFromCache(){return i(this,void 0,void 0,(function*(){return yield this.crypto._cryptoStore.doTxn("readonly",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto._cryptoStore.getSecretStorePrivateKey(e,(e=>i(this,void 0,void 0,(function*(){if(e){const{key:i,keyInfo:o,deviceDisplayName:a,time:c}=e,l=n.from(this.crypto._olmDevice._pickleKey),h=yield u.decryptAES(i,l,r.DEHYDRATION_ALGORITHM);this.key=s.decodeBase64(h),this.keyInfo=o,this.deviceDisplayName=a;const f=Date.now(),p=Math.max(1,c+d-f);this.timeoutId=t.setTimeout(this.dehydrateDevice.bind(this),p)}}))),"dehydration")}))}))}setKeyAndQueueDehydration(e,t={},r){return i(this,void 0,void 0,(function*(){(yield this.setKey(e,t,r))||this.dehydrateDevice()}))}setKey(e,r={},n){return i(this,void 0,void 0,(function*(){if(!e)return this.timeoutId&&(t.clearTimeout(this.timeoutId),this.timeoutId=void 0),yield this.crypto._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto._cryptoStore.storeSecretStorePrivateKey(e,"dehydration",null)})),this.key=void 0,void(this.keyInfo=void 0);let i=this.key&&e.length==this.key.length;for(let t=0;i&&t<e.length;t++)e[t]!=this.key[t]&&(i=!1);return i||(this.key=e,this.keyInfo=r,this.deviceDisplayName=n),i}))}dehydrateDevice(){return i(this,void 0,void 0,(function*(){if(this.inProgress)l.logger.log("Dehydration already in progress -- not starting new dehydration");else{this.inProgress=!0,this.timeoutId&&(t.clearTimeout(this.timeoutId),this.timeoutId=void 0);try{const e=n.from(this.crypto._olmDevice._pickleKey),i=yield u.encryptAES(s.encodeBase64(this.key),e,r.DEHYDRATION_ALGORITHM);yield this.crypto._cryptoStore.doTxn("readwrite",[a.IndexedDBCryptoStore.STORE_ACCOUNT],(e=>{this.crypto._cryptoStore.storeSecretStorePrivateKey(e,"dehydration",{keyInfo:this.keyInfo,key:i,deviceDisplayName:this.deviceDisplayName,time:Date.now()})})),l.logger.log("Attempting to dehydrate device"),l.logger.log("Creating account");const o=new t.Olm.Account;o.create();const h=JSON.parse(o.identity_keys()),f=o.max_number_of_one_time_keys();o.generate_one_time_keys(f/2),o.generate_fallback_key();const p=JSON.parse(o.one_time_keys()),g=JSON.parse(o.fallback_key());o.mark_keys_as_published();const v=o.pickle(new Uint8Array(this.key)),y={algorithm:r.DEHYDRATION_ALGORITHM,account:v};this.keyInfo.passphrase&&(y.passphrase=this.keyInfo.passphrase),l.logger.log("Uploading account to server");const m=(yield this.crypto._baseApis.http.authedRequest(void 0,"PUT","/dehydrated_device",void 0,{device_data:y,initial_device_display_name:this.deviceDisplayName},{prefix:"/_matrix/client/unstable/org.matrix.msc2697.v2"})).device_id;l.logger.log("Preparing device keys",m);const _={algorithms:this.crypto._supportedAlgorithms,device_id:m,user_id:this.crypto._userId,keys:{[`ed25519:${m}`]:h.ed25519,[`curve25519:${m}`]:h.curve25519}},b=o.sign(c.default.stringify(_));_.signatures={[this.crypto._userId]:{[`ed25519:${m}`]:b}},this.crypto._crossSigningInfo.getId("self_signing")&&(yield this.crypto._crossSigningInfo.signObject(_,"self_signing")),l.logger.log("Preparing one-time keys");const S={};for(const[e,t]of Object.entries(p.curve25519)){const r={key:t},n=o.sign(c.default.stringify(r));r.signatures={[this.crypto._userId]:{[`ed25519:${m}`]:n}},S[`signed_curve25519:${e}`]=r}l.logger.log("Preparing fallback keys");const k={};for(const[e,t]of Object.entries(g.curve25519)){const r={key:t,fallback:!0},n=o.sign(c.default.stringify(r));r.signatures={[this.crypto._userId]:{[`ed25519:${m}`]:n}},k[`signed_curve25519:${e}`]=r}return l.logger.log("Uploading keys to server"),yield this.crypto._baseApis.http.authedRequest(void 0,"POST","/keys/upload/"+encodeURI(m),void 0,{device_keys:_,one_time_keys:S,"org.matrix.msc2732.fallback_keys":k}),l.logger.log("Done dehydrating"),this.timeoutId=t.setTimeout(this.dehydrateDevice.bind(this),d),m}finally{this.inProgress=!1}}}))}stop(){this.timeoutId&&(t.clearTimeout(this.timeoutId),this.timeoutId=void 0)}}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../crypto/store/indexeddb-crypto-store":84,"../logger":102,"./aes":70,"./olmlib":81,"another-json":28,buffer:34}],78:[function(e,t,r){"use strict";function n(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=i.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceInfo=n,n.fromStorage=function(e,t){var r=new n(t);for(var i in e)e.hasOwnProperty(i)&&(r[i]=e[i]);return r},n.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},n.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},n.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},n.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},n.prototype.isBlocked=function(){return this.verified==i.BLOCKED},n.prototype.isVerified=function(){return this.verified==i.VERIFIED},n.prototype.isUnverified=function(){return this.verified==i.UNVERIFIED},n.prototype.isKnown=function(){return 1==this.known},n.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};var i=n.DeviceVerification},{}],79:[function(e,t,r){(function(t,n){(function(){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault"),o=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.isCryptoAvailable=function(){return Boolean(t.Olm)},r.Crypto=$,r.fixBackupKey=H,r.verificationMethods=void 0;var s,a=i(e("@babel/runtime/helpers/classCallCheck")),u=i(e("@babel/runtime/regenerator")),c=i(e("@babel/runtime/helpers/slicedToArray")),l=i(e("@babel/runtime/helpers/asyncToGenerator")),d=i(e("@babel/runtime/helpers/defineProperty")),h=i(e("another-json")),f=e("events"),p=e("../ReEmitter"),g=e("../logger"),v=o(e("../utils")),y=e("./OlmDevice"),m=o(e("./olmlib")),_=e("./DeviceList"),b=e("./deviceinfo"),S=o(e("./algorithms")),k=e("./CrossSigning"),E=e("./EncryptionSetup"),w=e("./SecretStorage"),I=e("./OutgoingRoomKeyRequestManager"),T=e("./store/indexeddb-crypto-store"),R=e("./verification/QRCode"),x=e("./verification/SAS"),C=e("./key_passphrase"),O=e("./recoverykey"),A=e("./verification/request/VerificationRequest"),D=e("./verification/request/InRoomChannel"),P=e("./verification/request/ToDeviceChannel"),M=e("./verification/IllegalMethod"),U=e("../errors"),N=e("./aes"),K=e("./dehydration"),B=e("../models/event"),L=e("./backup");function q(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return j(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return j(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function j(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var F=b.DeviceInfo.DeviceVerification,G=(s={},(0,d.default)(s,R.ReciprocateQRCode.NAME,R.ReciprocateQRCode),(0,d.default)(s,x.SAS.NAME,x.SAS),(0,d.default)(s,R.SHOW_QR_CODE_METHOD,M.IllegalMethod),(0,d.default)(s,R.SCAN_QR_CODE_METHOD,M.IllegalMethod),s),V={RECIPROCATE_QR_CODE:R.ReciprocateQRCode.NAME,SAS:x.SAS.NAME};r.verificationMethods=V;function $(e,t,r,n,i,o,s,a){var d=this;if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._trustCrossSignedDevices=!0,this._reEmitter=new p.ReEmitter(this),this._baseApis=e,this._sessionStore=t,this._userId=r,this._deviceId=n,this._clientStore=i,this._cryptoStore=o,this._roomList=s,a){this._verificationMethods=new Map;var h,f=q(a);try{for(f.s();!(h=f.n()).done;){var v=h.value;"string"==typeof v?G[v]&&this._verificationMethods.set(v,G[v]):v.NAME?this._verificationMethods.set(v.NAME,v):g.logger.warn("Excluding unknown verification method ".concat(v))}}catch(e){f.e(e)}finally{f.f()}}else this._verificationMethods=G;this._backupManager=new L.BackupManager(e,function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,d.getSessionBackupPrivateKey();case 2:if(!(r=e.sent)){e.next=5;break}return e.abrupt("return",r);case 5:return e.next=7,d.getSecret("m.megolm_backup.v1");case 7:if(!(n=e.sent)){e.next=19;break}if(!(i=H(n))){e.next=18;break}return e.next=13,d._crypto.getSecretStorageKey();case 13:return o=e.sent,s=(0,c.default)(o,1),a=s[0],e.next=18,d.storeSecret("m.megolm_backup.v1",i,[a]);case 18:return e.abrupt("return",m.decodeBase64(i||n));case 19:if(!d._baseApis._cryptoCallbacks||!d._baseApis._cryptoCallbacks.getBackupKey){e.next=23;break}return e.next=22,d._baseApis._cryptoCallbacks.getBackupKey(t);case 22:return e.abrupt("return",e.sent);case 23:throw new Error("Unable to get private key");case 24:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),this._olmDevice=new y.OlmDevice(o),this._deviceList=new _.DeviceList(e,o,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated","crypto.willUpdateDevices"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=Object.keys(S.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._globalErrorOnUnknownDevices=!0,this._outgoingRoomKeyRequestManager=new I.OutgoingRoomKeyRequestManager(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._toDeviceVerificationRequests=new P.ToDeviceRequests,this._inRoomVerificationRequests=new D.InRoomRequests,this._sendKeyRequestsImmediately=!1;var b=this._baseApis.cryptoCallbacks||{},E=(0,k.createCryptoStoreCacheCallbacks)(o,this._olmDevice);this._crossSigningInfo=new k.CrossSigningInfo(r,b,E),this._secretStorage=new w.SecretStorage(e,b),this._dehydrationManager=new K.DehydrationManager(this),!b.getCrossSigningKey&&b.getSecretStorageKey&&(b.getCrossSigningKey=function(){var e=(0,l.default)(u.default.mark((function e(t){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",k.CrossSigningInfo.getFromSecretStorage(t,d._secretStorage));case 1:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}function H(e){if("string"!=typeof e||e.indexOf(",")<0)return null;var t=Uint8Array.from(e.split(","),(function(e){return parseInt(e)}));return m.encodeBase64(t)}function W(e){if(!e._oneTimeKeyCheckInProgress){var t=Date.now();if(!(null!==e._lastOneTimeKeyCheck&&t-e._lastOneTimeKeyCheck<6e4)){e._lastOneTimeKeyCheck=t;var r=e._olmDevice.maxNumberOfOneTimeKeys(),n=Math.floor(r/2);e._oneTimeKeyCheckInProgress=!0,Promise.resolve().then((function(){return void 0!==e._oneTimeKeyCount?Promise.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({}).then((function(e){return e.one_time_key_counts.signed_curve25519||0}))})).then((function(e){return function(e){return i.apply(this,arguments)}(e)})).catch((function(e){g.logger.error("Error uploading one-time keys",e.stack||e)})).finally((function(){e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1}))}}function i(){return(i=(0,l.default)(u.default.mark((function t(r){var i,o;return u.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(n>r||e.getNeedsNewFallback())){t.next=21;break}if(!(n>r)){t.next=6;break}return g.logger.info("generating oneTimeKeys"),i=Math.min(n-r,5),t.next=6,e._olmDevice.generateOneTimeKeys(i);case 6:if(!e.getNeedsNewFallback()){t.next=10;break}return g.logger.info("generating fallback key"),t.next=10,e._olmDevice.generateFallbackKey();case 10:return g.logger.info("calling _uploadOneTimeKeys"),t.next=13,Y(e);case 13:if(!(o=t.sent).one_time_key_counts||!o.one_time_key_counts.signed_curve25519){t.next=18;break}r=o.one_time_key_counts.signed_curve25519,t.next=19;break;case 18:throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519");case 19:t.next=0;break;case 21:case"end":return t.stop()}}),t)})))).apply(this,arguments)}}function Y(e){return z.apply(this,arguments)}function z(){return(z=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s,a,l,d,h,f,p,g,v,y;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=[],n={},!t.getNeedsNewFallback()){e.next=8;break}return e.next=5,t._olmDevice.getFallbackKey();case 5:for(i=e.sent,o=0,s=Object.entries(i.curve25519);o<s.length;o++)a=(0,c.default)(s[o],2),l=a[0],d=a[1],h={key:d,fallback:!0},n["signed_curve25519:"+l]=h,r.push(t._signObject(h));t.setNeedsNewFallback(!1);case 8:return e.next=10,t._olmDevice.getOneTimeKeys();case 10:for(g in f=e.sent,p={},f.curve25519)f.curve25519.hasOwnProperty(g)&&(v={key:f.curve25519[g]},p["signed_curve25519:"+g]=v,r.push(t._signObject(v)));return e.next=15,Promise.all(r);case 15:return e.next=17,t._baseApis.uploadKeysRequest({one_time_keys:p,"org.matrix.msc2732.fallback_keys":n});case 17:return y=e.sent,e.next=20,t._olmDevice.markKeysAsPublished();case 20:return e.abrupt("return",y);case 21:case"end":return e.stop()}}),e)})))).apply(this,arguments)}v.inherits($,f.EventEmitter),$.prototype.init=function(){var e=(0,l.default)(u.default.mark((function e(r){var n,i,o,s,a,c=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=(n=r||{}).exportedOlmDevice,o=n.pickleKey,g.logger.log("Crypto: initialising Olm..."),e.next=4,t.Olm.init();case 4:return g.logger.log(i?"Crypto: initialising Olm device from exported device...":"Crypto: initialising Olm device..."),e.next=7,this._olmDevice.init({fromExportedDevice:i,pickleKey:o});case 7:return g.logger.log("Crypto: loading device list..."),e.next=10,this._deviceList.load();case 10:return this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,g.logger.log("Crypto: fetching own devices..."),(s=this._deviceList.getRawStoredDevicesForUser(this._userId))||(s={}),s[this._deviceId]||(g.logger.log("Crypto: adding this device to the store..."),a={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:F.VERIFIED,known:!0},s[this._deviceId]=a,this._deviceList.storeDevicesForUser(this._userId,s),this._deviceList.saveIfDirty()),e.next=18,this._cryptoStore.doTxn("readonly",[T.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){c._cryptoStore.getCrossSigningKeys(e,(function(e){e&&0!==Object.keys(e).length&&(g.logger.log("Loaded cross-signing public keys from crypto store"),c._crossSigningInfo.setKeys(e))}))}));case 18:this._deviceList.startTrackingDeviceList(this._userId),g.logger.log("Crypto: checking for key backup..."),this._backupManager.checkAndStart();case 21:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.getCryptoTrustCrossSignedDevices=function(){return this._trustCrossSignedDevices},$.prototype.setCryptoTrustCrossSignedDevices=function(e){this._trustCrossSignedDevices=e;var t,r=q(this._deviceList.getKnownUserIds());try{for(r.s();!(t=r.n()).done;)for(var n=t.value,i=this._deviceList.getRawStoredDevicesForUser(n),o=0,s=Object.keys(i);o<s.length;o++){var a=s[o],u=this.checkDeviceTrust(n,a);if(!u.isLocallyVerified()&&u.isCrossSigningVerified()){var c=this._deviceList.getStoredDevice(n,a);this.emit("deviceVerificationChanged",n,a,c)}}}catch(e){r.e(e)}finally{r.f()}},$.prototype.createRecoveryKeyFromPassphrase=function(){var e=(0,l.default)(u.default.mark((function e(r){var n,i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=new t.Olm.PkDecryption,e.prev=1,i={},!r){e.next=11;break}return e.next=6,(0,C.keyFromPassphrase)(r);case 6:o=e.sent,i.passphrase={algorithm:"m.pbkdf2",iterations:o.iterations,salt:o.salt},i.pubkey=n.init_with_private_key(o.key),e.next=12;break;case 11:i.pubkey=n.generate_key();case 12:return s=n.get_private_key(),a=(0,O.encodeRecoveryKey)(s),e.abrupt("return",{keyInfo:i,encodedPrivateKey:a,privateKey:s});case 15:return e.prev=15,n&&n.free(),e.finish(15);case 18:case"end":return e.stop()}}),e,null,[[1,,15,18]])})));return function(t){return e.apply(this,arguments)}}(),$.prototype.isCrossSigningReady=(0,l.default)(u.default.mark((function e(){var t,r;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._crossSigningInfo.getId(),e.next=3,this._crossSigningInfo.isStoredInKeyCache();case 3:if(e.t0=e.sent,e.t0){e.next=8;break}return e.next=7,this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);case 7:e.t0=e.sent;case 8:return r=e.t0,e.abrupt("return",!(!t||!r));case 10:case"end":return e.stop()}}),e,this)}))),$.prototype.isSecretStorageReady=(0,l.default)(u.default.mark((function e(){var t,r,n;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._secretStorage.hasKey();case 2:return t=e.sent,e.next=5,this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);case 5:return r=e.sent,n=!this._backupManager.getKeyBackupEnabled()||this._baseApis.isKeyBackupKeyStored(),e.abrupt("return",!!(t&&r&&n));case 8:case"end":return e.stop()}}),e,this)}))),$.prototype.bootstrapCrossSigning=(0,l.default)(u.default.mark((function e(){var t,r,n,i,o,s,a,c,d,h,f,p,v,y,m=this,_=arguments;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=_.length>0&&void 0!==_[0]?_[0]:{},r=t.authUploadDeviceSigningKeys,n=t.setupNewCrossSigning,g.logger.log("Bootstrapping cross-signing"),i=this._baseApis.cryptoCallbacks,o=new E.EncryptionSetupBuilder(this._baseApis.store.accountData,i),s=new k.CrossSigningInfo(this._userId,o.crossSigningCallbacks,o.crossSigningCallbacks),a=function(){var e=(0,l.default)(u.default.mark((function e(){var t,n;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s.resetKeys(),e.next=3,m._signObject(s.keys.master);case 3:return o.addCrossSigningKeys(r,s.keys),t=m._deviceList.getStoredDevice(m._userId,m._deviceId),e.next=7,s.signDevice(m._userId,t);case 7:if(n=e.sent,o.addKeySignature(m._userId,m._deviceId,n),!m._backupManager.backupInfo){e.next=13;break}return e.next=12,s.signObject(m._backupManager.backupInfo.auth_data,"master");case 12:o.addSessionBackup(m._backupManager.backupInfo);case 13:case"end":return e.stop()}}),e)})));return function(){return e.apply(this,arguments)}}(),c=this._crossSigningInfo.getId(),e.next=9,this._crossSigningInfo.isStoredInKeyCache();case 9:return d=e.sent,e.next=12,this._crossSigningInfo.isStoredInSecretStorage(this._secretStorage);case 12:if(h=e.sent,f=d||h,g.logger.log({setupNewCrossSigning:n,publicKeysOnDevice:c,privateKeysInCache:d,privateKeysInStorage:h,privateKeysExistSomewhere:f}),f&&!n){e.next=21;break}return g.logger.log("Cross-signing private keys not found locally or in secret storage, creating new keys"),e.next=19,a();case 19:e.next=29;break;case 21:if(!c||!d){e.next=25;break}g.logger.log("Cross-signing public keys trusted and private keys found locally"),e.next=29;break;case 25:if(!h){e.next=29;break}return g.logger.log("Cross-signing private keys not found locally, but they are available in secret storage, reading storage and caching locally"),e.next=29,this.checkOwnCrossSigningTrust({allowPrivateKeyRequests:!0});case 29:if(!(p=o.crossSigningCallbacks.privateKeys).size||this._baseApis.cryptoCallbacks.saveCrossSigningKeys){e.next=38;break}return v=new w.SecretStorage(o.accountDataClientAdapter,o.ssssCryptoCallbacks),e.next=34,v.hasKey();case 34:if(!e.sent){e.next=38;break}return g.logger.log("Storing new cross-signing private keys in secret storage"),e.next=38,k.CrossSigningInfo.storeInSecretStorage(p,v);case 38:return y=o.buildOperation(),e.next=41,y.apply(this);case 41:return e.next=43,o.persist(this);case 43:g.logger.log("Cross-signing ready");case 44:case"end":return e.stop()}}),e,this)}))),$.prototype.bootstrapSecretStorage=(0,l.default)(u.default.mark((function e(){var t,r,n,i,o,s,a,h,f,p,v,y,_,b,S,I,T,R,x,C,A,D,P,M,U,N,K,B,L,q,j,F,G,V=this,$=arguments;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=$.length>0&&void 0!==$[0]?$[0]:{},r=t.createSecretStorageKey,n=void 0===r?(0,l.default)(u.default.mark((function e(){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",{});case 1:case"end":return e.stop()}}),e)}))):r,i=t.keyBackupInfo,o=t.setupNewKeyBackup,s=t.setupNewSecretStorage,a=t.getKeyBackupPassphrase,g.logger.log("Bootstrapping Secure Secret Storage"),h=this._baseApis.cryptoCallbacks,f=new E.EncryptionSetupBuilder(this._baseApis.store.accountData,h),p=new w.SecretStorage(f.accountDataClientAdapter,f.ssssCryptoCallbacks),v=null,y=function(){var e=(0,l.default)(u.default.mark((function e(t,r){var n,i,o;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=t||{},r&&(t.key=r),e.next=4,p.addKey(w.SECRET_STORAGE_ALGORITHM_V1_AES,t);case 4:return n=e.sent,i=n.keyId,o=n.keyInfo,r&&f.ssssCryptoCallbacks.addPrivateKey(i,o,r),e.next=10,p.setDefaultKeyId(i);case 10:return e.abrupt("return",i);case 11:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),_=function(){var e=(0,l.default)(u.default.mark((function e(t,r){var n,i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.mac){e.next=16;break}return e.next=3,V._baseApis.cryptoCallbacks.getSecretStorageKey({keys:(0,d.default)({},t,r)},"");case 3:if(!(n=e.sent)){e.next=16;break}return i=n[1],f.ssssCryptoCallbacks.addPrivateKey(t,r,i),e.next=9,w.SecretStorage._calculateKeyCheck(i);case 9:return o=e.sent,s=o.iv,a=o.mac,r.iv=s,r.mac=a,e.next=16,f.setAccountData("m.secret_storage.key.".concat(t),r);case 16:case"end":return e.stop()}}),e)})));return function(t,r){return e.apply(this,arguments)}}(),b=function(){var e=(0,l.default)(u.default.mark((function e(t){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.t0=V._crossSigningInfo.getId(),!e.t0){e.next=5;break}return e.next=4,V._crossSigningInfo.isStoredInKeyCache("master");case 4:e.t0=e.sent;case 5:if(!e.t0){e.next=17;break}return e.prev=6,g.logger.log("Adding cross-signing signature to key backup"),e.next=10,V._crossSigningInfo.signObject(t,"master");case 10:e.next=15;break;case 12:e.prev=12,e.t1=e.catch(6),g.logger.error("Signing key backup with cross-signing keys failed",e.t1);case 15:e.next=18;break;case 17:g.logger.warn("Cross-signing keys not available, skipping signature on key backup");case 18:case"end":return e.stop()}}),e,null,[[6,12]])})));return function(t){return e.apply(this,arguments)}}(),e.next=11,this.getSecretStorageKey();case 11:if(S=e.sent,I=S||[null,null],T=(0,c.default)(I,2),R=T[0],x=T[1],C=!s&&x&&x.algorithm===w.SECRET_STORAGE_ALGORITHM_V1_AES,g.logger.log({keyBackupInfo:i,setupNewKeyBackup:o,setupNewSecretStorage:s,storageExists:C,oldKeyInfo:x}),C||i){e.next=27;break}return g.logger.log("Secret storage does not exist, creating new storage key"),e.next=19,n();case 19:return A=e.sent,D=A.keyInfo,P=A.privateKey,e.next=24,y(D,P);case 24:v=e.sent,e.next=53;break;case 27:if(C||!i){e.next=49;break}return g.logger.log("Secret storage does not exist, using key backup key"),e.next=31,this.getSessionBackupPrivateKey();case 31:if(e.t0=e.sent,e.t0){e.next=36;break}return e.next=35,a();case 35:e.t0=e.sent;case 36:return M=e.t0,U={},i.auth_data.private_key_salt&&i.auth_data.private_key_iterations&&(U.passphrase={algorithm:"m.pbkdf2",iterations:i.auth_data.private_key_iterations,salt:i.auth_data.private_key_salt,bits:256}),e.next=41,y(U,M);case 41:return v=e.sent,e.next=44,p.store("m.megolm_backup.v1",m.encodeBase64(M),[v]);case 44:return e.next=46,b(i.auth_data);case 46:f.addSessionBackup(i),e.next=53;break;case 49:if(g.logger.log("Secret storage exists"),!x||x.algorithm!==w.SECRET_STORAGE_ALGORITHM_V1_AES){e.next=53;break}return e.next=53,_(R,x);case 53:if(e.t2=!this._baseApis.cryptoCallbacks.saveCrossSigningKeys,!e.t2){e.next=58;break}return e.next=57,this.isCrossSigningReady();case 57:e.t2=e.sent;case 58:if(e.t1=e.t2,!e.t1){e.next=66;break}if(e.t3=v,e.t3){e.next=65;break}return e.next=64,this._crossSigningInfo.isStoredInSecretStorage(p);case 64:e.t3=!e.sent;case 65:e.t1=e.t3;case 66:if(!e.t1){e.next=73;break}return g.logger.log("Copying cross-signing private keys from cache to secret storage"),e.next=70,this._crossSigningInfo.getCrossSigningKeysFromCache();case 70:return N=e.sent,e.next=73,k.CrossSigningInfo.storeInSecretStorage(N,p);case 73:if(!o||i){e.next=87;break}return g.logger.log("Creating new message key backup version"),e.next=77,this._baseApis.prepareKeyBackupVersion(null,{secureSecretStorage:!1});case 77:return K=e.sent,B=(0,O.decodeRecoveryKey)(K.recovery_key),e.next=81,p.store("m.megolm_backup.v1",m.encodeBase64(B));case 81:return L={algorithm:K.algorithm,auth_data:K.auth_data},e.next=84,b(L.auth_data);case 84:return e.next=86,this._signObject(L.auth_data);case 86:f.addSessionBackup(L);case 87:return e.next=89,p.get("m.megolm_backup.v1");case 89:if(!(q=e.sent)){e.next=99;break}if(g.logger.info("Got session backup key from secret storage: caching"),!(j=H(q))){e.next=96;break}return e.next=96,p.store("m.megolm_backup.v1",j,[v||R]);case 96:return F=new Uint8Array(m.decodeBase64(j||q)),e.next=99,f.addSessionBackupPrivateKeyToCache(F);case 99:return G=f.buildOperation(),e.next=102,G.apply(this);case 102:return e.next=104,f.persist(this);case 104:g.logger.log("Secure Secret Storage ready");case 105:case"end":return e.stop()}}),e,this)}))),$.prototype.addSecretStorageKey=function(e,t,r){return this._secretStorage.addKey(e,t,r)},$.prototype.hasSecretStorageKey=function(e){return this._secretStorage.hasKey(e)},$.prototype.getSecretStorageKey=function(e){return this._secretStorage.getKey(e)},$.prototype.storeSecret=function(e,t,r){return this._secretStorage.store(e,t,r)},$.prototype.getSecret=function(e){return this._secretStorage.get(e)},$.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},$.prototype.requestSecret=function(e,t){return t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},$.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},$.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},$.prototype.checkSecretStorageKey=function(e,t){return this._secretStorage.checkKey(e,t)},$.prototype.checkSecretStoragePrivateKey=function(e,r){var n=null;try{return(n=new t.Olm.PkDecryption).init_with_private_key(e)===r}finally{n&&n.free()}},$.prototype.getSessionBackupPrivateKey=(0,l.default)(u.default.mark((function e(){var t,r,i,o=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,new Promise((function(e){o._cryptoStore.doTxn("readonly",[T.IndexedDBCryptoStore.STORE_ACCOUNT],(function(t){o._cryptoStore.getSecretStorePrivateKey(t,e,"m.megolm_backup.v1")}))}));case 2:if(!(t=e.sent)||"string"!=typeof t){e.next=7;break}return t=new Uint8Array(m.decodeBase64(H(t)||t)),e.next=7,this.storeSessionBackupPrivateKey(t);case 7:if(!t||!t.ciphertext){e.next=13;break}return r=n.from(this._olmDevice._pickleKey),e.next=11,(0,N.decryptAES)(t,r,"m.megolm_backup.v1");case 11:i=e.sent,t=m.decodeBase64(i);case 13:return e.abrupt("return",t);case 14:case"end":return e.stop()}}),e,this)}))),$.prototype.storeSessionBackupPrivateKey=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,i=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t instanceof Uint8Array){e.next=2;break}throw new Error("storeSessionBackupPrivateKey expects Uint8Array, got ".concat(t));case 2:return r=n.from(this._olmDevice._pickleKey),e.next=5,(0,N.encryptAES)(m.encodeBase64(t),r,"m.megolm_backup.v1");case 5:return t=e.sent,e.abrupt("return",this._cryptoStore.doTxn("readwrite",[T.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){i._cryptoStore.storeSecretStorePrivateKey(e,"m.megolm_backup.v1",t)})));case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.checkCrossSigningPrivateKey=function(e,r){var n=null;try{return(n=new t.Olm.PkSigning).init_with_seed(e)===r}finally{n&&n.free()}},$.prototype._afterCrossSigningLocalKeyChange=(0,l.default)(u.default.mark((function e(){var t,r,n,i,o,s,a,l,h,f,p,v,y,m,_=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return g.logger.info("Starting cross-signing key change post-processing"),t=this._deviceList.getStoredDevice(this._userId,this._deviceId),e.next=4,this._crossSigningInfo.signDevice(this._userId,t);case 4:if(r=e.sent,g.logger.info("Starting background key sig upload for ".concat(this._deviceId)),function e(t){var n=t.shouldEmit;return _._baseApis.uploadKeySignatures((0,d.default)({},_._userId,(0,d.default)({},_._deviceId,r))).then((function(t){var r=(t||{}).failures;if(Object.keys(r||[]).length>0)throw n&&_._baseApis.emit("crypto.keySignatureUploadFailure",r,"_afterCrossSigningLocalKeyChange",e),new U.KeySignatureUploadError("Key upload failed",{failures:r});g.logger.info("Finished background key sig upload for ".concat(_._deviceId))})).catch((function(e){g.logger.error("Error during background key sig upload for ".concat(_._deviceId),e)}))}({shouldEmit:!0}),!(n=this._baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications)){e.next=53;break}g.logger.info("Starting device verification upgrade"),i={},o=0,s=Object.entries(this._deviceList._crossSigningInfo);case 13:if(!(o<s.length)){e.next=22;break}return a=(0,c.default)(s[o],2),l=a[0],h=a[1],e.next=17,this._checkForDeviceVerificationUpgrade(l,k.CrossSigningInfo.fromStorage(h,l));case 17:(f=e.sent)&&(i[l]=f);case 19:o++,e.next=13;break;case 22:if(!(Object.keys(i).length>0)){e.next=52;break}return g.logger.info("Found ".concat(Object.keys(i).length," verif users to upgrade")),e.prev=24,e.next=27,n({users:i});case 27:if(!(p=e.sent)){e.next=47;break}v=q(p),e.prev=30,v.s();case 32:if((y=v.n()).done){e.next=39;break}if(!((m=y.value)in i)){e.next=37;break}return e.next=37,this._baseApis.setDeviceVerified(m,i[m].crossSigningInfo.getId());case 37:e.next=32;break;case 39:e.next=44;break;case 41:e.prev=41,e.t0=e.catch(30),v.e(e.t0);case 44:return e.prev=44,v.f(),e.finish(44);case 47:e.next=52;break;case 49:e.prev=49,e.t1=e.catch(24),g.logger.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e.t1);case 52:g.logger.info("Finished device verification upgrade");case 53:g.logger.info("Finished cross-signing key change post-processing");case 54:case"end":return e.stop()}}),e,this,[[24,49],[30,41,44,47]])}))),$.prototype._checkForDeviceVerificationUpgrade=function(){var e=(0,l.default)(u.default.mark((function e(t,r){var n,i,o;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._crossSigningInfo.checkUserTrust(r),!r.firstUse||n.verified){e.next=8;break}return i=this._deviceList.getRawStoredDevicesForUser(t),e.next=5,this._checkForValidDeviceSignature(t,r.keys.master,i);case 5:if(!(o=e.sent).length){e.next=8;break}return e.abrupt("return",{devices:o.map((function(e){return b.DeviceInfo.fromStorage(i[e],e)})),crossSigningInfo:r});case 8:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),$.prototype._checkForValidDeviceSignature=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n){var i,o,s,a,l,d,h;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=[],!(n&&r.signatures&&r.signatures[t])){e.next=18;break}o=0,s=Object.keys(r.signatures[t]);case 3:if(!(o<s.length)){e.next=18;break}if(a=s[o],l=a.split(":",2),d=(0,c.default)(l,2),!((h=d[1])in n)||n[h].verified!==F.VERIFIED){e.next=15;break}return e.prev=7,e.next=10,m.verifySignature(this._olmDevice,r,t,h,n[h].keys[a]);case 10:i.push(h),e.next=15;break;case 13:e.prev=13,e.t0=e.catch(7);case 15:o++,e.next=3;break;case 18:return e.abrupt("return",i);case 19:case"end":return e.stop()}}),e,this,[[7,13]])})));return function(t,r,n){return e.apply(this,arguments)}}(),$.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},$.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},$.prototype.checkUserTrust=function(e){var t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new k.UserTrustLevel(!1,!1,!1)},$.prototype.checkDeviceTrust=function(e,t){var r=this._deviceList.getStoredDevice(e,t);return this._checkDeviceInfoTrust(e,r)},$.prototype._checkDeviceInfoTrust=function(e,t){var r=!(!t||!t.isVerified()),n=this._deviceList.getStoredCrossSigningForUser(e);if(t&&n){var i=this._trustCrossSignedDevices||e===this._userId;return this._crossSigningInfo.checkDeviceTrust(n,t,r,i)}return new k.DeviceTrustLevel(!1,!1,r,!1)},$.prototype._onDeviceListUserCrossSigningUpdated=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==this._userId){e.next=15;break}if(r=this._deviceList.getStoredCrossSigningForUser(t),n=r?r.getId():null,i=this._crossSigningInfo.getId(),o=i!==n,!i||!n||o){e.next=10;break}return e.next=8,this.checkOwnCrossSigningTrust();case 8:e.next=13;break;case 10:this._storeTrustedSelfKeys(null),this.emit("crossSigning.keysChanged",{}),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(t));case 13:e.next=20;break;case 15:return e.next=17,this._checkDeviceVerifications(t);case 17:(s=this._deviceList.getStoredCrossSigningForUser(t))&&(s.updateCrossSigningVerifiedBefore(this.checkUserTrust(t).isCrossSigningVerified()),this._deviceList.setRawStoredCrossSigningForUser(t,s.toStorage())),this.emit("userTrustStatusChanged",t,this.checkUserTrust(t));case 20:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.checkOwnCrossSigningTrust=(0,l.default)(u.default.mark((function e(){var t,r,n,i,o,s,a,c,l,h,f,p,v,y,m,_,b,S,k,E,w,I,T,R,x,C,O,A=this,D=arguments;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=D.length>0&&void 0!==D[0]?D[0]:{},r=t.allowPrivateKeyRequests,n=void 0!==r&&r,i=this._userId,e.next=4,this.downloadKeys([this._userId]);case 4:return e.next=6,this._crossSigningInfo.getCrossSigningKeysFromCache();case 6:if(o=e.sent,s=this._deviceList.getStoredCrossSigningForUser(i)){e.next=11;break}return g.logger.error("Got cross-signing update event for user "+i+" but no new cross-signing information found!"),e.abrupt("return");case 11:if(a=s.getId(),c=this._crossSigningInfo.getId()!==a,l=s.getId()&&!o.has("master"),c&&g.logger.info("Got new master public key",a),!n||!c&&!l){e.next=27;break}return g.logger.info("Attempting to retrieve cross-signing master private key"),h=null,e.prev=18,e.next=21,this._crossSigningInfo.getCrossSigningKey("master",a);case 21:f=e.sent,h=f[1],g.logger.info("Got cross-signing master private key");case 24:return e.prev=24,h&&h.free(),e.finish(24);case 27:if(p=this._crossSigningInfo.getId("self_signing"),v=this._crossSigningInfo.getId("user_signing"),this._storeTrustedSelfKeys(s.keys),y=p!==s.getId("self_signing"),m=v!==s.getId("user_signing"),_=s.getId("self_signing")&&!o.has("self_signing"),b=s.getId("user_signing")&&!o.has("user_signing"),S={},y&&g.logger.info("Got new self-signing key",s.getId("self_signing")),!n||!y&&!_){e.next=53;break}return g.logger.info("Attempting to retrieve cross-signing self-signing private key"),k=null,e.prev=39,e.next=42,this._crossSigningInfo.getCrossSigningKey("self_signing",s.getId("self_signing"));case 42:E=e.sent,k=E[1],g.logger.info("Got cross-signing self-signing private key");case 45:return e.prev=45,k&&k.free(),e.finish(45);case 48:return w=this._deviceList.getStoredDevice(this._userId,this._deviceId),e.next=51,this._crossSigningInfo.signDevice(this._userId,w);case 51:I=e.sent,S[this._deviceId]=I;case 53:if(m&&g.logger.info("Got new user-signing key",s.getId("user_signing")),!n||!m&&!b){e.next=66;break}return g.logger.info("Attempting to retrieve cross-signing user-signing private key"),T=null,e.prev=57,e.next=60,this._crossSigningInfo.getCrossSigningKey("user_signing",s.getId("user_signing"));case 60:R=e.sent,T=R[1],g.logger.info("Got cross-signing user-signing private key");case 63:return e.prev=63,T&&T.free(),e.finish(63);case 66:if(!c){e.next=72;break}return x=this._crossSigningInfo.keys.master,e.next=70,this._signObject(x);case 70:C=x.signatures[this._userId]["ed25519:"+this._deviceId],S[this._crossSigningInfo.getId()]=Object.assign({},x,{signatures:(0,d.default)({},this._userId,(0,d.default)({},"ed25519:"+this._deviceId,C))});case 72:if((O=Object.keys(S)).length&&function e(t){var r=t.shouldEmit;return g.logger.info("Starting background key sig upload for ".concat(O)),A._baseApis.uploadKeySignatures((0,d.default)({},A._userId,S)).then((function(t){var n=(t||{}).failures;if(g.logger.info("Finished background key sig upload for ".concat(O)),Object.keys(n||[]).length>0)throw r&&A._baseApis.emit("crypto.keySignatureUploadFailure",n,"checkOwnCrossSigningTrust",e),new U.KeySignatureUploadError("Key upload failed",{failures:n})})).catch((function(e){g.logger.error("Error during background key sig upload for ".concat(O),e)}))}({shouldEmit:!0}),this.emit("userTrustStatusChanged",i,this.checkUserTrust(i)),!c){e.next=79;break}return this._baseApis.emit("crossSigning.keysChanged",{}),e.next=79,this._afterCrossSigningLocalKeyChange();case 79:return e.next=81,this._backupManager.checkKeyBackup();case 81:case"end":return e.stop()}}),e,this,[[18,,24,27],[39,,45,48],[57,,63,66]])}))),$.prototype._storeTrustedSelfKeys=function(){var e=(0,l.default)(u.default.mark((function e(t){var r=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t?this._crossSigningInfo.setKeys(t):this._crossSigningInfo.clearKeys(),e.next=3,this._cryptoStore.doTxn("readwrite",[T.IndexedDBCryptoStore.STORE_ACCOUNT],(function(e){r._cryptoStore.storeCrossSigningKeys(e,r._crossSigningInfo.keys)}));case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype._checkDeviceVerifications=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._baseApis.cryptoCallbacks.shouldUpgradeDeviceVerifications){e.next=3;break}return e.abrupt("return");case 3:if(g.logger.info("Starting device verification upgrade for ".concat(t)),!this._crossSigningInfo.keys.user_signing){e.next=17;break}if(!(n=this._deviceList.getStoredCrossSigningForUser(t))){e.next=17;break}return e.next=9,this._checkForDeviceVerificationUpgrade(t,n);case 9:if(!(i=e.sent)){e.next=17;break}return e.next=13,r({users:(0,d.default)({},t,i)});case 13:if(!e.sent.includes(t)){e.next=17;break}return e.next=17,this._baseApis.setDeviceVerified(t,n.getId());case 17:g.logger.info("Finished device verification upgrade for ".concat(t));case 18:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.setTrustedBackupPubKey=function(){var e=(0,l.default)(u.default.mark((function e(t){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._sessionStore.setLocalTrustedBackupPubKey(t),e.next=3,this._backupManager.checkKeyBackup();case 3:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},$.prototype.registerEventHandlers=function(e){var t=this;e.on("RoomMember.membership",(function(e,r,n){try{t._onRoomMembership(e,r,n)}catch(e){g.logger.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",t._onToDeviceEvent.bind(t));var r=t._onTimelineEvent.bind(t);e.on("Room.timeline",r),e.on("Event.decrypted",r)},$.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},$.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop(),this._dehydrationManager.stop()},$.getOlmVersion=function(){return y.OlmDevice.getOlmVersion()},$.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},$.prototype.getDeviceCurve25519Key=function(){return this._olmDevice.deviceCurve25519Key},$.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},$.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},$.prototype.setGlobalErrorOnUnknownDevices=function(e){this._globalErrorOnUnknownDevices=e},$.prototype.getGlobalErrorOnUnknownDevices=function(){return this._globalErrorOnUnknownDevices},$.prototype.uploadDeviceKeys=function(){var e=this,t=e._userId,r=e._deviceId,n={algorithms:e._supportedAlgorithms,device_id:r,keys:e._deviceKeys,user_id:t};return e._signObject(n).then((function(){return e._baseApis.uploadKeysRequest({device_keys:n})}))},$.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},$.prototype.setNeedsNewFallback=function(e){this._needsNewFallback=!!e},$.prototype.getNeedsNewFallback=function(){return this._needsNewFallback},$.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},$.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},$.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},$.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},$.prototype.setDeviceVerification=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n,i,o){var s,a,c,h,f,p,v,y,m,_,S=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=null),!(s=this._deviceList.getStoredCrossSigningForUser(t))||s.getId()!==r){e.next=23;break}if(null===i&&null===o){e.next=7;break}throw new Error("Cannot set blocked or known for a cross-signing key");case 7:if(n){e.next=9;break}throw new Error("Cannot set a cross-signing key as unverified");case 9:if(this._crossSigningInfo.getId()||t!==this._crossSigningInfo.userId||(this._storeTrustedSelfKeys(s.keys),this.emit("userTrustStatusChanged",this._userId,this.checkUserTrust(t))),t===this._userId){e.next=22;break}return g.logger.info("Master key "+s.getId()+" for "+t+" marked verified. Signing..."),e.next=14,this._crossSigningInfo.signUser(s);case 14:if(!(a=e.sent)){e.next=19;break}return c=function(){var e=(0,l.default)(u.default.mark((function e(n){var i,o,s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.shouldEmit,g.logger.info("Uploading signature for "+t+"..."),e.next=4,S._baseApis.uploadKeySignatures((0,d.default)({},t,(0,d.default)({},r,a)));case 4:if(o=e.sent,s=(o||{}).failures,!(Object.keys(s||[]).length>0)){e.next=9;break}throw i&&S._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",c),new U.KeySignatureUploadError("Key upload failed",{failures:s});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=19,c({shouldEmit:!0});case 19:return e.abrupt("return",a);case 22:return e.abrupt("return",s);case 23:if((h=this._deviceList.getRawStoredDevicesForUser(t))&&h[r]){e.next=26;break}throw new Error("Unknown device "+t+":"+r);case 26:if(f=h[r],p=f.verified,n?p=F.VERIFIED:null!==n&&p==F.VERIFIED&&(p=F.UNVERIFIED),i?p=F.BLOCKED:null!==i&&p==F.BLOCKED&&(p=F.UNVERIFIED),v=f.known,null!==o&&(v=o),f.verified===p&&f.known===v||(f.verified=p,f.known=v,this._deviceList.storeDevicesForUser(t,h),this._deviceList.saveIfDirty()),!n||t!==this._userId){e.next=47;break}if(g.logger.info("Own device "+r+" marked verified: signing"),!this.checkDeviceTrust(t,r).isCrossSigningVerified()){e.next=40;break}g.logger.log("Own device ".concat(r," already cross-signing verified")),e.next=43;break;case 40:return e.next=42,this._crossSigningInfo.signDevice(t,b.DeviceInfo.fromStorage(f,r));case 42:y=e.sent;case 43:if(!y){e.next=47;break}return m=function(){var e=(0,l.default)(u.default.mark((function e(n){var i,o,s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=n.shouldEmit,g.logger.info("Uploading signature for "+r),e.next=4,S._baseApis.uploadKeySignatures((0,d.default)({},t,(0,d.default)({},r,y)));case 4:if(o=e.sent,s=(o||{}).failures,!(Object.keys(s||[]).length>0)){e.next=9;break}throw i&&S._baseApis.emit("crypto.keySignatureUploadFailure",s,"setDeviceVerification",m),new U.KeySignatureUploadError("Key upload failed",{failures:s});case 9:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}(),e.next=47,m({shouldEmit:!0});case 47:return _=b.DeviceInfo.fromStorage(f,r),this.emit("deviceVerificationChanged",t,r,_),e.abrupt("return",_);case 50:case"end":return e.stop()}}),e,this)})));return function(t,r,n,i,o){return e.apply(this,arguments)}}(),$.prototype.findVerificationRequestDMInProgress=function(e){return this._inRoomVerificationRequests.findRequestInProgress(e)},$.prototype.getVerificationRequestsToDeviceInProgress=function(e){return this._toDeviceVerificationRequests.getRequestsInProgress(e)},$.prototype.requestVerificationDM=function(e,t){var r=this._inRoomVerificationRequests.findRequestInProgress(t);if(r)return Promise.resolve(r);var n=new D.InRoomChannel(this._baseApis,t,e);return this._requestVerificationWithChannel(e,n,this._inRoomVerificationRequests)},$.prototype.requestVerification=function(e,t){t||(t=Object.keys(this._deviceList.getRawStoredDevicesForUser(e)));var r=this._toDeviceVerificationRequests.findRequestInProgress(e,t);if(r)return Promise.resolve(r);var n=new P.ToDeviceChannel(this._baseApis,e,t,P.ToDeviceChannel.makeTransactionId());return this._requestVerificationWithChannel(e,n,this._toDeviceVerificationRequests)},$.prototype._requestVerificationWithChannel=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n){var i,o;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=new A.VerificationRequest(r,this._verificationMethods,this._baseApis),r.transactionId&&n.setRequestByChannel(r,i),e.next=4,i.sendRequest();case 4:return(o=n.getRequestByChannel(r))?i=o:(g.logger.log("Crypto: adding new request to "+"requestsByTxnId with id ".concat(r.transactionId," ").concat(r.roomId)),n.setRequestByChannel(r,i)),e.abrupt("return",i);case 7:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),$.prototype.beginKeyVerification=function(e,t,r){var n,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;if(i){if(!(n=this._toDeviceVerificationRequests.getRequestBySenderAndTxnId(t,i)))throw new Error("No request found for user ".concat(t," with ")+"transactionId ".concat(i))}else{i=P.ToDeviceChannel.makeTransactionId();var o=new P.ToDeviceChannel(this._baseApis,t,[r],i,r);n=new A.VerificationRequest(o,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,n)}return n.beginKeyVerification(e,{userId:t,deviceId:r})},$.prototype.legacyDeviceVerification=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n){var i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=P.ToDeviceChannel.makeTransactionId(),o=new P.ToDeviceChannel(this._baseApis,t,[r],i,r),s=new A.VerificationRequest(o,this._verificationMethods,this._baseApis),this._toDeviceVerificationRequests.setRequestBySenderAndTxnId(t,i,s),a=s.beginKeyVerification(n,{userId:t,deviceId:r}),e.next=7,Promise.race([a.verify(),s.waitFor((function(e){return e.started}))]);case 7:return e.abrupt("return",s);case 8:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),$.prototype.getOlmSessionsForUser=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.getStoredDevicesForUser(t)||[],n={},i=0;case 3:if(!(i<r.length)){e.next=13;break}return o=r[i],s=o.getIdentityKey(),e.next=8,this._olmDevice.getSessionInfoForDevice(s);case 8:a=e.sent,n[o.deviceId]={deviceIdKey:s,sessions:a};case 10:++i,e.next=3;break;case 13:return e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.getEventSenderDeviceInfo=function(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;if(e.isKeySourceUntrusted())return null;var n=this._deviceList.getDeviceByIdentityKey(r,t);if(null===n)return null;var i=e.getClaimedEd25519Key();return i?i!==n.getFingerprint()?(g.logger.warn("Event "+e.getId()+" claims ed25519 key "+i+" but sender device has key "+n.getFingerprint()),null):n:(g.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},$.prototype.getEventEncryptionInfo=function(e){var t={};if(t.senderKey=e.getSenderKey(),t.algorithm=e.getWireContent().algorithm,!t.senderKey||!t.algorithm)return t.encrypted=!1,t;t.encrypted=!0,e.getForwardingCurve25519KeyChain().length>0||e.isKeySourceUntrusted()?t.authenticated=!1:t.authenticated=!0,t.sender=this._deviceList.getDeviceByIdentityKey(t.algorithm,t.senderKey);var r=e.getClaimedEd25519Key();return r||(g.logger.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),t.mismatchedSender=!0),t.sender&&r!==t.sender.getFingerprint()&&(g.logger.warn("Event "+e.getId()+" claims ed25519 key "+r+"but sender device has key "+t.sender.getFingerprint()),t.mismatchedSender=!0),t},$.prototype.forceDiscardSession=function(e){var t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},$.prototype.setRoomEncryption=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n){var i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.algorithm){e.next=3;break}return g.logger.log("Ignoring setRoomEncryption with no algorithm"),e.abrupt("return");case 3:if(!(i=this._roomList.getRoomEncryption(t))){e.next=8;break}if(JSON.stringify(i)==JSON.stringify(r)){e.next=8;break}return g.logger.error("Ignoring m.room.encryption event which requests a change of config in "+t),e.abrupt("return");case 8:if(!this._roomEncryptors[t]){e.next=11;break}return e.abrupt("return");case 11:if(o=null,i||(o=this._roomList.setRoomEncryption(t,r)),s=S.ENCRYPTION_CLASSES[r.algorithm]){e.next=16;break}throw new Error("Unable to encrypt with "+r.algorithm);case 16:if(a=new s({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:t,config:r}),this._roomEncryptors[t]=a,!o){e.next=21;break}return e.next=21,o;case 21:if(this._lazyLoadMembers){e.next=28;break}return g.logger.log("Enabling encryption in "+t+"; starting to track device lists for all users therein"),e.next=25,this.trackRoomDevices(t);case 25:this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists(),e.next=29;break;case 28:g.logger.log("Enabling encryption in "+t);case 29:case"end":return e.stop()}}),e,this)})));return function(t,r,n){return e.apply(this,arguments)}}(),$.prototype.trackRoomDevices=function(e){var t=this,r=function(){var r=(0,l.default)(u.default.mark((function r(){var n;return u.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t._roomEncryptors[e]){r.next=2;break}return r.abrupt("return");case 2:if(n=t._clientStore.getRoom(e)){r.next=5;break}throw new Error("Unable to start tracking devices in unknown room ".concat(e));case 5:return g.logger.log("Starting to track devices for room ".concat(e," ...")),r.next=8,n.getEncryptionTargetMembers();case 8:r.sent.forEach((function(e){t._deviceList.startTrackingDeviceList(e.userId)}));case 10:case"end":return r.stop()}}),r)})));return function(){return r.apply(this,arguments)}}(),n=this._roomDeviceTrackingState[e];return n||(n=r(),this._roomDeviceTrackingState[e]=n.catch((function(r){throw t._roomDeviceTrackingState[e]=null,r}))),n},$.prototype.ensureOlmSessionsForUsers=function(e){for(var t={},r=0;r<e.length;++r){var n=e[r];t[n]=[];for(var i=this.getStoredDevicesForUser(n)||[],o=0;o<i.length;++o){var s=i[o];s.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(s.verified!=F.BLOCKED&&t[n].push(s))}}return m.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},$.prototype.exportRoomKeys=(0,l.default)(u.default.mark((function e(){var t,r=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,this._cryptoStore.doTxn("readonly",[T.IndexedDBCryptoStore.STORE_INBOUND_GROUP_SESSIONS],(function(e){r._cryptoStore.getAllEndToEndInboundGroupSessions(e,(function(e){if(null!==e){var n=r._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);delete n.first_known_index,n.algorithm=m.MEGOLM_ALGORITHM,t.push(n)}}))}));case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)}))),$.prototype.importRoomKeys=function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=0,i=0,o=e.length;function s(){r.progressCallback({stage:"load_keys",successes:n,failures:i,total:o})}return Promise.all(e.map((function(e){return e.room_id&&e.algorithm?t._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e,r).finally((function(e){n++,r.progressCallback&&s()})):(g.logger.warn("ignoring room key entry with missing fields",e),i++,r.progressCallback&&s(),null)})))},$.prototype.countSessionsNeedingBackup=function(){return this._backupManager.countSessionsNeedingBackup()},$.prototype.prepareToEncrypt=function(e){var t=e.roomId,r=this._roomEncryptors[t];r&&r.prepareToEncrypt(e)},$.prototype.encryptEvent=function(){var e=(0,l.default)(u.default.mark((function e(t,r){var n,i,o,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw new Error("Cannot send encrypted messages in unknown rooms");case 2:if(n=t.getRoomId(),i=this._roomEncryptors[n]){e.next=6;break}throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");case 6:return this._roomDeviceTrackingState[n]||this.trackRoomDevices(n),e.next=9,this._roomDeviceTrackingState[n];case 9:return o=t.getContent(),(s=o["m.relates_to"])&&delete(o=Object.assign({},o))["m.relates_to"],e.next=14,i.encryptMessage(r,t.getType(),o);case 14:a=e.sent,s&&(a["m.relates_to"]=s),t.makeEncrypted("m.room.encrypted",a,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key);case 17:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),$.prototype.decryptEvent=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.isRedacted()){e.next=8;break}return r=new B.MatrixEvent(t.getUnsigned().redacted_because),e.next=4,this.decryptEvent(r);case 4:return n=e.sent,e.abrupt("return",{clearEvent:{room_id:t.getRoomId(),type:"m.room.message",content:{},unsigned:{redacted_because:n.clearEvent}}});case 8:return i=t.getWireContent(),o=this._getRoomDecryptor(t.getRoomId(),i.algorithm),e.next=12,o.decryptEvent(t);case 12:return e.abrupt("return",e.sent);case 13:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.handleDeviceListChanges=function(){var e=(0,l.default)(u.default.mark((function e(t,r){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.oldSyncToken){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this._evalDeviceListChanges(r);case 4:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),$.prototype.requestRoomKey=function(e,t){var r=this,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._outgoingRoomKeyRequestManager.queueRoomKeyRequest(e,t,n).then((function(){r._sendKeyRequestsImmediately&&r._outgoingRoomKeyRequestManager.sendQueuedRequests()})).catch((function(e){g.logger.error("Error requesting key for event",e)}))},$.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((function(e){g.logger.warn("Error clearing pending room key requests",e)}))},$.prototype.cancelAndResendAllOutgoingKeyRequests=function(){return this._outgoingRoomKeyRequestManager.cancelAndResendAllOutgoingRequests()},$.prototype.onCryptoEvent=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.getRoomId(),n=t.getContent(),e.prev=2,e.next=5,this.setRoomEncryption(r,n,!0);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),g.logger.error("Error configuring encryption in room "+r+":",e.t0);case 10:case"end":return e.stop()}}),e,this,[[2,7]])})));return function(t){return e.apply(this,arguments)}}(),$.prototype.onSyncWillProcess=function(){var e=(0,l.default)(u.default.mark((function e(t){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.oldSyncToken||(g.logger.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={}),this._sendKeyRequestsImmediately=!1;case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype.onSyncCompleted=function(){var e=(0,l.default)(u.default.mark((function e(t){var r;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=t.nextSyncToken,this._deviceList.setSyncToken(t.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=r,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),t.catchingUp||(W(this),this._processReceivedRoomKeyRequests(),this._outgoingRoomKeyRequestManager.sendQueuedRequests(),this._sendKeyRequestsImmediately=!0);case 7:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype._evalDeviceListChanges=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.changed&&Array.isArray(t.changed)&&t.changed.forEach((function(e){n._deviceList.invalidateUserDeviceList(e)})),!(t.left&&Array.isArray(t.left)&&t.left.length)){e.next=8;break}return e.t0=Set,e.next=5,this._getTrackedE2eUsers();case 5:e.t1=e.sent,r=new e.t0(e.t1),t.left.forEach((function(e){r.has(e)||n._deviceList.stopTrackingDeviceList(e)}));case 8:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype._getTrackedE2eUsers=(0,l.default)(u.default.mark((function e(){var t,r,n,i,o,s,a,c;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=q(this._getTrackedE2eRooms()),e.prev=2,r.s();case 4:if((n=r.n()).done){e.next=13;break}return i=n.value,e.next=8,i.getEncryptionTargetMembers();case 8:o=e.sent,s=q(o);try{for(s.s();!(a=s.n()).done;)c=a.value,t.push(c.userId)}catch(e){s.e(e)}finally{s.f()}case 11:e.next=4;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(2),r.e(e.t0);case 18:return e.prev=18,r.f(),e.finish(18);case 21:return e.abrupt("return",t);case 22:case"end":return e.stop()}}),e,this,[[2,15,18,21]])}))),$.prototype._getTrackedE2eRooms=function(){var e=this;return this._clientStore.getRooms().filter((function(t){if(!e._roomEncryptors[t.roomId])return!1;if(!e._roomDeviceTrackingState[t.roomId])return!1;var r=t.getMyMembership();return"join"===r||"invite"===r}))},$.prototype._onToDeviceEvent=function(e){var t=this;try{g.logger.log("received to_device ".concat(e.getType()," from: ")+"".concat(e.getSender()," id: ").concat(e.getId())),"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"org.matrix.room_key.withheld"===e.getType()?this._onRoomKeyWithheldEvent(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):(e.isBeingDecrypted()||e.shouldAttemptDecryption())&&(e.isBeingDecrypted()||e.attemptDecryption(this),e.once("Event.decrypted",(function(e){t._onToDeviceEvent(e)})))}catch(e){g.logger.error("Error handling toDeviceEvent:",e)}},$.prototype._onRoomKeyEvent=function(e){var t=e.getContent();t.room_id&&t.algorithm?(this._backupManager.checkedForBackup||this._backupManager.checkAndStart(),this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)):g.logger.error("key event is missing fields")},$.prototype._onRoomKeyWithheldEvent=function(e){var t=e.getContent();if(("m.no_olm"===t.code||t.room_id&&t.session_id)&&t.algorithm&&t.sender_key){g.logger.info("Got room key withheld event from ".concat(e.getSender()," (").concat(t.sender_key,") ")+"for ".concat(t.algorithm,"/").concat(t.room_id,"/").concat(t.session_id," ")+"with reason ".concat(t.code," (").concat(t.reason,")"));var r=this._getRoomDecryptor(t.room_id,t.algorithm);if(r.onRoomKeyWithheldEvent&&r.onRoomKeyWithheldEvent(e),!t.room_id){var n,i=q(this._getRoomDecryptors(t.algorithm));try{for(i.s();!(n=i.n()).done;){n.value.retryDecryptionFromSender(t.sender_key)}}catch(e){i.e(e)}finally{i.f()}}}else g.logger.error("key withheld event is missing fields")},$.prototype._onKeyVerificationMessage=function(e){var t=this;if(P.ToDeviceChannel.validateEvent(e,this._baseApis)){this._handleVerificationEvent(e,this._toDeviceVerificationRequests,(function(e){if(P.ToDeviceChannel.canCreateRequest(P.ToDeviceChannel.getEventType(e))){var r=e.getContent(),n=r&&r.from_device;if(n){var i=e.getSender(),o=new P.ToDeviceChannel(t._baseApis,i,[n]);return new A.VerificationRequest(o,t._verificationMethods,t._baseApis)}}}))}},$.prototype._onTimelineEvent=function(e,t,r,n){var i=this,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{},s=o.liveEvent;if(D.InRoomChannel.validateEvent(e,this._baseApis)){var a=function(e){var t=new D.InRoomChannel(i._baseApis,e.getRoomId());return new A.VerificationRequest(t,i._verificationMethods,i._baseApis)};this._handleVerificationEvent(e,this._inRoomVerificationRequests,a,s)}},$.prototype._handleVerificationEvent=function(){var e=(0,l.default)(u.default.mark((function e(t,r,n){var i,o,s,a=arguments;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=!(a.length>3&&void 0!==a[3])||a[3],o=r.getRequest(t),s=!1,o){e.next=10;break}if(o=n(t)){e.next=8;break}return g.logger.log("Crypto: could not find VerificationRequest for "+"".concat(t.getType(),", and could not create one, so ignoring.")),e.abrupt("return");case 8:s=!0,r.setRequest(t,o);case 10:return t.setVerificationRequest(o),e.prev=11,e.next=14,o.channel.handleEvent(t,o,i);case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(11),g.logger.error("error while handling verification event: "+e.t0.message);case 19:s&&!o.initiatedByMe&&!o.invalid&&!o.observeOnly&&this._baseApis.emit("crypto.verification.request",o);case 21:case"end":return e.stop()}}),e,this,[[11,16]])})));return function(t,r,n){return e.apply(this,arguments)}}(),$.prototype._onToDeviceBadEncrypted=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s,a,c,l,h,f,p,v,y,_=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getWireContent(),n=t.getSender(),i=r.algorithm,o=r.sender_key,s=function(){var e,t=q(_._getRoomDecryptors(m.MEGOLM_ALGORITHM));try{for(t.s();!(e=t.n()).done;){e.value.retryDecryptionFromSender(o)}}catch(e){t.e(e)}finally{t.f()}},void 0!==n&&void 0!==o&&void 0!==o){e.next=7;break}return e.abrupt("return");case 7:if(this._lastNewSessionForced[n]=this._lastNewSessionForced[n]||{},!((a=this._lastNewSessionForced[n][o]||0)+36e5>Date.now())){e.next=15;break}return g.logger.debug("New session already forced with device "+n+":"+o+" at "+a+": not forcing another"),e.next=13,this._olmDevice.recordSessionProblem(o,"wedged",!0);case 13:return s(),e.abrupt("return");case 15:if(c=this._deviceList.getDeviceByIdentityKey(i,o)){e.next=26;break}return e.next=19,this.downloadKeys([n],!1);case 19:if(c=this._deviceList.getDeviceByIdentityKey(i,o)){e.next=26;break}return g.logger.info("Couldn't find device for identity key "+o+": not re-establishing session"),e.next=24,this._olmDevice.recordSessionProblem(o,"wedged",!1);case 24:return s(),e.abrupt("return");case 26:return(l={})[n]=[c],e.next=30,m.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,l,!0);case 30:return this._lastNewSessionForced[n][o]=Date.now(),h={algorithm:m.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=34,m.encryptMessageForDevice(h.ciphertext,this._userId,this._deviceId,this._olmDevice,n,c,{type:"m.dummy"});case 34:return e.next=36,this._olmDevice.recordSessionProblem(o,"wedged",!0);case 36:return s(),e.next=39,this._baseApis.sendToDevice("m.room.encrypted",(0,d.default)({},n,(0,d.default)({},c.deviceId,h)));case 39:return e.next=41,this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,c.deviceId);case 41:f=e.sent,p=q(f);try{for(p.s();!(v=p.n()).done;)y=v.value,this.requestRoomKey(y.requestBody,y.recipients,!0)}catch(e){p.e(e)}finally{p.f()}case 44:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype._onRoomMembership=function(e,t,r){var n=t.roomId,i=this._roomEncryptors[n];i&&(this._roomDeviceTrackingState[n]&&("join"==t.membership?(g.logger.log("Join event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(g.logger.log("Invite event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId))),i.onRoomMembership(e,t,r))},$.prototype._onRoomKeyRequestEvent=function(e){var t=e.getContent();if("request"===t.action){var r=new Q(e);this._receivedRoomKeyRequests.push(r)}else if("request_cancellation"===t.action){var n=new J(e);this._receivedRoomKeyRequestCancellations.push(n)}},$.prototype._processReceivedRoomKeyRequests=(0,l.default)(u.default.mark((function e(){var t,r,n=this;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._processingRoomKeyRequests){e.next=2;break}return e.abrupt("return");case 2:return this._processingRoomKeyRequests=!0,e.prev=3,t=this._receivedRoomKeyRequests,this._receivedRoomKeyRequests=[],r=this._receivedRoomKeyRequestCancellations,this._receivedRoomKeyRequestCancellations=[],e.next=10,Promise.all(t.map((function(e){return n._processReceivedRoomKeyRequest(e)})));case 10:return e.next=12,Promise.all(r.map((function(e){return n._processReceivedRoomKeyRequestCancellation(e)})));case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(3),g.logger.error("Error processing room key requsts: ".concat(e.t0));case 17:return e.prev=17,this._processingRoomKeyRequests=!1,e.finish(17);case 20:case"end":return e.stop()}}),e,this,[[3,14,17,20]])}))),$.prototype._processReceivedRoomKeyRequest=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n,i,o,s,a,c,l;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.userId,n=t.deviceId,i=t.requestBody,o=i.room_id,s=i.algorithm,g.logger.log("m.room_key_request from ".concat(r,":").concat(n)+" for ".concat(o," / ").concat(i.session_id," (id ").concat(t.requestId,")")),r===this._userId){e.next=24;break}if(this._roomEncryptors[o]){e.next=10;break}return g.logger.debug("room key request for unencrypted room ".concat(o)),e.abrupt("return");case 10:if(a=this._roomEncryptors[o],c=this._deviceList.getStoredDevice(r,n)){e.next=15;break}return g.logger.debug("Ignoring keyshare for unknown device ".concat(r,":").concat(n)),e.abrupt("return");case 15:return e.prev=15,e.next=18,a.reshareKeyWithDevice(i.sender_key,i.session_id,r,c);case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(15),g.logger.warn("Failed to re-share keys for session "+i.session_id+" with device "+r+":"+c.deviceId,e.t0);case 23:return e.abrupt("return");case 24:if(n!==this._deviceId){e.next=27;break}return g.logger.log("Ignoring room key request from ourselves"),e.abrupt("return");case 27:if(this._roomDecryptors[o]){e.next=30;break}return g.logger.log("room key request for unencrypted room ".concat(o)),e.abrupt("return");case 30:if(l=this._roomDecryptors[o][s]){e.next=34;break}return g.logger.log("room key request for unknown alg ".concat(s," in room ").concat(o)),e.abrupt("return");case 34:return e.next=36,l.hasKeysForKeyRequest(t);case 36:if(e.sent){e.next=39;break}return g.logger.log("room key request for unknown session ".concat(o," / ")+i.session_id),e.abrupt("return");case 39:if(t.share=function(){l.shareKeysWithDevice(t)},!this.checkDeviceTrust(r,n).isVerified()){e.next=44;break}return g.logger.log("device is already verified: sharing keys"),t.share(),e.abrupt("return");case 44:this.emit("crypto.roomKeyRequest",t);case 45:case"end":return e.stop()}}),e,this,[[15,20]])})));return function(t){return e.apply(this,arguments)}}(),$.prototype._processReceivedRoomKeyRequestCancellation=function(){var e=(0,l.default)(u.default.mark((function e(t){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:g.logger.log("m.room_key_request cancellation for ".concat(t.userId,":")+"".concat(t.deviceId," (id ").concat(t.requestId,")")),this.emit("crypto.roomKeyRequestCancellation",t);case 2:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),$.prototype._getRoomDecryptor=function(e,t){var r,n;if((e=e||null)&&((r=this._roomDecryptors[e])||(this._roomDecryptors[e]=r={}),n=r[t]))return n;var i=S.DECRYPTION_CLASSES[t];if(!i)throw new S.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new i({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),r&&(r[t]=n),n},$.prototype._getRoomDecryptors=function(e){for(var t=[],r=0,n=Object.values(this._roomDecryptors);r<n.length;r++){var i=n[r];e in i&&t.push(i[e])}return t},$.prototype._signObject=function(){var e=(0,l.default)(u.default.mark((function e(t){var r,n;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.signatures||{},n=t.unsigned,delete t.signatures,delete t.unsigned,r[this._userId]=r[this._userId]||{},e.next=7,this._olmDevice.sign(h.default.stringify(t));case 7:r[this._userId]["ed25519:"+this._deviceId]=e.sent,t.signatures=r,void 0!==n&&(t.unsigned=n);case 10:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}();var Q=function e(t){(0,a.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id,this.requestBody=r.body||{},this.share=function(){throw new Error("don't know how to share keys for this request yet")}},J=function e(t){(0,a.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../ReEmitter":57,"../errors":95,"../logger":102,"../models/event":109,"../utils":133,"./CrossSigning":63,"./DeviceList":64,"./EncryptionSetup":65,"./OlmDevice":66,"./OutgoingRoomKeyRequestManager":67,"./SecretStorage":69,"./aes":70,"./algorithms":72,"./backup":76,"./dehydration":77,"./deviceinfo":78,"./key_passphrase":80,"./olmlib":81,"./recoverykey":82,"./store/indexeddb-crypto-store":84,"./verification/IllegalMethod":89,"./verification/QRCode":90,"./verification/SAS":91,"./verification/request/InRoomChannel":92,"./verification/request/ToDeviceChannel":93,"./verification/request/VerificationRequest":94,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,"another-json":28,buffer:34,events:36}],80:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.keyFromAuthData=function(e,t){return c.apply(this,arguments)},r.keyFromPassphrase=function(e){return l.apply(this,arguments)},r.deriveKey=d;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/asyncToGenerator")),s=e("../randomstring"),a=5e5,u=256;function c(){return(c=(0,o.default)(i.default.mark((function e(r,n){return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Olm){e.next=2;break}throw new Error("Olm is not available");case 2:if(r.private_key_salt&&r.private_key_iterations){e.next=4;break}throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");case 4:return e.next=6,d(n,r.private_key_salt,r.private_key_iterations,r.private_key_bits||u);case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function l(){return(l=(0,o.default)(i.default.mark((function e(r){var n,o;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Olm){e.next=2;break}throw new Error("Olm is not available");case 2:return n=(0,s.randomString)(32),e.next=5,d(r,n,a,u);case 5:return o=e.sent,e.abrupt("return",{key:o,salt:n,iterations:a});case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function d(e,t,r){return h.apply(this,arguments)}function h(){return(h=(0,o.default)(i.default.mark((function e(r,n,o){var s,a,c,l,d,h=arguments;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s=h.length>3&&void 0!==h[3]?h[3]:u,a=t.crypto.subtle,c=t.TextEncoder,a&&c){e.next=5;break}throw new Error("Password-based backup is not avaiable on this platform");case 5:return e.next=7,a.importKey("raw",(new c).encode(r),{name:"PBKDF2"},!1,["deriveBits"]);case 7:return l=e.sent,e.next=10,a.deriveBits({name:"PBKDF2",salt:(new c).encode(n),iterations:o,hash:"SHA-512"},l,s);case 10:return d=e.sent,e.abrupt("return",new Uint8Array(d));case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../randomstring":119,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/regenerator":27}],81:[function(e,t,r){(function(t,n){(function(){"use strict";var i=e("@babel/runtime/helpers/interopRequireWildcard"),o=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.encryptMessageForDevice=function(e,t,r,n,i,o,s){return g.apply(this,arguments)},r.getExistingOlmSessions=function(e,t,r){return v.apply(this,arguments)},r.ensureOlmSessionsForDevices=function(e,t,r,n,i,o,s){return y.apply(this,arguments)},r.verifySignature=b,r.pkSign=function(e,r,n,i){var o=!1;if(r instanceof Uint8Array){var s=new t.Olm.PkSigning;i=s.init_with_seed(r),r=s,o=!0}var a=e.signatures||{};delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{var c=a[n]||{};return a[n]=c,c["ed25519:"+i]=r.sign(h.default.stringify(e))}finally{e.signatures=a,u&&(e.unsigned=u),o&&r.free()}},r.pkVerify=function(e,r,n){var i="ed25519:"+r;if(!(e.signatures&&e.signatures[n]&&e.signatures[n][i]))throw new Error("No signature");var o=e.signatures[n][i],s=new t.Olm.Utility,a=e.signatures;delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{s.ed25519_verify(r,h.default.stringify(e),o)}finally{e.signatures=a,u&&(e.unsigned=u),s.free()}},r.encodeBase64=k,r.encodeUnpaddedBase64=function(e){return k(e).replace(/=+$/g,"")},r.decodeBase64=function(e){return n.from(e,"base64")},r.MEGOLM_BACKUP_ALGORITHM=r.MEGOLM_ALGORITHM=r.OLM_ALGORITHM=void 0;var s=o(e("@babel/runtime/helpers/toConsumableArray")),a=o(e("@babel/runtime/helpers/slicedToArray")),u=o(e("@babel/runtime/regenerator")),c=o(e("@babel/runtime/helpers/asyncToGenerator")),l=e("../logger"),d=i(e("../utils")),h=o(e("another-json"));function f(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return p(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return p(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function p(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}r.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2";r.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2";function g(){return(g=(0,c.default)(u.default.mark((function e(t,r,n,i,o,s,a){var c,h,f;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=s.getIdentityKey(),e.next=3,i.getSessionIdForDevice(c);case 3:if(null!==(h=e.sent)){e.next=6;break}return e.abrupt("return");case 6:return l.logger.log("Using sessionid "+h+" for device "+o+":"+s.deviceId),f={sender:r,sender_device:n,keys:{ed25519:i.deviceEd25519Key},recipient:o,recipient_keys:{ed25519:s.getFingerprint()}},d.extend(f,a),e.next=11,i.encryptMessage(c,h,JSON.stringify(f));case 11:t[c]=e.sent;case 12:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function v(){return(v=(0,c.default)(u.default.mark((function e(t,r,n){var i,o,s,l,d,h;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(i={},o={},s=[],l=function(){var e,r=(0,a.default)(h[d],2),n=r[0],l=f(r[1]);try{var p=function(){var r=e.value,a=r.deviceId,l=r.getIdentityKey();s.push((0,c.default)(u.default.mark((function e(){var s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getSessionIdForDevice(l,!0);case 2:null===(s=e.sent)?(i[n]=i[n]||[],i[n].push(r)):(o[n]=o[n]||{},o[n][a]={device:r,sessionId:s});case 4:case"end":return e.stop()}}),e)})))())};for(l.s();!(e=l.n()).done;)p()}catch(e){l.e(e)}finally{l.f()}},d=0,h=Object.entries(n);d<h.length;d++)l();return e.next=7,Promise.all(s);case 7:return e.abrupt("return",[i,o]);case 8:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function y(){return(y=(0,c.default)(u.default.mark((function e(t,r,n,i,o,c,d){var h,p,g,v,y,_,b,S,k,E,w,I,T,R,x,C,O,A,D,P,M,U,N,K,B,L,q,j,F,G,V,$,H;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:"number"==typeof i&&(d=c,c=o,o=i,i=!1),d||(d=l.logger),h=[],p={},g={},v=0,y=Object.entries(n);case 6:if(!(v<y.length)){e.next=29;break}_=(0,a.default)(y[v],2),b=_[1],S=f(b),e.prev=9,E=function(){var e=k.value.getIdentityKey();if(e===t.deviceCurve25519Key)return"continue";t._sessionsInProgress[e]||(t._sessionsInProgress[e]=new Promise((function(r){g[e]=function(){delete t._sessionsInProgress[e],r.apply(void 0,arguments)}})))},S.s();case 12:if((k=S.n()).done){e.next=18;break}if("continue"!==E()){e.next=16;break}return e.abrupt("continue",16);case 16:e.next=12;break;case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(9),S.e(e.t0);case 23:return e.prev=23,S.f(),e.finish(23);case 26:v++,e.next=6;break;case 29:w=0,I=Object.entries(n);case 30:if(!(w<I.length)){e.next=64;break}T=(0,a.default)(I[w],2),R=T[0],x=T[1],p[R]={},C=f(x),e.prev=34,C.s();case 36:if((O=C.n()).done){e.next=53;break}if(A=O.value,D=A.deviceId,(P=A.getIdentityKey())!==t.deviceCurve25519Key){e.next=44;break}return d.info("Attempted to start session with ourself! Ignoring"),p[R][D]={device:A,sessionId:null},e.abrupt("continue",51);case 44:return M="for ".concat(P," (").concat(R,":").concat(D,")"),e.next=47,t.getSessionIdForDevice(P,g[P],d);case 47:null!==(U=e.sent)&&g[P]&&g[P](),(null===U||i)&&(i?d.info("Forcing new Olm session ".concat(M)):d.info("Making new Olm session ".concat(M)),h.push([R,D])),p[R][D]={device:A,sessionId:U};case 51:e.next=36;break;case 53:e.next=58;break;case 55:e.prev=55,e.t1=e.catch(34),C.e(e.t1);case 58:return e.prev=58,C.f(),e.finish(58);case 61:w++,e.next=30;break;case 64:if(0!==h.length){e.next=66;break}return e.abrupt("return",p);case 66:return N="signed_curve25519",B="one-time keys for ".concat(h.length," devices"),e.prev=68,d.debug("Claiming ".concat(B)),e.next=72,r.claimOneTimeKeys(h,N,o);case 72:K=e.sent,d.debug("Claimed ".concat(B)),e.next=81;break;case 76:for(e.prev=76,e.t2=e.catch(68),L=0,q=Object.values(g);L<q.length;L++)(0,q[L])();throw d.log("Failed to claim ".concat(B),e.t2,h),e.t2;case 81:c&&"failures"in K&&(j=c).push.apply(j,(0,s.default)(Object.keys(K.failures))),F=K.one_time_keys||{},G=[],V=function(){for(var e=(0,a.default)(H[$],2),r=e[0],n=e[1],o=F[r]||{},s=function(e){var s=n[e],a=s.deviceId,u=s.getIdentityKey();if(u===t.deviceCurve25519Key)return"continue";if(p[r][a].sessionId&&!i)return"continue";var c=o[a]||{},l=null;for(var h in c)0===h.indexOf(N+":")&&(l=c[h]);if(!l)return d.warn("No one-time keys (alg=".concat(N,") ")+"for device ".concat(r,":").concat(a)),g[u]&&g[u](),"continue";G.push(m(t,l,r,s).then((function(e){g[u]&&g[u](e),p[r][a].sessionId=e}),(function(e){throw g[u]&&g[u](),e})))},u=0;u<n.length;u++)s(u)};for($=0,H=Object.entries(n);$<H.length;$++)V();return B="Olm sessions for ".concat(G.length," devices"),d.debug("Starting ".concat(B)),e.next=90,Promise.all(G);case 90:return d.debug("Started ".concat(B)),e.abrupt("return",p);case 92:case"end":return e.stop()}}),e,null,[[9,20,23,26],[34,55,58,61],[68,76]])})))).apply(this,arguments)}function m(e,t,r,n){return _.apply(this,arguments)}function _(){return(_=(0,c.default)(u.default.mark((function e(t,r,n,i){var o,s;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=i.deviceId,e.prev=1,e.next=4,b(t,r,n,o,i.getFingerprint());case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(1),l.logger.error("Unable to verify signature on one-time key for device "+n+":"+o+":",e.t0),e.abrupt("return",null);case 10:return e.prev=10,e.next=13,t.createOutboundSession(i.getIdentityKey(),r.key);case 13:s=e.sent,e.next=20;break;case 16:return e.prev=16,e.t1=e.catch(10),l.logger.error("Error starting olm session with device "+n+":"+o+": "+e.t1),e.abrupt("return",null);case 20:return l.logger.log("Started new olm sessionid "+s+" for device "+n+":"+o),e.abrupt("return",s);case 22:case"end":return e.stop()}}),e,null,[[1,6],[10,16]])})))).apply(this,arguments)}function b(e,t,r,n,i){return S.apply(this,arguments)}function S(){return(S=(0,c.default)(u.default.mark((function e(t,r,n,i,o){var s,a,c,l,d,f;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(s="ed25519:"+i,a=r.signatures||{},c=a[n]||{},l=c[s]){e.next=6;break}throw Error("No signature");case 6:delete(d=Object.assign({},r)).unsigned,delete d.signatures,f=h.default.stringify(d),t.verifySignature(o,f,l);case 11:case"end":return e.stop()}}),e)})))).apply(this,arguments)}function k(e){return n.from(e).toString("base64")}r.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2"}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../logger":102,"../utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/helpers/toConsumableArray":23,"@babel/runtime/regenerator":27,"another-json":28,buffer:34}],82:[function(e,t,r){(function(t,n){(function(){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.encodeRecoveryKey=function(e){var t=new n(a.length+e.length+1);t.set(a,0),t.set(e,a.length);for(var r=0,i=0;i<t.length-1;++i)r^=t[i];return t[t.length-1]=r,o.default.encode(t).match(/.{1,4}/g).join(" ")},r.decodeRecoveryKey=function(e){var r,n=o.default.decode(e.replace(/ /g,"")),i=0,u=function(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw o}}}}(n);try{for(u.s();!(r=u.n()).done;){var c=r.value;i^=c}}catch(e){u.e(e)}finally{u.f()}if(0!==i)throw new Error("Incorrect parity");for(var l=0;l<a.length;++l)if(n[l]!==a[l])throw new Error("Incorrect prefix");if(n.length!==a.length+t.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return Uint8Array.from(n.slice(a.length,a.length+t.Olm.PRIVATE_KEY_LENGTH))};var o=i(e("bs58"));function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var a=[139,1]}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"@babel/runtime/helpers/interopRequireDefault":12,bs58:33,buffer:34}],83:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.upgradeDatabase=function(e,t){c.logger.log("Upgrading IndexedDBCryptoStore from version ".concat(t)+" to ".concat(10)),t<1&&function(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]});t<8&&e.createObjectStore("inbound_group_sessions_withheld",{keyPath:["senderCurve25519Key","sessionId"]});if(t<9){e.createObjectStore("session_problems",{keyPath:["deviceKey","time"]}).createIndex("deviceKey","deviceKey"),e.createObjectStore("notified_error_devices",{keyPath:["userId","deviceId"]})}t<10&&e.createObjectStore("shared_history_inbound_group_sessions",{keyPath:["roomId"]})},r.Backend=r.VERSION=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=i(e("@babel/runtime/helpers/classCallCheck")),u=i(e("@babel/runtime/helpers/createClass")),c=e("../../logger"),l=n(e("../../utils"));function d(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return h(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return h(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}r.VERSION=10;var f=function(){function e(t){var r=this;(0,a.default)(this,e),this._db=t,this._nextTxnId=0,t.onversionchange=function(e){c.logger.log("versionchange for indexeddb ".concat(r._dbName,": closing")),t.close()}}var t,r,n;return(0,u.default)(e,[{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=this,r=e.requestBody;return new Promise((function(n,i){var o=t._db.transaction("outgoingRoomKeyRequests","readwrite");o.onerror=i,t._getOutgoingRoomKeyRequest(o,r,(function(t){if(t)return c.logger.log("already have key request outstanding for "+"".concat(r.room_id," / ").concat(r.session_id,": ")+"not sending another"),void n(t);c.logger.log("enqueueing key request for ".concat(r.room_id," / ")+r.session_id),o.oncomplete=function(){n(e)},o.objectStore("outgoingRoomKeyRequests").add(e)}))}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){var t=this;return new Promise((function(r,n){var i=t._db.transaction("outgoingRoomKeyRequests","readonly");i.onerror=n,t._getOutgoingRoomKeyRequest(i,e,(function(e){r(e)}))}))}},{key:"_getOutgoingRoomKeyRequest",value:function(e,t,r){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=function(e){var n=e.target.result;if(n){var i=n.value;l.deepCompare(i.requestBody,t)?r(i):n.continue()}else r(null)}}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){if(0===e.length)return Promise.resolve(null);var t,r=0;var n=this._db.transaction("outgoingRoomKeyRequests","readonly"),i=n.objectStore("outgoingRoomKeyRequests"),o=e[r];return i.index("state").openCursor(o).onsuccess=function n(i){var o=i.target.result;if(o)t=o.value;else if(!(++r>=e.length)){var s=e[r];i.target.source.openCursor(s).onsuccess=n}},g(n).then((function(){return t}))}},{key:"getAllOutgoingRoomKeyRequestsByState",value:function(e){var t=this;return new Promise((function(r,n){var i=t._db.transaction("outgoingRoomKeyRequests","readonly").objectStore("outgoingRoomKeyRequests").index("state").getAll(e);i.onsuccess=function(e){return r(e.target.result)},i.onerror=function(e){return n(e.target.error)}}))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n=0,i=[];var o=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=o.objectStore("outgoingRoomKeyRequests"),a=r[n];return s.index("state").openCursor(a).onsuccess=function o(s){var a=s.target.result;if(a){var u=a.value;u.recipients.includes({userId:e,deviceId:t})&&i.push(u),a.continue()}else{if(++n>=r.length)return;var c=r[n];s.target.source.openCursor(c).onsuccess=o}},g(o).then((function(){return i}))}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var n=null;var i=this._db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var i=e.target.result;if(i){var o=i.value;o.state==t?(Object.assign(o,r),i.update(o),n=o):c.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(o.state))}},g(i).then((function(){return n}))}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){var r=this._db.transaction("outgoingRoomKeyRequests","readwrite");return r.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var r=e.target.result;if(r){var n=r.value;n.state==t?r.delete():c.logger.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")"))}},g(r)}},{key:"getAccount",value:function(e,t){var r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){p(e,t)}}}},{key:"storeAccount",value:function(e,t){e.objectStore("account").put(t,"-")}},{key:"getCrossSigningKeys",value:function(e,t){var r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){p(e,t)}}}},{key:"getSecretStorePrivateKey",value:function(e,t,r){var n=e.objectStore("account").get("ssss_cache:".concat(r));n.onsuccess=function(){try{t(n.result||null)}catch(t){p(e,t)}}}},{key:"storeCrossSigningKeys",value:function(e,t){e.objectStore("account").put(t,"crossSigningKeys")}},{key:"storeSecretStorePrivateKey",value:function(e,t,r){e.objectStore("account").put(r,"ssss_cache:".concat(t))}},{key:"countEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").count();r.onsuccess=function(){try{t(r.result)}catch(t){p(e,t)}}}},{key:"getEndToEndSessions",value:function(e,t,r){var n=t.objectStore("sessions").index("deviceKey").openCursor(e),i={};n.onsuccess=function(){var e=n.result;if(e)i[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(i)}catch(e){p(t,e)}}}},{key:"getEndToEndSession",value:function(e,t,r,n){var i=r.objectStore("sessions").get([e,t]);i.onsuccess=function(){try{i.result?n({session:i.result.session,lastReceivedMessageTs:i.result.lastReceivedMessageTs}):n(null)}catch(e){p(r,e)}}}},{key:"getAllEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").openCursor();r.onsuccess=function(){try{var n=r.result;n?(t(n.value),n.continue()):t(null)}catch(t){p(e,t)}}}},{key:"storeEndToEndSession",value:function(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}},{key:"storeEndToEndSessionProblem",value:(n=(0,s.default)(o.default.mark((function e(t,r,n){var i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(i=this._db.transaction("session_problems","readwrite")).objectStore("session_problems").put({deviceKey:t,type:r,fixed:n,time:Date.now()}),e.abrupt("return",g(i));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"getEndToEndSessionProblem",value:(r=(0,s.default)(o.default.mark((function e(t,r){var n,i,s,a,u;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=this._db.transaction("session_problems","readwrite"),s=i.objectStore("session_problems"),a=s.index("deviceKey"),(u=a.getAll(t)).onsuccess=function(e){var t=u.result;if(t.length){t.sort((function(e,t){return e.time-t.time}));var i,o=t[t.length-1],s=d(t);try{for(s.s();!(i=s.n()).done;){var a=i.value;if(a.time>r)return void(n=Object.assign({},a,{fixed:o.fixed}))}}catch(e){s.e(e)}finally{s.f()}n=o.fixed?null:o}else n=null},e.next=7,g(i);case 7:return e.abrupt("return",n);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return r.apply(this,arguments)})},{key:"filterOutNotifiedErrorDevices",value:(t=(0,s.default)(o.default.mark((function e(t){var r,n,i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this._db.transaction("notified_error_devices","readwrite"),n=r.objectStore("notified_error_devices"),i=[],e.next=5,Promise.all(t.map((function(e){return new Promise((function(t){var r=e.userId,o=e.deviceInfo,s=n.get([r,o.deviceId]);s.onsuccess=function(){s.result||(n.put({userId:r,deviceId:o.deviceId}),i.push(e)),t()}}))})));case 5:return e.abrupt("return",i);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){var i=!1,o=!1,s=r.objectStore("inbound_group_sessions").get([e,t]);s.onsuccess=function(){try{i=s.result?s.result.session:null,!1!==o&&n(i,o)}catch(e){p(r,e)}};var a=r.objectStore("inbound_group_sessions_withheld").get([e,t]);a.onsuccess=function(){try{o=a.result?a.result.session:null,!1!==i&&n(i,o)}catch(e){p(r,e)}}}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){var r=e.objectStore("inbound_group_sessions").openCursor();r.onsuccess=function(){var n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){p(e,t)}n.continue()}else try{t(null)}catch(t){p(e,t)}}}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var i=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:r});i.onerror=function(r){"ConstraintError"===i.error.name?(r.stopPropagation(),r.preventDefault(),c.logger.log("Ignoring duplicate inbound group session: "+e+" / "+t)):p(n,new Error("Failed to add inbound group session: "+i.error))}}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){n.objectStore("inbound_group_sessions_withheld").put({senderCurve25519Key:e,sessionId:t,session:r})}},{key:"getEndToEndDeviceData",value:function(e,t){var r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){p(e,t)}}}},{key:"storeEndToEndDeviceData",value:function(e,t){t.objectStore("device_data").put(e,"-")}},{key:"storeEndToEndRoom",value:function(e,t,r){r.objectStore("rooms").put(t,e)}},{key:"getEndToEndRooms",value:function(e,t){var r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){var i=n.result;if(i)r[i.key]=i.value,i.continue();else try{t(r)}catch(t){p(e,t)}}}},{key:"getSessionsNeedingBackup",value:function(e){var t=this;return new Promise((function(r,n){var i=[],o=t._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");o.onerror=n,o.oncomplete=function(){r(i)};var s=o.objectStore("sessions_needing_backup"),a=o.objectStore("inbound_group_sessions"),u=s.openCursor();u.onsuccess=function(){var t=u.result;if(t){var r=a.get(t.key);r.onsuccess=function(){i.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||i.length<e)&&t.continue()}}}))}},{key:"countSessionsNeedingBackup",value:function(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new Promise((function(e,r){var n=t.count();n.onerror=r,n.onsuccess=function(){return e(n.result)}}))}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return Promise.all(e.map((function(e){return new Promise((function(t,n){var i=r.delete([e.senderKey,e.sessionId]);i.onsuccess=t,i.onerror=n}))})))}},{key:"markSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return Promise.all(e.map((function(e){return new Promise((function(t,n){var i=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});i.onsuccess=t,i.onerror=n}))})))}},{key:"addSharedHistoryInboundGroupSession",value:function(e,t,r,n){n||(n=this._db.transaction("shared_history_inbound_group_sessions","readwrite"));var i=n.objectStore("shared_history_inbound_group_sessions"),o=i.get([e]);o.onsuccess=function(){var n=(o.result||{sessions:[]}).sessions;n.push([t,r]),i.put({roomId:e,sessions:n})}}},{key:"getSharedHistoryInboundGroupSessions",value:function(e,t){t||(t=this._db.transaction("shared_history_inbound_group_sessions","readonly"));var r=t.objectStore("shared_history_inbound_group_sessions").get([e]);return new Promise((function(e,t){r.onsuccess=function(){var t=(r.result||{sessions:[]}).sessions;e(t)},r.onerror=t}))}},{key:"doTxn",value:function(e,t,r){arguments.length>3&&void 0!==arguments[3]||c.logger;var n=this._db.transaction(t,e),i=g(n),o=r(n);return i.then((function(){return o}))}}]),e}();function p(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function g(e){return new Promise((function(t,r){e.oncomplete=function(){void 0!==e._mx_abortexception&&r(e._mx_abortexception),t()},e.onerror=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(c.logger.log("Error performing indexeddb txn",t),r(t.target.error))},e.onabort=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(c.logger.log("Error performing indexeddb txn",t),r(t.target.error))}}))}r.Backend=f},{"../../logger":102,"../../utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27}],84:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IndexedDBCryptoStore=void 0;var o=i(e("@babel/runtime/helpers/classCallCheck")),s=i(e("@babel/runtime/helpers/createClass")),a=e("../../logger"),u=e("./localStorage-crypto-store"),c=e("./memory-crypto-store"),l=n(e("./indexeddb-crypto-store-backend")),d=e("../../errors"),h=n(e("../../indexeddb-helpers")),f=function(){function e(t,r){(0,o.default)(this,e),this._indexedDB=t,this._dbName=r,this._backendPromise=null,this._backend=null}return(0,s.default)(e,[{key:"startup",value:function(){var r=this;return this._backendPromise||(this._backendPromise=new Promise((function(e,t){if(r._indexedDB){a.logger.log("connecting to indexeddb ".concat(r._dbName));var n=r._indexedDB.open(r._dbName,l.VERSION);n.onupgradeneeded=function(e){var t=e.target.result,r=e.oldVersion;l.upgradeDatabase(t,r)},n.onblocked=function(){a.logger.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){a.logger.log("Error connecting to indexeddb",e),t(e.target.error)},n.onsuccess=function(t){var n=t.target.result;a.logger.log("connected to indexeddb ".concat(r._dbName)),e(new l.Backend(n))}}else t(new Error("no indexeddb support available"))})).then((function(t){return t.doTxn("readonly",[e.STORE_INBOUND_GROUP_SESSIONS,e.STORE_INBOUND_GROUP_SESSIONS_WITHHELD],(function(e){t.getEndToEndInboundGroupSession("","",e,(function(){}))})).then((function(){return t}))})).catch((function(e){if("VersionError"===e.name)throw a.logger.warn("Crypto DB is too new for us to use!",e),new d.InvalidCryptoStoreError(d.InvalidCryptoStoreError.TOO_NEW);a.logger.warn("unable to connect to indexeddb ".concat(r._dbName)+": falling back to localStorage store: ".concat(e));try{return new u.LocalStorageCryptoStore(t.localStorage)}catch(e){return a.logger.warn("unable to open localStorage: falling back to in-memory store: ".concat(e)),new c.MemoryCryptoStore}})).then((function(e){r._backend=e}))),this._backendPromise}},{key:"deleteAllData",value:function(){var e=this;return new Promise((function(t,r){if(e._indexedDB){a.logger.log("Removing indexeddb instance: ".concat(e._dbName));var n=e._indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){a.logger.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){a.logger.log("Error deleting data from indexeddb",e),r(e.target.error)},n.onsuccess=function(){a.logger.log("Removed indexeddb instance: ".concat(e._dbName)),t()}}else r(new Error("no indexeddb support available"))})).catch((function(e){a.logger.warn("unable to delete IndexedDBCryptoStore: ".concat(e))}))}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){return this._backend.getOrAddOutgoingRoomKeyRequest(e)}},{key:"getOutgoingRoomKeyRequest",value:function(e){return this._backend.getOutgoingRoomKeyRequest(e)}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){return this._backend.getOutgoingRoomKeyRequestByState(e)}},{key:"getAllOutgoingRoomKeyRequestsByState",value:function(e){return this._backend.getAllOutgoingRoomKeyRequestsByState(e)}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){return this._backend.getOutgoingRoomKeyRequestsByTarget(e,t,r)}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){return this._backend.updateOutgoingRoomKeyRequest(e,t,r)}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){return this._backend.deleteOutgoingRoomKeyRequest(e,t)}},{key:"getAccount",value:function(e,t){this._backend.getAccount(e,t)}},{key:"storeAccount",value:function(e,t){this._backend.storeAccount(e,t)}},{key:"getCrossSigningKeys",value:function(e,t){this._backend.getCrossSigningKeys(e,t)}},{key:"getSecretStorePrivateKey",value:function(e,t,r){this._backend.getSecretStorePrivateKey(e,t,r)}},{key:"storeCrossSigningKeys",value:function(e,t){this._backend.storeCrossSigningKeys(e,t)}},{key:"storeSecretStorePrivateKey",value:function(e,t,r){this._backend.storeSecretStorePrivateKey(e,t,r)}},{key:"countEndToEndSessions",value:function(e,t){this._backend.countEndToEndSessions(e,t)}},{key:"getEndToEndSession",value:function(e,t,r,n){this._backend.getEndToEndSession(e,t,r,n)}},{key:"getEndToEndSessions",value:function(e,t,r){this._backend.getEndToEndSessions(e,t,r)}},{key:"getAllEndToEndSessions",value:function(e,t){this._backend.getAllEndToEndSessions(e,t)}},{key:"storeEndToEndSession",value:function(e,t,r,n){this._backend.storeEndToEndSession(e,t,r,n)}},{key:"storeEndToEndSessionProblem",value:function(e,t,r){return this._backend.storeEndToEndSessionProblem(e,t,r)}},{key:"getEndToEndSessionProblem",value:function(e,t){return this._backend.getEndToEndSessionProblem(e,t)}},{key:"filterOutNotifiedErrorDevices",value:function(e){return this._backend.filterOutNotifiedErrorDevices(e)}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){this._backend.getEndToEndInboundGroupSession(e,t,r,n)}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){this._backend.getAllEndToEndInboundGroupSessions(e,t)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){this._backend.addEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._backend.storeEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){this._backend.storeEndToEndInboundGroupSessionWithheld(e,t,r,n)}},{key:"storeEndToEndDeviceData",value:function(e,t){this._backend.storeEndToEndDeviceData(e,t)}},{key:"getEndToEndDeviceData",value:function(e,t){this._backend.getEndToEndDeviceData(e,t)}},{key:"storeEndToEndRoom",value:function(e,t,r){this._backend.storeEndToEndRoom(e,t,r)}},{key:"getEndToEndRooms",value:function(e,t){this._backend.getEndToEndRooms(e,t)}},{key:"getSessionsNeedingBackup",value:function(e){return this._backend.getSessionsNeedingBackup(e)}},{key:"countSessionsNeedingBackup",value:function(e){return this._backend.countSessionsNeedingBackup(e)}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){return this._backend.unmarkSessionsNeedingBackup(e,t)}},{key:"markSessionsNeedingBackup",value:function(e,t){return this._backend.markSessionsNeedingBackup(e,t)}},{key:"addSharedHistoryInboundGroupSession",value:function(e,t,r,n){this._backend.addSharedHistoryInboundGroupSession(e,t,r,n)}},{key:"getSharedHistoryInboundGroupSessions",value:function(e,t){return this._backend.getSharedHistoryInboundGroupSessions(e,t)}},{key:"doTxn",value:function(e,t,r,n){return this._backend.doTxn(e,t,r,n)}}],[{key:"exists",value:function(e,t){return h.exists(e,t)}}]),e}();r.IndexedDBCryptoStore=f,f.STORE_ACCOUNT="account",f.STORE_SESSIONS="sessions",f.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",f.STORE_INBOUND_GROUP_SESSIONS_WITHHELD="inbound_group_sessions_withheld",f.STORE_SHARED_HISTORY_INBOUND_GROUP_SESSIONS="shared_history_inbound_group_sessions",f.STORE_DEVICE_DATA="device_data",f.STORE_ROOMS="rooms",f.STORE_BACKUP="sessions_needing_backup"}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../errors":95,"../../indexeddb-helpers":100,"../../logger":102,"./indexeddb-crypto-store-backend":83,"./localStorage-crypto-store":85,"./memory-crypto-store":86,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13}],85:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.LocalStorageCryptoStore=void 0;var i=n(e("@babel/runtime/helpers/defineProperty")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=n(e("@babel/runtime/helpers/slicedToArray")),u=n(e("@babel/runtime/helpers/classCallCheck")),c=n(e("@babel/runtime/helpers/createClass")),l=n(e("@babel/runtime/helpers/inherits")),d=n(e("@babel/runtime/helpers/possibleConstructorReturn")),h=n(e("@babel/runtime/helpers/getPrototypeOf")),f=e("../../logger"),p=e("./memory-crypto-store");function g(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,h.default)(e);if(t){var i=(0,h.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,d.default)(this,r)}}var m="crypto.",_="crypto.account",b="crypto.cross_signing_keys",S="crypto.notified_error_devices",k="crypto.device_data",E="crypto.inboundgroupsessions/",w="crypto.sessionsneedingbackup";function I(e){return"crypto.sessions/"+e}function T(e){return"crypto.session.problems/"+e}function R(e,t){return E+e+"/"+t}function x(e,t){return"crypto.inboundgroupsessions.withheld/"+e+"/"+t}function C(e){return"crypto.rooms/"+e}var O=function(e){(0,l.default)(h,e);var t,r,n,d=y(h);function h(e){var t;return(0,u.default)(this,h),(t=d.call(this)).store=e,t}return(0,c.default)(h,[{key:"countEndToEndSessions",value:function(e,t){for(var r=0,n=0;n<this.store.length;++n)this.store.key(n).startsWith(I(""))&&++r;t(r)}},{key:"_getEndToEndSessions",value:function(e,t,r){for(var n=A(this.store,I(e)),i={},o=0,s=Object.entries(n||{});o<s.length;o++){var u=(0,a.default)(s[o],2),c=u[0],l=u[1];i[c]="string"==typeof l?{session:l}:l}return i}},{key:"getEndToEndSession",value:function(e,t,r,n){n(this._getEndToEndSessions(e)[t]||{})}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._getEndToEndSessions(e)||{})}},{key:"getAllEndToEndSessions",value:function(e,t){for(var r=0;r<this.store.length;++r)if(this.store.key(r).startsWith(I("")))for(var n=this.store.key(r).split("/")[1],i=0,o=Object.values(this._getEndToEndSessions(n));i<o.length;i++){t(o[i])}}},{key:"storeEndToEndSession",value:function(e,t,r,n){var i=this._getEndToEndSessions(e)||{};i[t]=r,D(this.store,I(e),i)}},{key:"storeEndToEndSessionProblem",value:(n=(0,s.default)(o.default.mark((function e(t,r,n){var i,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=T(t),(s=A(this.store,i)||[]).push({type:r,fixed:n,time:Date.now()}),s.sort((function(e,t){return e.time-t.time})),D(this.store,i,s);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"getEndToEndSessionProblem",value:(r=(0,s.default)(o.default.mark((function e(t,r){var n,i,s,a,u,c;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=T(t),(i=A(this.store,n)||[]).length){e.next=4;break}return e.abrupt("return",null);case 4:s=i[i.length-1],a=g(i),e.prev=6,a.s();case 8:if((u=a.n()).done){e.next=14;break}if(!((c=u.value).time>r)){e.next=12;break}return e.abrupt("return",Object.assign({},c,{fixed:s.fixed}));case 12:e.next=8;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(6),a.e(e.t0);case 19:return e.prev=19,a.f(),e.finish(19);case 22:if(!s.fixed){e.next=26;break}return e.abrupt("return",null);case 26:return e.abrupt("return",s);case 27:case"end":return e.stop()}}),e,this,[[6,16,19,22]])}))),function(e,t){return r.apply(this,arguments)})},{key:"filterOutNotifiedErrorDevices",value:(t=(0,s.default)(o.default.mark((function e(t){var r,n,s,a,u,c,l;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=A(this.store,S)||{},n=[],s=g(t);try{for(s.s();!(a=s.n()).done;)u=a.value,c=u.userId,l=u.deviceInfo,c in r?l.deviceId in r[c]||(n.push(u),r[c][l.deviceId]=!0):(n.push(u),r[c]=(0,i.default)({},l.deviceId,!0))}catch(e){s.e(e)}finally{s.f()}return D(this.store,S,r),e.abrupt("return",n);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){n(A(this.store,R(e,t)),A(this.store,x(e,t)))}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);n.startsWith(E)&&t({senderKey:n.substr(E.length,43),sessionId:n.substr(E.length+44),sessionData:A(this.store,n)})}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){A(this.store,R(e,t))||this.storeEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){D(this.store,R(e,t),r)}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){D(this.store,x(e,t),r)}},{key:"getEndToEndDeviceData",value:function(e,t){t(A(this.store,k))}},{key:"storeEndToEndDeviceData",value:function(e,t){D(this.store,k,e)}},{key:"storeEndToEndRoom",value:function(e,t,r){D(this.store,C(e),t)}},{key:"getEndToEndRooms",value:function(e,t){for(var r={},n=C(""),i=0;i<this.store.length;++i){var o=this.store.key(i);if(o.startsWith(n))r[o.substr(n.length)]=A(this.store,o)}t(r)}},{key:"getSessionsNeedingBackup",value:function(e){var t=this,r=A(this.store,w)||{},n=[];for(var i in r){if(Object.prototype.hasOwnProperty.call(r,i))if("break"===function(){var r=i.substr(0,43),o=i.substr(44);if(t.getEndToEndInboundGroupSession(r,o,null,(function(e){n.push({senderKey:r,sessionId:o,sessionData:e})})),e&&i.length>=e)return"break"}())break}return Promise.resolve(n)}},{key:"countSessionsNeedingBackup",value:function(){var e=A(this.store,w)||{};return Promise.resolve(Object.keys(e).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t,r=A(this.store,w)||{},n=g(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;delete r[i.senderKey+"/"+i.sessionId]}}catch(e){n.e(e)}finally{n.f()}return D(this.store,w,r),Promise.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t,r=A(this.store,w)||{},n=g(e);try{for(n.s();!(t=n.n()).done;){var i=t.value;r[i.senderKey+"/"+i.sessionId]=!0}}catch(e){n.e(e)}finally{n.f()}return D(this.store,w,r),Promise.resolve()}},{key:"deleteAllData",value:function(){return this.store.removeItem(_),Promise.resolve()}},{key:"getAccount",value:function(e,t){t(A(this.store,_))}},{key:"storeAccount",value:function(e,t){D(this.store,_,t)}},{key:"getCrossSigningKeys",value:function(e,t){t(A(this.store,b))}},{key:"getSecretStorePrivateKey",value:function(e,t,r){t(A(this.store,m+"ssss_cache.".concat(r)))}},{key:"storeCrossSigningKeys",value:function(e,t){D(this.store,b,t)}},{key:"storeSecretStorePrivateKey",value:function(e,t,r){D(this.store,m+"ssss_cache.".concat(t),r)}},{key:"doTxn",value:function(e,t,r){return Promise.resolve(r(null))}}],[{key:"exists",value:function(e){for(var t=e.length,r=0;r<t;r++)if(e.key(r).startsWith(m))return!0;return!1}}]),h}(p.MemoryCryptoStore);function A(e,t){try{return JSON.parse(e.getItem(t))}catch(e){f.logger.log("Error: Failed to get key %s: %s",t,e.stack||e),f.logger.log(e.stack)}return null}function D(e,t,r){e.setItem(t,JSON.stringify(r))}r.LocalStorageCryptoStore=O},{"../../logger":102,"./memory-crypto-store":86,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27}],86:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MemoryCryptoStore=void 0;var o=i(e("@babel/runtime/helpers/defineProperty")),s=i(e("@babel/runtime/helpers/slicedToArray")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/asyncToGenerator")),c=i(e("@babel/runtime/helpers/classCallCheck")),l=i(e("@babel/runtime/helpers/createClass")),d=e("../../logger"),h=n(e("../../utils"));function f(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function p(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?f(Object(r),!0).forEach((function(t){(0,o.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):f(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function g(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var y=function(){function e(){(0,c.default)(this,e),this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._privateKeys={},this._backupKeys={},this._sessions={},this._sessionProblems={},this._notifiedErrorDevices={},this._inboundGroupSessions={},this._inboundGroupSessionsWithheld={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={},this._sharedHistoryInboundGroupSessions={}}var t,r,n,i;return(0,l.default)(e,[{key:"startup",value:(i=(0,u.default)(a.default.mark((function e(){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",this);case 1:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"deleteAllData",value:function(){return Promise.resolve()}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=this,r=e.requestBody;return h.promiseTry((function(){var n=t._getOutgoingRoomKeyRequest(r);return n?(d.logger.log("already have key request outstanding for "+"".concat(r.room_id," / ").concat(r.session_id,": ")+"not sending another"),n):(d.logger.log("enqueueing key request for ".concat(r.room_id," / ")+r.session_id),t._outgoingRoomKeyRequests.push(e),e)}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){return Promise.resolve(this._getOutgoingRoomKeyRequest(e))}},{key:"_getOutgoingRoomKeyRequest",value:function(e){var t,r=g(this._outgoingRoomKeyRequests);try{for(r.s();!(t=r.n()).done;){var n=t.value;if(h.deepCompare(n.requestBody,e))return n}}catch(e){r.e(e)}finally{r.f()}return null}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){var t,r=g(this._outgoingRoomKeyRequests);try{for(r.s();!(t=r.n()).done;){var n,i=t.value,o=g(e);try{for(o.s();!(n=o.n()).done;){var s=n.value;if(i.state===s)return Promise.resolve(i)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}return Promise.resolve(null)}},{key:"getAllOutgoingRoomKeyRequestsByState",value:function(e){return Promise.resolve(this._outgoingRoomKeyRequests.filter((function(t){return t.state==e})))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n,i=[],o=g(this._outgoingRoomKeyRequests);try{for(o.s();!(n=o.n()).done;){var s,a=n.value,u=g(r);try{for(u.s();!(s=u.n()).done;){var c=s.value;a.state===c&&a.recipients.includes({userId:e,deviceId:t})&&i.push(a)}}catch(e){u.e(e)}finally{u.f()}}}catch(e){o.e(e)}finally{o.f()}return Promise.resolve(i)}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var n,i=g(this._outgoingRoomKeyRequests);try{for(i.s();!(n=i.n()).done;){var o=n.value;if(o.requestId===e)return o.state!=t?(d.logger.warn("Cannot update room key request from ".concat(t," ")+"as it was already updated to ".concat(o.state)),Promise.resolve(null)):(Object.assign(o,r),Promise.resolve(o))}}catch(e){i.e(e)}finally{i.f()}return Promise.resolve(null)}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){for(var r=0;r<this._outgoingRoomKeyRequests.length;r++){var n=this._outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(d.logger.warn("Cannot delete room key request in state ".concat(n.state," ")+"(expected ".concat(t,")")),Promise.resolve(null)):(this._outgoingRoomKeyRequests.splice(r,1),Promise.resolve(n))}return Promise.resolve(null)}},{key:"getAccount",value:function(e,t){t(this._account)}},{key:"storeAccount",value:function(e,t){this._account=t}},{key:"getCrossSigningKeys",value:function(e,t){t(this._crossSigningKeys)}},{key:"getSecretStorePrivateKey",value:function(e,t,r){return t(this._privateKeys[r]||null)}},{key:"storeCrossSigningKeys",value:function(e,t){this._crossSigningKeys=t}},{key:"storeSecretStorePrivateKey",value:function(e,t,r){this._privateKeys[t]=r}},{key:"countEndToEndSessions",value:function(e,t){return Object.keys(this._sessions).length}},{key:"getEndToEndSession",value:function(e,t,r,n){n((this._sessions[e]||{})[t]||null)}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._sessions[e]||{})}},{key:"getAllEndToEndSessions",value:function(e,t){Object.entries(this._sessions).forEach((function(e){var r=(0,s.default)(e,2),n=r[0],i=r[1];Object.entries(i).forEach((function(e){var r=(0,s.default)(e,2),i=r[0],o=r[1];t(p(p({},o),{},{deviceKey:n,sessionId:i}))}))}))}},{key:"storeEndToEndSession",value:function(e,t,r,n){var i=this._sessions[e];void 0===i&&(i={},this._sessions[e]=i),i[t]=r}},{key:"storeEndToEndSessionProblem",value:(n=(0,u.default)(a.default.mark((function e(t,r,n){var i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:(i=this._sessionProblems[t]=this._sessionProblems[t]||[]).push({type:r,fixed:n,time:Date.now()}),i.sort((function(e,t){return e.time-t.time}));case 3:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)})},{key:"getEndToEndSessionProblem",value:(r=(0,u.default)(a.default.mark((function e(t,r){var n,i,o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((n=this._sessionProblems[t]||[]).length){e.next=3;break}return e.abrupt("return",null);case 3:i=n[n.length-1],o=g(n),e.prev=5,o.s();case 7:if((s=o.n()).done){e.next=13;break}if(!((u=s.value).time>r)){e.next=11;break}return e.abrupt("return",Object.assign({},u,{fixed:i.fixed}));case 11:e.next=7;break;case 13:e.next=18;break;case 15:e.prev=15,e.t0=e.catch(5),o.e(e.t0);case 18:return e.prev=18,o.f(),e.finish(18);case 21:if(!i.fixed){e.next=25;break}return e.abrupt("return",null);case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}}),e,this,[[5,15,18,21]])}))),function(e,t){return r.apply(this,arguments)})},{key:"filterOutNotifiedErrorDevices",value:(t=(0,u.default)(a.default.mark((function e(t){var r,n,i,s,u,c,l;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this._notifiedErrorDevices,n=[],i=g(t);try{for(i.s();!(s=i.n()).done;)u=s.value,c=u.userId,l=u.deviceInfo,c in r?l.deviceId in r[c]||(n.push(u),r[c][l.deviceId]=!0):(n.push(u),r[c]=(0,o.default)({},l.deviceId,!0))}catch(e){i.e(e)}finally{i.f()}return e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){var i=e+"/"+t;n(this._inboundGroupSessions[i]||null,this._inboundGroupSessionsWithheld[i]||null)}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){for(var r=0,n=Object.keys(this._inboundGroupSessions);r<n.length;r++){var i=n[r];t({senderKey:i.substr(0,43),sessionId:i.substr(44),sessionData:this._inboundGroupSessions[i]})}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var i=e+"/"+t;void 0===this._inboundGroupSessions[i]&&(this._inboundGroupSessions[i]=r)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._inboundGroupSessions[e+"/"+t]=r}},{key:"storeEndToEndInboundGroupSessionWithheld",value:function(e,t,r,n){var i=e+"/"+t;this._inboundGroupSessionsWithheld[i]=r}},{key:"getEndToEndDeviceData",value:function(e,t){t(this._deviceData)}},{key:"storeEndToEndDeviceData",value:function(e,t){this._deviceData=e}},{key:"storeEndToEndRoom",value:function(e,t,r){this._rooms[e]=t}},{key:"getEndToEndRooms",value:function(e,t){t(this._rooms)}},{key:"getSessionsNeedingBackup",value:function(e){var t=[];for(var r in this._sessionsNeedingBackup)if(this._inboundGroupSessions[r]&&(t.push({senderKey:r.substr(0,43),sessionId:r.substr(44),sessionData:this._inboundGroupSessions[r]}),e&&r.length>=e))break;return Promise.resolve(t)}},{key:"countSessionsNeedingBackup",value:function(){return Promise.resolve(Object.keys(this._sessionsNeedingBackup).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t,r=g(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,i=n.senderKey+"/"+n.sessionId;delete this._sessionsNeedingBackup[i]}}catch(e){r.e(e)}finally{r.f()}return Promise.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t,r=g(e);try{for(r.s();!(t=r.n()).done;){var n=t.value,i=n.senderKey+"/"+n.sessionId;this._sessionsNeedingBackup[i]=!0}}catch(e){r.e(e)}finally{r.f()}return Promise.resolve()}},{key:"addSharedHistoryInboundGroupSession",value:function(e,t,r){var n=this._sharedHistoryInboundGroupSessions[e]||[];n.push([t,r]),this._sharedHistoryInboundGroupSessions[e]=n}},{key:"getSharedHistoryInboundGroupSessions",value:function(e){return Promise.resolve(this._sharedHistoryInboundGroupSessions[e]||[])}},{key:"doTxn",value:function(e,t,r){return Promise.resolve(r(null))}}]),e}();r.MemoryCryptoStore=y},{"../../logger":102,"../../utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27}],87:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.VerificationBase=r.SwitchStartEventError=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/defineProperty")),s=n(e("@babel/runtime/helpers/slicedToArray")),a=n(e("@babel/runtime/helpers/asyncToGenerator")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/classCallCheck")),l=n(e("@babel/runtime/helpers/inherits")),d=n(e("@babel/runtime/helpers/possibleConstructorReturn")),h=n(e("@babel/runtime/helpers/getPrototypeOf")),f=n(e("@babel/runtime/helpers/wrapNativeSuper")),p=e("../../models/event"),g=e("events"),v=e("../../logger"),y=e("../deviceinfo"),m=e("./Error"),_=e("../CrossSigning");function b(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,h.default)(e);if(t){var i=(0,h.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,d.default)(this,r)}}var S=new Error("Verification timed out"),k=function(e){(0,l.default)(r,e);var t=b(r);function r(e){var n;return(0,c.default)(this,r),(n=t.call(this)).startEvent=e,n}return r}((0,f.default)(Error));r.SwitchStartEventError=k;var E=function(e){(0,l.default)(n,e);var t,r=b(n);function n(e,t,i,o,s,a){var u;return(0,c.default)(this,n),(u=r.call(this))._channel=e,u._baseApis=t,u.userId=i,u.deviceId=o,u.startEvent=s,u.request=a,u.cancelled=!1,u._done=!1,u._promise=null,u._transactionTimeoutTimer=null,u}return(0,u.default)(n,[{key:"_resetTimer",value:function(){var e=this;v.logger.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout((function(){e._done||e.cancelled||(v.logger.info("Triggering verification timeout"),e.cancel(S))}),6e5)}},{key:"_endTimer",value:function(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}},{key:"_send",value:function(e,t){return this._channel.send(e,t)}},{key:"_waitForEvent",value:function(e){var t=this;if(this._done)return Promise.reject(new Error("Verification is already done"));var r=this.request.getEventFromOtherParty(e);return r?Promise.resolve(r):(this._expectedEvent=e,new Promise((function(e,r){t._resolveEvent=e,t._rejectEvent=r})))}},{key:"canSwitchStartEvent",value:function(){return!1}},{key:"switchStartEvent",value:function(e){if(this.canSwitchStartEvent(e))if(v.logger.log("Verification Base: switching verification start event",{restartingFlow:!!this._rejectEvent}),this._rejectEvent){var t=this._rejectEvent;this._rejectEvent=void 0,t(new k(e))}else this.startEvent=e}},{key:"handleEvent",value:function(e){if(!this._done)if(e.getType()===this._expectedEvent)"m.key.verification.done"!==this._expectedEvent&&(this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e));else if("m.key.verification.cancel"===e.getType()){var t=this._reject;if(this._reject=void 0,t){var r=e.getContent(),n=r.reason,i=r.code;t(new Error("Other side cancelled verification "+"because ".concat(n," (").concat(i,")")))}}else if(this._expectedEvent){var o=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){var s=this._rejectEvent;this._rejectEvent=void 0,s(o)}this.cancel(o)}}},{key:"done",value:function(){if(this._endTimer(),!this._done)return this.request.onVerifierFinished(),this._resolve(),(0,_.requestKeysDuringVerification)(this._baseApis,this.userId,this.deviceId)}},{key:"cancel",value:function(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.request.onVerifierCancelled(),this.userId&&this.deviceId)if(e===S){var t=(0,m.newTimeoutError)();this._send(t.getType(),t.getContent())}else if(e instanceof p.MatrixEvent){if(e.getSender()!==this.userId){var r=e.getContent();"m.key.verification.cancel"===e.getType()?(r.code=r.code||"m.unknown",r.reason=r.reason||r.body||"Unknown reason",this._send("m.key.verification.cancel",r)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:r.body||"Unknown reason"})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString()});null!==this._promise?this._reject&&this._reject(e):this._promise=Promise.reject(e),this.emit("cancel",e)}}},{key:"verify",value:function(){var e=this;return this._promise||(this._promise=new Promise((function(t,r){e._resolve=function(){e._done=!0,e._endTimer(),t.apply(void 0,arguments)},e._reject=function(){e._done=!0,e._endTimer(),r.apply(void 0,arguments)}})),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),Promise.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this)))),this._promise}},{key:"_verifyKeys",value:(t=(0,a.default)(i.default.mark((function e(t,r,n){var a,u,c,l,d,h,f,p,g,m,_,b;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=[],u=0,c=Object.entries(r);case 2:if(!(u<c.length)){e.next=23;break}if(l=(0,s.default)(c[u],2),d=l[0],h=l[1],f=d.split(":",2)[1],!(p=this._baseApis.getStoredDevice(t,f))){e.next=12;break}return e.next=9,n(d,p,h);case 9:a.push(f),e.next=20;break;case 12:if(!(g=this._baseApis.crypto._deviceList.getStoredCrossSigningForUser(t))||g.getId()!==f){e.next=19;break}return e.next=16,n(d,y.DeviceInfo.fromStorage({keys:(0,o.default)({},d,f)},f),h);case 16:a.push(f),e.next=20;break;case 19:v.logger.warn("verification: Could not find device ".concat(f," to verify"));case 20:u++,e.next=2;break;case 23:if(a.length){e.next=25;break}throw new Error("No devices could be verified");case 25:v.logger.info("Verification completed! Marking devices verified: ",a),m=0,_=a;case 27:if(!(m<_.length)){e.next=34;break}return b=_[m],e.next=31,this._baseApis.setDeviceVerified(t,b);case 31:m++,e.next=27;break;case 34:case"end":return e.stop()}}),e,this)}))),function(e,r,n){return t.apply(this,arguments)})},{key:"initiatedByMe",get:function(){if(!this.startEvent)return!0;var e=this.startEvent.getSender(),t=this.startEvent.getContent();return e===this._baseApis.getUserId()&&t.from_device===this._baseApis.getDeviceId()}}]),n}(g.EventEmitter);r.VerificationBase=E},{"../../logger":102,"../../models/event":109,"../CrossSigning":63,"../deviceinfo":78,"./Error":88,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/helpers/wrapNativeSuper":26,"@babel/runtime/regenerator":27,events:36}],88:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.newVerificationError=i,r.errorFactory=o,r.errorFromEvent=function(e){var t=e.getContent();if(t){var r=t.code,n=t.reason;return{code:r,reason:n}}return{code:"Unknown error",reason:"m.unknown"}},r.newInvalidMessageError=r.newUserMismatchError=r.newKeyMismatchError=r.newUnexpectedMessageError=r.newUnknownMethodError=r.newUnknownTransactionError=r.newTimeoutError=r.newUserCancelledError=void 0;var n=e("../../models/event");function i(e,t,r){var i=Object.assign({},{code:e,reason:t},r);return new n.MatrixEvent({type:"m.key.verification.cancel",content:i})}function o(e,t){return function(r){return i(e,t,r)}}var s=o("m.user","Cancelled by user");r.newUserCancelledError=s;var a=o("m.timeout","Timed out");r.newTimeoutError=a;var u=o("m.unknown_transaction","Unknown transaction");r.newUnknownTransactionError=u;var c=o("m.unknown_method","Unknown method");r.newUnknownMethodError=c;var l=o("m.unexpected_message","Unexpected message");r.newUnexpectedMessageError=l;var d=o("m.key_mismatch","Key mismatch");r.newKeyMismatchError=d;var h=o("m.user_error","User mismatch");r.newUserMismatchError=h;var f=o("m.invalid_message","Invalid message");r.newInvalidMessageError=f},{"../../models/event":109}],89:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IllegalMethod=void 0;var i=n(e("@babel/runtime/helpers/construct")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/inherits")),l=n(e("@babel/runtime/helpers/possibleConstructorReturn")),d=n(e("@babel/runtime/helpers/getPrototypeOf"));function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,d.default)(e);if(t){var i=(0,d.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,l.default)(this,r)}}var f=function(e){(0,c.default)(n,e);var t,r=h(n);function n(){return(0,a.default)(this,n),r.apply(this,arguments)}return(0,u.default)(n,[{key:"_doVerification",value:(t=(0,s.default)(o.default.mark((function e(){return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Verification is not possible with this method");case 1:case"end":return e.stop()}}),e)}))),function(){return t.apply(this,arguments)})}],[{key:"factory",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,i.default)(n,t)}},{key:"NAME",get:function(){return"org.matrix.illegal_method"}}]),n}(e("./Base").VerificationBase);r.IllegalMethod=f},{"./Base":87,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/construct":7,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/regenerator":27}],90:[function(e,t,r){(function(t,n){(function(){"use strict";var i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.QRCodeData=r.ReciprocateQRCode=r.SCAN_QR_CODE_METHOD=r.SHOW_QR_CODE_METHOD=void 0;var o=i(e("@babel/runtime/helpers/construct")),s=i(e("@babel/runtime/regenerator")),a=i(e("@babel/runtime/helpers/asyncToGenerator")),u=i(e("@babel/runtime/helpers/classCallCheck")),c=i(e("@babel/runtime/helpers/createClass")),l=i(e("@babel/runtime/helpers/inherits")),d=i(e("@babel/runtime/helpers/possibleConstructorReturn")),h=i(e("@babel/runtime/helpers/getPrototypeOf")),f=e("./Base"),p=e("./Error"),g=e("../olmlib"),v=e("../../logger");function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,h.default)(e);if(t){var i=(0,h.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,d.default)(this,r)}}r.SHOW_QR_CODE_METHOD="m.qr_code.show.v1";r.SCAN_QR_CODE_METHOD="m.qr_code.scan.v1";var m=function(e){(0,l.default)(n,e);var t,r=y(n);function n(){return(0,u.default)(this,n),r.apply(this,arguments)}return(0,c.default)(n,[{key:"_doVerification",value:(t=(0,a.default)(s.default.mark((function e(){var t,r,n,i,o,a=this;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.startEvent){e.next=2;break}throw new Error("It is not currently possible to start verificationwith this method yet.");case 2:if(t=this.request.qrCodeData,this.startEvent.getContent().secret===t.encodedSharedSecret){e.next=5;break}throw(0,p.newKeyMismatchError)();case 5:return e.next=7,new Promise((function(e,t){a.reciprocateQREvent={confirm:e,cancel:function(){return t((0,p.newUserCancelledError)())}},a.emit("show_reciprocate_qr",a.reciprocateQREvent)}));case 7:r={},e.t0=t.mode,e.next=e.t0===_?11:e.t0===b?14:e.t0===S?17:20;break;case 11:return n=t.otherUserMasterKey,r["ed25519:".concat(n)]=n,e.abrupt("break",20);case 14:return i=this.request.targetDevice.deviceId,r["ed25519:".concat(i)]=t.otherDeviceKey,e.abrupt("break",20);case 17:return o=t.myMasterKey,r["ed25519:".concat(o)]=o,e.abrupt("break",20);case 20:return e.next=22,this._verifyKeys(this.userId,r,(function(e,t,n){var i=r[e];if(!i)throw(0,p.newKeyMismatchError)();if(n!==i)throw v.logger.error("key ID from key info does not match"),(0,p.newKeyMismatchError)();for(var o in t.keys)if(o.startsWith("ed25519")){var s=r[o];if(!s)throw(0,p.newKeyMismatchError)();if(t.keys[o]!==s)throw v.logger.error("master key does not match"),(0,p.newKeyMismatchError)()}}));case 22:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})}],[{key:"factory",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return(0,o.default)(n,t)}},{key:"NAME",get:function(){return"m.reciprocate.v1"}}]),n}(f.VerificationBase);r.ReciprocateQRCode=m;var _=0,b=1,S=2,k=function(){function e(t,r,n,i,o,s){(0,u.default)(this,e),this._sharedSecret=r,this._mode=t,this._otherUserMasterKey=n,this._otherDeviceKey=i,this._myMasterKey=o,this._buffer=s}var r,i;return(0,c.default)(e,[{key:"buffer",get:function(){return this._buffer}},{key:"mode",get:function(){return this._mode}},{key:"otherDeviceKey",get:function(){return this._otherDeviceKey}},{key:"otherUserMasterKey",get:function(){return this._otherUserMasterKey}},{key:"myMasterKey",get:function(){return this._myMasterKey}},{key:"encodedSharedSecret",get:function(){return this._sharedSecret}}],[{key:"create",value:(i=(0,a.default)(s.default.mark((function t(r,n){var i,o,a,u,c,l,d,h,f,p;return s.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(i=e._generateSharedSecret(),o=e._determineMode(r,n),a=null,u=null,c=null,o!==_){t.next=10;break}l=n.getStoredCrossSigningForUser(r.otherUserId),a=l.getId("master"),t.next=17;break;case 10:if(o!==b){t.next=16;break}return t.next=13,e._getOtherDeviceKey(r,n);case 13:u=t.sent,t.next=17;break;case 16:o===S&&(d=n.getUserId(),h=n.getStoredCrossSigningForUser(d),c=h.getId("master"));case 17:return f=e._generateQrData(r,n,o,i,a,u,c),p=e._generateBuffer(f),t.abrupt("return",new e(o,i,a,u,c,p));case 20:case"end":return t.stop()}}),t)}))),function(e,t){return i.apply(this,arguments)})},{key:"_generateSharedSecret",value:function(){var e=new Uint8Array(11);return t.crypto.getRandomValues(e),(0,g.encodeUnpaddedBase64)(e)}},{key:"_getOtherDeviceKey",value:(r=(0,a.default)(s.default.mark((function e(t,r){var n,i,o,a,u;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.getUserId(),i=t.targetDevice,o=i?i.deviceId:null,a=r.getStoredDevice(n,o)){e.next=6;break}throw new Error("could not find device "+o);case 6:return u=a.getFingerprint(),e.abrupt("return",u);case 8:case"end":return e.stop()}}),e)}))),function(e,t){return r.apply(this,arguments)})},{key:"_determineMode",value:function(e,t){var r=t.getUserId(),n=e.otherUserId,i=_;r===n&&(i=t.checkUserTrust(r).isCrossSigningVerified()?b:S);return i}},{key:"_generateQrData",value:function(e,t,r,n,i,o,s){var a=t.getUserId(),u={prefix:"MATRIX",version:2,mode:r,transactionId:e.channel.transactionId,firstKeyB64:"",secondKeyB64:"",secretB64:n},c=t.getStoredCrossSigningForUser(a);return r===_?(u.firstKeyB64=c.getId("master"),u.secondKeyB64=i):r===b?(u.firstKeyB64=c.getId("master"),u.secondKeyB64=o):r===S&&(u.firstKeyB64=t.getDeviceEd25519Key(),u.secondKeyB64=s),u}},{key:"_generateBuffer",value:function(e){var t=n.alloc(0),r=function(e){var r=n.from([e]);t=n.concat([t,r])},i=function(e){var r=n.alloc(2);r.writeInt16BE(e,0),t=n.concat([t,r])},o=function(e,r){var o=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],s=n.from(e,r);o&&i(s.byteLength),t=n.concat([t,s])},s=function(e){var r=(0,g.decodeBase64)(e),i=n.from(r);t=n.concat([t,i])};return o(e.prefix,"ascii",!1),r(e.version),r(e.mode),o(e.transactionId,"utf-8"),s(e.firstKeyB64),s(e.secondKeyB64),s(e.secretB64),t}}]),e}();r.QRCodeData=k}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"../../logger":102,"../olmlib":81,"./Base":87,"./Error":88,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/construct":7,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/regenerator":27,buffer:34}],91:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SAS=void 0;var i=n(e("@babel/runtime/helpers/slicedToArray")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/inherits")),l=n(e("@babel/runtime/helpers/possibleConstructorReturn")),d=n(e("@babel/runtime/helpers/getPrototypeOf")),h=e("./Base"),f=n(e("another-json")),p=e("./Error"),g=e("../../logger");function v(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,d.default)(e);if(t){var i=(0,d.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,l.default)(this,r)}}function y(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return m(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return m(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function m(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var _,b="m.key.verification.start",S=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"],k=(0,p.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),E=(0,p.errorFactory)("m.mismatched_commitment","Mismatched commitment");var w=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","lock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];var I={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((function(e){return w[e]}))}};function T(e,t){var r,n={},i=y(t);try{for(i.s();!(r=i.n()).done;){var o=r.value;o in I&&(n[o]=I[o](e))}}catch(e){i.e(e)}finally{i.f()}return n}var R={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"};function x(e,t){return function(){for(var r=e[R[t]],n=arguments.length,i=new Array(n),o=0;o<n;o++)i[o]=arguments[o];var s=r.apply(e,i);return g.logger.log("SAS calculateMAC:",t,i,s),s}}var C={"curve25519-hkdf-sha256":function(e,t,r){var n="".concat(e._baseApis.getUserId(),"|").concat(e._baseApis.deviceId,"|")+"".concat(e.ourSASPubKey,"|"),i="".concat(e.userId,"|").concat(e.deviceId,"|").concat(e.theirSASPubKey,"|"),o="MATRIX_KEY_VERIFICATION_SAS|"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,r)},curve25519:function(e,t,r){var n="".concat(e._baseApis.getUserId()).concat(e._baseApis.deviceId),i="".concat(e.userId).concat(e.deviceId),o="MATRIX_KEY_VERIFICATION_SAS"+(e.initiatedByMe?n+i:i+n)+e._channel.transactionId;return t.generate_bytes(o,r)}},O=["curve25519-hkdf-sha256","curve25519"],A=["sha256"],D=["hkdf-hmac-sha256","hmac-sha256"],P=Object.keys(I),M=new Set(O),U=new Set(A),N=new Set(D),K=new Set(P);function B(e,t){return e instanceof Array?e.filter((function(e){return t.has(e)})):[]}var L=function(e){(0,c.default)(m,e);var r,n,l,d,g,y=v(m);function m(){return(0,a.default)(this,m),y.apply(this,arguments)}return(0,u.default)(m,[{key:"_doVerification",value:(g=(0,s.default)(o.default.mark((function e(){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.Olm.init();case 2:return _=_||new t.Olm.Utility,e.next=5,this._baseApis.downloadKeys([this.userId]);case 5:r=!1;case 6:if(e.prev=6,!this.initiatedByMe){e.next=13;break}return e.next=10,this._doSendVerification();case 10:return e.abrupt("return",e.sent);case 13:return e.next=15,this._doRespondVerification();case 15:return e.abrupt("return",e.sent);case 16:e.next=26;break;case 18:if(e.prev=18,e.t0=e.catch(6),!(e.t0 instanceof h.SwitchStartEventError)){e.next=25;break}this.startEvent=e.t0.startEvent,r=!0,e.next=26;break;case 25:throw e.t0;case 26:if(r){e.next=6;break}case 27:case"end":return e.stop()}}),e,this,[[6,18]])}))),function(){return g.apply(this,arguments)})},{key:"canSwitchStartEvent",value:function(e){if(e.getType()!==b)return!1;var t=e.getContent();return t&&t.method===m.NAME&&this._waitingForAccept}},{key:"_sendStart",value:(d=(0,s.default)(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._channel.completeContent(b,{method:m.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:O,hashes:A,message_authentication_codes:D,short_authentication_string:P}),e.next=3,this._channel.sendCompleted(b,t);case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)}))),function(){return d.apply(this,arguments)})},{key:"_doSendVerification",value:(l=(0,s.default)(o.default.mark((function e(){var r,n,a,u,c,l,d,g,v,y,m,b,S,w=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._waitingForAccept=!0,!this.startEvent){e.next=5;break}r=this._channel.completedContentFromEvent(this.startEvent),e.next=8;break;case 5:return e.next=7,this._sendStart();case 7:r=e.sent;case 8:if(this.initiatedByMe){e.next=10;break}throw new h.SwitchStartEventError(this.startEvent);case 10:return e.prev=10,e.next=13,this._waitForEvent("m.key.verification.accept");case 13:n=e.sent;case 14:return e.prev=14,this._waitingForAccept=!1,e.finish(14);case 17:if(a=n.getContent(),u=B(a.short_authentication_string,K),M.has(a.key_agreement_protocol)&&U.has(a.hash)&&N.has(a.message_authentication_code)&&u.length){e.next=21;break}throw(0,p.newUnknownMethodError)();case 21:if("string"==typeof a.commitment){e.next=23;break}throw(0,p.newInvalidMessageError)();case 23:return c=a.key_agreement_protocol,l=a.message_authentication_code,d=a.commitment,g=new t.Olm.SAS,e.prev=27,this.ourSASPubKey=g.get_pubkey(),e.next=31,this._send("m.key.verification.key",{key:this.ourSASPubKey});case 31:return e.next=33,this._waitForEvent("m.key.verification.key");case 33:if(n=e.sent,a=n.getContent(),v=a.key+f.default.stringify(r),_.sha256(v)===d){e.next=38;break}throw E();case 38:return this.theirSASPubKey=a.key,g.set_their_key(a.key),y=C[c](this,g,6),m=new Promise((function(e,t){var r;w.sasEvent={sas:T(y,u),confirm:(r=(0,s.default)(o.default.mark((function r(){return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,w._sendMAC(g,l);case 3:e(),r.next=9;break;case 6:r.prev=6,r.t0=r.catch(0),t(r.t0);case 9:case"end":return r.stop()}}),r,null,[[0,6]])}))),function(){return r.apply(this,arguments)}),cancel:function(){return t((0,p.newUserCancelledError)())},mismatch:function(){return t(k())}},w.emit("show_sas",w.sasEvent)})),e.next=44,Promise.all([this._waitForEvent("m.key.verification.mac").then((function(e){return w._expectedEvent="m.key.verification.done",e})),m]);case 44:return b=e.sent,S=(0,i.default)(b,1),n=S[0],a=n.getContent(),e.next=50,this._checkMAC(g,a,l);case 50:return e.prev=50,g.free(),e.finish(50);case 53:case"end":return e.stop()}}),e,this,[[10,,14,17],[27,,50,53]])}))),function(){return l.apply(this,arguments)})},{key:"_doRespondVerification",value:(n=(0,s.default)(o.default.mark((function e(){var r,n,a,u,c,l,d,h,g,v,y,m,b=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._channel.completedContentFromEvent(this.startEvent),n=B(O,new Set(r.key_agreement_protocols))[0],a=B(A,new Set(r.hashes))[0],u=B(D,new Set(r.message_authentication_codes))[0],c=B(r.short_authentication_string,K),void 0!==n&&void 0!==a&&void 0!==u&&c.length){e.next=7;break}throw(0,p.newUnknownMethodError)();case 7:return l=new t.Olm.SAS,e.prev=8,d=l.get_pubkey()+f.default.stringify(r),e.next=12,this._send("m.key.verification.accept",{key_agreement_protocol:n,hash:a,message_authentication_code:u,short_authentication_string:c,commitment:_.sha256(d)});case 12:return e.next=14,this._waitForEvent("m.key.verification.key");case 14:return h=e.sent,r=h.getContent(),this.theirSASPubKey=r.key,l.set_their_key(r.key),this.ourSASPubKey=l.get_pubkey(),e.next=21,this._send("m.key.verification.key",{key:this.ourSASPubKey});case 21:return g=C[n](this,l,6),v=new Promise((function(e,t){var r;b.sasEvent={sas:T(g,c),confirm:(r=(0,s.default)(o.default.mark((function r(){return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,b._sendMAC(l,u);case 3:e(),r.next=9;break;case 6:r.prev=6,r.t0=r.catch(0),t(r.t0);case 9:case"end":return r.stop()}}),r,null,[[0,6]])}))),function(){return r.apply(this,arguments)}),cancel:function(){return t((0,p.newUserCancelledError)())},mismatch:function(){return t(k())}},b.emit("show_sas",b.sasEvent)})),e.next=25,Promise.all([this._waitForEvent("m.key.verification.mac").then((function(e){return b._expectedEvent="m.key.verification.done",e})),v]);case 25:return y=e.sent,m=(0,i.default)(y,1),h=m[0],r=h.getContent(),e.next=31,this._checkMAC(l,r,u);case 31:return e.prev=31,l.free(),e.finish(31);case 34:case"end":return e.stop()}}),e,this,[[8,,31,34]])}))),function(){return n.apply(this,arguments)})},{key:"_sendMAC",value:function(e,t){var r={},n=[],i="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this._channel.transactionId,o="ed25519:".concat(this._baseApis.deviceId);r[o]=x(e,t)(this._baseApis.getDeviceEd25519Key(),i+o),n.push(o);var s=this._baseApis.getCrossSigningId();if(s){var a="ed25519:".concat(s);r[a]=x(e,t)(s,i+a),n.push(a)}var u=x(e,t)(n.sort().join(","),i+"KEY_IDS");return this._send("m.key.verification.mac",{mac:r,keys:u})}},{key:"_checkMAC",value:(r=(0,s.default)(o.default.mark((function e(t,r,n){var i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this._channel.transactionId,r.keys===x(t,n)(Object.keys(r.mac).sort().join(","),i+"KEY_IDS")){e.next=3;break}throw(0,p.newKeyMismatchError)();case 3:return e.next=5,this._verifyKeys(this.userId,r.mac,(function(e,r,o){if(o!==x(t,n)(r.keys[e],i+e))throw(0,p.newKeyMismatchError)()}));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"events",get:function(){return S}}],[{key:"NAME",get:function(){return"m.sas.v1"}}]),m}(h.VerificationBase);r.SAS=L}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../logger":102,"./Base":87,"./Error":88,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,"another-json":28}],92:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.InRoomRequests=r.InRoomChannel=void 0;var i=n(e("@babel/runtime/regenerator")),o=n(e("@babel/runtime/helpers/asyncToGenerator")),s=n(e("@babel/runtime/helpers/classCallCheck")),a=n(e("@babel/runtime/helpers/createClass")),u=e("./VerificationRequest"),c=e("../../../logger");function l(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var h="m.room.message",f="m.reference",p="m.relates_to",g=function(){function e(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;(0,s.default)(this,e),this._client=t,this._roomId=r,this.userId=n,this._requestEventId=null}var t,r;return(0,a.default)(e,[{key:"getTimestamp",value:function(e){return e.getTs()}},{key:"handleEvent",value:(r=(0,o.default)(i.default.mark((function t(r,n,o){var s,a,u,l,d,h;return i.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!n.hasEventId(r.getId())){t.next=2;break}return t.abrupt("return");case 2:if(s=e.getEventType(r),r.getRoomId()===this._roomId){t.next=5;break}return t.abrupt("return");case 5:if(null===this.userId&&(a=e.getOtherPartyUserId(r,this._client))&&(this.userId=a),u=this._client.getUserId(),l=r.getSender(),null===this.userId){t.next=12;break}if(l===u||l===this.userId){t.next=12;break}return c.logger.log("InRoomChannel: ignoring verification event from "+"non-participating sender ".concat(l)),t.abrupt("return");case 12:return null===this._requestEventId&&(this._requestEventId=e.getTransactionId(r)),d=!!r.getUnsigned().transaction_id,h=r.getSender()===this._client.getUserId(),t.next=17,n.handleEvent(s,r,o,d,h);case 17:return t.abrupt("return",t.sent);case 18:case"end":return t.stop()}}),t,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"completedContentFromEvent",value:function(e){var t=Object.assign({},e.getContent());return t[p]=e.getRelation(),t}},{key:"completeContent",value:function(e,t){return t=Object.assign({},t),e!==u.REQUEST_TYPE&&e!==u.READY_TYPE&&e!==u.START_TYPE||(t.from_device=this._client.getDeviceId()),e===u.REQUEST_TYPE?t={body:this._client.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:u.REQUEST_TYPE,to:this.userId,from_device:t.from_device,methods:t.methods}:t[p]={rel_type:f,event_id:this.transactionId},t}},{key:"send",value:function(e,t){var r=this.completeContent(e,t);return this.sendCompleted(e,r)}},{key:"sendCompleted",value:(t=(0,o.default)(i.default.mark((function e(t,r){var n,o;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t,t===u.REQUEST_TYPE&&(n=h),e.next=4,this._client.sendEvent(this._roomId,n,r);case 4:o=e.sent,t===u.REQUEST_TYPE&&(this._requestEventId=o.event_id);case 6:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"receiveStartFromOtherDevices",get:function(){return!0}},{key:"roomId",get:function(){return this._roomId}},{key:"transactionId",get:function(){return this._requestEventId}}],[{key:"getOtherPartyUserId",value:function(t,r){if(e.getEventType(t)===u.REQUEST_TYPE){var n=r.getUserId(),i=t.getSender(),o=t.getContent().to;return i===n?o:o===n?i:void 0}}},{key:"canCreateRequest",value:function(e){return e===u.REQUEST_TYPE}},{key:"getTransactionId",value:function(t){if(e.getEventType(t)===u.REQUEST_TYPE)return t.getId();var r=t.getRelation();return r&&r.rel_type===f?r.event_id:void 0}},{key:"validateEvent",value:function(t,r){var n=e.getTransactionId(t);if("string"!=typeof n||0===n.length)return!1;var i=e.getEventType(t),o=t.getContent();if(i===u.REQUEST_TYPE){if(!o||"string"!=typeof o.to||!o.to.length)return c.logger.log("InRoomChannel: validateEvent: no valid to "+(o&&o.to)),!1;if(!e.getOtherPartyUserId(t,r))return c.logger.log("InRoomChannel: validateEvent: "+"not directed to or sent by me: ".concat(t.getSender())+", ".concat(o&&o.to)),!1}return u.VerificationRequest.validateEvent(i,t,r)}},{key:"getEventType",value:function(e){var t=e.getType();if(t===h){var r=e.getContent();if(r)if(r.msgtype===u.REQUEST_TYPE)return u.REQUEST_TYPE}return t&&t!==u.REQUEST_TYPE?t:""}}]),e}();r.InRoomChannel=g;var v=function(){function e(){(0,s.default)(this,e),this._requestsByRoomId=new Map}return(0,a.default)(e,[{key:"getRequest",value:function(e){var t=e.getRoomId(),r=g.getTransactionId(e);return this._getRequestByTxnId(t,r)}},{key:"getRequestByChannel",value:function(e){return this._getRequestByTxnId(e.roomId,e.transactionId)}},{key:"_getRequestByTxnId",value:function(e,t){var r=this._requestsByRoomId.get(e);if(r)return r.get(t)}},{key:"setRequest",value:function(e,t){this._setRequest(e.getRoomId(),g.getTransactionId(e),t)}},{key:"setRequestByChannel",value:function(e,t){this._setRequest(e.roomId,e.transactionId,t)}},{key:"_setRequest",value:function(e,t,r){var n=this._requestsByRoomId.get(e);n||(n=new Map,this._requestsByRoomId.set(e,n)),n.set(t,r)}},{key:"removeRequest",value:function(e){var t=e.getRoomId(),r=this._requestsByRoomId.get(t);r&&(r.delete(g.getTransactionId(e)),0===r.size&&this._requestsByRoomId.delete(t))}},{key:"findRequestInProgress",value:function(e){var t=this._requestsByRoomId.get(e);if(t){var r,n=l(t.values());try{for(n.s();!(r=n.n()).done;){var i=r.value;if(i.pending)return i}}catch(e){n.e(e)}finally{n.f()}}}}]),e}();r.InRoomRequests=v},{"../../../logger":102,"./VerificationRequest":94,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/regenerator":27}],93:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.ToDeviceRequests=r.ToDeviceChannel=void 0;var i=n(e("@babel/runtime/helpers/defineProperty")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=n(e("@babel/runtime/helpers/typeof")),u=n(e("@babel/runtime/helpers/classCallCheck")),c=n(e("@babel/runtime/helpers/createClass")),l=e("../../../randomstring"),d=e("../../../logger"),h=e("./VerificationRequest"),f=e("../Error"),p=e("../../../models/event");function g(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return v(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return v(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function v(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var y=function(){function e(t,r,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null;(0,u.default)(this,e),this._client=t,this.userId=r,this._devices=n,this.transactionId=i,this._deviceId=o}var t,r;return(0,c.default)(e,[{key:"isToDevices",value:function(e){var t=this;if(e.length===this._devices.length){var r,n=g(e);try{var i=function(){var e=r.value;if(!t._devices.find((function(t){return t.deviceId===e.deviceId})))return{v:!1}};for(n.s();!(r=n.n()).done;){var o=i();if("object"===(0,a.default)(o))return o.v}}catch(e){n.e(e)}finally{n.f()}return!0}return!1}},{key:"getTimestamp",value:function(e){var t=e.getContent();return t&&t.timestamp}},{key:"handleEvent",value:(r=(0,s.default)(o.default.mark((function e(t,r,n){var i,s,a,u,c,l,d,p,g=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.getType(),s=t.getContent(),i!==h.REQUEST_TYPE&&i!==h.READY_TYPE&&i!==h.START_TYPE){e.next=9;break}if(this.transactionId||(this.transactionId=s.transaction_id),a=s.from_device,!this._deviceId&&this._devices.includes(a)&&(this._deviceId=a),this._deviceId&&this._deviceId===a){e.next=9;break}return u=this.completeContent((0,f.errorFromEvent)((0,f.newUnexpectedMessageError)())),e.abrupt("return",this._sendToDevices(h.CANCEL_TYPE,u,[a]));case 9:return c=r.phase===h.PHASE_STARTED||r.phase===h.PHASE_READY,e.next=12,r.handleEvent(t.getType(),t,n,!1,!1);case 12:if(l=r.phase===h.PHASE_STARTED||r.phase===h.PHASE_READY,i!==h.START_TYPE&&i!==h.READY_TYPE||c||!l||!this._deviceId){e.next=20;break}if(!(d=this._devices.filter((function(e){return e!==g._deviceId&&e!==g._client.getDeviceId()}))).length){e.next=20;break}return p=this.completeContent({code:"m.accepted",reason:"Verification request accepted by another device"}),e.next=20,this._sendToDevices(h.CANCEL_TYPE,p,d);case 20:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"completedContentFromEvent",value:function(e){return e.getContent()}},{key:"completeContent",value:function(e,t){return t=Object.assign({},t),this.transactionId&&(t.transaction_id=this.transactionId),e!==h.REQUEST_TYPE&&e!==h.READY_TYPE&&e!==h.START_TYPE||(t.from_device=this._client.getDeviceId()),e===h.REQUEST_TYPE&&(t.timestamp=Date.now()),t}},{key:"send",value:function(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};t!==h.REQUEST_TYPE&&t!==h.START_TYPE||this.transactionId||(this.transactionId=e.makeTransactionId());var n=this.completeContent(t,r);return this.sendCompleted(t,n)}},{key:"sendCompleted",value:(t=(0,s.default)(o.default.mark((function e(t,r){var n,i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==h.REQUEST_TYPE){e.next=6;break}return e.next=3,this._sendToDevices(t,r,this._devices);case 3:n=e.sent,e.next=9;break;case 6:return e.next=8,this._sendToDevices(t,r,[this._deviceId]);case 8:n=e.sent;case 9:return i=new p.MatrixEvent({sender:this._client.getUserId(),content:r,type:t}),e.next=12,this._request.handleEvent(t,i,!0,!0,!0);case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"_sendToDevices",value:function(e,t,r){if(r.length){var n,o={},s=g(r);try{for(s.s();!(n=s.n()).done;){o[n.value]=t}}catch(e){s.e(e)}finally{s.f()}return this._client.sendToDevice(e,(0,i.default)({},this.userId,o))}return Promise.resolve()}},{key:"deviceId",get:function(){return this._deviceId}}],[{key:"getEventType",value:function(e){return e.getType()}},{key:"getTransactionId",value:function(e){var t=e.getContent();return t&&t.transaction_id}},{key:"canCreateRequest",value:function(e){return e===h.REQUEST_TYPE||e===h.START_TYPE}},{key:"validateEvent",value:function(e,t){if(e.isCancelled())return d.logger.warn("Ignoring flagged verification request from "+e.getSender()),!1;var r=e.getContent();if(!r)return d.logger.warn("ToDeviceChannel.validateEvent: invalid: no content"),!1;if(!r.transaction_id)return d.logger.warn("ToDeviceChannel.validateEvent: invalid: no transaction_id"),!1;var n=e.getType();if(n===h.REQUEST_TYPE){if(!Number.isFinite(r.timestamp))return d.logger.warn("ToDeviceChannel.validateEvent: invalid: no timestamp"),!1;if(e.getSender()===t.getUserId()&&r.from_device==t.getDeviceId())return d.logger.warn("ToDeviceChannel.validateEvent: invalid: from own device"),!1}return h.VerificationRequest.validateEvent(n,e,t)}},{key:"makeTransactionId",value:function(){return(0,l.randomString)(32)}}]),e}();r.ToDeviceChannel=y;var m=function(){function e(){(0,u.default)(this,e),this._requestsByUserId=new Map}return(0,c.default)(e,[{key:"getRequest",value:function(e){return this.getRequestBySenderAndTxnId(e.getSender(),y.getTransactionId(e))}},{key:"getRequestByChannel",value:function(e){return this.getRequestBySenderAndTxnId(e.userId,e.transactionId)}},{key:"getRequestBySenderAndTxnId",value:function(e,t){var r=this._requestsByUserId.get(e);if(r)return r.get(t)}},{key:"setRequest",value:function(e,t){this.setRequestBySenderAndTxnId(e.getSender(),y.getTransactionId(e),t)}},{key:"setRequestByChannel",value:function(e,t){this.setRequestBySenderAndTxnId(e.userId,e.transactionId,t)}},{key:"setRequestBySenderAndTxnId",value:function(e,t,r){var n=this._requestsByUserId.get(e);n||(n=new Map,this._requestsByUserId.set(e,n)),n.set(t,r)}},{key:"removeRequest",value:function(e){var t=e.getSender(),r=this._requestsByUserId.get(t);r&&(r.delete(y.getTransactionId(e)),0===r.size&&this._requestsByUserId.delete(t))}},{key:"findRequestInProgress",value:function(e,t){var r=this._requestsByUserId.get(e);if(r){var n,i=g(r.values());try{for(i.s();!(n=i.n()).done;){var o=n.value;if(o.pending&&o.channel.isToDevices(t))return o}}catch(e){i.e(e)}finally{i.f()}}}},{key:"getRequestsInProgress",value:function(e){var t=this._requestsByUserId.get(e);return t?Array.from(t.values()).filter((function(e){return e.pending})):[]}}]),e}();r.ToDeviceRequests=m},{"../../../logger":102,"../../../models/event":109,"../../../randomstring":119,"../Error":88,"./VerificationRequest":94,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/typeof":24,"@babel/runtime/regenerator":27}],94:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.VerificationRequest=r.PHASE_DONE=r.PHASE_CANCELLED=r.PHASE_STARTED=r.PHASE_READY=r.PHASE_REQUESTED=r.PHASE_UNSENT=r.READY_TYPE=r.DONE_TYPE=r.CANCEL_TYPE=r.START_TYPE=r.REQUEST_TYPE=r.EVENT_PREFIX=void 0;var i=n(e("@babel/runtime/helpers/slicedToArray")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/toConsumableArray")),a=n(e("@babel/runtime/helpers/asyncToGenerator")),u=n(e("@babel/runtime/helpers/classCallCheck")),c=n(e("@babel/runtime/helpers/createClass")),l=n(e("@babel/runtime/helpers/assertThisInitialized")),d=n(e("@babel/runtime/helpers/inherits")),h=n(e("@babel/runtime/helpers/possibleConstructorReturn")),f=n(e("@babel/runtime/helpers/getPrototypeOf")),p=n(e("@babel/runtime/helpers/defineProperty")),g=e("../../../logger"),v=e("events"),y=e("../Error"),m=e("../QRCode");function _(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return b(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return b(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function S(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,f.default)(e);if(t){var i=(0,f.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,h.default)(this,r)}}var k="m.key.verification.";r.EVENT_PREFIX=k;var E=k+"request";r.REQUEST_TYPE=E;var w=k+"start";r.START_TYPE=w;var I=k+"cancel";r.CANCEL_TYPE=I;var T=k+"done";r.DONE_TYPE=T;var R=k+"ready";r.READY_TYPE=R;r.PHASE_UNSENT=1;r.PHASE_REQUESTED=2;r.PHASE_READY=3;r.PHASE_STARTED=4;r.PHASE_CANCELLED=5;r.PHASE_DONE=6;var x=function(e){(0,d.default)(b,e);var t,r,n,h,f,v=S(b);function b(e,t,r){var n;return(0,u.default)(this,b),n=v.call(this),(0,p.default)((0,l.default)(n),"_cancelOnTimeout",(function(){try{n.initiatedByMe?n.cancel({reason:"Other party didn't accept in time",code:"m.timeout"}):n.cancel({reason:"User didn't accept in time",code:"m.timeout"})}catch(e){g.logger.error("Error while cancelling verification request",e)}})),n.channel=e,n.channel._request=(0,l.default)(n),n._verificationMethods=t,n._client=r,n._commonMethods=[],n._setPhase(1,!1),n._eventsByUs=new Map,n._eventsByThem=new Map,n._observeOnly=!1,n._timeoutTimer=null,n._accepting=!1,n._declining=!1,n._verifierHasFinished=!1,n._cancelled=!1,n._chosenMethod=null,n._qrCodeData=null,n._requestReceivedAt=null,n}return(0,c.default)(b,[{key:"calculateEventTimeout",value:function(e){var t=this.channel.getTimestamp(e)+6e5;if(this._requestReceivedAt&&!this.initiatedByMe&&this.phase<=2){var r=this._requestReceivedAt+12e4;t=Math.min(t,r)}return Math.max(0,t-Date.now())}},{key:"otherPartySupportsMethod",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!t&&!this.ready&&!this.started)return!1;var r=this._eventsByThem.get(E)||this._eventsByThem.get(R);if(!r){if(this.started&&this.initiatedByMe){var n=this._eventsByUs.get(w),i=n&&n.getContent(),o=i&&i.method;return e==o}return!1}var s=r.getContent();if(!s)return!1;var a=s.methods;return!!Array.isArray(a)&&a.includes(e)}},{key:"beginKeyVerification",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.observeOnly&&!this._verifier){var r=2===this.phase||3===this.phase||1===this.phase&&this.channel.constructor.canCreateRequest(w);if(r){if(this._commonMethods.length&&!this._commonMethods.includes(e))throw(0,y.newUnknownMethodError)();if(this._verifier=this._createVerifier(e,null,t),!this._verifier)throw(0,y.newUnknownMethodError)();this._chosenMethod=e}}return this._verifier}},{key:"sendRequest",value:(f=(0,a.default)(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.observeOnly||1!==this._phase){e.next=4;break}return t=(0,s.default)(this._verificationMethods.keys()),e.next=4,this.channel.send(E,{methods:t});case 4:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)})},{key:"cancel",value:(h=(0,a.default)(o.default.mark((function e(){var t,r,n,i,s,a=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=a.length>0&&void 0!==a[0]?a[0]:{},r=t.reason,n=void 0===r?"User declined":r,i=t.code,s=void 0===i?"m.user":i,this.observeOnly||5===this._phase){e.next=11;break}if(this._declining=!0,this.emit("change"),!this._verifier){e.next=8;break}return e.abrupt("return",this._verifier.cancel((0,y.errorFactory)(s,n)()));case 8:return this._cancellingUserId=this._client.getUserId(),e.next=11,this.channel.send(I,{code:s,reason:n});case 11:case"end":return e.stop()}}),e,this)}))),function(){return h.apply(this,arguments)})},{key:"accept",value:(n=(0,a.default)(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.observeOnly||2!==this.phase||this.initiatedByMe){e.next=6;break}return t=(0,s.default)(this._verificationMethods.keys()),this._accepting=!0,this.emit("change"),e.next=6,this.channel.send(R,{methods:t});case 6:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"waitFor",value:function(e){var t=this;return new Promise((function(r,n){var i=function i(){var o=!1;return e(t)?(r(t),o=!0):t.cancelled&&(n(new Error("cancelled")),o=!0),o&&t.off("change",i),o};i()||t.on("change",i)}))}},{key:"_setPhase",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._phase=e,t&&this.emit("change")}},{key:"_getEventByEither",value:function(e){return this._eventsByThem.get(e)||this._eventsByUs.get(e)}},{key:"_getEventBy",value:function(e,t){return t?this._eventsByThem.get(e):this._eventsByUs.get(e)}},{key:"_calculatePhaseTransitions",value:function(){var e=[{phase:1}],t=function(){return e[e.length-1].phase},r=this._eventsByThem.has(E),n=this._getEventBy(E,r);n&&e.push({phase:2,event:n});var i,o=n&&this._getEventBy(R,!r);if(o&&2===t()&&e.push({phase:3,event:o}),o||!n){var s=this._eventsByThem.get(w),a=this._eventsByUs.get(w);i=s&&a?s.getSender()<a.getSender()?s:a:s||a}else i=this._getEventBy(w,!r);if(i){var u=2===t()&&n.getSender()!==i.getSender(),c=1===t()&&this.channel.constructor.canCreateRequest(w);(u||3===t()||c)&&e.push({phase:4,event:i})}var l=this._eventsByUs.get(T);(this._verifierHasFinished||l&&4===t())&&e.push({phase:6});var d=this._getEventByEither(I);return(this._cancelled||d)&&6!==t()?(e.push({phase:5,event:d}),e):e}},{key:"_transitionToPhase",value:function(e){var t=this,r=e.phase,n=e.event;if((2===r||3===r)&&!this._wasSentByOwnDevice(n)){var i=n.getContent();this._commonMethods=i.methods.filter((function(e){return t._verificationMethods.has(e)}))}if(this.observeOnly||2!==r&&4!==r&&3!==r||this.channel.receiveStartFromOtherDevices&&this._wasSentByOwnUser(n)&&!this._wasSentByOwnDevice(n)&&(this._observeOnly=!0),4===r){var o=n.getContent().method;this._verifier||this.observeOnly||(this._verifier=this._createVerifier(o,n),this._verifier?this._chosenMethod=o:this.cancel({code:"m.unknown_method",reason:"Unknown method: ".concat(o)}))}}},{key:"_applyPhaseTransitions",value:function(){var e,t=this,r=this._calculatePhaseTransitions(),n=r.findIndex((function(e){return e.phase===t.phase})),i=r.slice(n+1),o=_(i);try{for(o.s();!(e=o.n()).done;){var s=e.value;this._transitionToPhase(s)}}catch(e){o.e(e)}finally{o.f()}return i}},{key:"_isWinningStartRace",value:function(e){if(e.getType()!==w)return!1;var t,r,n=this._verifier.startEvent;if(this.isSelfVerification)if(n){var i=n.getContent();t=i&&i.from_device}else t=this._client.getDeviceId();else t=n?n.getSender():this._client.getUserId();if(this.isSelfVerification){var o=e.getContent();r=o&&o.from_device}else r=e.getSender();return r<t}},{key:"hasEventId",value:function(e){var t,r=_(this._eventsByUs.values());try{for(r.s();!(t=r.n()).done;){if(t.value.getId()===e)return!0}}catch(e){r.e(e)}finally{r.f()}var n,i=_(this._eventsByThem.values());try{for(i.s();!(n=i.n()).done;){if(n.value.getId()===e)return!0}}catch(e){i.e(e)}finally{i.f()}return!1}},{key:"handleEvent",value:(r=(0,a.default)(o.default.mark((function e(t,r,n,i,s){var a,u,c,l,d,h;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this.done&&!this.cancelled){e.next=2;break}return e.abrupt("return");case 2:if(a=this._observeOnly,this._adjustObserveOnly(r,n),this.observeOnly||i){e.next=9;break}return e.next=7,this._cancelOnError(t,r);case 7:if(!e.sent){e.next=9;break}return e.abrupt("return");case 9:if(!(s?this._eventsByUs.has(t):this._eventsByThem.has(t))){e.next=12;break}return e.abrupt("return");case 12:if(u=this.phase,this._addEvent(t,r,s),c=this._applyPhaseTransitions(),e.prev=15,this._verifier&&!this.observeOnly&&(l=this._isWinningStartRace(r),this._verifier.canSwitchStartEvent(r)&&l?this._verifier.switchStartEvent(r):i||(t===I||this._verifier.events&&this._verifier.events.includes(t))&&this._verifier.handleEvent(r)),!c.length){e.next=30;break}if(!n||!c.some((function(e){return 3===e.phase}))){e.next=24;break}if(!this.otherPartySupportsMethod(m.SCAN_QR_CODE_METHOD,!0)){e.next=24;break}return e.next=23,m.QRCodeData.create(this,this._client);case 23:this._qrCodeData=e.sent;case 24:d=c[c.length-1],h=d.phase,this._setupTimeout(h),this._setPhase(h),e.next=31;break;case 30:this._observeOnly!==a&&this.emit("change");case 31:return e.prev=31,g.logger.log("Verification request ".concat(this.channel.transactionId,": ")+"".concat(t," event with id:").concat(r.getId(),", ")+"content:".concat(JSON.stringify(r.getContent())," ")+"deviceId:".concat(this.channel.deviceId,", ")+"sender:".concat(r.getSender(),", isSentByUs:").concat(s,", ")+"isLiveEvent:".concat(n,", isRemoteEcho:").concat(i,", ")+"phase:".concat(u,"=>").concat(this.phase,", ")+"observeOnly:".concat(a,"=>").concat(this._observeOnly)),e.finish(31);case 34:case"end":return e.stop()}}),e,this,[[15,,31,34]])}))),function(e,t,n,i,o){return r.apply(this,arguments)})},{key:"_setupTimeout",value:function(e){(!this._timeoutTimer&&!this.observeOnly&&2===e&&(this._timeoutTimer=setTimeout(this._cancelOnTimeout,this.timeout)),this._timeoutTimer)&&((4===e||3===e||6===e||5===e)&&(clearTimeout(this._timeoutTimer),this._timeoutTimer=null))}},{key:"_cancelOnError",value:(t=(0,a.default)(o.default.mark((function e(t,r){var n,i,s,a;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==w){e.next=6;break}if(n=r.getContent().method,this._verificationMethods.has(n)){e.next=6;break}return e.next=5,this.cancel((0,y.errorFromEvent)((0,y.newUnknownMethodError)()));case 5:return e.abrupt("return",!0);case 6:if(i=t===E&&1!==this.phase,s=t===R&&2!==this.phase,1===this.phase||!i&&!s){e.next=14;break}return g.logger.warn("Cancelling, unexpected ".concat(t," verification ")+"event from ".concat(r.getSender())),a="Unexpected ".concat(t," event in phase ").concat(this.phase),e.next=13,this.cancel((0,y.errorFromEvent)((0,y.newUnexpectedMessageError)({reason:a})));case 13:return e.abrupt("return",!0);case 14:return e.abrupt("return",!1);case 15:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})},{key:"_adjustObserveOnly",value:function(e,t){t||(this._observeOnly=!0),this.calculateEventTimeout(e)<3e3&&(this._observeOnly=!0)}},{key:"_addEvent",value:function(e,t,r){if(r?this._eventsByUs.set(e,t):this._eventsByThem.set(e,t),e===E){var n,o=_(this._eventsByThem.entries());try{for(o.s();!(n=o.n()).done;){var s=(0,i.default)(n.value,2),a=s[0];s[1].getSender()!==this.otherUserId&&this._eventsByThem.delete(a)}}catch(e){o.e(e)}finally{o.f()}this._requestReceivedAt=Date.now()}}},{key:"_createVerifier",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;r||(r=this.targetDevice);var n=r,i=n.userId,o=n.deviceId,s=this._verificationMethods.get(e);if(s)return new s(this.channel,this._client,i,o,t,this);g.logger.warn("could not find verifier constructor for method",e)}},{key:"_wasSentByOwnUser",value:function(e){return e.getSender()===this._client.getUserId()}},{key:"_wasSentByOwnDevice",value:function(e){if(!this._wasSentByOwnUser(e))return!1;var t=e.getContent();return!(!t||t.from_device!==this._client.getDeviceId())}},{key:"onVerifierCancelled",value:function(){this._cancelled=!0;var e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}},{key:"onVerifierFinished",value:function(){this.channel.send("m.key.verification.done",{}),this._verifierHasFinished=!0;var e=this._applyPhaseTransitions();e.length&&this._setPhase(e[e.length-1].phase)}},{key:"getEventFromOtherParty",value:function(e){return this._eventsByThem.get(e)}},{key:"invalid",get:function(){return 1===this.phase}},{key:"requested",get:function(){return 2===this.phase}},{key:"cancelled",get:function(){return 5===this.phase}},{key:"ready",get:function(){return 3===this.phase}},{key:"started",get:function(){return 4===this.phase}},{key:"done",get:function(){return 6===this.phase}},{key:"methods",get:function(){return this._commonMethods}},{key:"chosenMethod",get:function(){return this._chosenMethod}},{key:"timeout",get:function(){var e=this._getEventByEither(E);return e?this.calculateEventTimeout(e):0}},{key:"requestEvent",get:function(){return this._getEventByEither(E)}},{key:"phase",get:function(){return this._phase}},{key:"verifier",get:function(){return this._verifier}},{key:"canAccept",get:function(){return this.phase<3&&!this._accepting&&!this._declining}},{key:"accepting",get:function(){return this._accepting}},{key:"declining",get:function(){return this._declining}},{key:"pending",get:function(){return!this.observeOnly&&6!==this._phase&&5!==this._phase}},{key:"qrCodeData",get:function(){return this._qrCodeData}},{key:"initiatedByMe",get:function(){var e=this._eventsByUs.size+this._eventsByThem.size===0;if(1===this._phase&&e)return!0;var t=this._eventsByUs.has(E),r=this._eventsByThem.has(E);if(t&&!r)return!0;if(!t&&r)return!1;var n=this._eventsByUs.has(w),i=this._eventsByThem.has(w);return!(!n||i)}},{key:"requestingUserId",get:function(){return this.initiatedByMe?this._client.getUserId():this.otherUserId}},{key:"receivingUserId",get:function(){return this.initiatedByMe?this.otherUserId:this._client.getUserId()}},{key:"otherUserId",get:function(){return this.channel.userId}},{key:"isSelfVerification",get:function(){return this._client.getUserId()===this.otherUserId}},{key:"cancellingUserId",get:function(){var e=this._eventsByUs.get(I),t=this._eventsByThem.get(I);return e&&(!t||e.getId()<t.getId())?e.getSender():t?t.getSender():void 0}},{key:"cancellationCode",get:function(){var e=this._getEventByEither(I);return e?e.getContent().code:null}},{key:"observeOnly",get:function(){return this._observeOnly}},{key:"targetDevice",get:function(){var e=(this._eventsByThem.get(E)||this._eventsByThem.get(R)||this._eventsByThem.get(w)).getContent().from_device;return{userId:this.otherUserId,deviceId:e}}}],[{key:"validateEvent",value:function(e,t,r){var n=t.getContent();return!(!e||!e.startsWith(k))&&(n?e!==E&&e!==R||Array.isArray(n.methods)?e!==E&&e!==R&&e!==w||"string"==typeof n.from_device&&0!==n.from_device.length||(g.logger.log("VerificationRequest: validateEvent: fail because from_device"),!1):(g.logger.log("VerificationRequest: validateEvent: fail because methods"),!1):(g.logger.log("VerificationRequest: validateEvent: no content"),!1))}}]),b}(v.EventEmitter);r.VerificationRequest=x},{"../../../logger":102,"../Error":88,"../QRCode":90,"@babel/runtime/helpers/assertThisInitialized":4,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/helpers/toConsumableArray":23,"@babel/runtime/regenerator":27,events:36}],95:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.InvalidStoreError=l,r.InvalidCryptoStoreError=d,r.KeySignatureUploadError=void 0;var i=n(e("@babel/runtime/helpers/classCallCheck")),o=n(e("@babel/runtime/helpers/inherits")),s=n(e("@babel/runtime/helpers/possibleConstructorReturn")),a=n(e("@babel/runtime/helpers/getPrototypeOf")),u=n(e("@babel/runtime/helpers/wrapNativeSuper"));function c(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,a.default)(e);if(t){var i=(0,a.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,s.default)(this,r)}}function l(e,t){var r="Store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again",n=Reflect.construct(Error,[r]);return Reflect.setPrototypeOf(n,Reflect.getPrototypeOf(this)),n.reason=e,n.value=t,n}function d(e){var t="Crypto store is invalid because ".concat(e,", ")+"please stop the client, delete all data and start the client again",r=Reflect.construct(Error,[t]);return Reflect.setPrototypeOf(r,Reflect.getPrototypeOf(this)),r.reason=e,r.name="InvalidCryptoStoreError",r}l.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",l.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(l,Error),d.TOO_NEW="TOO_NEW",d.prototype=Object.create(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),Reflect.setPrototypeOf(d,Error);var h=function(e){(0,o.default)(r,e);var t=c(r);function r(e,n){var o;return(0,i.default)(this,r),(o=t.call(this,e)).value=n,o}return r}((0,u.default)(Error));r.KeySignatureUploadError=h},{"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/wrapNativeSuper":26}],96:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.eventMapperFor=void 0;const n=e("./models/event");r.eventMapperFor=function(e,t){const r=Boolean(t.preventReEmit),i=!1!==t.decrypt;return function(t){const o=new n.MatrixEvent(t);return o.isEncrypted()&&(r||e.reEmitter.reEmit(o,["Event.decrypted"]),i&&e.decryptEventIfNeeded(o)),r||e.reEmitter.reEmit(o,["Event.replaced"]),o}}},{"./models/event":109}],97:[function(e,t,r){"use strict";function n(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}Object.defineProperty(r,"__esModule",{value:!0}),r.FilterComponent=n,n.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},n.prototype._checkFields=function(e,t,r,n){for(var i={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){var r=t.slice(0,-1);return e.substr(0,r.length)===r}return e===t}(r,e)}},o=0;o<Object.keys(i).length;o++){var s=Object.keys(i)[o],a=i[s];if(this["not_"+s].filter(a).length>0)return!1;var u=this[s];if(u&&u.length>0)if(!u.some(a))return!1}var c=this.filter_json.contains_url;return void 0===c||c===n},n.prototype.filter=function(e){return e.filter(this.check,this)},n.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10}},{}],98:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Filter=o;var n=e("./filter-component");function i(e,t,r){for(var n=t.split("."),i=e,o=0;o<n.length-1;o++)i[n[o]]||(i[n[o]]={}),i=i[n[o]];i[n[n.length-1]]=r}function o(e,t){this.userId=e,this.filterId=t,this.definition={}}o.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},o.prototype.getFilterId=function(){return this.filterId},o.prototype.getDefinition=function(){return this.definition},o.prototype.setDefinition=function(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new n.FilterComponent(r),this._room_timeline_filter=new n.FilterComponent(t&&t.timeline||{})},o.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},o.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},o.prototype.setTimelineLimit=function(e){i(this.definition,"room.timeline.limit",e)},o.prototype.setLazyLoadMembers=function(e){i(this.definition,"room.state.lazy_load_members",!!e)},o.prototype.setIncludeLeaveRooms=function(e){i(this.definition,"room.include_leave",e)},o.fromJson=function(e,t,r){var n=new o(e,t);return n.setDefinition(r),n}},{"./filter-component":97}],99:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixHttpApi=k,r.retryNetworkOperation=function(e,t){return R.apply(this,arguments)},r.AbortError=r.ConnectionError=r.MatrixError=r.PREFIX_MEDIA_R0=r.PREFIX_IDENTITY_V2=r.PREFIX_IDENTITY_V1=r.PREFIX_UNSTABLE=r.PREFIX_R0=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=i(e("@babel/runtime/helpers/createClass")),u=i(e("@babel/runtime/helpers/classCallCheck")),c=i(e("@babel/runtime/helpers/inherits")),l=i(e("@babel/runtime/helpers/possibleConstructorReturn")),d=i(e("@babel/runtime/helpers/getPrototypeOf")),h=i(e("@babel/runtime/helpers/wrapNativeSuper")),f=i(e("@babel/runtime/helpers/defineProperty")),p=i(e("@babel/runtime/helpers/typeof")),g=e("content-type"),v=n(e("./utils")),y=e("./logger"),m=n(e("./realtime-callbacks"));function _(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,d.default)(e);if(t){var i=(0,d.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,l.default)(this,r)}}function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){(0,f.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}r.PREFIX_R0="/_matrix/client/r0";r.PREFIX_UNSTABLE="/_matrix/client/unstable";r.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1";r.PREFIX_IDENTITY_V2="/_matrix/identity/v2";function k(e,t){v.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]}r.PREFIX_MEDIA_R0="/_matrix/media/r0",k.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){var e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(e,r){v.isFunction(r)?r={callback:r}:void 0===r&&(r={});var n=!1!==r.includeFilename,i=r.type||e.type||"application/octet-stream",o=r.name||e.name,s=e;s.stream&&"function"!=typeof s.stream&&(y.logger.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),s=s.stream);var a=r.rawResponse;void 0===a&&(t.XMLHttpRequest?a=!1:(y.logger.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),a=!0));var u=r.onlyContentUri;a||void 0!==u||(t.XMLHttpRequest?(y.logger.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),u=!0):u=!1);var c,l={loaded:0,total:0},d=null;if(a||(d=function(e){var t=JSON.parse(e);if(u&&void 0===(t=t.content_uri))throw Error("Bad response");return t}),t.XMLHttpRequest){var h=v.defer(),f=new t.XMLHttpRequest;l.xhr=f;var p=E(h,r.callback,this.opts.onlyData),g=function(){f.abort(),p(new Error("Timeout"))};f.timeout_timer=m.setTimeout(g,3e4),f.onreadystatechange=function(){var e;switch(f.readyState){case t.XMLHttpRequest.DONE:m.clearTimeout(f.timeout_timer);try{if(0===f.status)throw new T;if(!f.responseText)throw new Error("No response body.");e=f.responseText,d&&(e=d(e))}catch(e){return e.http_status=f.status,void p(e)}p(void 0,f,e)}},f.upload.addEventListener("progress",(function(e){m.clearTimeout(f.timeout_timer),l.loaded=e.loaded,l.total=e.total,f.timeout_timer=m.setTimeout(g,3e4),r.progressHandler&&r.progressHandler({loaded:e.loaded,total:e.total})}));var _=this.opts.baseUrl+"/_matrix/media/r0/upload",b=[];n&&o&&b.push("filename="+encodeURIComponent(o)),this.useAuthorizationHeader||b.push("access_token="+encodeURIComponent(this.opts.accessToken)),b.length>0&&(_+="?"+b.join("&")),f.open("POST",_),this.useAuthorizationHeader&&f.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),f.setRequestHeader("Content-Type",i),f.send(s),(c=h.promise).abort=f.abort.bind(f)}else{var S={};n&&o&&(S.filename=o),c=this.authedRequest(r.callback,"POST","/upload",S,s,{prefix:"/_matrix/media/r0",headers:{"Content-Type":i},json:!1,bodyParser:d})}var k=this,w=c.finally((function(){for(var e=0;e<k.uploads.length;++e)if(k.uploads[e]===l)return void k.uploads.splice(e,1)}));return w.abort=c.abort,l.promise=w,this.uploads.push(l),w},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,r,n,i,o){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");var s=this.opts.idBaseUrl+i+r;if(void 0!==e&&!v.isFunction(e))throw Error("Expected callback to be a function but got "+(0,p.default)(e));var a={uri:s,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?a.qs=n:"object"===(0,p.default)(n)&&(a.json=n),o&&(a.headers.Authorization="Bearer ".concat(o));var u=v.defer();return this.opts.request(a,E(u,e,this.opts.onlyData)),u.promise},authedRequest:function(e,t,r,n,i,o){n||(n={}),this.useAuthorizationHeader?(isFinite(o)&&(o={localTimeoutMs:o}),o||(o={}),o.headers||(o.headers={}),o.headers.Authorization||(o.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);var s=this.request(e,t,r,n,i,o),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,r,n,i,o){var s=void 0!==(o=o||{}).prefix?o.prefix:this.opts.prefix,a=this.opts.baseUrl+s+r;return this.requestOtherUrl(e,t,a,n,i,o)},requestOtherUrl:function(e,t,r,n,i,o){return null==o?o={}:isFinite(o)&&(o={localTimeoutMs:o}),this._request(e,t,r,n,i,o)},getUrl:function(e,t,r){var n="";return t&&(n="?"+v.encodeParams(t)),this.opts.baseUrl+r+e+n},_request:function(e,t,r,n,i,o){if(void 0!==e&&!v.isFunction(e))throw Error("Expected callback to be a function but got "+(0,p.default)(e));o=o||{};var s=this;this.opts.extraParams&&(n=S(S({},n),this.opts.extraParams));var a=v.extend({},o.headers||{}),u=void 0===o.json||o.json,c=o.bodyParser;u&&(i&&(i=JSON.stringify(i),a["content-type"]="application/json"),a.accept||(a.accept="application/json"),void 0===c&&(c=function(e){return JSON.parse(e)}));var l,d,h=v.defer(),f=!1,g=o.localTimeoutMs||this.opts.localTimeoutMs,y=function(){g&&(l&&m.clearTimeout(l),l=m.setTimeout((function(){f=!0,d&&d.abort&&d.abort(),h.reject(new w({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:g}))}),g))};y();var _=h.promise;try{(d=this.opts.request({uri:r,method:t,withCredentials:!1,qs:n,qsStringifyOptions:o.qsStringifyOptions,useQuerystring:!0,body:i,json:!1,timeout:g,headers:a||{},_matrix_opts:this.opts},(function(t,r,n){g&&(m.clearTimeout(l),f)||E(h,e,s.opts.onlyData,c)(t,r,n)})))&&("onprogress"in d&&(d.onprogress=function(e){y()}),d.abort&&(_.abort=d.abort.bind(d)))}catch(t){h.reject(t),e&&e(t)}return _}};var E=function(e,t,r,n){return t=t||function(){},function(i,o,s){i&&("AbortError"===i.name||"aborted"===i||i instanceof w||(i=new I("request failed",i)));if(!i)try{(o.status||o.statusCode)>=400?i=function(e,t){var r,n=e.status||e.statusCode,i=function(e){var t;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return(0,g.parse)(t)}catch(e){throw new Error("Error parsing Content-Type '".concat(t,"': ").concat(e))}}(e);if(i)if("application/json"===i.type){var o="object"===(0,p.default)(t)?t:JSON.parse(t);r=new w(o)}else"text/plain"===i.type&&(r=new Error("Server returned ".concat(n," error: ").concat(t)));r||(r=new Error("Server returned ".concat(n," error")));return r.httpStatus=n,r}(o,s):n&&(s=n(s))}catch(e){i=new Error("Error parsing server response: ".concat(e))}if(i)e.reject(i),t(i);else{var a={code:o.status||o.statusCode,headers:o.headers,data:s};e.resolve(r?s:a),t(null,r?s:a)}}};var w=function(e){(0,c.default)(r,e);var t=_(r);function r(e){var n;return(0,u.default)(this,r),e=e||{},(n=t.call(this,"MatrixError: ".concat(e.errcode))).errcode=e.errcode,n.name=e.errcode||"Unknown error code",n.message=e.error||"Unknown message",n.data=e,n}return r}((0,h.default)(Error));r.MatrixError=w;var I=function(e){(0,c.default)(r,e);var t=_(r);function r(e){var n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;return(0,u.default)(this,r),(n=t.call(this,e+(i?": ".concat(i.message):"")))._cause=i,n}return(0,a.default)(r,[{key:"name",get:function(){return"ConnectionError"}},{key:"cause",get:function(){return this._cause}}]),r}((0,h.default)(Error));r.ConnectionError=I;var T=function(e){(0,c.default)(r,e);var t=_(r);function r(){return(0,u.default)(this,r),t.call(this,"Operation aborted")}return(0,a.default)(r,[{key:"name",get:function(){return"AbortError"}}]),r}((0,h.default)(Error));function R(){return(R=(0,s.default)(o.default.mark((function e(t,r){var n,i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=0,i=null;case 2:if(!(n<t)){e.next=21;break}if(e.prev=3,!(n>0)){e.next=6;break}return e.delegateYield(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=1e3*Math.pow(2,n),y.logger.log("network operation failed ".concat(n," times,")+" retrying in ".concat(t,"ms...")),e.next=4,new Promise((function(e){return setTimeout(e,t)}));case 4:case"end":return e.stop()}}),e)}))(),"t0",6);case 6:return e.next=8,r();case 8:return e.abrupt("return",e.sent);case 11:if(e.prev=11,e.t1=e.catch(3),!(e.t1 instanceof I)){e.next=18;break}n+=1,i=e.t1,e.next=19;break;case 18:throw e.t1;case 19:e.next=2;break;case 21:throw i;case 22:case"end":return e.stop()}}),e,null,[[3,11]])})))).apply(this,arguments)}r.AbortError=T}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":102,"./realtime-callbacks":120,"./utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/typeof":24,"@babel/runtime/helpers/wrapNativeSuper":26,"@babel/runtime/regenerator":27,"content-type":35}],100:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.exists=function(e,t){return new Promise((function(r,n){var i=!0,o=e.open(t);o.onupgradeneeded=function(){i=!1},o.onblocked=function(){return n()},o.onsuccess=function(){o.result.close(),i||e.deleteDatabase(t),r(i)},o.onerror=function(e){return n(e.target.error)}}))}},{}],101:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.InteractiveAuth=y;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=i(e("url")),u=n(e("./utils")),c=e("./logger");function l(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return d(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return d(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var h,f,p,g="m.login.email.identity",v="m.login.msisdn";function y(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}y.prototype={attemptAuth:function(){var e=this;return new Promise((function(t,r){if(e._resolveFunc=t,e._rejectFunc=r,e._data&&e._data.flows)e._startNextAuthStage();else{e._busyChangedCallback&&e._busyChangedCallback(!0);var n=null;e._data.session&&(n={session:e._data.session}),e._doRequest(n).finally((function(){e._busyChangedCallback&&e._busyChangedCallback(!1)}))}}))},poll:(p=(0,s.default)(o.default.mark((function e(){var t,r,n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._data.session){e.next=2;break}return e.abrupt("return");case 2:if(this._resolveFunc){e.next=4;break}return e.abrupt("return");case 4:if(!this._submitPromise){e.next=6;break}return e.abrupt("return");case 6:if(t={},this._currentStage!=g){e.next=16;break}if(!this._emailSid){e.next=16;break}return r={sid:this._emailSid,client_secret:this._clientSecret},e.next=12,this._matrixClient.doesServerRequireIdServerParam();case 12:if(!e.sent){e.next=15;break}n=a.default.parse(this._matrixClient.getIdentityServerUrl()),r.id_server=n.host;case 15:t={type:g,threepid_creds:r,threepidCreds:r};case 16:this.submitAuthDict(t,!0);case 17:case"end":return e.stop()}}),e,this)}))),function(){return p.apply(this,arguments)}),getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){var t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow:function(){return this._chosenFlow},submitAuthDict:(f=(0,s.default)(o.default.mark((function e(t,r){var n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._resolveFunc){e.next=2;break}throw new Error("submitAuthDict() called before attemptAuth()");case 2:!r&&this._busyChangedCallback&&this._busyChangedCallback(!0);case 3:if(!this._submitPromise){e.next=13;break}return e.prev=4,e.next=7,this._submitPromise;case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(4);case 11:e.next=3;break;case 13:return this._data.session?(n={session:this._data.session},u.extend(n,t)):n=t,e.prev=14,this._submitPromise=this._doRequest(n,r),e.next=18,this._submitPromise;case 18:return e.prev=18,this._submitPromise=null,!r&&this._busyChangedCallback&&this._busyChangedCallback(!1),e.finish(18);case 22:case"end":return e.stop()}}),e,this,[[4,9],[14,,18,22]])}))),function(e,t){return f.apply(this,arguments)}),getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:(h=(0,s.default)(o.default.mark((function e(t,r){var n,i,s,a;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._requestCallback(t,r);case 3:n=e.sent,this._resolveFunc(n),this._resolveFunc=null,this._rejectFunc=null,e.next=34;break;case 9:e.prev=9,e.t0=e.catch(0),i=e.t0.data?e.t0.data.flows:null,s=this._data.flows||Boolean(i),401===e.t0.httpStatus&&e.t0.data&&s||(r?c.logger.log("Background poll request failed doing UI auth: ignoring",e.t0):this._rejectFunc(e.t0)),e.t0.data.flows||e.t0.data.completed||e.t0.data.session||(e.t0.data.flows=this._data.flows,e.t0.data.completed=this._data.completed,e.t0.data.session=this._data.session),this._data=e.t0.data;try{this._startNextAuthStage()}catch(e){this._rejectFunc(e),this._resolveFunc=null,this._rejectFunc=null}if(this._emailSid||this._requestingEmailToken||!this._chosenFlow.stages.includes("m.login.email.identity")){e.next=34;break}return this._requestingEmailToken=!0,e.prev=19,e.next=22,this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session);case 22:a=e.sent,this._emailSid=a.sid,e.next=31;break;case 26:e.prev=26,e.t1=e.catch(19),this._rejectFunc(e.t1),this._resolveFunc=null,this._rejectFunc=null;case 31:return e.prev=31,this._requestingEmailToken=!1,e.finish(31);case 34:case"end":return e.stop()}}),e,this,[[0,9],[19,26,31,34]])}))),function(e,t){return h.apply(this,arguments)}),_startNextAuthStage:function(){var e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"!==e)if(this._data&&this._data.errcode||this._data.error)this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});else{var t={};e==g&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)}else this.submitAuthDict({type:"m.login.dummy"})},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),c.logger.log("Active flow => %s",JSON.stringify(this._chosenFlow));var e=this._firstUncompletedStage(this._chosenFlow);return c.logger.log("Next stage: %s",e),e},_chooseFlow:function(){var e,t=this._data.flows||[],r=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),n=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber),i=l(t);try{for(i.s();!(e=i.n()).done;){var o,s=e.value,a=!1,u=!1,c=l(s.stages);try{for(c.s();!(o=c.n()).done;){var d=o.value;d===g?a=!0:d==v&&(u=!0)}}catch(h){c.e(h)}finally{c.f()}if(a==r&&u==n)return s}}catch(h){i.e(h)}finally{i.f()}var h=new Error("No appropriate authentication flow found");throw h.name="NoAuthFlowFoundError",h.required_stages=[],r&&h.required_stages.push(g),n&&h.required_stages.push(v),h.available_flows=t,h},_firstUncompletedStage:function(e){for(var t=(this._data||{}).completed||[],r=0;r<e.stages.length;++r){var n=e.stages[r];if(-1===t.indexOf(n))return n}}}},{"./logger":102,"./utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27,url:52}],102:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.logger=void 0;const i=n(e("loglevel")),o="matrix";function s(e){e.withPrefix=function(e){return function(e){const t=i.default.getLogger(`matrix-${e}`);t.prefix!==e&&(s(t),t.prefix=e,t.setLevel(i.default.levels.DEBUG));return t}((this.prefix||"")+e)}}i.default.methodFactory=function(e,t,r){return function(...t){this.prefix&&t.unshift(this.prefix);return"error"===e||"warn"===e||"trace"===e||"info"===e?console[e](...t):console.log(...t)}},r.logger=i.default.getLogger(o),r.logger.setLevel(i.default.levels.DEBUG),s(r.logger)},{loglevel:38}],103:[function(e,t,r){(function(t){(function(){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)},s=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t};Object.defineProperty(r,"__esModule",{value:!0}),r.createClient=r.setCryptoStoreFactory=r.wrapRequest=r.getRequest=r.request=r.setMatrixCallVideoInput=r.setMatrixCallAudioInput=r.createNewMatrixCall=r.ContentHelpers=void 0;const a=e("./crypto/store/memory-crypto-store"),u=e("./store/memory"),c=e("./scheduler"),l=e("./client");o(e("./client"),r),o(e("./http-api"),r),o(e("./autodiscovery"),r),o(e("./sync-accumulator"),r),o(e("./errors"),r),o(e("./models/event"),r),o(e("./models/room"),r),o(e("./models/group"),r),o(e("./models/event-timeline"),r),o(e("./models/event-timeline-set"),r),o(e("./models/room-member"),r),o(e("./models/room-state"),r),o(e("./models/user"),r),o(e("./scheduler"),r),o(e("./filter"),r),o(e("./timeline-window"),r),o(e("./interactive-auth"),r),o(e("./service-types"),r),o(e("./store/memory"),r),o(e("./store/indexeddb"),r),o(e("./store/session/webstorage"),r),o(e("./crypto/store/memory-crypto-store"),r),o(e("./crypto/store/indexeddb-crypto-store"),r),o(e("./content-repo"),r),r.ContentHelpers=s(e("./content-helpers"));var d=e("./webrtc/call");let h;Object.defineProperty(r,"createNewMatrixCall",{enumerable:!0,get:function(){return d.createNewMatrixCall}}),Object.defineProperty(r,"setMatrixCallAudioInput",{enumerable:!0,get:function(){return d.setAudioInput}}),Object.defineProperty(r,"setMatrixCallVideoInput",{enumerable:!0,get:function(){return d.setVideoInput}}),r.request=function(e){h=e},r.getRequest=function(){return h},r.wrapRequest=function(e){const t=h;h=function(r,n){return e(t,r,n)}};let f=()=>new a.MemoryCryptoStore;r.setCryptoStoreFactory=function(e){f=e},r.createClient=function(e){return"string"==typeof e&&(e={baseUrl:e}),e.request=e.request||h,e.store=e.store||new u.MemoryStore({localStorage:t.localStorage}),e.scheduler=e.scheduler||new c.MatrixScheduler,e.cryptoStore=e.cryptoStore||f(),new l.MatrixClient(e)}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./autodiscovery":58,"./client":60,"./content-helpers":61,"./content-repo":62,"./crypto/store/indexeddb-crypto-store":84,"./crypto/store/memory-crypto-store":86,"./errors":95,"./filter":98,"./http-api":99,"./interactive-auth":101,"./models/event":109,"./models/event-timeline":108,"./models/event-timeline-set":107,"./models/group":110,"./models/room":115,"./models/room-member":112,"./models/room-state":113,"./models/user":117,"./scheduler":121,"./service-types":122,"./store/indexeddb":125,"./store/memory":126,"./store/session/webstorage":127,"./sync-accumulator":129,"./timeline-window":132,"./webrtc/call":134}],104:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.MSC3089Branch=void 0;const i=e("../@types/event");r.MSC3089Branch=class{constructor(e,t){this.client=e,this.indexEvent=t}get id(){return this.indexEvent.getStateKey()}get isActive(){return!0===this.indexEvent.getContent().active}get roomId(){return this.indexEvent.getRoomId()}delete(){return n(this,void 0,void 0,(function*(){yield this.client.sendStateEvent(this.roomId,i.UNSTABLE_MSC3089_BRANCH.name,{},this.id),yield this.client.redactEvent(this.roomId,this.id)}))}getName(){return this.indexEvent.getContent().name||"Unnamed File"}setName(e){return this.client.sendStateEvent(this.roomId,i.UNSTABLE_MSC3089_BRANCH.name,Object.assign(Object.assign({},this.indexEvent.getContent()),{name:e}),this.id)}getFileInfo(){return n(this,void 0,void 0,(function*(){const e=this.client.getRoom(this.roomId);if(!e)throw new Error("Unknown room");const t=yield this.client.getEventTimeline(e.getUnfilteredTimelineSet(),this.id);if(!t)throw new Error("Failed to get timeline for room event");const r=t.getEvents().find((e=>e.getId()===this.id));if(!r)throw new Error("Failed to find event");yield this.client.decryptEventIfNeeded(r,{emit:!1,isRetry:!1});const n=r.getContent().file;return{info:n,httpUrl:this.client.mxcUrlToHttp(n.url)}}))}}},{"../@types/event":54}],105:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.MSC3089TreeSpace=r.TreePermissions=r.DEFAULT_TREE_POWER_LEVELS_TEMPLATE=void 0;const i=e("../@types/event"),o=e("../logger"),s=e("../utils"),a=e("./MSC3089Branch");var u;r.DEFAULT_TREE_POWER_LEVELS_TEMPLATE={invite:100,kick:100,ban:100,redact:50,state_default:50,events_default:50,users_default:0,events:{[i.EventType.RoomPowerLevels]:100,[i.EventType.RoomHistoryVisibility]:100,[i.EventType.RoomTombstone]:100,[i.EventType.RoomEncryption]:100,[i.EventType.RoomName]:50,[i.EventType.RoomMessage]:50,[i.EventType.RoomMessageEncrypted]:50,[i.EventType.Sticker]:50},users:{}},function(e){e.Viewer="viewer",e.Editor="editor",e.Owner="owner"}(u=r.TreePermissions||(r.TreePermissions={}));r.MSC3089TreeSpace=class{constructor(e,t){if(this.client=e,this.roomId=t,this.room=this.client.getRoom(this.roomId),!this.room)throw new Error("Unknown room")}get id(){return this.roomId}get isTopLevel(){const e=this.room.currentState.getStateEvents(i.EventType.SpaceParent);return!(null==e?void 0:e.length)||e.every((e=>{var t;return!(null===(t=e.getContent())||void 0===t?void 0:t.via)}))}setName(e){return this.client.sendStateEvent(this.roomId,i.EventType.RoomName,{name:e},"")}invite(e){return this.client.invite(this.roomId,e)}setPermissions(e,t){var r;return n(this,void 0,void 0,(function*(){const n=this.room.currentState.getStateEvents(i.EventType.RoomPowerLevels,"");if(Array.isArray(n))throw new Error("Unexpected return type for power levels");const o=n.getContent()||{},s=o.users_default||0,a=o.events_default||50,c=(null===(r=o.events)||void 0===r?void 0:r[i.EventType.RoomPowerLevels])||100,l=o.users||{};switch(t){case u.Viewer:l[e]=s;break;case u.Editor:l[e]=a;break;case u.Owner:l[e]=c;break;default:throw new Error("Invalid role: "+t)}return o.users=l,this.client.sendStateEvent(this.roomId,i.EventType.RoomPowerLevels,o,"")}))}createDirectory(e){return n(this,void 0,void 0,(function*(){const t=yield this.client.unstableCreateFileTree(e);return yield this.client.sendStateEvent(this.roomId,i.EventType.SpaceChild,{via:[this.client.getDomain()]},t.roomId),yield this.client.sendStateEvent(t.roomId,i.EventType.SpaceParent,{via:[this.client.getDomain()]},this.roomId),t}))}getDirectories(){const e=[],t=this.room.currentState.getStateEvents(i.EventType.SpaceChild);for(const r of t)try{const t=this.client.unstableGetFileTreeSpace(r.getStateKey());t&&e.push(t)}catch(e){o.logger.warn("Unable to create tree space instance for listing. Are we joined?",e)}return e}getDirectory(e){return this.getDirectories().find((t=>t.roomId===e))}delete(){return n(this,void 0,void 0,(function*(){const e=this.getDirectories();for(const t of e)yield t.delete();const t=["invite","knock","join"],r=this.room.currentState.getStateEvents(i.EventType.RoomMember);for(const e of r){e.getStateKey()!==this.client.getUserId()&&t.includes(e.getContent().membership)&&(yield this.client.kick(this.roomId,e.getStateKey(),"Room deleted"))}yield this.client.leave(this.roomId)}))}getOrderedChildren(e){const t=e.map((e=>({roomId:e.getStateKey(),order:e.getContent().order})));return t.sort(((e,t)=>{var r,n,o,a;if(e.order&&!t.order)return-1;if(!e.order&&t.order)return 1;if(e.order||t.order)return s.lexicographicCompare(e.order,t.order);{const u=this.client.getRoom(e.roomId),c=this.client.getRoom(t.roomId);if(!u||!c)return s.lexicographicCompare(e.roomId,t.roomId);const l=null!==(n=null===(r=u.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===r?void 0:r.getTs())&&void 0!==n?n:0,d=null!==(a=null===(o=c.currentState.getStateEvents(i.EventType.RoomCreate,""))||void 0===o?void 0:o.getTs())&&void 0!==a?a:0;return l===d?s.lexicographicCompare(e.roomId,t.roomId):l-d}})),t}getParentRoom(){const e=this.room.currentState.getStateEvents(i.EventType.SpaceParent)[0];if(!e)throw new Error("Expected to have a parent in a non-top level space");const t=this.client.getRoom(e.getStateKey());if(!t)throw new Error("Unable to locate room for parent");return t}getOrder(){if(this.isTopLevel)return-1;const e=this.getParentRoom().currentState.getStateEvents(i.EventType.SpaceChild);return this.getOrderedChildren(e).findIndex((e=>e.roomId===this.roomId))}setOrder(e){var t,r;return n(this,void 0,void 0,(function*(){if(this.isTopLevel)throw new Error("Cannot set order of top level spaces currently");const n=this.getParentRoom(),o=n.currentState.getStateEvents(i.EventType.SpaceChild),a=this.getOrderedChildren(o);e=Math.max(Math.min(e,a.length-1),0);const u=this.getOrder()<e;u&&e===a.length-1?e--:u||0!==e||e++;const c=a[u?e:e-1],l=a[u?e+1:e];let d=s.DEFAULT_ALPHABET[0],h=!1;if(c)if(e===a.length-1)(null==l?void 0:l.order)&&(d=s.nextString(l.order));else{const e=null==c?void 0:c.order,t=null==l?void 0:l.order;e&&t?d=e===t?s.nextString(e):s.averageBetweenStrings(e,t):e?d=s.nextString(e):t?d=s.prevString(t):h=!0}else(null==l?void 0:l.order)&&(d=s.prevString(l.order));if(h){let r;for(let o=0;o<=e;o++){const e=a[o];if(0===o&&(r=e.order),e.order)r=e.order;else{r=r?s.nextString(r):s.DEFAULT_ALPHABET[0];const o=n.currentState.getStateEvents(i.EventType.SpaceChild,e.roomId),a=null!==(t=null==o?void 0:o.getContent())&&void 0!==t?t:{via:[this.client.getDomain()]};yield this.client.sendStateEvent(n.roomId,i.EventType.SpaceChild,Object.assign(Object.assign({},a),{order:r}),e.roomId)}}d=s.nextString(r)}const f=n.currentState.getStateEvents(i.EventType.SpaceChild,this.roomId),p=null!==(r=null==f?void 0:f.getContent())&&void 0!==r?r:{via:[this.client.getDomain()]};yield this.client.sendStateEvent(n.roomId,i.EventType.SpaceChild,Object.assign(Object.assign({},p),{order:d}),this.roomId)}))}createFile(e,t,r){return n(this,void 0,void 0,(function*(){const n=yield this.client.uploadContent(new Blob([t]),{includeFilename:!1,onlyContentUri:!0});r.url=n;const o=yield this.client.sendMessage(this.roomId,{msgtype:i.MsgType.File,body:e,url:n,file:r,[i.UNSTABLE_MSC3089_LEAF.name]:{}});yield this.client.sendStateEvent(this.roomId,i.UNSTABLE_MSC3089_BRANCH.name,{active:!0,name:e},o.event_id)}))}getFile(e){const t=this.room.currentState.getStateEvents(i.UNSTABLE_MSC3089_BRANCH.name,e);return t?new a.MSC3089Branch(this.client,t):null}listFiles(){var e;return(null!==(e=this.room.currentState.getStateEvents(i.UNSTABLE_MSC3089_BRANCH.name))&&void 0!==e?e:[]).map((e=>new a.MSC3089Branch(this.client,e))).filter((e=>e.isActive))}}},{"../@types/event":54,"../logger":102,"../utils":133,"./MSC3089Branch":104}],106:[function(e,t,r){"use strict";function n(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}Object.defineProperty(r,"__esModule",{value:!0}),r.EventContext=n,n.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},n.prototype.getTimeline=function(){return this._timeline},n.prototype.getOurEventIndex=function(){return this._ourEventIndex},n.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},n.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},n.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)}},{}],107:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.EventTimelineSet=d;var i,o=e("events"),s=e("./event-timeline"),a=e("./event"),u=n(e("../utils")),c=e("../logger"),l=e("./relations");function d(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new s.EventTimeline(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}i=c.logger.log.bind(c.logger),u.inherits(d,o.EventEmitter),d.prototype.getTimelines=function(){return this._timelines},d.prototype.getFilter=function(){return this._filter},d.prototype.setFilter=function(e){this._filter=e},d.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},d.prototype.getLiveTimeline=function(){return this._liveTimeline},d.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},d.prototype.replaceEventId=function(e,t){var r=this._eventIdToTimeline[e];r&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=r)},d.prototype.resetLiveTimeline=function(e,t){var r=!this._timelineSupport||!t,n=this._liveTimeline,i=r?n.forkLive(s.EventTimeline.FORWARDS):n.fork(s.EventTimeline.FORWARDS);r?(this._timelines=[i],this._eventIdToTimeline={}):this._timelines.push(i),t&&n.setPaginationToken(t,s.EventTimeline.FORWARDS),i.setPaginationToken(e,s.EventTimeline.BACKWARDS),this._liveTimeline=i,this.emit("Room.timelineReset",this.room,this,r)},d.prototype.getTimelineForEvent=function(e){var t=this._eventIdToTimeline[e];return void 0===t?null:t},d.prototype.findEventById=function(e){var t=this.getTimelineForEvent(e);if(t)return t.getEvents().find((function(t){return t.getId()==e}))},d.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new s.EventTimeline(this);return this._timelines.push(e),e},d.prototype.addEventsToTimeline=function(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this._filter||(e=this._filter.filterRoomTimeline(e)).length){for(var o=t?s.EventTimeline.BACKWARDS:s.EventTimeline.FORWARDS,a=t?s.EventTimeline.FORWARDS:s.EventTimeline.BACKWARDS,u=!1,l=!1,d=0;d<e.length;d++){var h=e[d],f=h.getId(),p=this._eventIdToTimeline[f];if(p)if(l=!1,p!=r){var g=r.getNeighbouringTimeline(o);if(g)i(p==g?"Event "+f+" in neighbouring timeline - switching to "+p:"Event "+f+" already in a different timeline "+p),r=p;else{c.logger.info("Already have timeline for "+f+" - joining timeline "+r+" to "+p);var v=p===this._liveTimeline,y=r===this._liveTimeline,m=o===s.EventTimeline.BACKWARDS&&v,_=o===s.EventTimeline.FORWARDS&&y;m||_?(m&&c.logger.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+p+")"),_&&c.logger.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")")):(r.setNeighbouringTimeline(p,o),p.setNeighbouringTimeline(r,a),r=p,u=!0)}}else i("Event "+f+" already in timeline "+r);else this.addEventToTimeline(h,r,t),l=!0,u=!0}if(l||!u){if(o===s.EventTimeline.FORWARDS&&r===this._liveTimeline)return c.logger.warn({lastEventWasNew:l,didUpdate:u}),void c.logger.warn("Refusing to set forwards pagination token of live timeline "+"".concat(r," to ").concat(n));r.setPaginationToken(n,o)}}},d.prototype.addLiveEvent=function(e,t,r){if(this._filter&&!this._filter.filterRoomTimeline([e]).length)return;var n=this._eventIdToTimeline[e.getId()];if(n)if("replace"===t){i("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var o=n.getEvents(),a=0;a<o.length;a++)if(o[a].getId()===e.getId()){s.EventTimeline.setEventMetadata(e,n.getState(s.EventTimeline.FORWARDS),!1),o[a].encryptedType||(o[a]=e);break}}else i("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1,r)},d.prototype.addEventToTimeline=function(e,t,r,n){var i=e.getId();t.addEvent(e,r),this._eventIdToTimeline[i]=t,this.setRelationsTarget(e),this.aggregateRelations(e);var o={timeline:t,liveEvent:!r&&t==this._liveTimeline&&!n};this.emit("Room.timeline",e,this.room,Boolean(r),!1,o)},d.prototype.handleRemoteEcho=function(e,t,r){var n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[r]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.removeEvent=function(e){var t=this._eventIdToTimeline[e];if(!t)return null;var r=t.removeEvent(e);if(r){delete this._eventIdToTimeline[e];var n={timeline:t};this.emit("Room.timeline",r,this.room,void 0,!0,n)}return r},d.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;var r=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===r)return null;if(void 0===n)return null;if(r===n){for(var i,o,a=r.getEvents(),u=0;u<a.length&&(void 0===i||void 0===o);u++){var c=a[u].getId();c==e&&(i=u),c==t&&(o=u)}return i-o}for(var l=r;l;){if(l===n)return-1;l=l.getNeighbouringTimeline(s.EventTimeline.FORWARDS)}for(l=r;l;){if(l===n)return 1;l=l.getNeighbouringTimeline(s.EventTimeline.BACKWARDS)}return null},d.prototype.getRelationsForEvent=function(e,t,r){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!r)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[r]},d.prototype.setRelationsTarget=function(e){if(this._unstableClientRelationAggregation){var t=this._relations[e.getId()];if(t)for(var r=0,n=Object.values(t);r<n.length;r++)for(var i=n[r],o=0,s=Object.values(i);o<s.length;o++){s[o].setTargetEvent(e)}}},d.prototype.aggregateRelations=function(e){var t=this;if(this._unstableClientRelationAggregation&&!e.isRedacted()&&e.status!==a.EventStatus.CANCELLED)if(e.isBeingDecrypted()||e.shouldAttemptDecryption())e.once("Event.decrypted",(function(){t.aggregateRelations(e)}));else{var r=e.getRelation();if(r){var n=r.event_id,i=r.rel_type,o=e.getType(),s=this._relations[n];s||(s=this._relations[n]={});var u=s[i];u||(u=s[i]={});var c,d=u[o];d||(d=u[o]=new l.Relations(i,o,this.room),(c=this.findEventById(n)||this.room.getPendingEvent(n))&&d.setTargetEvent(c)),d.addEvent(e)}}}},{"../logger":102,"../utils":133,"./event":109,"./event-timeline":108,"./relations":111,"@babel/runtime/helpers/interopRequireWildcard":13,events:36}],108:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.EventTimeline=s;var n=e("./room-state");function i(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return o(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return o(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var s,a=!0,u=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,s=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw s}}}}function o(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function s(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new n.RoomState(this._roomId),this._startState.paginationToken=null,this._endState=new n.RoomState(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}s.BACKWARDS="b",s.FORWARDS="f",s.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");var t,r=i(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;Object.freeze(n)}}catch(e){r.e(e)}finally{r.f()}this._startState.setStateEvents(e),this._endState.setStateEvents(e)},s.prototype.forkLive=function(e){var t=this.getState(e),r=new s(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t,this._endState=t.clone(),r},s.prototype.fork=function(e){var t=this.getState(e),r=new s(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t.clone(),r},s.prototype.getRoomId=function(){return this._roomId},s.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},s.prototype.getTimelineSet=function(){return this._eventTimelineSet},s.prototype.getBaseIndex=function(){return this._baseIndex},s.prototype.getEvents=function(){return this._events},s.prototype.getState=function(e){if(e==s.BACKWARDS)return this._startState;if(e==s.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},s.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},s.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},s.prototype.getNeighbouringTimeline=function(e){if(e==s.BACKWARDS)return this._prevTimeline;if(e==s.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},s.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==s.BACKWARDS)this._prevTimeline=e;else{if(t!=s.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},s.prototype.addEvent=function(e,t){var r,n=t?this._startState:this._endState,i=this.getTimelineSet();i.room&&i.room.getUnfilteredTimelineSet()===i&&(s.setEventMetadata(e,n,t),e.isState()&&(n.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||s.setEventMetadata(e,n,t))),r=t?0:this._events.length,this._events.splice(r,0,e),t&&this._baseIndex++},s.setEventMetadata=function(e,t,r){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)},s.prototype.removeEvent=function(e){for(var t=this._events.length-1;t>=0;t--){var r=this._events[t];if(r.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,r}return null},s.prototype.toString=function(){return this._name}},{"./room-state":113}],109:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixEvent=r.EventStatus=void 0;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=e("events"),u=n(e("../utils")),c=e("../logger");r.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};var l={};function d(e){return l[e]||(l[e]=e),l[e]}var h,f,p=function(e){["state_key","type","sender","room_id","membership"].forEach((function(t){e[t]&&(e[t]=d(e[t]))})),["membership","avatar_url","displayname"].forEach((function(t){e.content&&e.content[t]&&(e.content[t]=d(e.content[t]))})),["rel_type"].forEach((function(t){e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=d(e.content["m.relates_to"][t]))})),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._untrusted=null,this._decryptionPromise=null,this._retryDecryption=!1,this.verificationRequest=null,this._txnId=e.txn_id||null,this._localTimestamp=Date.now()-this.getAge()};r.MatrixEvent=p,u.inherits(p,a.EventEmitter),u.extend(p.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getLocalAge:function(){return Date.now()-this._localTimestamp},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,r,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=r,this._claimedEd25519Key=n},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},shouldAttemptDecryption:function(){return this.isEncrypted()&&!this.isBeingDecrypted()&&null===this.getClearContent()},attemptDecryption:(f=(0,s.default)(o.default.mark((function e(t){var r,n=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("boolean"==typeof(r=n.length>1&&void 0!==n[1]?n[1]:{})&&(r={isRetry:r}),this.isEncrypted()){e.next=4;break}throw new Error("Attempt to decrypt event which isn't encrypted");case 4:if(!this._clearEvent||!this._clearEvent.content||"m.bad.encrypted"===this._clearEvent.content.msgtype){e.next=6;break}throw new Error("Attempt to decrypt event which has already been decrypted");case 6:if(!this._decryptionPromise){e.next=10;break}return c.logger.log("Event ".concat(this.getId()," already being decrypted; queueing a retry")),this._retryDecryption=!0,e.abrupt("return",this._decryptionPromise);case 10:return this._decryptionPromise=this._decryptionLoop(t,r),e.abrupt("return",this._decryptionPromise);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)}),cancelAndResendKeyRequest:function(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){var t=this.getWireContent(),r=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&r.push({userId:n,deviceId:t.device_id}),r},_decryptionLoop:(h=(0,s.default)(o.default.mark((function e(t){var r,n,i,s,a=arguments;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=a.length>1&&void 0!==a[1]?a[1]:{},e.next=3,Promise.resolve();case 3:if(this._retryDecryption=!1,n=void 0,i=void 0,e.prev=7,t){e.next=12;break}n=this._badEncryptedMessage("Encryption not enabled"),e.next=16;break;case 12:return e.next=14,t.decryptEvent(this);case 14:n=e.sent,!0===r.isRetry&&c.logger.info("Decrypted event on retry (id=".concat(this.getId(),")"));case 16:e.next=32;break;case 18:if(e.prev=18,e.t0=e.catch(7),"DecryptionError"===e.t0.name){e.next=26;break}return s=r.isRetry?"re":"",c.logger.error("Error ".concat(s,"decrypting event ")+"(id=".concat(this.getId(),"): ").concat(e.t0.stack||e.t0)),this._decryptionPromise=null,this._retryDecryption=!1,e.abrupt("return");case 26:if(i=e.t0,!this._retryDecryption){e.next=30;break}return c.logger.log("Got error decrypting event (id=".concat(this.getId(),": ")+"".concat(e.t0,"), but retrying")),e.abrupt("continue",3);case 30:c.logger.warn("Error decrypting event (id=".concat(this.getId(),"): ").concat(e.t0.detailedString)),n=this._badEncryptedMessage(e.t0.message);case 32:return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(n),this.setPushActions(null),!1!==r.emit&&this.emit("Event.decrypted",this,i),e.abrupt("return");case 40:case"end":return e.stop()}}),e,this,[[7,18]])}))),function(e){return h.apply(this,arguments)}),_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[],this._untrusted=e.untrusted||!1},getClearContent:function(){var e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return!this.isState()&&"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},isKeySourceUntrusted:function(){return this._untrusted},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");var t;for(t in this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event,this.event)this.event.hasOwnProperty(t)&&(g[t]||delete this.event[t]);var r=v[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(r[t]||delete n[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getRedactionEvent:function(){return this.isRedacted()?this._clearEvent.unsigned?this._clearEvent.unsigned.redacted_because:this.event.unsigned.redacted_because?this.event.unsigned.redacted_because:{}:null},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){var t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit("Event.localEventIdReplaced",this)},isSending:function(){return!!this.status},setStatus:function(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId:function(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=this.getWireContent(),r=t&&t["m.relates_to"];return r&&r.rel_type&&r.event_id&&(e&&r.rel_type===e||!e)},getRelation:function(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced:function(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus:function(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation:function(e){var t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId:function(){var e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent:function(){return this._replacingEvent},replacingEventDate:function(){var e=this.getServerAggregatedRelation("m.replace");if(e){var t=e.origin_server_ts;if(Number.isFinite(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent:function(){return this._localRedactionEvent},getAssociatedId:function(){var e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation:function(){return!!this.getAssociatedId()},updateAssociatedId:function(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e},isCancelled:function(){return this._isCancelled},toJSON:function(){var e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e},setVerificationRequest:function(e){this.verificationRequest=e},setTxnId:function(e){this._txnId=e},getTxnId:function(){return this._txnId}});var g=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),v={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},{"../logger":102,"../utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27,events:36}],110:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.Group=s;var i=n(e("../utils")),o=e("events");function s(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}i.inherits(s,o.EventEmitter),s.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},s.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},s.prototype.setInviter=function(e){this.inviter=e}},{"../utils":133,"@babel/runtime/helpers/interopRequireWildcard":13,events:36}],111:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.Relations=void 0;var i=n(e("@babel/runtime/helpers/toConsumableArray")),o=n(e("@babel/runtime/regenerator")),s=n(e("@babel/runtime/helpers/asyncToGenerator")),a=n(e("@babel/runtime/helpers/classCallCheck")),u=n(e("@babel/runtime/helpers/createClass")),c=n(e("@babel/runtime/helpers/assertThisInitialized")),l=n(e("@babel/runtime/helpers/inherits")),d=n(e("@babel/runtime/helpers/possibleConstructorReturn")),h=n(e("@babel/runtime/helpers/getPrototypeOf")),f=n(e("@babel/runtime/helpers/defineProperty")),p=e("events"),g=e("../models/event"),v=e("../logger");function y(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,h.default)(e);if(t){var i=(0,h.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,d.default)(this,r)}}var m=function(e){(0,l.default)(p,e);var t,r,n,d,h=y(p);function p(e,t,r){var n;return(0,a.default)(this,p),n=h.call(this),(0,f.default)((0,c.default)(n),"_onEventStatus",(function(e,t){e.isSending()?t===g.EventStatus.CANCELLED&&(e.removeListener("Event.status",n._onEventStatus),n._removeEvent(e)):e.removeListener("Event.status",n._onEventStatus)})),(0,f.default)((0,c.default)(n),"_onBeforeRedaction",function(){var e=(0,s.default)(o.default.mark((function e(t){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n._relations.has(t)){e.next=2;break}return e.abrupt("return");case 2:if(n._relations.delete(t),"m.annotation"!==n.relationType){e.next=7;break}n._removeAnnotationFromAggregation(t),e.next=12;break;case 7:if("m.replace"!==n.relationType||!n._targetEvent){e.next=12;break}return e.next=10,n.getLastReplacement();case 10:r=e.sent,n._targetEvent.makeReplaced(r);case 12:t.removeListener("Event.beforeRedaction",n._onBeforeRedaction),n.emit("Relations.redaction",t);case 14:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()),n.relationType=e,n.eventType=t,n._relationEventIds=new Set,n._relations=new Set,n._annotationsByKey={},n._annotationsBySender={},n._sortedAnnotationsByKey=[],n._targetEvent=null,n._room=r,n._creationEmitted=!1,n}return(0,u.default)(p,[{key:"addEvent",value:(d=(0,s.default)(o.default.mark((function e(t){var r,n,i,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._relationEventIds.has(t.getId())){e.next=2;break}return e.abrupt("return");case 2:if(r=t.getRelation()){e.next=6;break}return v.logger.error("Event must have relation info"),e.abrupt("return");case 6:if(n=r.rel_type,i=t.getType(),this.relationType===n&&this.eventType===i){e.next=11;break}return v.logger.error("Event relation info doesn't match this container"),e.abrupt("return");case 11:if(t.isSending()&&t.on("Event.status",this._onEventStatus),this._relations.add(t),this._relationEventIds.add(t.getId()),"m.annotation"!==this.relationType){e.next=18;break}this._addAnnotationToAggregation(t),e.next=23;break;case 18:if("m.replace"!==this.relationType||!this._targetEvent){e.next=23;break}return e.next=21,this.getLastReplacement();case 21:s=e.sent,this._targetEvent.makeReplaced(s);case 23:t.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",t),this._maybeEmitCreated();case 26:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)})},{key:"_removeEvent",value:(n=(0,s.default)(o.default.mark((function e(t){var r,n,i,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._relations.has(t)){e.next=2;break}return e.abrupt("return");case 2:if(r=t.getRelation()){e.next=6;break}return v.logger.error("Event must have relation info"),e.abrupt("return");case 6:if(n=r.rel_type,i=t.getType(),this.relationType===n&&this.eventType===i){e.next=11;break}return v.logger.error("Event relation info doesn't match this container"),e.abrupt("return");case 11:if(this._relations.delete(t),"m.annotation"!==this.relationType){e.next=16;break}this._removeAnnotationFromAggregation(t),e.next=21;break;case 16:if("m.replace"!==this.relationType||!this._targetEvent){e.next=21;break}return e.next=19,this.getLastReplacement();case 19:s=e.sent,this._targetEvent.makeReplaced(s);case 21:this.emit("Relations.remove",t);case 22:case"end":return e.stop()}}),e,this)}))),function(e){return n.apply(this,arguments)})},{key:"getRelations",value:function(){return(0,i.default)(this._relations)}},{key:"_addAnnotationToAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r||(r=this._annotationsByKey[t]=new Set,this._sortedAnnotationsByKey.push([t,r])),r.add(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size}));var n=e.getSender(),i=this._annotationsBySender[n];i||(i=this._annotationsBySender[n]=new Set),i.add(e)}}},{key:"_removeAnnotationFromAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r&&(r.delete(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size})));var n=e.getSender(),i=this._annotationsBySender[n];i&&i.delete(e)}}},{key:"getSortedAnnotationsByKey",value:function(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}},{key:"getAnnotationsBySender",value:function(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}},{key:"getLastReplacement",value:(r=(0,s.default)(o.default.mark((function e(){var t,r,n,i=this;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("m.replace"===this.relationType){e.next=2;break}return e.abrupt("return",null);case 2:if(this._targetEvent){e.next=4;break}return e.abrupt("return",null);case 4:if(t=this._targetEvent.getServerAggregatedRelation("m.replace"),r=t&&t.origin_server_ts,null==(n=this.getRelations().reduce((function(e,t){return t.getSender()!==i._targetEvent.getSender()||r&&r>t.getTs()||e&&e.getTs()>t.getTs()?e:t}),null))||!n.shouldAttemptDecryption()){e.next=12;break}return e.next=10,n.attemptDecryption(this._room._client.crypto);case 10:e.next=15;break;case 12:if(null==n||!n.isBeingDecrypted()){e.next=15;break}return e.next=15,n._decryptionPromise;case 15:return e.abrupt("return",n);case 16:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setTargetEvent",value:(t=(0,s.default)(o.default.mark((function e(t){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._targetEvent){e.next=2;break}return e.abrupt("return");case 2:if(this._targetEvent=t,"m.replace"!==this.relationType){e.next=8;break}return e.next=6,this.getLastReplacement();case 6:(r=e.sent)&&this._targetEvent.makeReplaced(r);case 8:this._maybeEmitCreated();case 9:case"end":return e.stop()}}),e,this)}))),function(e){return t.apply(this,arguments)})},{key:"_maybeEmitCreated",value:function(){this._creationEmitted||this._targetEvent&&this._relations.size&&(this._creationEmitted=!0,this._targetEvent.emit("Event.relationsCreated",this.relationType,this.eventType))}}]),p}(p.EventEmitter);r.Relations=m},{"../logger":102,"../models/event":109,"@babel/runtime/helpers/assertThisInitialized":4,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/getPrototypeOf":10,"@babel/runtime/helpers/inherits":11,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/possibleConstructorReturn":20,"@babel/runtime/helpers/toConsumableArray":23,"@babel/runtime/regenerator":27,events:36}],112:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomMember=a;var i=e("events"),o=e("../content-repo"),s=n(e("../utils"));function a(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime(),this.disambiguate=!1}s.inherits(a,i.EventEmitter),a.prototype.markOutOfBand=function(){this._isOutOfBand=!0},a.prototype.isOutOfBand=function(){return this._isOutOfBand},a.prototype.setMembershipEvent=function(e,t){var r=e.getDirectionalContent().displayname;if("m.room.member"===e.getType()){this._isOutOfBand=!1,this.events.member=e;var n=this.membership;this.membership=e.getDirectionalContent().membership,this.disambiguate=function(e,t,r){return!(!t||t===e)&&(!!s.removeHiddenChars(t)&&(!!r&&(!!u.test(t)||(!!c.test(t)||!!r.getUserIdsWithDisplayName(t).some((function(t){return t!==e}))))))}(this.userId,r,t);var i=this.name;this.name=function(e,t,r,n){return n?t+" ("+e+")":t&&t!==e&&s.removeHiddenChars(t)?t:e}(this.userId,r,0,this.disambiguate),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,n!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,n)),i!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,i))}},a.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"===e.getType()){var t=e.getDirectionalContent(),r=t.users_default||0,n=t.users||{};Object.values(n).forEach((function(e){r=Math.max(r,e)}));var i=this.powerLevel,o=this.powerLevelNorm;void 0!==n[this.userId]?this.powerLevel=n[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),i===this.powerLevel&&o===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}},a.prototype.setTypingEvent=function(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;Array.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}},a.prototype._updateModifiedTime=function(){this._modified=Date.now()},a.prototype.getLastModifiedTime=function(){return this._modified},a.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},a.prototype.getDMInviter=function(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return r}},a.prototype.getAvatarUrl=function(e,t,r,n,i,s){void 0===i&&(i=!0);var a=this.getMxcAvatarUrl();if(!a&&!i)return null;var u=(0,o.getHttpUriForMxc)(e,a,t,r,n,s);return u||null},a.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null};var u=/@.+:.+/,c=/[\u200E\u200F\u202A-\u202F]/},{"../content-repo":62,"../utils":133,"@babel/runtime/helpers/interopRequireWildcard":13,events:36}],113:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.RoomState=c;var i=e("events"),o=e("./room-member"),s=e("../logger"),a=n(e("../utils")),u=e("../@types/event");function c(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.roomId=e,this.members={},this.events=new Map,this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:1}),this._oobMemberFlags=t}function l(e,t,r){var n=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],n){var i=a.removeHiddenChars(n),o=e._displayNameToUserIds[i];if(o){var s=o.filter((function(e){return e!==t}));e._displayNameToUserIds[i]=s}}e._userIdsToDisplayNames[t]=r;var u=r&&a.removeHiddenChars(r);u&&(e._displayNameToUserIds[u]||(e._displayNameToUserIds[u]=[]),e._displayNameToUserIds[u].push(t))}a.inherits(c,i.EventEmitter),c.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((function(e,t){return"join"===t.membership?e+1:e}),0)),this._joinedMemberCount)},c.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},c.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((function(e,t){return"invite"===t.membership?e+1:e}),0)),this._invitedMemberCount)},c.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},c.prototype.getMembers=function(){return Object.values(this.members)},c.prototype.getMembersExcept=function(e){return Object.values(this.members).filter((function(t){return!e.includes(t.userId)}))},c.prototype.getMember=function(e){return this.members[e]||null},c.prototype.getSentinelMember=function(e){if(!e)return null;var t=this._sentinels[e];if(void 0===t){t=new o.RoomMember(this.roomId,e);var r=this.members[e];r&&t.setMembershipEvent(r.events.member,this),this._sentinels[e]=t}return t},c.prototype.getStateEvents=function(e,t){if(!this.events.has(e))return void 0===t?[]:null;if(void 0===t)return Array.from(this.events.get(e).values());var r=this.events.get(e).get(t);return r||null},c.prototype.clone=function(){var e=new c(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=1,Array.from(this.events.values()).forEach((function(t){e.setStateEvents(Array.from(t.values()))})),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach((function(t){t.isOutOfBand()&&e.getMember(t.userId).markOutOfBand()})),e},c.prototype.setUnknownStateEvents=function(e){var t=this,r=e.filter((function(e){return!t.events.has(e.getType())||!t.events.get(e.getType()).has(e.getStateKey())}));this.setStateEvents(r)},c.prototype.setStateEvents=function(e){var t=this;this._updateModifiedTime(),e.forEach((function(e){if(e.getRoomId()===t.roomId&&e.isState()){var r=t._getStateEventMatching(e);t._setStateEvent(e),"m.room.member"===e.getType()&&(l(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;var r=(t.getContent().third_party_invite.signed||{}).token;if(!r)return;if(!e.getStateEvents("m.room.third_party_invite",r))return;e._tokenToInvite[r]=t}(t,e)),t.emit("RoomState.events",e,t,r)}})),e.forEach((function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){var r=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=t._getOrCreateMember(r,e);n.setMembershipEvent(e,t),t._updateMember(n),t.emit("RoomState.members",e,t,n)}else if("m.room.power_levels"===e.getType()){if(""!==e.getStateKey())return;Object.values(t.members).forEach((function(r){var n=r.getLastModifiedTime();r.setPowerLevelEvent(e),n!==r.getLastModifiedTime()&&t.emit("RoomState.members",e,t,r)})),t._sentinels={}}}))},c.prototype._getOrCreateMember=function(e,t){var r=this.members[e];return r||(r=new o.RoomMember(this.roomId,e),this.members[e]=r,this.emit("RoomState.newMember",t,this,r)),r},c.prototype._setStateEvent=function(e){this.events.has(e.getType())||this.events.set(e.getType(),new Map),this.events.get(e.getType()).set(e.getStateKey(),e)},c.prototype._getStateEventMatching=function(e){return this.events.has(e.getType())?this.events.get(e.getType()).get(e.getStateKey()):null},c.prototype._updateMember=function(e){var t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},c.prototype.needsOutOfBandMembers=function(){return 1===this._oobMemberFlags.status},c.prototype.markOutOfBandMembersStarted=function(){1===this._oobMemberFlags.status&&(this._oobMemberFlags.status=2)},c.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=1)},c.prototype.clearOutOfBandMembers=function(){var e=this,t=0;Object.keys(this.members).forEach((function(r){e.members[r].isOutOfBand()&&(++t,delete e.members[r])})),s.logger.log("LL: RoomState removed ".concat(t," members...")),this._oobMemberFlags.status=1},c.prototype.setOutOfBandMembers=function(e){var t=this;s.logger.log("LL: RoomState about to set ".concat(e.length," OOB members ...")),2===this._oobMemberFlags.status&&(s.logger.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach((function(e){return t._setOutOfBandMember(e)})))},c.prototype._setOutOfBandMember=function(e){if("m.room.member"===e.getType()){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this._getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),l(this,n.userId,n.name),this._setStateEvent(e),this._updateMember(n),this.emit("RoomState.members",e,this,n)}}},c.prototype.setTypingEvent=function(e){Object.values(this.members).forEach((function(t){t.setTypingEvent(e)}))},c.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},c.prototype._updateModifiedTime=function(){this._modified=Date.now()},c.prototype.getLastModifiedTime=function(){return this._modified},c.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[a.removeHiddenChars(e)]||[]},c.prototype.maySendRedactionForEvent=function(e,t){var r=this.getMember(t);if(!r||"leave"===r.membership)return!1;if(e.status||e.isRedacted())return!1;var n=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?n:this._hasSufficientPowerLevelFor("redact",r.powerLevel)},c.prototype._hasSufficientPowerLevelFor=function(e,t){var r=this.getStateEvents("m.room.power_levels",""),n={};r&&(n=r.getContent());var i=50;return a.isNumber(n[e])&&(i=n[e]),t>=i},c.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},c.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},c.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},c.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},c.prototype._maySendEventOfType=function(e,t,r){var n,i=this.getStateEvents("m.room.power_levels",""),o={},s=0,a=0,u=0;if(i){o=(n=i.getContent()).events||{},s=Number.isFinite(n.state_default)?n.state_default:50;var c=n.users&&n.users[t];Number.isFinite(c)?u=c:Number.isFinite(n.users_default)&&(u=n.users_default),Number.isFinite(n.events_default)&&(a=n.events_default)}var l=r?s:a;return Number.isFinite(o[e])&&(l=o[e]),u>=l},c.prototype.mayTriggerNotifOfType=function(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents("m.room.power_levels",""),i=50;return n&&n.getContent()&&n.getContent().notifications&&a.isNumber(n.getContent().notifications[e])&&(i=n.getContent().notifications[e]),r.powerLevel>=i},c.prototype.getJoinRule=function(){var e=this.getStateEvents(u.EventType.RoomJoinRules,"");return(e?e.getContent():{}).join_rule||"invite"}},{"../@types/event":54,"../logger":102,"../utils":133,"./room-member":112,"@babel/runtime/helpers/interopRequireWildcard":13,events:36}],114:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.RoomSummary=function(e,t){this.roomId=e,this.info=t}},{}],115:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.Room=T;var o=i(e("@babel/runtime/helpers/slicedToArray")),s=i(e("@babel/runtime/helpers/defineProperty")),a=i(e("@babel/runtime/regenerator")),u=i(e("@babel/runtime/helpers/asyncToGenerator")),c=e("events"),l=e("./event-timeline-set"),d=e("./event-timeline"),h=e("../content-repo"),f=n(e("../utils")),p=e("./event"),g=e("./room-member"),v=e("./room-summary"),y=e("../logger"),m=e("../ReEmitter"),_=e("../@types/event");function b(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function S(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?b(Object(r),!0).forEach((function(t){(0,s.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):b(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}function k(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return E(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return E(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function E(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var w=["1","2","3","4","5","6"];function I(e,t,r){var n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][r]={},n.content[t.getId()][r][e]={ts:t.getTs()},new p.MatrixEvent(n)}function T(e,t,r,n){var i=this;if((n=n||{}).pendingEventOrdering=n.pendingEventOrdering||"chronological",this._client=t,this.setMaxListeners(100),this.reEmitter=new m.ReEmitter(this),-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");if(this.myUserId=r,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=n.storageToken,this._opts=n,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new l.EventTimelineSet(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering){this._pendingEventList=[];var o=t.sessionStore.store.getItem(R(this.roomId));o&&JSON.parse(o).forEach(function(){var e=(0,u.default)(a.default.mark((function e(t){var r;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("m.room.encrypted"!==(r=new p.MatrixEvent(t)).getType()){e.next=4;break}return e.next=4,r.attemptDecryption(i._client.crypto);case 4:r.setStatus(p.EventStatus.NOT_SENT),i.addPendingEvent(r,r.getTxnId());case 6:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=Promise.resolve(),this.getTypeWarning=!1,this.getVersionWarning=!1}function R(e){return"mx_pending_events_".concat(e)}f.inherits(T,c.EventEmitter),T.prototype.decryptCriticalEvents=function(){var e=this,t=this.getEventReadUpTo(this._client.getUserId(),!0),r=this.getLiveTimeline().getEvents(),n=r.findIndex((function(e){return e.event.event_id===t})),i=r.slice(n).filter((function(e){return e.shouldAttemptDecryption()})).reverse().map((function(t){return t.attemptDecryption(e._client.crypto,{isRetry:!0})}));return Promise.allSettled(i)},T.prototype.decryptAllEvents=function(){var e=this,t=this.getUnfilteredTimelineSet().getLiveTimeline().getEvents().filter((function(e){return e.shouldAttemptDecryption()})).reverse().map((function(t){return t.attemptDecryption(e._client.crypto,{isRetry:!0})}));return Promise.allSettled(t)},T.prototype.getVersion=function(){var e=this.currentState.getStateEvents("m.room.create","");if(!e)return this.getVersionWarning||(y.logger.warn("[getVersion] Room "+this.roomId+" does not have an m.room.create event"),this.getVersionWarning=!0),"1";var t=e.getContent().room_version;return void 0===t?"1":t},T.prototype.shouldUpgradeToVersion=function(){return w.includes(this.getVersion())?null:"6"},T.prototype.getRecommendedVersion=(0,u.default)(a.default.mark((function e(){var t,r,n,i,o,s,u;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._client.getCapabilities();case 2:if(t=e.sent,!(r=t["m.room_versions"])){r={default:"6",available:{}},n=k(w);try{for(n.s();!(i=n.n()).done;)o=i.value,r.available[o]="stable"}catch(e){n.e(e)}finally{n.f()}}if(!(s=this._checkVersionAgainstCapability(r)).urgent||!s.needsUpgrade){e.next=18;break}return y.logger.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),e.next=10,this._client.getCapabilities(!0);case 10:if(u=e.sent,r=u["m.room_versions"]){e.next=17;break}return y.logger.warn("No room version capability - assuming upgrade required."),e.abrupt("return",s);case 17:s=this._checkVersionAgainstCapability(r);case 18:return e.abrupt("return",s);case 19:case"end":return e.stop()}}),e,this)}))),T.prototype._checkVersionAgainstCapability=function(e){var t=this.getVersion();y.logger.log("[".concat(this.roomId,"] Current version: ").concat(t)),y.logger.log("[".concat(this.roomId,"] Version capability: "),e);var r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default||Object.keys(e.available).filter((function(t){return"stable"===e.available[t]})).includes(t)||(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?y.logger.warn("URGENT upgrade required on ".concat(this.roomId)):y.logger.warn("Non-urgent upgrade required on ".concat(this.roomId))),r},T.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},T.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},T.prototype.removePendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call removePendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);var t=f.removeElement(this._pendingEventList,(function(t){return t.getId()==e}),!1);return this._savePendingEvents(),t},T.prototype.hasPendingEvent=function(e){return"detached"===this._opts.pendingEventOrdering&&this._pendingEventList.some((function(t){return t.getId()===e}))},T.prototype.getPendingEvent=function(e){return"detached"!==this._opts.pendingEventOrdering?null:this._pendingEventList.find((function(t){return t.getId()===e}))},T.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},T.prototype.getLastActiveTimestamp=function(){var e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():Number.MIN_SAFE_INTEGER},T.prototype.getMyMembership=function(){return this._selfMembership},T.prototype.getDMInviter=function(){if(this.myUserId){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership&&(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length))return this._summaryHeroes[0]},T.prototype.guessDMUserId=function(){var e=this,t=this.getMember(this.myUserId);if(t){var r=t.getDMInviter();if(r)return r}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];var n=this.currentState.getMembers().find((function(t){return t.userId!==e.myUserId}));return n?n.userId:this.myUserId},T.prototype.getAvatarFallbackMember=function(){var e=this;if(!(this.getInvitedAndJoinedMemberCount()>2)){var t=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(t){var r=this._summaryHeroes.map((function(t){return e.getMember(t)})).find((function(e){return!!e}));if(r)return r}var n=this.currentState.getMembers();if(n.length<=2){var i=n.find((function(t){return t.userId!==e.myUserId}));if(i)return i}if(t){var o=this._summaryHeroes.map((function(t){return e._client.getUser(t)})).find((function(e){return!!e}));if(o){var s=new g.RoomMember(this.roomId,o.userId);return s.user=o,s}}}},T.prototype.updateMyMembership=function(e){var t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},T.prototype._loadMembersFromServer=(0,u.default)(a.default.mark((function e(){var t,r,n,i,o;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._client.store.getSyncToken(),r=f.encodeParams({not_membership:"leave",at:t}),n=f.encodeUri("/rooms/$roomId/members?"+r,{$roomId:this.roomId}),i=this._client.http,e.next=6,i.authedRequest(void 0,"GET",n);case 6:return o=e.sent,e.abrupt("return",o.chunk);case 8:case"end":return e.stop()}}),e,this)}))),T.prototype._loadMembers=(0,u.default)(a.default.mark((function e(){var t,r,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!1,e.next=3,this._client.store.getOutOfBandMembers(this.roomId);case 3:if(null!==(r=e.sent)){e.next=10;break}return t=!0,e.next=8,this._loadMembersFromServer();case 8:r=e.sent,y.logger.log("LL: got ".concat(r.length," ")+"members from server for room ".concat(this.roomId));case 10:return n=r.map(this._client.getEventMapper()),e.abrupt("return",{memberEvents:n,fromServer:t});case 12:case"end":return e.stop()}}),e,this)}))),T.prototype.loadMembersIfNeeded=function(){var e=this;if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();var t=this._loadMembers().then((function(t){return e.currentState.setOutOfBandMembers(t.memberEvents),e._client.isCryptoEnabled()&&e._client.isRoomEncrypted(e.roomId)&&e._client.crypto.trackRoomDevices(e.roomId),t.fromServer})).catch((function(t){throw e._membersPromise=null,e.currentState.markOutOfBandMembersFailed(),t}));return t.then((function(t){if(t){var r=e.currentState.getMembers().filter((function(e){return e.isOutOfBand()})).map((function(e){return e.events.member.event}));return y.logger.log("LL: telling store to write ".concat(r.length)+" members for room ".concat(e.roomId)),e._client.store.setOutOfBandMembers(e.roomId,r).catch((function(e){y.logger.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((function(e){y.logger.error(e)})),this._membersPromise=t,this._membersPromise},T.prototype.clearLoadedMembersIfNeeded=(0,u.default)(a.default.mark((function e(){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._opts.lazyLoadMembers||!this._membersPromise){e.next=7;break}return e.next=3,this.loadMembersIfNeeded();case 3:return e.next=5,this._client.store.clearOutOfBandMembers(this.roomId);case 5:this.currentState.clearOutOfBandMembers(),this._membersPromise=null;case 7:case"end":return e.stop()}}),e,this)}))),T.prototype._cleanupAfterLeaving=function(){var e=this;this.clearLoadedMembersIfNeeded().catch((function(t){y.logger.error("error after clearing loaded members from "+"room ".concat(e.roomId," after leaving")),y.logger.log(t)}))},T.prototype.resetLiveTimeline=function(e,t){for(var r=0;r<this._timelineSets.length;r++)this._timelineSets[r].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},T.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(d.EventTimeline.BACKWARDS),this.currentState=this.getLiveTimeline().getState(d.EventTimeline.FORWARDS)},T.prototype.hasUnverifiedDevices=(0,u.default)(a.default.mark((function e(){var t,r,n,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._client.isRoomEncrypted(this.roomId)){e.next=2;break}return e.abrupt("return",!1);case 2:return e.next=4,this.getEncryptionTargetMembers();case 4:t=e.sent,r=k(t),e.prev=6,r.s();case 8:if((n=r.n()).done){e.next=15;break}if(i=n.value,!this._client.getStoredDevicesForUser(i.userId).some((function(e){return e.isUnverified()}))){e.next=13;break}return e.abrupt("return",!0);case 13:e.next=8;break;case 15:e.next=20;break;case 17:e.prev=17,e.t0=e.catch(6),r.e(e.t0);case 20:return e.prev=20,r.f(),e.finish(20);case 23:return e.abrupt("return",!1);case 24:case"end":return e.stop()}}),e,this,[[6,17,20,23]])}))),T.prototype.getTimelineSets=function(){return this._timelineSets},T.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},T.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},T.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},T.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},T.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},T.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},T.prototype.setSummary=function(e){var t=this,r=e["m.heroes"],n=e["m.joined_member_count"],i=e["m.invited_member_count"];Number.isInteger(n)&&this.currentState.setJoinedMemberCount(n),Number.isInteger(i)&&this.currentState.setInvitedMemberCount(i),Array.isArray(r)&&(this._summaryHeroes=r.filter((function(e){return e!==t.myUserId})))},T.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},T.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},T.prototype.getAvatarUrl=function(e,t,r,n,i){var o=this.currentState.getStateEvents(_.EventType.RoomAvatar,"");if(void 0===i&&(i=!0),!o&&!i)return null;var s=o?o.getContent().url:null;return s?(0,h.getHttpUriForMxc)(e,s,t,r,n):null},T.prototype.getMxcAvatarUrl=function(){var e=this.currentState.getStateEvents(_.EventType.RoomAvatar,"");return e?e.getContent().url:null},T.prototype.getAliases=function(){var e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(var r=function(r){var n=t[r];if(Array.isArray(n.getContent().aliases)){var i=n.getContent().aliases.filter((function(e){return"string"==typeof e&&("#"===e[0]&&!!e.endsWith(":".concat(n.getStateKey())))}));Array.prototype.push.apply(e,i)}},n=0;n<t.length;++n)r(n);return e},T.prototype.getCanonicalAlias=function(){var e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alias||null},T.prototype.getAltAliases=function(){var e=this.currentState.getStateEvents("m.room.canonical_alias","");return e&&e.getContent().alt_aliases||[]},T.prototype.addEventsToTimeline=function(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)},T.prototype.getMember=function(e){return this.currentState.getMember(e)},T.prototype.getMembers=function(){return this.currentState.getMembers()},T.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},T.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},T.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},T.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},T.prototype.getMembersWithMembership=function(e){return this.currentState.getMembers().filter((function(t){return t.membership===e}))},T.prototype.getEncryptionTargetMembers=(0,u.default)(a.default.mark((function e(){var t;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.loadMembersIfNeeded();case 2:return t=this.getMembersWithMembership("join"),this.shouldEncryptForInvitedMembers()&&(t=t.concat(this.getMembersWithMembership("invite"))),e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),T.prototype.shouldEncryptForInvitedMembers=function(){var e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},T.prototype.getDefaultRoomName=function(e){return C(this,e,!0)},T.prototype.hasMembershipState=function(e,t){var r=this.getMember(e);return!!r&&r.membership===t},T.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];var t=Object.assign({filter:e},this._opts),r=new l.EventTimelineSet(this,t);this.reEmitter.reEmit(r,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=r,this._timelineSets.push(r);var n=this.getLiveTimeline();n.getEvents().forEach((function(e){r.addLiveEvent(e)}));for(var i=n;i.getNeighbouringTimeline(d.EventTimeline.BACKWARDS);)i=i.getNeighbouringTimeline(d.EventTimeline.BACKWARDS);return r.getLiveTimeline().setPaginationToken(i.getPaginationToken(d.EventTimeline.BACKWARDS),d.EventTimeline.BACKWARDS),r},T.prototype.removeFilteredTimelineSet=function(e){var t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];var r=this._timelineSets.indexOf(t);r>-1&&this._timelineSets.splice(r,1)},T.prototype._addLiveEvent=function(e,t,r){if(e.isRedaction()){var n=e.event.redacts,i=this.getUnfilteredTimelineSet().findEventById(n);if(i){if(i.makeRedacted(e),i.getStateKey())this.currentState.getStateEvents(i.getType(),i.getStateKey()).getId()===i.getId()&&this.currentState.setStateEvents([i]);this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){var o=this._txnToEvent[e.getUnsigned().transaction_id];if(o)return void this._handleRemoteEcho(e,o)}for(var s=0;s<this._timelineSets.length;s++)this._timelineSets[s].addLiveEvent(e,t,r);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(I(e.sender.userId,e,"m.read"),!0)},T.prototype.addPendingEvent=function(e,t){if(e.status!==p.EventStatus.SENDING&&e.status!==p.EventStatus.NOT_SENT)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(d.EventTimeline.setEventMetadata(e,this.getLiveTimeline().getState(d.EventTimeline.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some((function(e){return e.status===p.EventStatus.NOT_SENT}))&&(y.logger.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(p.EventStatus.NOT_SENT)),this._pendingEventList.push(e),this._savePendingEvents(),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this._pendingEventList&&this._pendingEventList.find((function(e){return e.getId()===r}));n||(n=this.getUnfilteredTimelineSet().findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(var i=0;i<this._timelineSets.length;i++){var o=this._timelineSets[i];o.getFilter()?o.getFilter().filterRoomTimeline([e]).length&&o.addEventToTimeline(e,o.getLiveTimeline(),!1):o.addEventToTimeline(e,o.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},T.prototype._savePendingEvents=function(){var e=this;if(this._pendingEventList){var t=this._pendingEventList.map((function(e){return S(S({},e.event),{},{txn_id:e.getTxnId()})})).filter((function(t){var r="m.room.encrypted"===t.type,n=e._client.isRoomEncrypted(e.roomId);return r||!n})),r=this._client.sessionStore.store;this._pendingEventList.length>0?r.setItem(R(this.roomId),JSON.stringify(t)):r.removeItem(R(this.roomId))}},T.prototype._aggregateNonLiveRelation=function(e){for(var t=0;t<this._timelineSets.length;t++){var r=this._timelineSets[t];r.getFilter()?r.getFilter().filterRoomTimeline([e]).length&&r.aggregateRelations(e):r.aggregateRelations(e)}},T.prototype._handleRemoteEcho=function(e,t){var r=t.getId(),n=e.getId(),i=t.status;y.logger.debug("Got remote echo for event ".concat(r," -> ").concat(n," ")+"old status ".concat(i)),delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&this.removePendingEvent(r),t.handleRemoteEcho(e.event);for(var o=0;o<this._timelineSets.length;o++){this._timelineSets[o].handleRemoteEcho(t,r,n)}this.emit("Room.localEchoUpdated",t,this,r,i)};var x={};function C(e,t,r){if(!r){var n=e.currentState.getStateEvents("m.room.name","");if(n&&n.getContent()&&n.getContent().name)return n.getContent().name}var i=e.getCanonicalAlias();if(!i){var o=e.getAltAliases();o.length&&(i=o[0])}if(i)return i;var s=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1,a=null;if(e._summaryHeroes)a=e._summaryHeroes.map((function(t){var r=e.getMember(t);return r?r.name:t}));else{var u=e.currentState.getMembers().filter((function(e){return e.userId!==t&&("invite"===e.membership||"join"===e.membership)}));u.sort((function(e,t){return e.userId.localeCompare(t.userId)})),a=(u=u.slice(0,5)).map((function(e){return e.name}))}if(s)return O(a,s);if("join"==e.getMyMembership()){var c=e.currentState.getStateEvents("m.room.third_party_invite");if(c&&c.length){var l=c.map((function(e){return e.getContent().display_name}));return"Inviting ".concat(O(l))}}var d=a;return d.length||(d=e.currentState.getMembers().filter((function(e){return e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership})).map((function(e){return e.name}))),d.length?"Empty room (was ".concat(O(d),")"):"Empty room"}function O(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length+1,r=t-1;if(e.length){if(1===e.length&&r<=1)return e[0];if(2===e.length&&r<=2)return"".concat(e[0]," and ").concat(e[1]);var n=r>1;return n?"".concat(e[0]," and ").concat(r," others"):"".concat(e[0]," and 1 other")}return"Empty room"}x[p.EventStatus.ENCRYPTING]=[p.EventStatus.SENDING,p.EventStatus.NOT_SENT],x[p.EventStatus.SENDING]=[p.EventStatus.ENCRYPTING,p.EventStatus.QUEUED,p.EventStatus.NOT_SENT,p.EventStatus.SENT],x[p.EventStatus.QUEUED]=[p.EventStatus.SENDING,p.EventStatus.CANCELLED],x[p.EventStatus.SENT]=[],x[p.EventStatus.NOT_SENT]=[p.EventStatus.SENDING,p.EventStatus.QUEUED,p.EventStatus.CANCELLED],x[p.EventStatus.CANCELLED]=[],T.prototype.updatePendingEvent=function(e,t,r){if(y.logger.log("setting pendingEvent status to ".concat(t," in ").concat(e.getRoomId()," ")+"event ID ".concat(e.getId()," -> ").concat(r)),t==p.EventStatus.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==p.EventStatus.SENT&&this.getUnfilteredTimelineSet().eventIdToTimeline(r))return;var n=e.status,i=e.getId();if(!n)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var s=x[n];if(!s||s.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+n+"->"+t);if(e.setStatus(t),t==p.EventStatus.SENT){e.replaceLocalEventId(r);for(var a=0;a<this._timelineSets.length;a++)this._timelineSets[a].replaceEventId(i,r)}else if(t==p.EventStatus.CANCELLED){if(this._pendingEventList){var u=this._pendingEventList.findIndex((function(e){return e.getId()===i}));if(-1!==u){var c=this._pendingEventList.splice(u,1),l=(0,o.default)(c,1)[0];l.isRedaction()&&this._revertRedactionLocalEcho(l)}}this.removeEvent(i)}this._savePendingEvents(),this.emit("Room.localEchoUpdated",e,this,i,n)},T.prototype._revertRedactionLocalEcho=function(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),r.isRelation()&&this._aggregateNonLiveRelation(r))}},T.prototype.addLiveEvents=function(e,t,r){var n;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(n=0;n<this._timelineSets.length;n++){var i=this._timelineSets[n].getLiveTimeline();if(i.getPaginationToken(d.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a pagination token ("+i.getPaginationToken(d.EventTimeline.FORWARDS)+")");if(i.getNeighbouringTimeline(d.EventTimeline.FORWARDS))throw new Error("live timeline "+n+" is no longer live - it has a neighbouring timeline")}for(n=0;n<e.length;n++)this._addLiveEvent(e[n],t,r)},T.prototype.addEphemeralEvents=function(e){var t,r=k(e);try{for(r.s();!(t=r.n()).done;){var n=t.value;"m.typing"===n.getType()?this.currentState.setTypingEvent(n):"m.receipt"===n.getType()&&this.addReceipt(n)}}catch(e){r.e(e)}finally{r.f()}},T.prototype.removeEvents=function(e){for(var t=0;t<e.length;++t)this.removeEvent(e[t])},T.prototype.removeEvent=function(e){for(var t=!1,r=0;r<this._timelineSets.length;r++){var n=this._timelineSets[r].removeEvent(e);n&&(n.isRedaction()&&this._revertRedactionLocalEcho(n),t=!0)}return t},T.prototype.recalculate=function(){var e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);t&&"invite"===t.getContent().membership&&(t.event.invite_room_state||[]).forEach((function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new p.MatrixEvent({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}));var r=this.name;this.name=C(this,this.myUserId),this.normalizedName=(0,f.normalize)(this.name),this.summary=new v.RoomSummary(this.roomId,{title:this.name}),r!==this.name&&this.emit("Room.name",this)},T.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},T.prototype.getEventReadUpTo=function(e,t){var r=this._receipts;return t&&(r=this._realReceipts),void 0===r["m.read"]||void 0===r["m.read"][e]?null:r["m.read"][e].eventId},T.prototype.hasUserReadEvent=function(e,t){var r=this.getEventReadUpTo(e,!1);if(r===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(var n=this.timeline.length-1;n>=0;--n){var i=this.timeline[n];if(i.getId()===t)return!1;if(i.getId()===r)return!0}return!1},T.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},T.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},T.prototype._addReceiptsToStructure=function(e,t){var r=this;Object.keys(e.getContent()).forEach((function(n){Object.keys(e.getContent()[n]).forEach((function(i){Object.keys(e.getContent()[n][i]).forEach((function(o){var s=e.getContent()[n][i][o];t[i]||(t[i]={});var a=t[i][o];if(a){var u=r.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,n);if(null!==u&&u>=0)return}else t[i][o]={};t[i][o]={eventId:n,data:s}}))}))}))},T.prototype._buildReceiptCache=function(e){var t={};return Object.keys(e).forEach((function(r){Object.keys(e[r]).forEach((function(n){var i=e[r][n];t[i.eventId]||(t[i.eventId]=[]),t[i.eventId].push({userId:n,type:r,data:i.data})}))})),t},T.prototype._addLocalEchoReceipt=function(e,t,r){this.addReceipt(I(e,t,r),!0)},T.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},T.prototype.addAccountData=function(e){for(var t=0;t<e.length;t++){var r=e[t];"m.tag"===r.getType()&&this.addTags(r);var n=this.accountData[r.getType()];this.accountData[r.getType()]=r,this.emit("Room.accountData",r,this,n)}},T.prototype.getAccountData=function(e){return this.accountData[e]},T.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)},T.prototype.canInvite=function(e){var t="join"===this.getMyMembership(),r=this.currentState.getStateEvents(_.EventType.RoomPowerLevels,""),n=r&&r.getContent(),i=this.getMember(e);return n&&i&&n.invite>i.powerLevel&&(t=!1),t},T.prototype.getJoinRule=function(){return this.currentState.getJoinRule()},T.prototype.getType=function(){var e=this.currentState.getStateEvents("m.room.create","");if(e)return e.getContent()[_.RoomCreateTypeField];this.getTypeWarning||(y.logger.warn("[getType] Room "+this.roomId+" does not have an m.room.create event"),this.getTypeWarning=!0)},T.prototype.isSpaceRoom=function(){return this.getType()===_.RoomType.Space}},{"../@types/event":54,"../ReEmitter":57,"../content-repo":62,"../logger":102,"../utils":133,"./event":109,"./event-timeline":108,"./event-timeline-set":107,"./room-member":112,"./room-summary":114,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/defineProperty":9,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,events:36}],116:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SearchResult=i;var n=e("./event-context");function i(e,t){this.rank=e,this.context=t}i.fromJson=function(e,t){var r=e.context||{},o=r.events_before||[],s=r.events_after||[],a=new n.EventContext(t(e.result));return a.setPaginateToken(r.start,!0),a.addEvents(o.map(t),!0),a.addEvents(s.map(t),!1),a.setPaginateToken(r.end,!1),new i(e.rank,a)}},{"./event-context":106}],117:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.User=s;var i=n(e("../utils")),o=e("events");function s(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}i.inherits(s,o.EventEmitter),s.prototype.setPresenceEvent=function(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push("User.currentlyActive"),this.presence=e.getContent().presence,r.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(var n=0;n<r.length;n++)this.emit(r[n],e,this)}},s.prototype.setDisplayName=function(e){var t=this.displayName;this.displayName="string"==typeof e?e:void 0,e!==t&&this._updateModifiedTime()},s.prototype.setRawDisplayName=function(e){this.rawDisplayName="string"==typeof e?e:void 0},s.prototype.setAvatarUrl=function(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},s.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)}},{"../utils":133,"@babel/runtime/helpers/interopRequireWildcard":13,events:36}],118:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.PushProcessor=d;var i=n(e("@babel/runtime/helpers/typeof")),o=e("./utils"),s=e("./logger");function a(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return u(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return u(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var c=["override","content","room","sender","underride"],l=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function d(e){var t=this,r={},n=function(e,t){var r={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":r.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;r.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;r.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return r},i=function(e,t){var r={event_match:h,contains_display_name:l,room_member_count:u,sender_notification_permission:s};return!!r[e.kind]&&r[e.kind](e,t)},s=function(t,r){var n=t.key;if(!n)return!1;var i=e.getRoom(r.getRoomId());return!(!i||!i.currentState)&&i.currentState.mayTriggerNotifOfType(n,r.getSender())},u=function(t,r){if(!t.is)return!1;var n=e.getRoom(r.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var i=n.currentState.getJoinedMemberCount(),o=t.is.match(/^([=<>]*)([0-9]*)$/);if(!o)return!1;var s=o[1],a=parseInt(o[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return i==a;case"<":return i<a;case">":return i>a;case"<=":return i<=a;case">=":return i>=a;default:return!1}},l=function(t,r){var n=r.getContent();if(r.isEncrypted()&&r.getClearContent()&&(n=r.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var i=e.getRoom(r.getRoomId());if(!(i&&i.currentState&&i.currentState.members&&i.currentState.getMember(e.credentials.userId)))return!1;var s=i.currentState.getMember(e.credentials.userId).name,a=new RegExp("(^|\\W)"+(0,o.escapeRegExp)(s)+"(\\W|$)","i");return n.body.search(a)>-1},h=function(e,t){if(!e.key)return!1;var r,n=p(e.key,t);return"string"==typeof n&&(e.value?e.value===n:"string"==typeof e.pattern&&(r="content.body"==e.key?f("(^|\\W)",e.pattern,"(\\W|$)"):f("^",e.pattern,"$"),!!n.match(r)))},f=function(e,t,n){return r[t]||(r[t]=new RegExp(e+(0,o.globToRegexp)(t)+n,"i")),r[t]},p=function(e,t){var r,n=e.split("."),i=n[0];for("content"===i?(r=t.getContent(),n.shift()):"type"===i?(r=t.getType(),n.shift()):r=t.event;n.length>0;){var s=n.shift();if((0,o.isNullOrUndefined)(r[s]))return null;r=r[s]}return r},g=function(r,i){return i?r.getSender()===e.credentials.userId?null:function(e,r){for(var i=0;i<c.length;++i){var o=c[i],s=r[o];if(s)for(var a=0;a<s.length;++a){var u=s[a];if(u.enabled){var l=n(o,u);if(l&&t.ruleMatchesEvent(l,e))return u.kind=o,u}}}return null}(r,i.global):null};this.ruleMatchesEvent=function(e,t){for(var r=!0,n=0;n<e.conditions.length;++n){var o=e.conditions[n];r&=i(o,t)}return r},this.actionsForEvent=function(t){return function(e,t){var r=g(e,t);if(!r)return{};var n=d.actionListToActionsObject(r.actions);return void 0===n.tweaks.highlight&&(n.tweaks.highlight="content"==r.kind),n}(t,e.pushRules)},this.getPushRuleById=function(t){for(var r=0,n=["global"];r<n.length;r++){var i=n[r];if(void 0!==e.pushRules[i]){var o,s=a(c);try{for(s.s();!(o=s.n()).done;){var u=o.value;if(void 0!==e.pushRules[i][u]){var l,d=a(e.pushRules[i][u]);try{for(d.s();!(l=d.n()).done;){var h=l.value;if(h.rule_id===t)return h}}catch(e){d.e(e)}finally{d.f()}}}}catch(e){s.e(e)}finally{s.f()}}}return null}}d.actionListToActionsObject=function(e){for(var t={notify:!1,tweaks:{}},r=0;r<e.length;++r){var n=e[r];"notify"===n?t.notify=!0:"object"===(0,i.default)(n)&&(void 0===n.value&&(n.value=!0),t.tweaks[n.set_tweak]=n.value)}return t},d.rewriteDefaultRules=function(e){var t=JSON.parse(JSON.stringify(e));t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]);var r,n=t.global.override,i=a(l);try{var o=function(){var e=r.value,t=n.find((function(t){return t.rule_id===e.rule_id}));if(t)t.default=e.default,t.conditions=e.conditions,t.actions=e.actions;else{var i=e.rule_id;s.logger.warn("Adding default global override for ".concat(i)),n.push(e)}};for(i.s();!(r=i.n()).done;)o()}catch(e){i.e(e)}finally{i.f()}return t}},{"./logger":102,"./utils":133,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/typeof":24}],119:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.randomUppercaseString=r.randomLowercaseString=r.randomString=void 0;const n="abcdefghijklmnopqrstuvwxyz",i="ABCDEFGHIJKLMNOPQRSTUVWXYZ";function o(e,t){let r="";for(let n=0;n<e;++n)r+=t.charAt(Math.floor(Math.random()*t.length));return r}r.randomString=function(e){return o(e,i+n+"0123456789")},r.randomLowercaseString=function(e){return o(e,n)},r.randomUppercaseString=function(e){return o(e,i)}},{}],120:[function(e,t,r){(function(t){(function(){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.setNow=function(e){a=e||Date.now},r.setTimeout=function(e,t){(t=t||0)<0&&(t=0);var r=Array.prototype.slice.call(arguments,2),n=a()+t,i=o++;var c={runAt:n,func:e,params:r,key:i},d=l(s,(function(e){return e.runAt-n}));return s.splice(d,0,c),u(),i},r.clearTimeout=function(e){if(0===s.length)return;var t;for(t=0;t<s.length;t++){if(s[t].key==e){s.splice(t,1);break}}0===t&&u()};var n,i=e("./logger"),o=0,s=[];var a=Date.now;function u(){n&&t.clearTimeout(n);var e=s[0];if(e){var r=a(),i=Math.min(e.runAt-r,1e3);n=t.setTimeout(c,i)}}function c(){for(var e,r=a(),n=[];;){var o=s[0];if(!o||o.runAt>r)break;(e=s.shift()).key,n.push(e)}u();for(var c=0;c<n.length;c++){e=n[c];try{e.func.apply(t,e.params)}catch(e){i.logger.error("Uncaught exception in callback function",e.stack||e)}}}function l(e,t){for(var r=0,n=e.length;r<n;){var i=r+n>>1;t(e[i])>0?n=i:r=i+1}return r}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":102}],121:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.MatrixScheduler=o;var i=n(e("./utils"));e("./logger");function o(e,t){this.retryAlgorithm=e||o.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||o.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function s(e){e._procFn&&Object.keys(e._queues).filter((function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})).forEach((function(t){e._activeQueues.push(t),c("Spinning up queue: '%s'",t),a(e,t)}))}function a(e,t){var r=function(e,t){var r=e._queues[t];if(!Array.isArray(r))return null;return r[0]}(e,t);if(!r){var n=e._activeQueues.indexOf(t);return n>=0&&e._activeQueues.splice(n,1),void c("Stopping queue '%s' as it is now empty",t)}c("Queue '%s' has %s pending events",t,e._queues[t].length),Promise.resolve().then((function(){return e._procFn(r.event)})).then((function(n){u(e,t),c("Queue '%s' sent event %s",t,r.event.getId()),r.defer.resolve(n),a(e,t)}),(function(n){r.attempts+=1;var i=e.retryAlgorithm(r.event,r.attempts,n);c("retry(%s) err=%s event_id=%s waitTime=%s",r.attempts,n,r.event.getId(),i),-1===i?(c("Queue '%s' giving up on event %s",t,r.event.getId()),u(e,t),r.defer.reject(n),a(e,t)):setTimeout((function(){a(e,t)}),i)}))}function u(e,t){var r=e._queues[t];return Array.isArray(r)?r.shift():null}function c(){false}o.prototype.getQueueForEvent=function(e){var t=this.queueAlgorithm(e);return t&&this._queues[t]?this._queues[t].map((function(e){return e.event})):null},o.prototype.removeEventFromQueue=function(e){var t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;var r=!1;return i.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return r=!0,!0})),r},o.prototype.setProcessFunction=function(e){this._procFn=e,s(this)},o.prototype.queueEvent=function(e){var t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);var r=i.defer();return this._queues[t].push({event:e,defer:r,attempts:0}),c("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),s(this),r.promise},o.RETRY_BACKOFF_RATELIMIT=function(e,t,r){if(400===r.httpStatus||403===r.httpStatus||401===r.httpStatus)return-1;if("rejected"===r.cors)return-1;if("M_TOO_LARGE"===r.name)return-1;if("M_LIMIT_EXCEEDED"===r.name){var n=r.data.retry_after_ms;if(n>0)return n}return t>4?-1:1e3*Math.pow(2,t)},o.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null}},{"./logger":102,"./utils":133,"@babel/runtime/helpers/interopRequireWildcard":13}],122:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SERVICE_TYPES=void 0;var n=Object.freeze({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"});r.SERVICE_TYPES=n},{}],123:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.LocalIndexedDBStoreBackend=k;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=i(e("@babel/runtime/helpers/slicedToArray")),u=e("../sync-accumulator"),c=n(e("../utils")),l=n(e("../indexeddb-helpers")),d=e("../logger");function h(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return f(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return f(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function f(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var p,g,v;function y(e,t,r){var n=e.openCursor(t);return new Promise((function(e,t){var i=[];n.onerror=function(e){t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=function(t){var n=t.target.result;n?(i.push(r(n)),n.continue()):e(i)}}))}function m(e){return new Promise((function(t,r){e.oncomplete=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function _(e){return new Promise((function(t,r){e.onsuccess=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function b(e){return new Promise((function(t,r){e.onsuccess=function(){return t(e)},e.onerror=function(e){return r(e)}}))}function S(e){return _(e).then((function(e){return e.target.result}))}function k(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new u.SyncAccumulator,this._isNewlyCreated=!1}k.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),l.exists(e,t)},k.prototype={connect:function(){var e=this;if(!this._disconnected)return d.logger.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),Promise.resolve();this._disconnected=!1,d.logger.log("LocalIndexedDBStoreBackend.connect: connecting...");var t=this.indexedDB.open(this._dbName,3);return t.onupgradeneeded=function(t){var r=t.target.result,n=t.oldVersion;d.logger.log("LocalIndexedDBStoreBackend.connect: upgrading from ".concat(n)),n<1&&(e._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(r)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(r),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(r)},t.onblocked=function(){d.logger.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},d.logger.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),_(t).then((function(t){return d.logger.log("LocalIndexedDBStoreBackend.connect: connected"),e.db=t.target.result,e.db.onversionchange=function(){e.db.close()},e._init()}))},isNewlyCreated:function(){return Promise.resolve(this._isNewlyCreated)},_init:function(){var e=this;return Promise.all([this._loadAccountData(),this._loadSyncData()]).then((function(t){var r=(0,a.default)(t,2),n=r[0],i=r[1];d.logger.log("LocalIndexedDBStoreBackend: loaded initial data"),e._syncAccumulator.accumulate({next_batch:i.nextBatch,rooms:i.roomsData,groups:i.groupsData,account_data:{events:n}},!0)}))},getOutOfBandMembers:function(e){var t=this;return new Promise((function(r,n){var i=t.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),o=IDBKeyRange.only(e),s=i.openCursor(o),a=[],u=!1;s.onsuccess=function(e){var t=e.target.result;if(!t)return a.length||u?r(a):r(null);var n=t.value;n.oob_written?u=!0:a.push(n),t.continue()},s.onerror=function(e){n(e)}})).then((function(t){return d.logger.log("LL: got ".concat(t&&t.length)+" membershipEvents from storage for room ".concat(e," ...")),t}))},setOutOfBandMembers:(v=(0,s.default)(o.default.mark((function e(t,r){var n,i,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d.logger.log("LL: backend about to store ".concat(r.length)+" members for ".concat(t)),n=this.db.transaction(["oob_membership_events"],"readwrite"),i=n.objectStore("oob_membership_events"),r.forEach((function(e){i.put(e)})),s={room_id:t,oob_written:!0,state_key:0},i.put(s),e.next=8,m(n);case 8:d.logger.log("LL: backend done storing for ".concat(t,"!"));case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)}),clearOutOfBandMembers:(g=(0,s.default)(o.default.mark((function e(t){var r,n,i,s,u,c,l,h,f,p,g,v,y;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),i=n.index("room"),s=IDBKeyRange.only(t),u=S(i.openKeyCursor(s,"next")).then((function(e){return e&&e.primaryKey[1]})),c=S(i.openKeyCursor(s,"prev")).then((function(e){return e&&e.primaryKey[1]})),e.next=8,Promise.all([u,c]);case 8:return l=e.sent,h=(0,a.default)(l,2),f=h[0],p=h[1],g=this.db.transaction(["oob_membership_events"],"readwrite"),v=g.objectStore("oob_membership_events"),y=IDBKeyRange.bound([t,f],[t,p]),d.logger.log("LL: Deleting all users + marker in storage for "+"room ".concat(t,", with key range:"),[t,f],[t,p]),e.next=18,b(v.delete(y));case 18:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)}),clearDatabase:function(){var e=this;return new Promise((function(t,r){d.logger.log("Removing indexeddb instance: ".concat(e._dbName));var n=e.indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){d.logger.log("can't yet delete indexeddb ".concat(e._dbName)+" because it is open elsewhere")},n.onerror=function(e){d.logger.warn("unable to delete js-sdk store indexeddb: ".concat(e.target.error)),t()},n.onsuccess=function(){d.logger.log("Removed indexeddb instance: ".concat(e._dbName)),t()}}))},getSavedSync:function(e){void 0===e&&(e=!0);var t=this._syncAccumulator.getJSON();return t.nextBatch?e?Promise.resolve(c.deepCopy(t)):Promise.resolve(t):Promise.resolve(null)},getNextBatchToken:function(){return Promise.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){var t=this;return Promise.resolve().then((function(){t._syncAccumulator.accumulate(e)}))},syncToDatabase:function(e){var t=this._syncAccumulator.getJSON(!0);return Promise.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,r){var n=this;return d.logger.log("Persisting sync data up to",e),c.promiseTry((function(){var i=n.db.transaction(["sync"],"readwrite");return i.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:r}),m(i)}))},_persistAccountData:function(e){var t=this;return c.promiseTry((function(){for(var r=t.db.transaction(["accountData"],"readwrite"),n=r.objectStore("accountData"),i=0;i<e.length;i++)n.put(e[i]);return m(r)}))},_persistUserPresenceEvents:function(e){var t=this;return c.promiseTry((function(){var r,n=t.db.transaction(["users"],"readwrite"),i=n.objectStore("users"),o=h(e);try{for(o.s();!(r=o.n()).done;){var s=r.value;i.put({userId:s[0],event:s[1]})}}catch(e){o.e(e)}finally{o.f()}return m(n)}))},getUserPresenceEvents:function(){var e=this;return c.promiseTry((function(){return y(e.db.transaction(["users"],"readonly").objectStore("users"),void 0,(function(e){return[e.value.userId,e.value.event]}))}))},_loadAccountData:function(){var e=this;return d.logger.log("LocalIndexedDBStoreBackend: loading account data..."),c.promiseTry((function(){return y(e.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(function(e){return e.value})).then((function(e){return d.logger.log("LocalIndexedDBStoreBackend: loaded account data"),e}))}))},_loadSyncData:function(){var e=this;return d.logger.log("LocalIndexedDBStoreBackend: loading sync data..."),c.promiseTry((function(){return y(e.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(function(e){return e.value})).then((function(e){return d.logger.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&d.logger.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{}}))}))},getClientOptions:function(){var e=this;return Promise.resolve().then((function(){return y(e.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(function(e){if(e.value&&e.value&&e.value.options)return e.value.options})).then((function(e){return e[0]}))}))},storeClientOptions:(p=(0,s.default)(o.default.mark((function e(t){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=this.db.transaction(["client_options"],"readwrite")).objectStore("client_options").put({clobber:"-",options:t}),e.next=5,m(r);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})}},{"../indexeddb-helpers":100,"../logger":102,"../sync-accumulator":129,"../utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27}],124:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.RemoteIndexedDBStoreBackend=o;var n=e("../logger"),i=e("../utils");function o(e,t,r){this._workerScript=e,this._dbName=t,this._workerApi=r,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null}o.prototype={connect:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("connect")}))},clearDatabase:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("clearDatabase")}))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then((function(){n.logger.log("IndexedDB worker is ready")}))),this._startPromise},_doCmd:function(e,t){var r=this;return Promise.resolve().then((function(){var n=r._nextSeq++,o=(0,i.defer)();return r._inFlight[n]=o,r._worker.postMessage({command:e,seq:n,args:t}),o.promise}))},_onWorkerMessage:function(e){var t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void n.logger.error("Got reply from worker with no seq");var r=this._inFlight[t.seq];if(void 0===r)return void n.logger.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)r.resolve(t.result);else{var i=new Error(t.error.message);i.name=t.error.name,r.reject(i)}}else n.logger.warn("Unrecognised message from worker: "+t)}}},{"../logger":102,"../utils":133}],125:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.IndexedDBStore=m;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=i(e("@babel/runtime/helpers/slicedToArray")),u=e("./memory"),c=n(e("../utils")),l=e("events"),d=e("./indexeddb-local-backend.js"),h=e("./indexeddb-remote-backend.js"),f=e("../models/user"),p=e("../models/event"),g=e("../logger");function v(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return y(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function m(e){if(u.MemoryStore.call(this,e),!e.indexedDB)throw new Error("Missing required option: indexedDB");if(e.workerScript){var r=e.workerApi;r||(r=t.Worker),this.backend=new h.RemoteIndexedDBStoreBackend(e.workerScript,e.dbName,r)}else this.backend=new d.LocalIndexedDBStoreBackend(e.indexedDB,e.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}}function _(e,t){return(0,s.default)(o.default.mark((function r(){var n,i,s,a,c=arguments;return o.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:for(n=c.length,i=new Array(n),s=0;s<n;s++)i[s]=c[s];return r.prev=1,r.next=4,e.call.apply(e,[this].concat(i));case 4:return r.abrupt("return",r.sent);case 7:return r.prev=7,r.t0=r.catch(1),g.logger.error("IndexedDBStore failure, degrading to MemoryStore",r.t0),this.emit("degraded",r.t0),r.prev=11,g.logger.log("IndexedDBStore trying to delete degraded data"),r.next=15,this.backend.clearDatabase();case 15:g.logger.log("IndexedDBStore delete after degrading succeeeded"),r.next=21;break;case 18:r.prev=18,r.t1=r.catch(11),g.logger.warn("IndexedDBStore delete after degrading failed",r.t1);case 21:if(Object.setPrototypeOf(this,u.MemoryStore.prototype),!t){r.next=26;break}return r.next=25,(a=u.MemoryStore.prototype[t]).call.apply(a,[this].concat(i));case 25:return r.abrupt("return",r.sent);case 26:case"end":return r.stop()}}),r,this,[[1,7],[11,18]])})))}c.inherits(m,u.MemoryStore),c.extend(m.prototype,l.EventEmitter.prototype),m.exists=function(e,t){return d.LocalIndexedDBStoreBackend.exists(e,t)},m.prototype.startup=function(){var e=this;return this.startedUp?(g.logger.log("IndexedDBStore.startup: already started"),Promise.resolve()):(g.logger.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((function(){return g.logger.log("IndexedDBStore.startup: loading presence events"),e.backend.getUserPresenceEvents()})).then((function(t){g.logger.log("IndexedDBStore.startup: processing presence events"),t.forEach((function(t){var r=(0,a.default)(t,2),n=r[0],i=r[1],o=new f.User(n);i&&o.setPresenceEvent(new p.MatrixEvent(i)),e._userModifiedMap[o.userId]=o.getLastModifiedTime(),e.storeUser(o)}))})))},m.prototype.getSavedSync=_((function(){return this.backend.getSavedSync()}),"getSavedSync"),m.prototype.isNewlyCreated=_((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),m.prototype.getSavedSyncToken=_((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),m.prototype.deleteAllData=_((function(){return u.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then((function(){g.logger.log("Deleted indexeddb data.")}),(function(e){throw g.logger.error("Failed to delete indexeddb data: ".concat(e)),e}))})),m.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},m.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():Promise.resolve()},m.prototype._reallySave=_((function(){this._syncTs=Date.now();var e,t=[],r=v(this.getUsers());try{for(r.s();!(e=r.n()).done;){var n=e.value;this._userModifiedMap[n.userId]!==n.getLastModifiedTime()&&(n.events.presence&&(t.push([n.userId,n.events.presence.event]),this._userModifiedMap[n.userId]=n.getLastModifiedTime()))}}catch(e){r.e(e)}finally{r.f()}return this.backend.syncToDatabase(t)})),m.prototype.setSyncData=_((function(e){return this.backend.setSyncData(e)}),"setSyncData"),m.prototype.getOutOfBandMembers=_((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),m.prototype.setOutOfBandMembers=_((function(e,t){return u.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),m.prototype.clearOutOfBandMembers=_((function(e){return u.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),m.prototype.getClientOptions=_((function(){return this.backend.getClientOptions()}),"getClientOptions"),m.prototype.storeClientOptions=_((function(e){return u.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions")}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":102,"../models/event":109,"../models/user":117,"../utils":133,"./indexeddb-local-backend.js":123,"./indexeddb-remote-backend.js":124,"./memory":126,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/helpers/slicedToArray":22,"@babel/runtime/regenerator":27,events:36}],126:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.MemoryStore=o;var n=e("../models/user");function i(e){return"string"==typeof e&&!!e&&"undefined"!==e&&"null"!==e||"number"==typeof e}function o(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}}o.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return Promise.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return Object.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));var t=this;e.currentState.getMembers().forEach((function(r){t._onRoomMember(null,e.currentState,r)}))},_onRoomMember:function(e,t,r){if("invite"!==r.membership){var i=this.users[r.userId]||new n.User(r.userId);r.name&&(i.setDisplayName(r.name),r.events.member&&i.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&i.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[i.userId]=i}},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return Object.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return Object.values(this.rooms).map((function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return Object.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;var t="mxjssdk_memory_filter_"+e;try{var r=this.localStorage.getItem(t);if(i(r))return r}catch(e){}return null},setFilterIdByName:function(e,t){if(this.localStorage){var r="mxjssdk_memory_filter_"+e;try{i(t)?this.localStorage.setItem(r,t):this.localStorage.removeItem(r)}catch(e){}}},storeAccountDataEvents:function(e){var t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},Promise.resolve()},getOutOfBandMembers:function(e){return Promise.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,Promise.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},Promise.resolve()},getClientOptions:function(){return Promise.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=Object.assign({},e),Promise.resolve()}}},{"../models/user":117}],127:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard");Object.defineProperty(r,"__esModule",{value:!0}),r.WebStorageSessionStore=u;var i=n(e("../../utils"));e("../../logger");function o(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return s(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return s(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,u=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return a=e.done,e},e:function(e){u=!0,o=e},f:function(){try{a||null==r.return||r.return()}finally{if(u)throw o}}}}function s(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}var a="session.e2e.";function u(e){if(this.store=e,!(i.isFunction(e.getItem)&&i.isFunction(e.setItem)&&i.isFunction(e.removeItem)&&i.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}u.prototype={removeEndToEndAccount:function(){this.store.removeItem(c)},getEndToEndAccount:function(){return this.store.getItem(c)},getAllEndToEndDevices:function(){for(var e=f(""),t={},r=0;r<this.store.length;++r){var n=this.store.key(r),i=n.substr(e.length);n.startsWith(e)&&(t[i]=v(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return v(this.store,d)},getEndToEndDeviceSyncToken:function(){return v(this.store,l)},removeEndToEndDeviceData:function(){m(this.store,f("")),m(this.store,d),m(this.store,l)},getEndToEndSessions:function(e){return v(this.store,p(e))},getAllEndToEndSessions:function(){var e,t={},r=o(y(this.store,p("")));try{for(r.s();!(e=r.n()).done;){var n=e.value;t[n.substr(p("").length)]=v(this.store,n)}}catch(e){r.e(e)}finally{r.f()}return t},removeAllEndToEndSessions:function(){m(this.store,p(""))},getAllEndToEndInboundGroupSessionKeys:function(){for(var e=a+"inboundgroupsessions/",t=[],r=0;r<this.store.length;r++){var n=this.store.key(r);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){var r=function(e,t){return a+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(r)},removeAllEndToEndInboundGroupSessions:function(){m(this.store,a+"inboundgroupsessions/")},getAllEndToEndRooms:function(){var e,t={},r=o(y(this.store,g("")));try{for(r.s();!(e=r.n()).done;){var n=e.value;t[n.substr(g("").length)]=v(this.store,n)}}catch(e){r.e(e)}finally{r.f()}return t},removeAllEndToEndRooms:function(){m(this.store,g(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(h,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(h)}};var c=a+"account",l=a+"device_sync_token",d=a+"device_tracking",h=a+"trusted_backup_pubkey";function f(e){return a+"devices/"+e}function p(e){return a+"sessions/"+e}function g(e){return a+"rooms/"+e}function v(e,t){try{return JSON.parse(e.getItem(t))}catch(e){_("Failed to get key %s: %s",t,e),_(e.stack)}return null}function y(e,t){for(var r=[],n=0;n<e.length;++n){var i=e.key(n);i.startsWith(t)&&r.push(i)}return r}function m(e,t){for(var r=[],n=0;n<e.length;++n){var i=e.key(n);i.startsWith(t)&&r.push(i)}for(var o=0,s=r;o<s.length;o++){var a=s[o];e.removeItem(a)}}function _(){false}},{"../../logger":102,"../../utils":133,"@babel/runtime/helpers/interopRequireWildcard":13}],128:[function(e,t,r){"use strict";function n(){this.fromToken=null}Object.defineProperty(r,"__esModule",{value:!0}),r.StubStore=n,n.prototype={isNewlyCreated:function(){return Promise.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return Promise.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return Promise.resolve()},getSavedSync:function(){return Promise.resolve(null)},getSavedSyncToken:function(){return Promise.resolve(null)},deleteAllData:function(){return Promise.resolve()},getOutOfBandMembers:function(){return Promise.resolve(null)},setOutOfBandMembers:function(){return Promise.resolve()},clearOutOfBandMembers:function(){return Promise.resolve()},getClientOptions:function(){return Promise.resolve()},storeClientOptions:function(){return Promise.resolve()}}},{}],129:[function(e,t,r){"use strict";var n=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SyncAccumulator=void 0;var i=n(e("@babel/runtime/helpers/classCallCheck")),o=n(e("@babel/runtime/helpers/createClass")),s=e("./logger"),a=e("./utils"),u=function(){function e(t){(0,i.default)(this,e),(t=t||{}).maxTimelineEntries=t.maxTimelineEntries||50,this.opts=t,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}return(0,o.default)(e,[{key:"accumulate",value:function(e,t){this._accumulateRooms(e,t),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}},{key:"_accumulateAccountData",value:function(e){var t=this;e.account_data&&e.account_data.events&&e.account_data.events.forEach((function(e){t.accountData[e.type]=e}))}},{key:"_accumulateRooms",value:function(e,t){var r=this;e.rooms&&(e.rooms.invite&&Object.keys(e.rooms.invite).forEach((function(n){r._accumulateRoom(n,"invite",e.rooms.invite[n],t)})),e.rooms.join&&Object.keys(e.rooms.join).forEach((function(n){r._accumulateRoom(n,"join",e.rooms.join[n],t)})),e.rooms.leave&&Object.keys(e.rooms.leave).forEach((function(n){r._accumulateRoom(n,"leave",e.rooms.leave[n],t)})))}},{key:"_accumulateRoom",value:function(e,t,r,n){switch(t){case"invite":this._accumulateInviteState(e,r);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,r,n);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:s.logger.error("Unknown cateogory: ",t)}}},{key:"_accumulateInviteState",value:function(e,t){if(t.invite_state&&t.invite_state.events)if(this.inviteRooms[e]){var r=this.inviteRooms[e];t.invite_state.events.forEach((function(e){for(var t=!1,n=0;n<r.invite_state.events.length;n++){var i=r.invite_state.events[n];i.type===e.type&&i.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)}))}else this.inviteRooms[e]={invite_state:t.invite_state}}},{key:"_accumulateJoinState",value:function(e,t,r){this.joinRooms[e]||(this.joinRooms[e]={_currentState:Object.create(null),_timeline:[],_accountData:Object.create(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});var n=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((function(e){n._accountData[e.type]=e})),t.unread_notifications&&(n._unreadNotifications=t.unread_notifications),t.summary){var i="m.heroes",o="m.invited_member_count",s="m.joined_member_count",a=n._summary,u=t.summary;a[i]=u[i]||a[i],a[s]=u[s]||a[s],a[o]=u[o]||a[o]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((function(e){"m.receipt"===e.type&&e.content&&Object.keys(e.content).forEach((function(t){e.content[t]["m.read"]&&Object.keys(e.content[t]["m.read"]).forEach((function(r){n._readReceipts[r]={data:e.content[t]["m.read"][r],eventId:t}}))}))})),t.timeline&&t.timeline.limited&&(n._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((function(e){c(n._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach((function(e,i){var o;if(c(n._currentState,e),r)o=e;else{void 0!==(o=Object.assign({},e)).unsigned&&(o.unsigned=Object.assign({},o.unsigned));var s=e.unsigned?e.unsigned.age:e.age;void 0!==s&&(o._localTs=Date.now()-s)}n._timeline.push({event:o,token:0===i?t.timeline.prev_batch:null})})),n._timeline.length>this.opts.maxTimelineEntries)for(var l=n._timeline.length-this.opts.maxTimelineEntries;l<n._timeline.length;l++)if(n._timeline[l].token){n._timeline=n._timeline.slice(l,n._timeline.length);break}}},{key:"_accumulateGroups",value:function(e){var t=this;e.groups&&(e.groups.invite&&Object.keys(e.groups.invite).forEach((function(r){t._accumulateGroup(r,"invite",e.groups.invite[r])})),e.groups.join&&Object.keys(e.groups.join).forEach((function(r){t._accumulateGroup(r,"join",e.groups.join[r])})),e.groups.leave&&Object.keys(e.groups.leave).forEach((function(r){t._accumulateGroup(r,"leave",e.groups.leave[r])})))}},{key:"_accumulateGroup",value:function(e,t,r){for(var n=0,i=["invite","join","leave"];n<i.length;n++){var o=i[n];delete this.groups[o][e]}this.groups[t][e]=r}},{key:"getJSON",value:function(e){var t=this,r={join:{},invite:{},leave:{}};Object.keys(this.inviteRooms).forEach((function(e){r.invite[e]=t.inviteRooms[e]})),Object.keys(this.joinRooms).forEach((function(n){var i=t.joinRooms[n],o={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,summary:i._summary};Object.keys(i._accountData).forEach((function(e){o.account_data.events.push(i._accountData[e])}));var s={type:"m.receipt",room_id:n,content:{}};Object.keys(i._readReceipts).forEach((function(e){var t=i._readReceipts[e];s.content[t.eventId]||(s.content[t.eventId]={"m.read":{}}),s.content[t.eventId]["m.read"][e]=t.data})),Object.keys(s.content).length>0&&o.ephemeral.events.push(s),i._timeline.forEach((function(t){if(!o.timeline.prev_batch){if(!t.token)return;o.timeline.prev_batch=t.token}var r;!e&&t.event._localTs?(void 0!==(r=Object.assign({},t.event)).unsigned&&(r.unsigned=Object.assign({},r.unsigned)),delete r._localTs,r.unsigned=r.unsigned||{},r.unsigned.age=Date.now()-t.event._localTs):r=t.event,o.timeline.events.push(r)}));for(var u=Object.create(null),l=o.timeline.events.length-1;l>=0;l--){var d=o.timeline.events[l];if(null!==d.state_key&&void 0!==d.state_key){var h=(0,a.deepCopy)(d);h.unsigned&&(h.unsigned.prev_content&&(h.content=h.unsigned.prev_content),h.unsigned.prev_sender&&(h.sender=h.unsigned.prev_sender)),c(u,h)}}Object.keys(i._currentState).forEach((function(e){Object.keys(i._currentState[e]).forEach((function(t){var r=i._currentState[e][t];u[e]&&u[e][t]&&(r=u[e][t]),o.state.events.push(r)}))})),r.join[n]=o}));var n=[];return Object.keys(this.accountData).forEach((function(e){n.push(t.accountData[e])})),{nextBatch:this.nextBatch,roomsData:r,groupsData:this.groups,accountData:n}}},{key:"getNextBatchToken",value:function(){return this.nextBatch}}]),e}();function c(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=Object.create(null)),e[t.type][t.state_key]=t)}r.SyncAccumulator=u},{"./logger":102,"./utils":133,"@babel/runtime/helpers/classCallCheck":6,"@babel/runtime/helpers/createClass":8,"@babel/runtime/helpers/interopRequireDefault":12}],130:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SyncState=void 0,function(e){e.Error="ERROR",e.Prepared="PREPARED",e.Stopped="STOPPED",e.Syncing="SYNCING",e.Catchup="CATCHUP",e.Reconnecting="RECONNECTING"}(r.SyncState||(r.SyncState={}))},{}],131:[function(e,t,r){(function(t){(function(){"use strict";var n=e("@babel/runtime/helpers/interopRequireWildcard"),i=e("@babel/runtime/helpers/interopRequireDefault");Object.defineProperty(r,"__esModule",{value:!0}),r.SyncApi=b;var o=i(e("@babel/runtime/regenerator")),s=i(e("@babel/runtime/helpers/asyncToGenerator")),a=e("./models/user"),u=e("./models/room"),c=e("./models/group"),l=n(e("./utils")),d=e("./filter"),h=e("./models/event-timeline"),f=e("./pushprocessor"),p=e("./logger"),g=e("./errors");function v(e,t){var r;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(r=function(e,t){if(!e)return;if("string"==typeof e)return y(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);"Object"===r&&e.constructor&&(r=e.constructor.name);if("Map"===r||"Set"===r)return Array.from(e);if("Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r))return y(e,t)}(e))||t&&e&&"number"==typeof e.length){r&&(e=r);var n=0,i=function(){};return{s:i,n:function(){return n>=e.length?{done:!0}:{done:!1,value:e[n++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,s=!0,a=!1;return{s:function(){r=e[Symbol.iterator]()},n:function(){var e=r.next();return s=e.done,e},e:function(e){a=!0,o=e},f:function(){try{s||null==r.return||r.return()}finally{if(a)throw o}}}}function y(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}function m(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function _(){p.logger.log.apply(p.logger,arguments)}function b(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoom=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function S(e,t){var r=new a.User(t);return e.reEmitter.reEmit(r,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),r}b.prototype.createRoom=function(e){var t=this.client,r=t.timelineSupport,n=t.unstableClientRelationAggregation,i=new u.Room(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:r,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(i,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(i),i},b.prototype.createGroup=function(e){var t=this.client,r=new c.Group(e);return t.reEmitter.reEmit(r,["Group.profile","Group.myMembership"]),t.store.storeGroup(r),r},b.prototype._registerStateListeners=function(e){var t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,r,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},b.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},b.prototype.syncLeftRooms=function(){var e=this.client,t=this,r=new d.Filter(this.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);var n=this.opts.pollTimeout+8e4,i={timeout:0};return e.getOrCreateFilter(m(e.credentials.userId,"LEFT_ROOMS"),r).then((function(t){return i.filter=t,e.http.authedRequest(void 0,"GET","/sync",i,void 0,n)})).then((function(r){var n=[];r.rooms&&r.rooms.leave&&(n=t._mapSyncResponseToRoomArray(r.rooms.leave));var i=[];return n.forEach((function(r){var n=r.room;if(i.push(n),r.isBrandNewRoom){r.timeline=r.timeline||{};var o=t._mapSyncEventsFormat(r.timeline,n),s=t._mapSyncEventsFormat(r.state,n);n.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,h.EventTimeline.BACKWARDS),t._processRoomEvents(n,s,o),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,o)}})),i}))},b.prototype.peek=function(e){var t=this;if(this._peekRoom&&this._peekRoom.roomId===e)return Promise.resolve(this._peekRoom);var r=this.client;return this._peekRoom=this.createRoom(e),this.client.roomInitialSync(e,20).then((function(e){e.messages=e.messages||{},e.messages.chunk=e.messages.chunk||[],e.state=e.state||[];var n=l.deepCopy(e.state).map(r.getEventMapper()),i=e.state.map(r.getEventMapper()),o=e.messages.chunk.map(r.getEventMapper());return e.presence&&Array.isArray(e.presence)&&e.presence.map(r.getEventMapper()).forEach((function(e){var t=r.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=S(r,e.getContent().user_id)).setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),e.messages.start&&(t._peekRoom.oldState.paginationToken=e.messages.start),t._peekRoom.oldState.setStateEvents(n),t._peekRoom.currentState.setStateEvents(i),t._resolveInvites(t._peekRoom),t._peekRoom.recalculate(),t._peekRoom.addEventsToTimeline(o.reverse(),!0,t._peekRoom.getLiveTimeline(),e.messages.start),r.store.storeRoom(t._peekRoom),r.emit("Room",t._peekRoom),t._peekPoll(t._peekRoom),t._peekRoom}))},b.prototype.stopPeeking=function(){this._peekRoom=null},b.prototype._peekPoll=function(e,t){if(this._peekRoom===e){var r=this;this.client.http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).then((function(t){if(r._peekRoom===e){t.chunk.filter((function(e){return"m.presence"===e.type})).map(r.client.getEventMapper()).forEach((function(e){var t=r.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=S(r.client,e.getContent().user_id)).setPresenceEvent(e),r.client.store.storeUser(t)),r.client.emit("event",e)}));var n=t.chunk.filter((function(t){return t.room_id===e.roomId&&t.event_id})).map(r.client.getEventMapper());e.addLiveEvents(n),r._peekPoll(e,t.end)}else _("Stopped peeking in room %s",e.roomId)}),(function(n){p.logger.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){r._peekPoll(e,t)}),3e4)}))}else _("Stopped peeking in room %s",e.roomId)},b.prototype.getSyncState=function(){return this._syncState},b.prototype.getSyncStateData=function(){return this._syncStateData},b.prototype.recoverFromSyncStartupError=function(){var e=(0,s.default)(o.default.mark((function e(t,r){var n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t;case 2:return n=this._startKeepAlives(),this._updateSyncState("ERROR",{error:r}),e.next=6,n;case 6:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),b.prototype._wasLazyLoadingToggled=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!!t,r=!1,e.next=4,this.client.store.isNewlyCreated();case 4:if(e.sent){e.next=11;break}return e.next=8,this.client.store.getClientOptions();case 8:return(n=e.sent)&&(r=!!n.lazyLoadMembers),e.abrupt("return",r!==t);case 11:return e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}(),b.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(p.logger.warn("Token no longer valid - assuming logout"),this.stop(),!0)},b.prototype.sync=function(){var e=this,r=this.client,n=this;this._running=!0,t.window&&t.window.addEventListener&&(this._onOnlineBound=this._onOnline.bind(this),t.window.addEventListener("online",this._onOnlineBound,!1));var i=Promise.resolve(),a=null;function u(){return c.apply(this,arguments)}function c(){return(c=(0,s.default)(o.default.mark((function e(){var t;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,_("Getting push rules..."),e.next=4,r.getPushRules();case 4:t=e.sent,_("Got push rules"),r.pushRules=t,e.next=19;break;case 9:if(e.prev=9,e.t0=e.catch(0),p.logger.error("Getting push rules failed",e.t0),!n._shouldAbortSync(e.t0)){e.next=14;break}return e.abrupt("return");case 14:return _("Waiting for saved sync before retrying push rules..."),e.next=17,n.recoverFromSyncStartupError(i,e.t0);case 17:return u(),e.abrupt("return");case 19:h();case 20:case"end":return e.stop()}}),e,null,[[0,9]])})))).apply(this,arguments)}function l(){var e=new d.Filter(r.credentials.userId);return e.setTimelineLimit(n.opts.initialSyncLimit),e}var h=function(){var t=(0,s.default)(o.default.mark((function t(){var n,i;return o.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(_("Checking lazy load status..."),e.opts.lazyLoadMembers&&r.isGuest()&&(e.opts.lazyLoadMembers=!1),!e.opts.lazyLoadMembers){t.next=8;break}return _("Checking server lazy load support..."),t.next=6,r.doesServerSupportLazyLoading();case 6:t.sent?(_("Enabling lazy load on sync filter..."),e.opts.filter||(e.opts.filter=l()),e.opts.filter.setLazyLoadMembers(!0)):(_("LL: lazy loading requested but not supported by server, so disabling"),e.opts.lazyLoadMembers=!1);case 8:return _("Checking whether lazy loading has changed in store..."),t.next=11,e._wasLazyLoadingToggled(e.opts.lazyLoadMembers);case 11:if(!t.sent){t.next=19;break}return e._storeIsInvalid=!0,n=g.InvalidStoreError.TOGGLED_LAZY_LOADING,i=new g.InvalidStoreError(n,!!e.opts.lazyLoadMembers),e._updateSyncState("ERROR",{error:i}),p.logger.warn("InvalidStoreError: store is not usable: stopping sync."),t.abrupt("return");case 19:return e.opts.lazyLoadMembers&&e.opts.crypto&&e.opts.crypto.enableLazyLoading(),t.prev=20,_("Storing client options..."),t.next=24,e.client.storeClientOptions();case 24:_("Stored client options"),t.next=31;break;case 27:throw t.prev=27,t.t0=t.catch(20),p.logger.error("Storing client options failed",t.t0),t.t0;case 31:f();case 32:case"end":return t.stop()}}),t,null,[[20,27]])})));return function(){return t.apply(this,arguments)}}();function f(){return v.apply(this,arguments)}function v(){return(v=(0,s.default)(o.default.mark((function e(){var t,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _("Getting filter..."),t=n.opts.filter?n.opts.filter:l(),e.prev=2,e.next=5,r.getOrCreateFilter(m(r.credentials.userId),t);case 5:s=e.sent,e.next=18;break;case 8:if(e.prev=8,e.t0=e.catch(2),p.logger.error("Getting filter failed",e.t0),!n._shouldAbortSync(e.t0)){e.next=13;break}return e.abrupt("return");case 13:return _("Waiting for saved sync before retrying filter..."),e.next=16,n.recoverFromSyncStartupError(i,e.t0);case 16:return f(),e.abrupt("return");case 18:return r.resetNotifTimelineSet(),null===n._currentSyncRequest&&(_("Sending first sync request..."),n._currentSyncRequest=n._doSyncRequest({filterId:s},a)),_("Waiting for saved sync before starting sync processing..."),e.next=23,i;case 23:n._sync({filterId:s});case 24:case"end":return e.stop()}}),e,null,[[2,8]])})))).apply(this,arguments)}r.isGuest()?n._sync({}):(_("Getting saved sync token..."),i=r.store.getSavedSyncToken().then((function(e){return _("Got saved sync token"),a=e,_("Getting saved sync..."),r.store.getSavedSync()})).then((function(e){if(_("Got reply from saved sync, exists? ".concat(!!e)),e)return n._syncFromCache(e)})).catch((function(e){p.logger.error("Getting saved sync failed",e)})),u())},b.prototype.stop=function(){_("SyncApi.stop"),t.window&&(t.window.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},b.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},b.prototype._syncFromCache=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n,i;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return _("sync(): not doing HTTP hit, instead returning stored /sync data"),r=t.nextBatch,this.client.store.setSyncToken(r),n={oldSyncToken:null,nextSyncToken:r,catchingUp:!1,fromCache:!0},i={next_batch:r,rooms:t.roomsData,groups:t.groupsData,account_data:{events:t.accountData}},e.prev=5,e.next=8,this._processSyncResponse(n,i);case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(5),p.logger.error("Error processing cached sync",e.t0.stack||e.t0);case 13:this._storeIsInvalid||this._updateSyncState("PREPARED",n);case 14:case"end":return e.stop()}}),e,this,[[5,10]])})));return function(t){return e.apply(this,arguments)}}(),b.prototype._sync=function(){var e=(0,s.default)(o.default.mark((function e(t){var r,n,i,s;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.client,this._running){e.next=6;break}return _("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),this._updateSyncState("STOPPED"),e.abrupt("return");case 6:return n=r.store.getSyncToken(),e.prev=7,null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(t,n)),e.next=11,this._currentSyncRequest;case 11:i=e.sent,e.next=18;break;case 14:return e.prev=14,e.t0=e.catch(7),this._onSyncError(e.t0,t),e.abrupt("return");case 18:return e.prev=18,this._currentSyncRequest=null,e.finish(18);case 21:return r.store.setSyncToken(i.next_batch),this._failedSyncCount=0,e.next=25,r.store.setSyncData(i);case 25:if(s={oldSyncToken:n,nextSyncToken:i.next_batch,catchingUp:this._catchingUp},!this.opts.crypto){e.next=29;break}return e.next=29,this.opts.crypto.onSyncWillProcess(s);case 29:return e.prev=29,e.next=32,this._processSyncResponse(s,i);case 32:e.next=38;break;case 34:e.prev=34,e.t1=e.catch(29),p.logger.error("Caught /sync error",e.t1.stack||e.t1),this.client.emit("sync.unexpectedError",e.t1);case 38:if(s.catchingUp=this._catchingUp,t.hasSyncedBefore||(this._updateSyncState("PREPARED",s),t.hasSyncedBefore=!0),!this.opts.crypto){e.next=43;break}return e.next=43,this.opts.crypto.onSyncCompleted(s);case 43:if(this._updateSyncState("SYNCING",s),!r.store.wantsSave()){e.next=49;break}if(!this.opts.crypto){e.next=48;break}return e.next=48,this.opts.crypto.saveDeviceList(0);case 48:r.store.save();case 49:this._sync(t);case 50:case"end":return e.stop()}}),e,this,[[7,14,18,21],[29,34]])})));return function(t){return e.apply(this,arguments)}}(),b.prototype._doSyncRequest=function(e,t){var r=this._getSyncParams(e,t);return this.client.http.authedRequest(void 0,"GET","/sync",r,void 0,r.timeout+8e4)},b.prototype._getSyncParams=function(e,t){var r=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,r=0);var n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());var i={filter:n,timeout:r};return this.opts.disablePresence&&(i.set_presence="offline"),t?i.since=t:i._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(i.timeout=0),i},b.prototype._onSyncError=function(e,t){var r=this;if(!this._running)return _("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");p.logger.error("/sync error %s",e),p.logger.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,p.logger.log("Number of consecutive failed sync requests:",this._failedSyncCount),_("Starting keep-alive"),this._startKeepAlives().then((function(e){e&&"ERROR"===r.getSyncState()&&r._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),r._sync(t)})),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},b.prototype._processSyncResponse=function(){var e=(0,s.default)(o.default.mark((function e(t,r){var n,i,a,u,c,d,g,v,y,m;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.client,i=this,r.presence&&Array.isArray(r.presence.events)&&r.presence.events.map(n.getEventMapper()).forEach((function(e){var t=n.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=S(n,e.getSender())).setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)})),r.account_data&&Array.isArray(r.account_data.events)&&(a=r.account_data.events.map(n.getEventMapper()),u=a.reduce((function(e,t){return e[t.getId()]=n.store.getAccountData(t.getType()),e}),{}),n.store.storeAccountDataEvents(a),a.forEach((function(e){if("m.push_rules"===e.getType()){var t=e.getContent();n.pushRules=f.PushProcessor.rewriteDefaultRules(t)}var r=u[e.getId()];return n.emit("accountData",e,r),e}))),r.to_device&&Array.isArray(r.to_device.events)&&r.to_device.events.length>0?(c=[],r.to_device.events.map(n.getEventMapper()).map((function(e){if("m.key.verification.cancel"===e.getType()){var t=e.getContent().transaction_id;t&&c.push(t)}return e})).forEach((function(e){var t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){var r=t.transaction_id;c.includes(r)&&e.flagCancelled()}n.emit("toDeviceEvent",e)}else p.logger.log("Ignoring undecryptable to-device event from "+e.getSender())}))):this._catchingUp=!1,r.groups&&(r.groups.invite&&this._processGroupSyncEntry(r.groups.invite,"invite"),r.groups.join&&this._processGroupSyncEntry(r.groups.join,"join"),r.groups.leave&&this._processGroupSyncEntry(r.groups.leave,"leave")),d=[],g=[],v=[],r.rooms&&(r.rooms.invite&&(d=this._mapSyncResponseToRoomArray(r.rooms.invite)),r.rooms.join&&(g=this._mapSyncResponseToRoomArray(r.rooms.join)),r.rooms.leave&&(v=this._mapSyncResponseToRoomArray(r.rooms.leave))),this._notifEvents=[],d.forEach((function(e){var t=e.room,r=i._mapSyncEventsFormat(e.invite_state,t);i._processRoomEvents(t,r),e.isBrandNewRoom&&(t.recalculate(),n.store.storeRoom(t),n.emit("Room",t)),r.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("invite")})),e.next=14,l.promiseMapSeries(g,function(){var e=(0,s.default)(o.default.mark((function e(r){var a,u,c,d,f,p,g,v,y,m,b;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(b=function(){return(b=(0,s.default)(o.default.mark((function e(t){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.emit("event",t),!t.isState()||"m.room.encryption"!=t.getType()||!i.opts.crypto){e.next=4;break}return e.next=4,i.opts.crypto.onCryptoEvent(t);case 4:t.isState()&&"im.vector.user_status"===t.getType()&&((r=n.store.getUser(t.getStateKey()))?r._unstable_updateStatusMessage(t):((r=S(n,t.getStateKey()))._unstable_updateStatusMessage(t),n.store.storeUser(r)));case 5:case"end":return e.stop()}}),e)})))).apply(this,arguments)},m=function(e){return b.apply(this,arguments)},a=r.room,u=i._mapSyncEventsFormat(r.state,a),c=i._mapSyncEventsFormat(r.timeline,a,!1),d=i._mapSyncEventsFormat(r.ephemeral),f=i._mapSyncEventsFormat(r.account_data),p=n.isRoomEncrypted(a.roomId),r.unread_notifications&&(a.setUnreadNotificationCount("total",r.unread_notifications.notification_count),(!p||p&&a.getUnreadNotificationCount("highlight")<=0)&&a.setUnreadNotificationCount("highlight",r.unread_notifications.highlight_count)),r.timeline=r.timeline||{},!r.isBrandNewRoom){e.next=14;break}a.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,h.EventTimeline.BACKWARDS),e.next=28;break;case 14:if(!r.timeline.limited){e.next=28;break}g=!0,v=c.length-1;case 17:if(!(v>=0)){e.next=27;break}if(y=c[v].getId(),!a.getTimelineForEvent(y)){e.next=24;break}return _("Already have event "+y+" in limited sync - not resetting"),g=!1,c.splice(0,v),e.abrupt("break",27);case 24:v--,e.next=17;break;case 27:g&&(i._deregisterStateListeners(a),a.resetLiveTimeline(r.timeline.prev_batch,i.opts.canResetEntireTimeline(a.roomId)?null:t.oldSyncToken),n.resetNotifTimelineSet(),i._registerStateListeners(a));case 28:return i._processRoomEvents(a,u,c,t.fromCache),r.summary&&a.setSummary(r.summary),a.addEphemeralEvents(d),a.addAccountData(f),a.recalculate(),r.isBrandNewRoom&&(n.store.storeRoom(a),n.emit("Room",a)),i._processEventsForNotifs(a,c),e.next=37,l.promiseMapSeries(u,m);case 37:return e.next=39,l.promiseMapSeries(c,m);case 39:d.forEach((function(e){n.emit("event",e)})),f.forEach((function(e){n.emit("event",e)})),a.updateMyMembership("join"),a.decryptCriticalEvents();case 43:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}());case 14:if(v.forEach((function(e){var t=e.room,r=i._mapSyncEventsFormat(e.state,t),o=i._mapSyncEventsFormat(e.timeline,t),s=i._mapSyncEventsFormat(e.account_data);i._processRoomEvents(t,r,o),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(n.store.storeRoom(t),n.emit("Room",t)),i._processEventsForNotifs(t,o),r.forEach((function(e){n.emit("event",e)})),o.forEach((function(e){n.emit("event",e)})),s.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("leave")})),t.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){n.getNotifTimelineSet().addLiveEvent(e)}))),!r.device_lists){e.next=22;break}if(!this.opts.crypto){e.next=22;break}return e.next=20,this.opts.crypto.handleDeviceListChanges(t,r.device_lists);case 20:e.next=22;break;case 22:this.opts.crypto&&r.device_one_time_keys_count&&(y=r.device_one_time_keys_count.signed_curve25519||0,this.opts.crypto.updateOneTimeKeyCount(y)),this.opts.crypto&&r["org.matrix.msc2732.device_unused_fallback_key_types"]&&(m=r["org.matrix.msc2732.device_unused_fallback_key_types"],this.opts.crypto.setNeedsNewFallback(m instanceof Array&&!m.includes("signed_curve25519")));case 24:case"end":return e.stop()}}),e,this)})));return function(t,r){return e.apply(this,arguments)}}(),b.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);var t=this;return e>0?t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t),e):t._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=l.defer()),this._connectionReturnedDefer.promise},b.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);var t=this;function r(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client.http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).then((function(){r()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(r,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},b.prototype._processGroupSyncEntry=function(e,t){for(var r=0,n=Object.keys(e);r<n.length;r++){var i=n[r],o=e[i],s=this.client.store.getGroup(i),a=null===s;null===s&&(s=this.createGroup(i)),o.profile&&s.setProfile(o.profile.name,o.profile.avatar_url),o.inviter&&s.setInviter({userId:o.inviter}),s.setMyMembership(t),a&&this.client.emit("Group",s)}},b.prototype._mapSyncResponseToRoomArray=function(e){var t=this.client,r=this;return Object.keys(e).map((function(n){var i=e[n],o=t.store.getRoom(n),s=!1;return o||(o=r.createRoom(n),s=!0),i.room=o,i.isBrandNewRoom=s,i}))},b.prototype._mapSyncEventsFormat=function(e,t){var r=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];if(!e||!Array.isArray(e.events))return[];var n=this.client.getEventMapper({decrypt:r});return e.events.map((function(e){return t&&(e.room_id=t.roomId),n(e)}))},b.prototype._resolveInvites=function(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership("invite").forEach((function(r){if(!r._requestedProfileInfo){r._requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?Promise.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).then((function(t){var n=r.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}}))}},b.prototype._processRoomEvents=function(e,t,r,n){var i=e.getLiveTimeline(),o=0==i.getEvents().length;if(o){var s,a=v(t);try{for(a.s();!(s=a.n()).done;){var u=s.value;this.client.getPushActionsForEvent(u)}}catch(e){a.e(e)}finally{a.f()}i.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(r||[],null,n)},b.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(var r=0;r<t.length;r++){var n=this.client.getPushActionsForEvent(t[r]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this._notifEvents.push(t[r])}},b.prototype._getGuestFilter=function(){return"{}"},b.prototype._updateSyncState=function(e,t){var r=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,r,t)},b.prototype._onOnline=function(){_("Browser thinks we are back online"),this._startKeepAlives(0)}}).call(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./errors":95,"./filter":98,"./logger":102,"./models/event-timeline":108,"./models/group":110,"./models/room":115,"./models/user":117,"./pushprocessor":118,"./utils":133,"@babel/runtime/helpers/asyncToGenerator":5,"@babel/runtime/helpers/interopRequireDefault":12,"@babel/runtime/helpers/interopRequireWildcard":13,"@babel/runtime/regenerator":27}],132:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.TimelineWindow=o,r.TimelineIndex=s;var n=e("./models/event-timeline"),i=(e("./logger"),function(){});function o(e,t,r){r=r||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=r.windowLimit||1e3}function s(e,t){this.timeline=e,this.index=t}o.prototype.load=function(e,t){var r=this;t=t||20;var n=function(n){var i,o=n.getEvents();if(e){for(var a=0;a<o.length;a++)if(o[a].getId()==e){i=a;break}if(void 0===i)throw new Error("getEventTimeline result didn't include requested event")}else i=o.length;var u=Math.min(o.length,i+Math.ceil(t/2)),c=Math.max(0,u-t);r._start=new s(n,c-n.getBaseIndex()),r._end=new s(n,u-n.getBaseIndex()),r._eventCount=u-c};if(e){var i=this._timelineSet.getTimelineForEvent(e);return i?(n(i),Promise.resolve(i)):this._client.getEventTimeline(this._timelineSet,e).then(n)}return n(this._timelineSet.getLiveTimeline()),Promise.resolve()},o.prototype.getTimelineIndex=function(e){if(e==n.EventTimeline.BACKWARDS)return this._start;if(e==n.EventTimeline.FORWARDS)return this._end;throw new Error("Invalid direction '"+e+"'")},o.prototype.extend=function(e,t){var r=this.getTimelineIndex(e);if(!r)return i("TimelineWindow: no timeline yet"),!1;var o=e==n.EventTimeline.BACKWARDS?r.retreat(t):r.advance(t);if(o){this._eventCount+=o,i("TimelineWindow: increased cap by "+o+" (now "+this._eventCount+")");var s=this._eventCount-this._windowLimit;return s>0&&this.unpaginate(s,e!=n.EventTimeline.BACKWARDS),!0}return!1},o.prototype.canPaginate=function(e){var t=this.getTimelineIndex(e);if(!t)return i("TimelineWindow: no timeline yet"),!1;if(e==n.EventTimeline.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},o.prototype.paginate=function(e,t,r,o){void 0===r&&(r=!0),void 0===o&&(o=5);var s=this.getTimelineIndex(e);if(!s)return i("TimelineWindow: no timeline yet"),Promise.resolve(!1);if(s.pendingPaginate)return s.pendingPaginate;if(this.extend(e,t))return Promise.resolve(!0);if(!r||0===o)return Promise.resolve(!1);if(!s.timeline.getPaginationToken(e))return i("TimelineWindow: no token"),Promise.resolve(!1);i("TimelineWindow: starting request");var a=this,u=this._client.paginateEventTimeline(s.timeline,{backwards:e==n.EventTimeline.BACKWARDS,limit:t}).finally((function(){s.pendingPaginate=null})).then((function(r){return i("TimelineWindow: request completed with result "+r),!!r&&a.paginate(e,t,!0,o-1)}));return s.pendingPaginate=u,u},o.prototype.unpaginate=function(e,t){var r=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,i("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},o.prototype.getEvents=function(){if(!this._start)return[];for(var e=[],t=this._start.timeline;;){var r=t.getEvents(),i=0,o=r.length;t===this._start.timeline&&(i=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(var s=i;s<o;s++)e.push(r[s]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(n.EventTimeline.FORWARDS)}return e},s.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},s.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},s.prototype.advance=function(e){if(!e)return 0;var t;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?n.EventTimeline.BACKWARDS:n.EventTimeline.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),i("paginate: switched to new neighbour"),this.advance(e)):0},s.prototype.retreat=function(e){return-1*this.advance(-1*e)}},{"./logger":102,"./models/event-timeline":108}],133:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.lexicographicCompare=r.prevString=r.nextString=r.averageBetweenStrings=r.stringToBase=r.baseToString=r.alphabetPad=r.DEFAULT_ALPHABET=r.getCrypto=r.setCrypto=r.chunkPromises=r.promiseTry=r.promiseMapSeries=r.defer=r.isNullOrUndefined=r.sleep=r.ensureNoTrailingSlash=r.globToRegexp=r.escapeRegExp=r.normalize=r.removeHiddenChars=r.isNumber=r.polyfillSuper=r.inherits=r.extend=r.deepCompare=r.deepCopy=r.checkObjectHasNoAdditionalKeys=r.checkObjectHasKeys=r.isFunction=r.removeElement=r.encodeUri=r.encodeParams=void 0;const o=i(e("unhomoglyph"));function s(e){return"string"==typeof e?o.default(e.normalize("NFD").replace(a,"")):""}r.encodeParams=function(e){let t="";for(const r in e)e.hasOwnProperty(r)&&(t+="&"+encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.substring(1)},r.encodeUri=function(e,t){for(const r in t)t.hasOwnProperty(r)&&(e=e.replace(r,encodeURIComponent(t[r])));return e},r.removeElement=function(e,t,r){let n,i;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return i=e[n],e.splice(n,1),i;return!1},r.isFunction=function(e){return"[object Function]"===Object.prototype.toString.call(e)},r.checkObjectHasKeys=function(e,t){for(let r=0;r<t.length;r++)if(!e.hasOwnProperty(t[r]))throw new Error("Missing required key: "+t[r])},r.checkObjectHasNoAdditionalKeys=function(e,t){for(const r in e)if(e.hasOwnProperty(r)&&-1===t.indexOf(r))throw new Error("Unknown key: "+r)},r.deepCopy=function(e){return JSON.parse(JSON.stringify(e))},r.deepCompare=function e(t,r){if(t===r)return!0;if(typeof t!=typeof r)return!1;if("number"==typeof t&&isNaN(t)&&isNaN(r))return!0;if(null===t||null===r)return t===r;if(!(t instanceof Object))return!1;if(t.constructor!==r.constructor||t.prototype!==r.prototype)return!1;if(t instanceof RegExp||t instanceof Date)return t.toString()===r.toString();if(t instanceof Array){if(t.length!==r.length)return!1;for(let n=0;n<t.length;n++)if(!e(t[n],r[n]))return!1}else{let n;for(n in r)if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;for(n in r){if(r.hasOwnProperty(n)!==t.hasOwnProperty(n))return!1;if(!e(t[n],r[n]))return!1}}return!0},r.extend=function(...e){const t=e[0]||{};for(let r=1;r<e.length;r++){const n=e[r];if(n)for(const e in n)t[e]=n[e]}return t},r.inherits=function(e,t){e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},r.polyfillSuper=function(e,t,...r){try{t.call(e,...r)}catch(n){const i=new t(...r);Object.assign(e,i)}},r.isNumber=function(e){return"number"==typeof e&&isFinite(e)},r.removeHiddenChars=s,r.normalize=function(e){return s(e.toLowerCase()).replace(/[\\'!"#$%&()*+,\-./:;<=>?@[\]^_`{|}~\u2000-\u206f\u2e00-\u2e7f]/g,"").toLowerCase()};const a=/[\u2000-\u200F\u202A-\u202F\u0300-\u036f\uFEFF\s]/g;function u(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}let c;function l(e,t,n=r.DEFAULT_ALPHABET){return e.padEnd(t,n[0])}function d(e,t=r.DEFAULT_ALPHABET){var n;const i=BigInt(t.length);if(e<=i)return null!==(n=t[Number(e)-1])&&void 0!==n?n:"";let o=e/i,s=Number(e%i)-1;return s<0&&(o-=BigInt(Math.abs(s)),s=Number(i)-1),d(o,t)+t[s]}function h(e,t=r.DEFAULT_ALPHABET){const n=BigInt(t.length);let i=BigInt(0);for(let r=e.length-1,o=BigInt(0);r>=0;r--,o++){const s=e.charCodeAt(r)-t.charCodeAt(0);i+=BigInt(1+s)*n**o}return i}r.escapeRegExp=u,r.globToRegexp=function(e,t){t="boolean"!=typeof t||t;let r=u(e);return r=r.replace(/\\\*/g,".*"),r=r.replace(/\?/g,"."),t&&(r=r.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,r,n,i){return"["+(t?"^":"")+r.replace(/\\-/,"-")+"]"}))),r},r.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e},r.sleep=function(e,t){return new Promise((r=>{setTimeout(r,e,t)}))},r.isNullOrUndefined=function(e){return null==e},r.defer=function(){let e,t;const r=new Promise(((r,n)=>{e=r,t=n}));return{resolve:e,reject:t,promise:r}},r.promiseMapSeries=function(e,t){return n(this,void 0,void 0,(function*(){for(const r of yield e)yield t(yield r)}))},r.promiseTry=function(e){return new Promise((t=>t(e())))},r.chunkPromises=function(e,t){return n(this,void 0,void 0,(function*(){const r=[];for(let n=0;n<e.length;n+=t)r.push(...yield Promise.all(e.slice(n,n+t).map((e=>e()))));return r}))},r.setCrypto=function(e){c=e},r.getCrypto=function(){return c},r.DEFAULT_ALPHABET=(()=>{let e="";for(let t=32;t<=126;t++)e+=String.fromCharCode(t);return e})(),r.alphabetPad=l,r.baseToString=d,r.stringToBase=h,r.averageBetweenStrings=function(e,t,n=r.DEFAULT_ALPHABET){const i=Math.max(e.length,t.length),o=h(l(e,i,n),n),s=h(l(t,i,n),n),a=(o+s)/BigInt(2);return a===o||a==s?d(a,n)+n[0]:d(a,n)},r.nextString=function(e,t=r.DEFAULT_ALPHABET){return d(h(e,t)+BigInt(1),t)},r.prevString=function(e,t=r.DEFAULT_ALPHABET){return d(h(e,t)-BigInt(1),t)},r.lexicographicCompare=function(e,t){return e<t?-1:e===t?0:1}},{unhomoglyph:51}],134:[function(e,t,r){(function(t){(function(){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r),Object.defineProperty(e,n,{enumerable:!0,get:function(){return t[r]}})}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),o=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&n(t,e,r);return i(t,e),t},s=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.createNewMatrixCall=r.setVideoInput=r.setAudioInput=r.MatrixCall=r.CallError=r.getDesktopCapturerSources=r.CallErrorCode=r.CallEvent=r.CallParty=r.CallDirection=r.CallType=r.CallState=void 0;const a=e("../logger"),u=e("events"),c=o(e("../utils")),l=e("../@types/event"),d=e("../randomstring"),h=e("./callEventTypes"),f=e("./callFeed");var p,g,v,y,m,_,b;!function(e){e.Fledgling="fledgling",e.InviteSent="invite_sent",e.WaitLocalMedia="wait_local_media",e.CreateOffer="create_offer",e.CreateAnswer="create_answer",e.Connecting="connecting",e.Connected="connected",e.Ringing="ringing",e.Ended="ended"}(p=r.CallState||(r.CallState={})),function(e){e.Voice="voice",e.Video="video"}(g=r.CallType||(r.CallType={})),function(e){e.Inbound="inbound",e.Outbound="outbound"}(v=r.CallDirection||(r.CallDirection={})),function(e){e.Local="local",e.Remote="remote"}(y=r.CallParty||(r.CallParty={})),function(e){e.Hangup="hangup",e.State="state",e.Error="error",e.Replaced="replaced",e.LocalHoldUnhold="local_hold_unhold",e.RemoteHoldUnhold="remote_hold_unhold",e.HoldUnhold="hold_unhold",e.FeedsChanged="feeds_changed",e.AssertedIdentityChanged="asserted_identity_changed"}(m=r.CallEvent||(r.CallEvent={})),function(e){e.UserHangup="user_hangup",e.LocalOfferFailed="local_offer_failed",e.NoUserMedia="no_user_media",e.UnknownDevices="unknown_devices",e.SendInvite="send_invite",e.CreateAnswer="create_answer",e.SendAnswer="send_answer",e.SetRemoteDescription="set_remote_description",e.SetLocalDescription="set_local_description",e.AnsweredElsewhere="answered_elsewhere",e.IceFailed="ice_failed",e.InviteTimeout="invite_timeout",e.Replaced="replaced",e.SignallingFailed="signalling_timeout",e.UserBusy="user_busy",e.Transfered="transferred"}(_=r.CallErrorCode||(r.CallErrorCode={})),function(e){e.Audio="audio",e.Video="video"}(b||(b={}));r.getDesktopCapturerSources=function(){return window.electron.getDesktopCapturerSources({thumbnailSize:{height:176,width:312},types:["screen","window"]})};class S extends Error{constructor(e,t,r){super(t+": "+r),this.code=e}}function k(){return Date.now().toString()+d.randomString(16)}r.CallError=S;class E extends u.EventEmitter{constructor(e){super(),this.remoteCandidateBuffer=new Map,this.gotUserMediaForInvite=e=>s(this,void 0,void 0,(function*(){if(this.successor)this.successor.gotUserMediaForAnswer(e);else if(this.callHasEnded())this.stopAllMedia();else{this.localAVStream=e,a.logger.info("Got local AV stream with id "+this.localAVStream.id),this.setState(p.CreateOffer),a.logger.debug("gotUserMediaForInvite -> "+this.type),this.screenSharingStream?(a.logger.debug("Setting screen sharing stream to the local video element"),this.pushNewFeed(this.screenSharingStream,this.client.getUserId(),h.SDPStreamMetadataPurpose.Screenshare)):this.pushNewFeed(e,this.client.getUserId(),h.SDPStreamMetadataPurpose.Usermedia),w(e.getAudioTracks(),!0);for(const t of e.getAudioTracks())a.logger.info("Adding audio track with id "+t.id),this.peerConn.addTrack(t,e);for(const t of(this.screenSharingStream||e).getVideoTracks())a.logger.info("Adding video track with id "+t.id),this.peerConn.addTrack(t,e)}})),this.gotUserMediaForAnswer=e=>s(this,void 0,void 0,(function*(){if(this.callHasEnded())return;this.pushNewFeed(e,this.client.getUserId(),h.SDPStreamMetadataPurpose.Usermedia),this.localAVStream=e,a.logger.info("Got local AV stream with id "+this.localAVStream.id),w(e.getAudioTracks(),!0);for(const t of e.getTracks())this.peerConn.addTrack(t,e);let t;this.setState(p.CreateAnswer);try{t=yield this.peerConn.createAnswer()}catch(e){return a.logger.debug("Failed to create answer: ",e),void this.terminate(y.Local,_.CreateAnswer,!0)}try{yield this.peerConn.setLocalDescription(t),this.setState(p.Connecting),yield new Promise((e=>{setTimeout(e,200)})),this.sendAnswer()}catch(e){return a.logger.debug("Error setting local description!",e),void this.terminate(y.Local,_.SetLocalDescription,!0)}})),this.gotLocalIceCandidate=e=>{if(e.candidate){if(a.logger.debug("Call "+this.callId+" got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),this.callHasEnded())return;""===e.candidate.candidate&&this.sentEndOfCandidates||(this.queueCandidate(e.candidate),""===e.candidate.candidate&&(this.sentEndOfCandidates=!0))}},this.onIceGatheringStateChange=e=>{if(a.logger.debug("ice gathering state changed to "+this.peerConn.iceGatheringState),"complete"===this.peerConn.iceGatheringState&&!this.sentEndOfCandidates){const e={candidate:""};this.queueCandidate(e),this.sentEndOfCandidates=!0}},this.gotLocalOffer=e=>s(this,void 0,void 0,(function*(){if(a.logger.debug("Created offer: ",e),this.callHasEnded())return void a.logger.debug("Ignoring newly created offer on call ID "+this.callId+" because the call has ended");try{yield this.peerConn.setLocalDescription(e)}catch(e){return a.logger.debug("Error setting local description!",e),void this.terminate(y.Local,_.SetLocalDescription,!0)}if("gathering"===this.peerConn.iceGatheringState&&(yield new Promise((e=>{setTimeout(e,200)}))),this.callHasEnded())return;const t=this.state===p.CreateOffer?l.EventType.CallInvite:l.EventType.CallNegotiate,r={lifetime:6e4};this.state===p.CreateOffer?r.offer=this.peerConn.localDescription:r.description=this.peerConn.localDescription,this.client.supportsCallTransfer&&(r.capabilities={"m.call.transferee":!0}),a.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in offer`),this.candidateSendQueue=[];try{yield this.sendVoipEvent(t,r)}catch(e){a.logger.error("Failed to send invite",e),e.event&&this.client.cancelPendingEvent(e.event);let t=_.SignallingFailed,r="Signalling failed";return this.state===p.CreateOffer&&(t=_.SendInvite,r="Failed to send invite"),"UnknownDeviceError"==e.name&&(t=_.UnknownDevices,r="Unknown devices present in the room"),this.emit(m.Error,new S(t,r,e)),void this.terminate(y.Local,t,!1)}this.sendCandidateQueue(),this.state===p.CreateOffer&&(this.inviteOrAnswerSent=!0,this.setState(p.InviteSent),this.inviteTimeout=setTimeout((()=>{this.inviteTimeout=null,this.state===p.InviteSent&&this.hangup(_.InviteTimeout,!1)}),6e4))})),this.getLocalOfferFailed=e=>{a.logger.error("Failed to get local offer",e),this.emit(m.Error,new S(_.LocalOfferFailed,"Failed to get local offer!",e)),this.terminate(y.Local,_.LocalOfferFailed,!1)},this.getUserMediaFailed=e=>{this.successor?this.successor.getUserMediaFailed(e):(a.logger.warn("Failed to get user media - ending call",e),this.emit(m.Error,new S(_.NoUserMedia,"Couldn't start capturing media! Is your microphone set up and does this app have permission?",e)),this.terminate(y.Local,_.NoUserMedia,!1))},this.onIceConnectionStateChanged=()=>{this.callHasEnded()||(a.logger.debug("Call ID "+this.callId+": ICE connection state changed to: "+this.peerConn.iceConnectionState),"connected"==this.peerConn.iceConnectionState?this.setState(p.Connected):"failed"==this.peerConn.iceConnectionState&&this.hangup(_.IceFailed,!1))},this.onSignallingStateChanged=()=>{a.logger.debug("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},this.onTrack=e=>{var t;if(0===e.streams.length)return void a.logger.warn(`Streamless ${e.track.kind} found: ignoring.`);const r=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(r&&e.streams[0].id!==r.id)return void a.logger.warn(`Ignoring new stream ID ${e.streams[0].id}: we already have stream ID ${r.id}`);r||a.logger.info("Got remote stream with id "+e.streams[0].id);const n=e.streams[0];a.logger.debug(`Track id ${e.track.id} of kind ${e.track.kind} added`),this.pushNewFeed(n,this.getOpponentMember().userId,h.SDPStreamMetadataPurpose.Usermedia),a.logger.info("playing remote. stream active? "+n.active)},this.onNegotiationNeeded=()=>s(this,void 0,void 0,(function*(){if(a.logger.info("Negotation is needed!"),this.state===p.CreateOffer||0!==this.opponentVersion){this.makingOffer=!0;try{const e=yield this.peerConn.createOffer();yield this.gotLocalOffer(e)}catch(e){return void this.getLocalOfferFailed(e)}finally{this.makingOffer=!1}}else a.logger.info("Opponent does not support renegotiation: ignoring negotiationneeded event")})),this.onHangupReceived=e=>{a.logger.debug("Hangup received for call ID "+this.callId),this.partyIdMatches(e)||this.state===p.Ringing?this.terminate(y.Remote,e.reason||_.UserHangup,!0):a.logger.info(`Ignoring message from party ID ${e.party_id}: our partner is ${this.opponentPartyId}`)},this.onRejectReceived=e=>{a.logger.debug("Reject received for call ID "+this.callId);[p.InviteSent,p.Ringing].includes(this.state)||this.state===p.Fledgling&&this.direction===v.Inbound?this.terminate(y.Remote,e.reason||_.UserHangup,!0):a.logger.debug(`Call is in state: ${this.state}: ignoring reject`)},this.onAnsweredElsewhere=e=>{a.logger.debug("Call ID "+this.callId+" answered elsewhere"),this.terminate(y.Remote,_.AnsweredElsewhere,!0)},this.roomId=e.roomId,this.client=e.client,this.type=null,this.forceTURN=e.forceTURN,this.ourPartyId=this.client.deviceId,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:["stun:turn.matrix.org"]});for(const e of this.turnServers)c.checkObjectHasKeys(e,["urls"]);this.callId=k(),this.state=p.Fledgling,this.candidateSendQueue=[],this.candidateSendTries=0,this.sentEndOfCandidates=!1,this.inviteOrAnswerSent=!1,this.makingOffer=!1,this.remoteOnHold=!1,this.micMuted=!1,this.vidMuted=!1,this.feeds=[]}placeVoiceCall(){return s(this,void 0,void 0,(function*(){a.logger.debug("placeVoiceCall"),this.checkForErrorListener();const e=I(b.Audio);this.type=g.Voice,yield this.placeCallWithConstraints(e)}))}placeVideoCall(){return s(this,void 0,void 0,(function*(){a.logger.debug("placeVideoCall"),this.checkForErrorListener();const e=I(b.Video);this.type=g.Video,yield this.placeCallWithConstraints(e)}))}placeScreenSharingCall(e){var t;return s(this,void 0,void 0,(function*(){a.logger.debug("placeScreenSharingCall"),this.checkForErrorListener();try{const r=yield function(e){var t;return s(this,void 0,void 0,(function*(){if((null===(t=window.electron)||void 0===t?void 0:t.getDesktopCapturerSources)&&e){a.logger.debug("Electron getDesktopCapturerSources() is available...");const t=yield e();return t?{audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t.id}}}:null}return a.logger.debug("Electron desktopCapturer is not available..."),{audio:!1,video:!0}}))}(e);if(!r)return void this.terminate(y.Local,_.NoUserMedia,!1);(null===(t=window.electron)||void 0===t?void 0:t.getDesktopCapturerSources)?(a.logger.debug("Getting screen stream using getUserMedia()..."),this.screenSharingStream=yield navigator.mediaDevices.getUserMedia(r)):(a.logger.debug("Getting screen stream using getDisplayMedia()..."),this.screenSharingStream=yield navigator.mediaDevices.getDisplayMedia(r)),a.logger.debug("Got screen stream, requesting audio stream...");const n=I(b.Audio);this.placeCallWithConstraints(n)}catch(e){this.emit(m.Error,new S(_.NoUserMedia,"Failed to get screen-sharing stream: ",e)),this.terminate(y.Local,_.NoUserMedia,!1)}this.type=g.Video}))}getOpponentMember(){return this.opponentMember}opponentCanBeTransferred(){return Boolean(this.opponentCaps&&this.opponentCaps["m.call.transferee"])}getRemoteAssertedIdentity(){return this.remoteAssertedIdentity}getFeeds(){return this.feeds}getLocalFeeds(){return this.feeds.filter((e=>e.isLocal()))}getRemoteFeeds(){return this.feeds.filter((e=>!e.isLocal()))}noIncomingFeeds(){return!this.feeds.some((e=>!e.isLocal()))}pushNewFeed(e,t,r){const n=this.feeds.find((t=>t.stream.id===e.id));n?n.setNewStream(e):(this.feeds.push(new f.CallFeed(e,t,r,this.client,this.roomId)),this.emit(m.FeedsChanged,this.feeds))}deleteAllFeeds(){this.feeds=[],this.emit(m.FeedsChanged,this.feeds)}getCurrentCallStats(){return s(this,void 0,void 0,(function*(){return this.callHasEnded()?this.callStatsAtEnd:this.collectCallStats()}))}collectCallStats(){return s(this,void 0,void 0,(function*(){if(!this.peerConn)return;const e=yield this.peerConn.getStats(),t=[];for(const r of e)t.push(r[1]);return t}))}initWithInvite(e){var t;return s(this,void 0,void 0,(function*(){const r=e.getContent();this.direction=v.Inbound;(yield this.client.checkTurnServers())||a.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection(),this.chooseOpponent(e);try{yield this.peerConn.setRemoteDescription(r.offer),yield this.addBufferedIceCandidates()}catch(e){return a.logger.debug("Failed to set remote description",e),void this.terminate(y.Local,_.SetRemoteDescription,!1)}const n=null===(t=this.feeds.find((e=>!e.isLocal())))||void 0===t?void 0:t.stream;if(!n||0===n.getTracks().length)return a.logger.error("No remote stream or no tracks after setting remote description!"),void this.terminate(y.Local,_.SetRemoteDescription,!1);this.type=n.getTracks().some((e=>"video"===e.kind))?g.Video:g.Voice,this.setState(p.Ringing),e.getLocalAge()&&setTimeout((()=>{this.state==p.Ringing&&(a.logger.debug("Call invite has expired. Hanging up."),this.hangupParty=y.Remote,this.setState(p.Ended),this.stopAllMedia(),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit(m.Hangup))}),r.lifetime-e.getLocalAge())}))}initWithHangup(e){this.setState(p.Ended)}answer(){return s(this,void 0,void 0,(function*(){if(!this.inviteOrAnswerSent)if(a.logger.debug(`Answering call ${this.callId} of type ${this.type}`),this.localAVStream||this.waitForLocalAVStream)this.localAVStream?this.gotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&this.setState(p.WaitLocalMedia);else{const e=I(this.type==g.Video?b.Video:b.Audio);a.logger.log("Getting user media with constraints",e),this.setState(p.WaitLocalMedia),this.waitForLocalAVStream=!0;try{const t=yield navigator.mediaDevices.getUserMedia(e);this.waitForLocalAVStream=!1,this.gotUserMediaForAnswer(t)}catch(e){return void this.getUserMediaFailed(e)}}}))}replacedBy(e){a.logger.debug(this.callId+" being replaced by "+e.callId),this.state===p.WaitLocalMedia?(a.logger.debug("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):(this.state===p.CreateOffer||this.state===p.InviteSent)&&(a.logger.debug("Handing local stream to new call"),e.gotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),this.successor=e,this.emit(m.Replaced,e),this.hangup(_.Replaced,!0)}hangup(e,t){if(this.callHasEnded())return;if(a.logger.debug("Ending call "+this.callId),this.terminate(y.Local,e,!t),this.state===p.WaitLocalMedia)return;const r={};e!==_.UserHangup&&(r.reason=e),this.sendVoipEvent(l.EventType.CallHangup,r)}reject(){if(this.state!==p.Ringing)throw Error("Call must be in 'ringing' state to reject!");if(this.opponentVersion<1)return a.logger.info(`Opponent version is less than 1 (${this.opponentVersion}): sending hangup instead of reject`),void this.hangup(_.UserHangup,!0);a.logger.debug("Rejecting call: "+this.callId),this.terminate(y.Local,_.UserHangup,!0),this.sendVoipEvent(l.EventType.CallReject,{})}setLocalVideoMuted(e){this.vidMuted=e,this.updateMuteStatus()}isLocalVideoMuted(){return this.vidMuted}setMicrophoneMuted(e){this.micMuted=e,this.updateMuteStatus()}isMicrophoneMuted(){return this.micMuted}isRemoteOnHold(){return this.remoteOnHold}setRemoteOnHold(e){if(this.isRemoteOnHold()!==e){this.remoteOnHold=e;for(const t of this.peerConn.getTransceivers())t.direction=e?"sendonly":"sendrecv";this.updateMuteStatus(),this.emit(m.RemoteHoldUnhold,this.remoteOnHold)}}isLocalOnHold(){if(this.state!==p.Connected)return!1;let e=!0;for(const t of this.peerConn.getTransceivers()){["inactive","recvonly"].includes(t.currentDirection)||(e=!1)}return e}sendDtmfDigit(e){for(const t of this.peerConn.getSenders())if("audio"===t.track.kind&&t.dtmf)return void t.dtmf.insertDTMF(e);throw new Error("Unable to find a track to send DTMF on")}updateMuteStatus(){if(!this.localAVStream)return;const e=this.micMuted||this.remoteOnHold;w(this.localAVStream.getAudioTracks(),!e);const t=this.vidMuted||this.remoteOnHold;w(this.localAVStream.getVideoTracks(),!t)}sendAnswer(){return s(this,void 0,void 0,(function*(){const e={answer:{sdp:this.peerConn.localDescription.sdp,type:this.peerConn.localDescription.type}};this.client.supportsCallTransfer&&(e.capabilities={"m.call.transferee":!0}),a.logger.info(`Discarding ${this.candidateSendQueue.length} candidates that will be sent in answer`),this.candidateSendQueue=[];try{yield this.sendVoipEvent(l.EventType.CallAnswer,e),this.inviteOrAnswerSent=!0}catch(e){this.setState(p.Ringing),this.client.cancelPendingEvent(e.event);let t=_.SendAnswer,r="Failed to send answer";throw"UnknownDeviceError"==e.name&&(t=_.UnknownDevices,r="Unknown devices present in the room"),this.emit(m.Error,new S(t,r,e)),e}this.sendCandidateQueue()}))}onRemoteIceCandidatesReceived(e){return s(this,void 0,void 0,(function*(){if(this.callHasEnded())return;const t=e.getContent().candidates;if(!t)return void a.logger.info("Ignoring candidates event with no candidates!");const r=0===e.getContent().version?null:e.getContent().party_id||null;if(void 0===this.opponentPartyId){a.logger.info(`Bufferring ${t.length} candidates until we pick an opponent`);const e=this.remoteCandidateBuffer.get(r)||[];return e.push(...t),void this.remoteCandidateBuffer.set(r,e)}this.partyIdMatches(e.getContent())?yield this.addIceCandidates(t):a.logger.info(`Ignoring candidates from party ID ${e.getContent().party_id}: we have chosen party ID ${this.opponentPartyId}`)}))}onAnswerReceived(e){return s(this,void 0,void 0,(function*(){if(a.logger.debug(`Got answer for call ID ${this.callId} from party ID ${e.getContent().party_id}`),this.callHasEnded())a.logger.debug(`Ignoring answer because call ID ${this.callId} has ended`);else if(void 0===this.opponentPartyId){this.chooseOpponent(e),yield this.addBufferedIceCandidates(),this.setState(p.Connecting);try{yield this.peerConn.setRemoteDescription(e.getContent().answer)}catch(e){return a.logger.debug("Failed to set remote description",e),void this.terminate(y.Local,_.SetRemoteDescription,!1)}if(null!==this.opponentPartyId)try{yield this.sendVoipEvent(l.EventType.CallSelectAnswer,{selected_party_id:this.opponentPartyId})}catch(e){a.logger.warn("Failed to send select_answer event",e)}}else a.logger.info(`Ignoring answer from party ID ${e.getContent().party_id}: we already have an answer/reject from ${this.opponentPartyId}`)}))}onSelectAnswerReceived(e){return s(this,void 0,void 0,(function*(){if(this.direction!==v.Inbound)return void a.logger.warn("Got select_answer for an outbound call: ignoring");const t=e.getContent().selected_party_id;null!=t?t!==this.ourPartyId&&(a.logger.info(`Got select_answer for party ID ${t}: we are party ID ${this.ourPartyId}.`),this.terminate(y.Remote,_.AnsweredElsewhere,!0)):a.logger.warn("Got nonsensical select_answer with null/undefined selected_party_id: ignoring")}))}onNegotiateReceived(e){return s(this,void 0,void 0,(function*(){const t=e.getContent().description;if(!t||!t.sdp||!t.type)return void a.logger.info("Ignoring invalid m.call.negotiate event");const r=this.direction===v.Inbound,n="offer"===t.type&&(this.makingOffer||"stable"!=this.peerConn.signalingState);if(this.ignoreOffer=!r&&n,this.ignoreOffer)return void a.logger.info("Ignoring colliding negotiate event because we're impolite");const i=this.isLocalOnHold();try{if(yield this.peerConn.setRemoteDescription(t),"offer"===t.type){const e=yield this.peerConn.createAnswer();yield this.peerConn.setLocalDescription(e),this.sendVoipEvent(l.EventType.CallNegotiate,{description:this.peerConn.localDescription})}}catch(e){a.logger.warn("Failed to complete negotiation",e)}const o=this.isLocalOnHold();i!==o&&(this.emit(m.LocalHoldUnhold,o),this.emit(m.HoldUnhold,o))}))}onAssertedIdentityReceived(e){return s(this,void 0,void 0,(function*(){e.getContent().asserted_identity&&(this.remoteAssertedIdentity={id:e.getContent().asserted_identity.id,displayName:e.getContent().asserted_identity.display_name},this.emit(m.AssertedIdentityChanged))}))}callHasEnded(){return this.state===p.Ended}setState(e){const t=this.state;this.state=e,this.emit(m.State,e,t)}sendVoipEvent(e,t){return this.client.sendEvent(this.roomId,e,Object.assign({},t,{version:1,call_id:this.callId,party_id:this.ourPartyId}))}queueCandidate(e){if(this.candidateSendQueue.push(e),this.state===p.Ringing||!this.inviteOrAnswerSent)return;const t=this.direction===v.Inbound?500:2e3;0===this.candidateSendTries&&setTimeout((()=>{this.sendCandidateQueue()}),t)}transfer(e){return s(this,void 0,void 0,(function*(){const t=yield this.client.getProfileInfo(e),r=k(),n={replacement_id:k(),target_user:{id:e,display_name:t.display_name,avatar_url:t.avatar_url},create_call:r};yield this.sendVoipEvent(l.EventType.CallReplaces,n),yield this.terminate(y.Local,_.Transfered,!0)}))}transferToCall(e){return s(this,void 0,void 0,(function*(){const t=yield this.client.getProfileInfo(e.getOpponentMember().userId),r=yield this.client.getProfileInfo(this.getOpponentMember().userId),n=k(),i={replacement_id:k(),target_user:{id:this.getOpponentMember().userId,display_name:r.display_name,avatar_url:r.avatar_url},await_call:n};yield e.sendVoipEvent(l.EventType.CallReplaces,i);const o={replacement_id:k(),target_user:{id:e.getOpponentMember().userId,display_name:t.display_name,avatar_url:t.avatar_url},create_call:n};yield this.sendVoipEvent(l.EventType.CallReplaces,o),yield this.terminate(y.Local,_.Replaced,!0),yield e.terminate(y.Local,_.Transfered,!0)}))}terminate(e,t,r){return s(this,void 0,void 0,(function*(){this.callHasEnded()||(this.callStatsAtEnd=yield this.collectCallStats(),this.inviteTimeout&&(clearTimeout(this.inviteTimeout),this.inviteTimeout=null),t!==_.Replaced&&this.stopAllMedia(),this.deleteAllFeeds(),this.hangupParty=e,this.hangupReason=t,this.setState(p.Ended),this.peerConn&&"closed"!==this.peerConn.signalingState&&this.peerConn.close(),r&&this.emit(m.Hangup,this))}))}stopAllMedia(){a.logger.debug(`stopAllMedia (stream=${this.localAVStream})`);for(const e of this.feeds)for(const t of e.stream.getTracks())t.stop()}checkForErrorListener(){if(0===this.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")}sendCandidateQueue(){return s(this,void 0,void 0,(function*(){if(0===this.candidateSendQueue.length)return;const e=this.candidateSendQueue;this.candidateSendQueue=[],++this.candidateSendTries;const t={candidates:e};a.logger.debug("Attempting to send "+e.length+" candidates");try{yield this.sendVoipEvent(l.EventType.CallCandidates,t)}catch(t){if(t.event&&this.client.cancelPendingEvent(t.event),this.candidateSendQueue.push(...e),this.candidateSendTries>5){a.logger.debug("Failed to send candidates on attempt "+this.candidateSendTries+". Giving up on this call.",t);const e=_.SignallingFailed,r="Signalling failed";return this.emit(m.Error,new S(e,r,t)),void this.hangup(e,!1)}const r=500*Math.pow(2,this.candidateSendTries);++this.candidateSendTries,a.logger.debug("Failed to send candidates. Retrying in "+r+"ms",t),setTimeout((()=>{this.sendCandidateQueue()}),r)}}))}placeCallWithConstraints(e){return s(this,void 0,void 0,(function*(){a.logger.log("Getting user media with constraints",e),this.client.callEventHandler.calls.set(this.callId,this),this.setState(p.WaitLocalMedia),this.direction=v.Outbound,this.config=e;(yield this.client.checkTurnServers())||a.logger.warn("Failed to get TURN credentials! Proceeding with call anyway..."),this.peerConn=this.createPeerConnection();try{const t=yield navigator.mediaDevices.getUserMedia(e);this.gotUserMediaForInvite(t)}catch(e){return void this.getUserMediaFailed(e)}}))}createPeerConnection(){const e=new window.RTCPeerConnection({iceTransportPolicy:this.forceTURN?"relay":void 0,iceServers:this.turnServers,iceCandidatePoolSize:this.client.iceCandidatePoolSize});return e.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChanged),e.addEventListener("signalingstatechange",this.onSignallingStateChanged),e.addEventListener("icecandidate",this.gotLocalIceCandidate),e.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.addEventListener("track",this.onTrack),e.addEventListener("negotiationneeded",this.onNegotiationNeeded),e}partyIdMatches(e){return(0===e.version?null:e.party_id||null)===this.opponentPartyId}chooseOpponent(e){const t=e.getContent();a.logger.debug(`Choosing party ID ${t.party_id} for call ID ${this.callId}`),this.opponentVersion=t.version,0===this.opponentVersion?this.opponentPartyId=null:this.opponentPartyId=t.party_id||null,this.opponentCaps=t.capabilities||{},this.opponentMember=e.sender}addBufferedIceCandidates(){return s(this,void 0,void 0,(function*(){const e=this.remoteCandidateBuffer.get(this.opponentPartyId);e&&(a.logger.info(`Adding ${e.length} buffered candidates for opponent ${this.opponentPartyId}`),yield this.addIceCandidates(e)),this.remoteCandidateBuffer=null}))}addIceCandidates(e){return s(this,void 0,void 0,(function*(){for(const t of e)if(null!==t.sdpMid&&void 0!==t.sdpMid||null!==t.sdpMLineIndex&&void 0!==t.sdpMLineIndex){a.logger.debug("Call "+this.callId+" got remote ICE "+t.sdpMid+" candidate: "+t.candidate);try{yield this.peerConn.addIceCandidate(t)}catch(e){this.ignoreOffer||a.logger.info("Failed to add remote ICE candidate",e)}}else a.logger.debug("Ignoring remote ICE candidate with no sdpMid or sdpMLineIndex")}))}}function w(e,t){for(let r=0;r<e.length;r++)e[r].enabled=t}function I(e){const t=!!navigator.webkitGetUserMedia;switch(e){case b.Audio:return{audio:{deviceId:T?{ideal:T}:void 0},video:!1};case b.Video:return{audio:{deviceId:T?{ideal:T}:void 0},video:{deviceId:R?{ideal:R}:void 0,width:t?{exact:640}:{ideal:640},height:t?{exact:360}:{ideal:360}}}}}let T,R;r.MatrixCall=E,r.setAudioInput=function(e){T=e},r.setVideoInput=function(e){R=e},r.createNewMatrixCall=function(e,r,n){if("undefined"==typeof window||"undefined"==typeof document)return null;try{if(!Boolean(window.RTCPeerConnection||window.RTCSessionDescription||window.RTCIceCandidate||navigator.mediaDevices))return"test"!==t.env.NODE_ENV&&a.logger.error("WebRTC is not supported in this browser / environment"),null}catch(e){return a.logger.error("Exception thrown when trying to access WebRTC",e),null}const i=!!n&&n.forceTURN,o={client:e,roomId:r,turnServers:e.getTurnServers(),forceTURN:e.forceTURN||i},s=new E(o);return e.reEmitter.reEmit(s,Object.values(m)),s}}).call(this)}).call(this,e("_process"))},{"../@types/event":54,"../logger":102,"../randomstring":119,"../utils":133,"./callEventTypes":136,"./callFeed":137,_process:39,events:36}],135:[function(e,t,r){"use strict";var n=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{u(n.next(e))}catch(e){o(e)}}function a(e){try{u(n.throw(e))}catch(e){o(e)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}u((n=n.apply(e,t||[])).next())}))};Object.defineProperty(r,"__esModule",{value:!0}),r.CallEventHandler=void 0;const i=e("../logger"),o=e("./call"),s=e("../@types/event");r.CallEventHandler=class{constructor(e){this.evaluateEventBuffer=()=>n(this,void 0,void 0,(function*(){if("SYNCING"===this.client.getSyncState()){yield Promise.all(this.callEventBuffer.map((e=>{this.client.decryptEventIfNeeded(e)})));const e=new Set;for(const t of this.callEventBuffer)t.getType()!==s.EventType.CallAnswer&&t.getType()!==s.EventType.CallHangup||e.add(t.getContent().call_id);for(const t of this.callEventBuffer)if(t.getType()!==s.EventType.CallInvite||!e.has(t.getContent().call_id))try{this.handleCallEvent(t)}catch(e){i.logger.error("Caught exception handling call event",e)}this.callEventBuffer=[]}})),this.onEvent=e=>{this.client.decryptEventIfNeeded(e),(this.eventIsACall(e)||e.isBeingDecrypted())&&this.callEventBuffer.push(e),(e.isBeingDecrypted()||e.isDecryptionFailure())&&e.once("Event.decrypted",(()=>{if(this.eventIsACall(e))if(this.callEventBuffer.includes(e))this.evaluateEventBuffer();else try{this.handleCallEvent(e)}catch(e){i.logger.error("Caught exception handling call event",e)}}))},this.client=e,this.calls=new Map,this.callEventBuffer=[],this.candidateEventsByCall=new Map}start(){this.client.on("sync",this.evaluateEventBuffer),this.client.on("event",this.onEvent)}stop(){this.client.removeListener("sync",this.evaluateEventBuffer),this.client.removeListener("event",this.onEvent)}eventIsACall(e){const t=e.getType();return t.startsWith("m.call.")||t.startsWith("org.matrix.call.")}handleCallEvent(e){const t=e.getContent();let r=t.call_id?this.calls.get(t.call_id):void 0;if(e.getType()===s.EventType.CallInvite){if(e.getSender()===this.client.credentials.userId)return;if(e.getLocalAge()>t.lifetime-3e3)return;if(r&&r.state===o.CallState.Ended)return;r&&i.logger.log(`WARN: Already have a MatrixCall with id ${t.call_id} but got an invite. Clobbering.`);const n=this.client.getTurnServersExpiry()-Date.now();if(i.logger.info("Current turn creds expire in "+n+" ms"),r=o.createNewMatrixCall(this.client,e.getRoomId(),{forceTURN:this.client.forceTURN}),!r)return void i.logger.log("Incoming call ID "+t.call_id+" but this client doesn't support WebRTC");if(r.callId=t.call_id,r.initWithInvite(e),this.calls.set(r.callId,r),this.candidateEventsByCall.get(r.callId))for(const e of this.candidateEventsByCall.get(r.callId))r.onRemoteIceCandidatesReceived(e);let s;for(const e of this.calls.values()){const t=[o.CallState.WaitLocalMedia,o.CallState.CreateOffer,o.CallState.InviteSent].includes(e.state);if(r.roomId===e.roomId&&e.direction===o.CallDirection.Outbound&&t){s=e;break}}s?s.state===o.CallState.WaitLocalMedia||s.state===o.CallState.CreateOffer||s.callId>r.callId?(i.logger.log("Glare detected: answering incoming call "+r.callId+" and canceling outgoing call "+s.callId),s.replacedBy(r),r.answer()):(i.logger.log("Glare detected: rejecting incoming call "+r.callId+" and keeping outgoing call "+s.callId),r.hangup(o.CallErrorCode.Replaced,!0)):this.client.emit("Call.incoming",r)}else if(e.getType()===s.EventType.CallAnswer){if(!r)return;e.getSender()===this.client.credentials.userId?r.state===o.CallState.Ringing&&r.onAnsweredElsewhere(t):r.onAnswerReceived(e)}else if(e.getType()===s.EventType.CallCandidates){if(e.getSender()===this.client.credentials.userId)return;r?r.onRemoteIceCandidatesReceived(e):(this.candidateEventsByCall.has(t.call_id)||this.candidateEventsByCall.set(t.call_id,[]),this.candidateEventsByCall.get(t.call_id).push(e))}else if([s.EventType.CallHangup,s.EventType.CallReject].includes(e.getType()))r?r.state!==o.CallState.Ended&&(e.getType()===s.EventType.CallHangup?r.onHangupReceived(t):r.onRejectReceived(t),this.calls.delete(t.call_id)):(r=o.createNewMatrixCall(this.client,e.getRoomId()),r&&(r.callId=t.call_id,r.initWithHangup(e),this.calls.set(t.call_id,r)));else if(e.getType()===s.EventType.CallSelectAnswer){if(!r)return;if(e.getContent().party_id===r.ourPartyId)return;r.onSelectAnswerReceived(e)}else if(e.getType()===s.EventType.CallNegotiate){if(!r)return;if(e.getContent().party_id===r.ourPartyId)return;r.onNegotiateReceived(e)}else if(e.getType()===s.EventType.CallAssertedIdentity||e.getType()===s.EventType.CallAssertedIdentityPrefix){if(!r)return;if(e.getContent().party_id===r.ourPartyId)return;r.onAssertedIdentityReceived(e)}}}},{"../@types/event":54,"../logger":102,"./call":134}],136:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SDPStreamMetadataPurpose=void 0,function(e){e.Usermedia="m.usermedia",e.Screenshare="m.screenshare"}(r.SDPStreamMetadataPurpose||(r.SDPStreamMetadataPurpose={}))},{}],137:[function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(r,"__esModule",{value:!0}),r.CallFeed=r.CallFeedEvent=void 0;const i=n(e("events"));var o;!function(e){e.NewStream="new_stream"}(o=r.CallFeedEvent||(r.CallFeedEvent={}));class s extends i.default{constructor(e,t,r,n,i){super(),this.stream=e,this.userId=t,this.purpose=r,this.client=n,this.roomId=i}getMember(){return this.client.getRoom(this.roomId).getMember(this.userId)}isLocal(){return this.userId===this.client.getUserId()}isAudioMuted(){return 0===this.stream.getAudioTracks().length}isVideoMuted(){return 0===this.stream.getVideoTracks().length}setNewStream(e){this.stream=e,this.emit(o.NewStream,this.stream)}}r.CallFeed=s},{events:36}]},{},[59]);